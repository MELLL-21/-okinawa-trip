<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2C3E50">
    <title>æ²–ç¹©è¡Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --primary: #2C3E50;
            --accent: #E76F51;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        html, body {
            margin: 0; padding: 0;
            height: 100%; width: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            color: var(--primary);
        }

        body {
            display: flex; 
            flex-direction: column;
        }

        header { 
            padding: calc(1rem + var(--safe-top)) 1.5rem 0.5rem; 
            flex-shrink: 0; 
            z-index: 10;
            position: relative;
        }
        h1 { margin: 0; font-family: 'Noto Serif TC', serif; font-size: 2rem; font-weight: 900; }
        .subtitle { color: #607d8b; font-size: 0.8rem; font-weight: 600; margin-top: 5px; display: flex; align-items: center; gap: 6px; }
        .badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }

        .tabs { 
            display: flex; 
            padding: 0 1.5rem; 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            background: rgba(255, 255, 255, 0.3); 
            backdrop-filter: blur(10px);
            z-index: 10; 
            justify-content: space-around;
            flex-shrink: 0;
            position: relative;
        }
        .tab { 
            padding: 1rem 0; 
            font-weight: 700; color: #999; font-size: 0.8rem; 
            position: relative; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer;
        }
        .tab svg { width: 24px; height: 24px; fill: currentColor; }
        .tab.active { color: var(--primary); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--accent); border-radius: 2px; }
        
        main { 
            flex: 1; 
            overflow-y: auto; 
            padding: 1rem 1rem calc(6rem + var(--safe-bottom)) 1rem;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 1;
        }

        .day-scroll { display: flex; gap: 0.8rem; overflow-x: auto; padding: 0.5rem 0 1rem; scroll-snap-type: x mandatory; z-index: 2; position: relative;}
        .day-scroll::-webkit-scrollbar { display: none; }
        
        .day-card { 
            flex: 0 0 8.5rem; height: 6.5rem; 
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            border-radius: 1rem; padding: 0.8rem; 
            display: flex; flex-direction: column; justify-content: space-between;
            border: 2px solid transparent; transition: 0.2s; scroll-snap-align: start;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            cursor: pointer; position: relative;
        }
        .day-card:active { transform: scale(0.96); }
        .day-card.active { 
            background: var(--primary); color: white; 
            box-shadow: 0 8px 20px rgba(44,62,80,0.3); 
            border-color: var(--primary); 
        }
        .day-top { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: 800; opacity: 0.8; letter-spacing: 1px; }
        .day-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }
        .day-num { font-family: 'Noto Serif TC'; font-size: 1.8rem; font-weight: 700; line-height: 1; margin-top: auto; }
        .day-num span { font-size: 0.8rem; opacity: 0.6; font-family: 'Inter'; margin-left: 2px; }
        .day-cost { text-align: right; font-size: 0.7rem; font-weight: 600; opacity: 0.7; }
        .day-card.active .day-cost { color: var(--accent); opacity: 1; }

        .weather { 
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            padding: 1rem 1.2rem; border-radius: 1.2rem; 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .w-txt h3 { margin: 0 0 4px 0; font-family: 'Noto Serif TC'; font-size: 1rem; }
        .w-txt p { margin: 0; font-size: 0.7rem; color: #666; }
        .w-val { background: rgba(255,255,255,0.8); padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 1.2rem; }

        .list-head { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 0.8rem; padding: 0 4px; }
        .list-head h2 { margin: 0; font-family: 'Noto Serif TC'; font-size: 1.2rem; }
        .hint { font-size: 0.65rem; background: rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 12px; color: #888; }

        .plan-card { 
            background: white; 
            padding: 1rem; 
            border-radius: 1.2rem; 
            margin-bottom: 1rem; 
            display: flex; 
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            cursor: pointer; transition: transform 0.1s;
            height: 7.5rem;
            position: relative; z-index: 2;
        }
        .plan-card:active { transform: scale(0.98); }
        .plan-left {
            display: flex; flex-direction: column; justify-content: center; gap: 6px;
            flex: 1; min-width: 0;
        }
        .plan-time { font-size: 1.4rem; font-weight: 900; color: var(--primary); line-height: 1; }
        .plan-tag { 
            display: inline-block; font-size: 0.7rem; padding: 3px 8px; 
            border-radius: 12px; font-weight: 700; color: white;
            width: fit-content; 
        }
        .plan-title { font-family: 'Noto Serif TC'; font-weight: 800; font-size: 1.1rem; color: var(--primary); margin-top: 2px;}
        .plan-loc { font-size: 0.75rem; color: #888; display: flex; align-items: center; gap: 4px; font-weight: 500;}

        .plan-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
            margin-left: 1rem;
            flex-shrink: 0;
        }
        .nav-btn {
            padding: 6px 10px;
            border-radius: 999px;
            background: #2563eb;
            color: #fff;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .nav-btn svg {
            width: 14px;
            height: 14px;
        }

        .ticket-card {
            display: flex;
            background: #ffffff;
            border-radius: 18px;
            padding: 10px 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }
        .ticket-left {
            border-right: 1px dashed #e5e7eb;
            padding-right: 12px;
            margin-right: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 12px;
        }
        .ticket-left .flight {
            font-size: 1.2rem;
            font-weight: 800;
            margin-top: 4px;
            color: #111827;
        }
        .ticket-left .date {
            font-size: 0.75rem;
            margin-top: 4px;
            color: #9ca3af;
        }
        .ticket-right {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex: 1;
        }
        .ticket-route {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            font-weight: 700;
            color: #111827;
        }
        .ticket-time-row {
            margin-top: 4px;
            font-size: 0.75rem;
            color: #4b5563;
            display: flex;
            justify-content: space-between;
        }
        .ticket-meta {
            margin-top: 4px;
            font-size: 0.7rem;
            color: #9ca3af;
            display: flex;
            justify-content: space-between;
        }

        .exp-summary-card { 
            background: var(--primary); color: white; padding: 2rem; border-radius: 1.5rem; text-align: center; margin-bottom: 1rem; 
            box-shadow: 0 8px 20px rgba(44,62,80,0.3);
        }
        .stat-tabs { display: flex; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 4px; margin-bottom: 1rem; }
        .stat-tab { flex: 1; text-align: center; padding: 6px; font-size: 0.8rem; color: rgba(255,255,255,0.6); border-radius: 8px; font-weight: 700; cursor: pointer;}
        .stat-tab.active { background: white; color: var(--primary); }

        .quick-expense-card {
            background: rgba(255,255,255,0.9);
            border-radius: 1.2rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .quick-expense-row {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 0.6rem;
            margin-bottom: 0.6rem;
        }
        .quick-expense-row-bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
            margin-bottom: 0.6rem;
        }
        .quick-expense-card label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 2px;
            display: block;
            font-weight: 700;
        }
        .quick-expense-card input,
        .quick-expense-card select {
            width: 100%;
            padding: 0.55rem 0.7rem;
            border-radius: 0.7rem;
            border: 1px solid #e5e7eb;
            font-size: 0.8rem;
        }
        .quick-expense-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.3rem;
        }
        .quick-expense-footer button {
            padding: 0.5rem 1.2rem;
            border-radius: 999px;
            border: none;
            background: var(--primary);
            color: #fff;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
        }

        .exp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;}
        .exp-item { background: rgba(255,255,255,0.8); padding: 1rem; border-radius: 1rem; backdrop-filter: blur(5px); }
        
        .expense-row {
            background: white; padding: 1rem; border-radius: 1rem; margin-bottom: 0.8rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            cursor: pointer;
        }
        .pay-method-badge { font-size: 0.6rem; background: #eee; color: #666; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
        .advance-badge { font-size: 0.6rem; border: 1px solid var(--accent); color: var(--accent); padding: 1px 4px; border-radius: 4px; margin-left: 4px; }

        .wish-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .wish-card { 
            background: white; border-radius: 1rem; overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative;
            cursor: pointer;
        }
        .wish-img { width: 100%; aspect-ratio: 1; object-fit: cover; background: #eee; display: block;}
        .wish-content { padding: 0.8rem; }
        .wish-check { 
            position: absolute; top: 8px; right: 8px; 
            width: 24px; height: 24px; background: rgba(255,255,255,0.9); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 5;
        }
        .wish-check.checked { background: var(--accent); color: white; }

        .bg-sight { background: #3b82f6; }
        .bg-food { background: #f97316; }
        .bg-shop { background: #ec4899; }
        .bg-trans { background: #64748b; }
        .bg-other { background: #10b981; }

        .fab { 
            position: fixed; bottom: calc(2rem + var(--safe-bottom)); right: 1.5rem; 
            width: 3.5rem; height: 3.5rem; background: var(--primary); 
            border-radius: 50%; color: white; box-shadow: 0 8px 20px rgba(44,62,80,0.4); 
            display: flex; align-items: center; justify-content: center; z-index: 100;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .fab:active { transform: scale(0.9); }

        .overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); 
            z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; 
            display: flex; align-items: flex-end;
        }
        .overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal { 
            background: #FDFBF7; width: 100%; border-radius: 1.5rem 1.5rem 0 0; padding: 1.5rem; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 90dvh; overflow-y: auto; padding-bottom: calc(2rem + var(--safe-bottom));
        }
        .overlay.open .modal { transform: translateY(0); }

        .form-row { margin-bottom: 1rem; }
        label { display: block; font-size: 0.75rem; color: #888; font-weight: 700; margin-bottom: 6px; }
        input, select, textarea { 
            width: 100%; padding: 0.9rem; background: white; 
            border: 1px solid #eee; border-radius: 0.8rem; 
            font-size: 1rem; color: var(--primary); outline: none; appearance: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        input:focus, select:focus { border-color: var(--primary); }

        .cats { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; }
        .cat-chip { 
            padding: 8px 16px; background: white; border-radius: 20px; 
            font-size: 0.8rem; color: #aaa; font-weight: 700; white-space: nowrap; 
            border: 1px solid #eee; cursor: pointer;
        }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .checkbox-wrapper {
            display: flex; align-items: center; gap: 10px;
            background: white; padding: 0.8rem; border-radius: 0.8rem; border: 1px solid #eee;
        }
        .checkbox-wrapper input[type="checkbox"] {
            width: 1.2rem; height: 1.2rem; margin: 0;
        }
        
        .btn-save { width: 100%; padding: 1rem; background: var(--primary); color: white; border-radius: 1rem; font-size: 1rem; font-weight: 700; margin-top: 1.5rem; box-shadow: 0 4px 12px rgba(44,62,80,0.2); }
        .btn-del { width: 100%; padding: 1rem; color: #ef4444; font-weight: 700; background: transparent; margin-top: 0.5rem; }

        .map-link { text-decoration: none; color: inherit; display: contents; }

        /* æ­¡è¿ç•«é¢ */
        .welcome-card-wrapper {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.18);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .welcome-card-inner {
            background: rgba(255,255,255,0.96);
            border-radius: 1.4rem;
            box-shadow: 0 12px 35px rgba(15,23,42,0.25);
            padding: 1.2rem 1.3rem 1.1rem;
            width: 88%;
            max-width: 320px;
            text-align: center;
        }

        .welcome-user-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 220px;
            overflow-y: auto;
            margin-top: 0.4rem;
            padding-right: 2px;
        }
        .welcome-user-list::-webkit-scrollbar { width: 3px; }
        .welcome-user-list::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 999px;
        }

        .welcome-user-btn {
            align-self: center;
            min-width: 120px;
            max-width: 180px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 0.8rem;
            font-weight: 700;
            color: #374151;
            cursor: pointer;
            transition: 0.15s;
        }
        .welcome-user-btn:hover {
            background: #e5e7eb;
        }
        .welcome-user-btn:active {
            transform: scale(0.95);
        }
        .welcome-user-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        #quick-advance-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
            justify-content: center;
        }
        #quick-advance-list .welcome-user-btn {
            min-width: auto;
            padding: 4px 8px;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>

<!-- æ­¡è¿å¡ç‰‡ -->
<div id="welcome-card" class="welcome-card-wrapper">
  <div class="welcome-card-inner">
    <div style="font-size:1.8rem;margin-bottom:0.4rem;">âœˆï¸</div>
    <div style="font-family:'Noto Serif TC',serif;font-weight:800;font-size:1.1rem;margin-bottom:0.2rem;">
      æ­¡è¿åŠ å…¥æ²–ç¹©è¡Œ
    </div>
    <div style="font-size:0.8rem;color:#6b7280;margin-bottom:0.4rem;">
      è«‹é¸æ“‡ä½ çš„åå­—ï¼Œä¹‹å¾Œè¨˜å¸³æœƒè‡ªå‹•å¸¶å…¥
    </div>
    <div id="welcome-user-list" class="welcome-user-list"></div>
  </div>
</div>

<header>
    <h1>æ²–ç¹©è¡Œ</h1>
    <div class="subtitle"><span class="badge">5 Days</span> æ—…éŠç´€éŒ„ Â· è¨˜å¸³</div>
</header>

<div class="tabs">
    <div class="tab active" onclick="switchTab(this, 'itinerary')">
        <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/></svg>
        è¡Œç¨‹
    </div>
    <div class="tab" onclick="switchTab(this, 'expense')">
        <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
        è¨˜å¸³
    </div>
    <div class="tab" onclick="switchTab(this, 'wishlist')">
        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        é¡˜æœ›æ¸…å–®
    </div>
</div>

<main id="view-itinerary">
    <div class="day-scroll" id="day-list"></div>
    
    <div class="weather" id="weather-card">
        <div class="w-txt">
            <h3>æ²–ç¹©ï¼å³æ™‚å¤©æ°£</h3>
            <p id="weather-desc">è¼‰å…¥ä¸­...</p>
            <p id="clothing-advice" style="font-size:0.7rem; color:var(--accent); margin-top:4px; font-weight:700;"></p>
        </div>
        <div class="w-val" id="weather-temp">--Â°C</div>
    </div>

    <div class="list-head">
        <h2>è¡Œç¨‹è¡¨</h2>
        <span class="hint">é»æ“Šç·¨è¼¯ / å³å´å°èˆª</span>
    </div>
    <div id="plan-list"></div>
</main>

<main id="view-expense" style="display:none">
    <div class="exp-summary-card">
        <div class="stat-tabs">
            <div class="stat-tab active" onclick="toggleStat('personal')">å€‹äººæ¶ˆè²»</div>
            <div class="stat-tab" onclick="toggleStat('advance')">å¾…æ”¶æ¬¾é …</div>
        </div>
        <div style="font-size:2.5rem;font-weight:900;">NT$ <span id="total-exp">0</span></div>
        <div id="stat-label">å€‹äººç¸½èŠ±è²»</div>
    </div>

    <!-- å¿«é€Ÿè¨˜å¸³è¡¨å–® -->
    <div class="quick-expense-card">
        <div style="font-size:0.8rem;font-weight:700;margin-bottom:0.4rem;">å¿«é€Ÿè¨˜å¸³</div>
        <div class="quick-expense-row">
            <div>
                <label>åç¨±</label>
                <input type="text" id="quick-title" placeholder="ä¾‹ï¼šåˆé¤ã€é›»è»Šç¥¨">
            </div>
            <div>
                <label>é‡‘é¡</label>
                <input type="number" id="quick-amt" min="1" placeholder="NT$">
            </div>
        </div>
        <div class="quick-expense-row-bottom">
            <div>
                <label>ç¨®é¡</label>
                <select id="quick-cat">
                    <option value="food">ç¾é£Ÿ</option>
                    <option value="sight">æ™¯é»</option>
                    <option value="shop">è³¼ç‰©</option>
                    <option value="trans">äº¤é€š</option>
                    <option value="other">å…¶ä»–</option>
                </select>
            </div>
            <div>
                <label>ä»˜æ¬¾æ–¹å¼</label>
                <select id="quick-pay">
                    <option value="cash">ç¾é‡‘</option>
                    <option value="card">ä¿¡ç”¨å¡ / é›»å­æ”¯ä»˜</option>
                </select>
            </div>
        </div>

        <!-- ä»£ä»˜å°è±¡ -->
        <div style="margin-top:0.4rem;">
            <label>ä»£ä»˜å°è±¡ï¼ˆå¯è¤‡é¸ï¼‰</label>
            <div id="quick-advance-list"></div>
        </div>

        <div class="quick-expense-footer">
            <div style="font-size:0.7rem;color:#9ca3af;">ä¸å‹¾é¸ï¼åªæœ‰è‡ªå·±ä½¿ç”¨</div>
            <button type="button" onclick="addQuickExpense()">æ–°å¢</button>
        </div>
    </div>

    <div class="exp-grid" id="exp-grid"></div>
    <div class="list-head">
        <h2>æ”¯å‡ºæ˜ç´°</h2>
        <span class="hint">é»æ“Šåˆªé™¤</span>
    </div>
    <div id="expense-list"></div>
</main>

<main id="view-wishlist" style="display:none">
    <div class="list-head">
        <h2>é¡˜æœ›æ¸…å–®</h2>
        <span class="hint">é»æ“Šæ‰“å‹¾ / æ–°å¢ç…§ç‰‡</span>
    </div>
    <div class="wish-grid" id="wish-list"></div>
</main>

<div class="fab" id="btn-add" onclick="openModal()">
    <svg class="icon" style="width:2em;height:2em;" viewBox="0 0 24 24"><path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
</div>

<div class="overlay" id="modal-overlay">
    <div class="modal">
        <h2 id="modal-title">æ–°å¢é …ç›®</h2>
        <form id="add-form" autocomplete="off">
            <div class="form-row" id="field-time">
                <label>æ™‚é–“</label>
                <input type="time" id="add-time" required>
            </div>

            <div class="form-row">
                <label>åç¨± / æ¨™é¡Œ</label>
                <input type="text" id="add-title" maxlength="32" required placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€è¬åº§æ¯›">
            </div>

            <div id="expense-fields" style="display:none">
                <div class="form-row">
                    <label>é‡‘é¡ (NT$)</label>
                    <input type="number" id="add-amt" min="1" max="999999" step="1" placeholder="è¼¸å…¥é‡‘é¡">
                </div>
                <div class="form-row">
                    <label>ä»˜æ¬¾æ–¹å¼</label>
                    <select id="add-pay-method">
                        <option value="cash">ç¾é‡‘</option>
                        <option value="card">ä¿¡ç”¨å¡ / é›»å­æ”¯ä»˜</option>
                    </select>
                </div>
            </div>

            <div class="form-row" id="field-loc">
                <label>åœ°é» / å‚™è¨»</label>
                <input type="text" id="add-loc" maxlength="64" placeholder="è¼¸å…¥åœ°é»æˆ–å‚™è¨»">
            </div>

            <div class="form-row">
                <label>ç¨®é¡æ¨™ç±¤</label>
                <div class="cats" id="cat-list"></div>
            </div>

            <div id="advance-field" class="form-row" style="display:none">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="add-advance">
                    <span style="font-size:0.9rem;font-weight:700;">æ­¤ç‚ºä»£ä»˜æ¬¾é … (ä¸è¨ˆå…¥å€‹äººæ¶ˆè²»)</span>
                </div>
            </div>

            <div id="wish-fields" style="display:none">
                <div class="form-row">
                    <label>åœ–ç‰‡ URL (é¸å¡«)</label>
                    <input type="text" id="wish-img-url" placeholder="https://...">
                </div>
            </div>

            <button type="submit" class="btn-save">å„²å­˜</button>
            <button type="button" class="btn-del" onclick="deleteItem()">åˆªé™¤ç´€éŒ„</button>
        </form>
    </div>
</div>

<script>
const DAYS = [
    { num: 1, label: '01/06', week: '(äºŒ)' },
    { num: 2, label: '01/07', week: '(ä¸‰)' },
    { num: 3, label: '01/08', week: '(å››)' },
    { num: 4, label: '01/09', week: '(äº”)' },
    { num: 5, label: '01/10', week: '(å…­)' }
];

const PLAN = [
    [ 
        { time: '09:00', cat: 'sight', title: 'è¬åº§æ¯›', loc: 'æ²–ç¹©æ™¯é»', id: 1 },
        { time: '12:30', cat: 'food', title: 'æµ·äººé£Ÿå ‚', loc: 'åˆé¤', id: 2 },
        { time: '14:00', cat: 'shop', title: 'åœ‹éš›é€šè³¼ç‰©', loc: 'è¡€æ‹¼', id: 3 }
    ],
    [ 
        { time: '10:00', cat: 'sight', title: 'ç¾ã‚‰æµ·æ°´æ—é¤¨', loc: '', id: 4 },
        { time: '13:00', cat: 'trans', title: 'å–®è»Œåˆ—è»Šé«”é©—', loc: '', id: 5 },
        { time: '17:00', cat: 'food', title: 'å’–å•¡å»³', loc: 'æ‚ é–’ä¸‹åˆèŒ¶', id: 6 }
    ],
    [], [], []
];

const EXPENSE = [
    [ 
        { cat: 'food', title: 'åˆé¤', amt: 650, payMethod:'cash', payBy: 'è¨±æ³¢', advanceFor: [], id: 'e1' },
        { cat: 'shop', title: 'ç´€å¿µå“', amt: 1200, payMethod:'card', payBy: 'è¨±æ³¢', advanceFor: ['æ–¹å‰', 'åƒåˆ'], id: 'e2' } 
    ],
    [ 
        { cat: 'food', title: 'å’–å•¡', amt: 180, payMethod:'cash', payBy: 'æ–¹å‰', advanceFor: [], id: 'e3' },
        { cat: 'trans', title: 'å–®è»Œè»Šç¥¨', amt: 1200, payMethod:'card', payBy: 'æ–¹å‰', advanceFor: ['è¨±æ³¢'], id: 'e4' }
    ],
    [], [], []
];

const WISHLIST = [
    { title: 'åƒ A5 å’Œç‰›', checked: false, img: 'https://images.unsplash.com/photo-1588168333986-5078d3ae3976?w=400', id: 'w1' },
    { title: 'è²·é™å®šæ³¡ç››', checked: true, img: '', id: 'w2' }
];

const CATEGORIES = [
    { key: 'sight', label: 'æ™¯é»', color: 'bg-sight' },
    { key: 'food', label: 'ç¾é£Ÿ', color: 'bg-food' },
    { key: 'shop', label: 'è³¼ç‰©', color: 'bg-shop' },
    { key: 'trans', label: 'äº¤é€š', color: 'bg-trans' },
    { key: 'other', label: 'å…¶ä»–', color: 'bg-other' }
];

const MEMBERS = ['è¨±æ³¢', 'æ–¹å‰', 'åƒåˆ', 'ä¾‘ç„„', 'å®¶éŠ˜'];

// æ¸¬è©¦éšæ®µï¼šä¸å¾ localStorage è®€å–ï¼Œæ¯æ¬¡é‡æ–°é–‹å§‹
let currentUser = null;
let curTab = 'itinerary';
let curDay = 0;
let editingItem = null;
let editingType = null;
let statMode = 'personal';

// ========== åˆå§‹åŒ– ==========

function init() {
    // æ¸¬è©¦éšæ®µï¼šå¼·åˆ¶é¡¯ç¤ºæ­¡è¿å¡ç‰‡ï¼Œä¸è®€å– localStorage
    currentUser = null;
    
    showWelcomeCard();
    renderQuickAdvanceList();
    renderDays();
    renderPlan();
    renderWishlist();
    fetchWeather();
    renderCategories();
    if (currentUser) renderExpense();
}

// ========== æ­¡è¿ç•«é¢ ==========

function showWelcomeCard() {
    const wrapper = document.getElementById('welcome-card');
    const list = document.getElementById('welcome-user-list');
    if (!wrapper || !list) return;

    list.innerHTML = '';
    MEMBERS.forEach(name => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'welcome-user-btn';
        btn.textContent = name;
        btn.onclick = (e) => {
            e.preventDefault();
            selectUser(name);
        };
        list.appendChild(btn);
    });

    wrapper.style.display = 'flex';
    wrapper.style.pointerEvents = 'auto';
}

function selectUser(name) {
    currentUser = name;
    // æ¸¬è©¦éšæ®µï¼šä¸å­˜åˆ° localStorageï¼Œæ¯æ¬¡éƒ½é‡æ–°é¸æ“‡
    // localStorage.setItem('tripUser', name);

    updateSubtitleWithUser();
    renderQuickAdvanceList();
    renderExpense();
    renderDays();
    renderPlan();
    
    // éš±è—æ­¡è¿å¡ç‰‡ï¼Œå…è¨±æ­£å¸¸ä½¿ç”¨ App
    const wrapper = document.getElementById('welcome-card');
    if (wrapper) {
        wrapper.style.display = 'none';
        wrapper.style.pointerEvents = 'none';
    }
}

function updateSubtitleWithUser() {
    const subtitle = document.querySelector('.subtitle');
    if (!subtitle || !currentUser) return;
    subtitle.innerHTML = `<span class="badge">${currentUser}</span> æ—…éŠç´€éŒ„ Â· è¨˜å¸³`;
}

function renderQuickAdvanceList() {
    const wrap = document.getElementById('quick-advance-list');
    if (!wrap) return;
    wrap.innerHTML = '';

    if (!currentUser || !MEMBERS.includes(currentUser)) return;

    const others = MEMBERS.filter(name => name !== currentUser);
    others.forEach(name => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'welcome-user-btn';
        btn.textContent = name;
        btn.dataset.name = name;
        btn.onclick = (e) => {
            e.preventDefault();
            btn.classList.toggle('selected');
        };
        wrap.appendChild(btn);
    });
}

// ========== å¤©æ°£ ==========

function fetchWeather() {
    updateWeatherUI(26, 'æ™´æ™‚å¤šé›²');
}

function updateWeatherUI(temp, desc) {
    document.getElementById('weather-temp').textContent = `${temp}Â°C`;
    document.getElementById('weather-desc').textContent = desc;
    
    let advice = "å¤©æ°£èˆ’é©ï¼Œç©¿çŸ­è¢–å³å¯";
    if(temp > 28) advice = "å¤©æ°£ç‚ç†±ï¼Œæ³¨æ„é˜²æ›¬èˆ‡è£œæ°´";
    else if(temp < 20) advice = "å¾®æ¶¼ï¼Œå»ºè­°å¸¶ä»¶è–„å¤–å¥—";
    document.getElementById('clothing-advice').textContent = `ğŸ’¡ ${advice}`;
}

// ========== åˆ†é  ==========

function switchTab(tabBtn, name) {
    document.querySelectorAll('.tab').forEach($=>$.classList.remove('active'));
    tabBtn.classList.add('active');
    
    document.getElementById('view-itinerary').style.display = 'none';
    document.getElementById('view-expense').style.display = 'none';
    document.getElementById('view-wishlist').style.display = 'none';
    
    document.getElementById(`view-${name}`).style.display = 'block';
    curTab = name;

    const fab = document.getElementById('btn-add');
    if (name === 'expense') {
        fab.style.display = 'none';
    } else {
        fab.style.display = 'flex';
    }

    if(name === 'wishlist') renderWishlist();
}

// ========== Day å¡ç‰‡ ==========

function renderDays() {
    const dayList = document.getElementById('day-list');
    dayList.innerHTML = '';
    DAYS.forEach((day, idx) => {
        const div = document.createElement('div');
        div.className = 'day-card' + (curDay===idx?' active':'');
        div.onclick = (e) => {
            e.preventDefault();
            curDay = idx;
            renderDays();
            renderPlan();
            renderExpense();
        };
        div.innerHTML = `
            <div class="day-top">
                <span>Day ${day.num}</span>
                <span class="day-dot"></span>
            </div>
            <div class="day-num">${day.label}<span>æ—¥</span></div>
        `;
        dayList.appendChild(div);
    });
}

// ========== èˆªç­å¡ç‰‡ ==========

function getFlightCardHtml(dayIndex) {
    if (dayIndex === 0) {
        return `
        <div class="ticket-card">
            <div class="ticket-left">
                <div class="flight">IT230</div>
                <div class="date">2026/01/06</div>
            </div>
            <div class="ticket-right">
                <div class="ticket-route">
                    <span>TPE</span>
                    <span style="font-size:0.9rem;">âœˆ</span>
                    <span>OKA</span>
                </div>
                <div class="ticket-time-row">
                    <span>èµ·é£› 06:35</span>
                    <span>æŠµé” 08:55</span>
                </div>
                <div class="ticket-meta">
                    <a href="https://tw.trip.com/actualtime/detail.html?flightNo=IT230&date=2026-01-06&locale=zh-TW" target="_blank" rel="noopener noreferrer" style="font-size:0.7rem;color:#2563eb;font-weight:700;text-decoration:none;">
                        å³æ™‚å‹•æ…‹ / å ±åˆ°æ«ƒæª¯ â†’
                    </a>
                </div>
            </div>
        </div>`;
    }
    if (dayIndex === 4) {
        return `
        <div class="ticket-card">
            <div class="ticket-left">
                <div class="flight">IT231</div>
                <div class="date">2026/01/10</div>
            </div>
            <div class="ticket-right">
                <div class="ticket-route">
                    <span>OKA</span>
                    <span style="font-size:0.9rem;">âœˆ</span>
                    <span>TPE</span>
                </div>
                <div class="ticket-time-row">
                    <span>èµ·é£› 09:45</span>
                    <span>æŠµé” 10:20</span>
                </div>
                <div class="ticket-meta">
                    <a href="https://tw.trip.com/actualtime/detail.html?flightNo=IT231&date=2026-01-10&locale=zh-TW" target="_blank" rel="noopener noreferrer" style="font-size:0.7rem;color:#2563eb;font-weight:700;text-decoration:none;">
                        å³æ™‚å‹•æ…‹ / å ±åˆ°æ«ƒæª¯ â†’
                    </a>
                </div>
            </div>
        </div>`;
    }
    return '';
}

// ========== è¡Œç¨‹ ==========

function renderPlan() {
    const list = document.getElementById('plan-list');
    list.innerHTML = '';

    const flightHtml = getFlightCardHtml(curDay);
    if (flightHtml) {
        list.insertAdjacentHTML('beforeend', flightHtml);
    }

    const plans = PLAN[curDay] || [];

    if (plans.length===0 && !flightHtml) {
        list.innerHTML = `<div style="color:#888;text-align:center;margin:2rem 0;">ç›®å‰æ²’æœ‰è¡Œç¨‹</div>`;
        return;
    }

    plans.forEach((item, idx) => {
        const cat = CATEGORIES.find(c=>c.key===item.cat) || {};
        const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.loc || ('æ²–ç¹© ' + item.title))}`;

        const div = document.createElement('div');
        div.className = 'plan-card';
        div.onclick = (e) => {
            if(e.target.closest('.nav-btn')) return;
            openModal('plan', item, idx);
        };

        div.innerHTML = `
            <div class="plan-left">
                <div class="plan-time">${item.time}</div>
                <div class="plan-tag ${cat.color}">${cat.label}</div>
                <div class="plan-title">${item.title}</div>
                <div class="plan-loc">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    ${item.loc || 'æœªè¨­å®šåœ°é»'}
                </div>
            </div>
            <div class="plan-actions">
                <a href="${mapUrl}" target="_blank" rel="noopener noreferrer" style="text-decoration:none;">
                    <button type="button" class="nav-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L4.5 20.29 11 18l1 4 1.5-6.29L19.5 9 12 2z"/>
                        </svg>
                        å°èˆª
                    </button>
                </a>
            </div>
        `;
        list.appendChild(div);
    });
}

// ========== è¨˜å¸³ ==========

function renderExpense() {
    if (!currentUser) return;

    const list = EXPENSE[curDay] || [];
    const filtered = list.filter(item => {
        if (statMode === 'advance') {
            // å¾…æ”¶æ¬¾ï¼šåªçœ‹ã€Œæˆ‘ç•¶ä»˜æ¬¾äºº & æœ‰ä»£ä»˜ã€
            return item.payBy === currentUser && item.advanceFor && item.advanceFor.length > 0;
        } else {
            // å€‹äººæ¶ˆè²»ï¼šåªçœ‹ã€Œæˆ‘ä»˜è‡ªå·±çš„ã€
            return item.payBy === currentUser && (!item.advanceFor || item.advanceFor.length === 0);
        }
    });

    const expenseList = document.getElementById('expense-list');
    expenseList.innerHTML = '';

    if (filtered.length === 0) {
        expenseList.innerHTML = `<div style="color:#888;text-align:center;margin:2rem 0;">ç›®å‰æ²’æœ‰è¨˜éŒ„</div>`;
        return;
    }

    filtered.forEach(item => {
        const cat = CATEGORIES.find(c=>c.key===item.cat) || {};
        const div = document.createElement('div');
        div.className = 'expense-row';
        div.onclick = () => openModal('expense', item);

        let advanceText = '';
        if (item.advanceFor && item.advanceFor.length > 0) {
            advanceText = `<span class="advance-badge">ä»£ä»˜: ${item.advanceFor.join(', ')}</span>`;
        }

        div.innerHTML = `
            <div>
                <div style="font-weight:700; color:var(--primary);">${item.title}</div>
                <div style="font-size:0.75rem; color:#888; margin-top:4px;">
                    ${cat.label}
                    <span class="pay-method-badge">${item.payMethod==='cash'?'ç¾é‡‘':'å¡'}</span>
                    ${advanceText}
                </div>
            </div>
            <div style="font-weight:700; font-size:1.1rem; color:var(--accent);">NT$ ${item.amt}</div>
        `;
        expenseList.appendChild(div);
    });

    updateExpenseStats();
}

function updateExpenseStats() {
    if (!currentUser) return;

    const list = EXPENSE[curDay] || [];

    if (statMode === 'advance') {
        // å¾…æ”¶æ¬¾ï¼šæˆ‘ä»˜çµ¦åˆ¥äººçš„ç¸½é¡
        const total = list
            .filter(item => item.payBy === currentUser && item.advanceFor && item.advanceFor.length > 0)
            .reduce((sum, item) => sum + item.amt, 0);
        document.getElementById('total-exp').textContent = total;
        document.getElementById('stat-label').textContent = 'å¾…æ”¶æ¬¾é …';
    } else {
        // å€‹äººæ¶ˆè²»ï¼šæˆ‘ä»˜è‡ªå·±çš„ç¸½é¡
        const total = list
            .filter(item => item.payBy === currentUser && (!item.advanceFor || item.advanceFor.length === 0))
            .reduce((sum, item) => sum + item.amt, 0);
        document.getElementById('total-exp').textContent = total;
        document.getElementById('stat-label').textContent = 'å€‹äººç¸½èŠ±è²»';
    }
}

function toggleStat(mode) {
    statMode = mode;
    document.querySelectorAll('.stat-tab').forEach($=>$.classList.remove('active'));
    event.target.classList.add('active');
    renderExpense();
}

function addQuickExpense() {
    if (!currentUser) {
        alert('è«‹å…ˆé¸æ“‡åå­—');
        return;
    }

    const title = document.getElementById('quick-title').value.trim();
    const amt = parseInt(document.getElementById('quick-amt').value) || 0;
    const cat = document.getElementById('quick-cat').value;
    const payMethod = document.getElementById('quick-pay').value;

    if (!title || amt <= 0) {
        alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        return;
    }

    // å–å¾—ä»£ä»˜å°è±¡
    const advanceFor = [];
    document.querySelectorAll('#quick-advance-list .welcome-user-btn.selected').forEach(btn => {
        advanceFor.push(btn.dataset.name);
    });

    const newExpense = {
        cat,
        title,
        amt,
        payMethod,
        payBy: currentUser,
        advanceFor,
        id: 'e' + Date.now()
    };

    EXPENSE[curDay].push(newExpense);

    // æ¸…ç©ºè¡¨å–®
    document.getElementById('quick-title').value = '';
    document.getElementById('quick-amt').value = '';
    document.getElementById('quick-cat').value = 'food';
    document.getElementById('quick-pay').value = 'cash';
    document.querySelectorAll('#quick-advance-list .welcome-user-btn').forEach($=>$.classList.remove('selected'));

    renderExpense();
    alert('è¨˜å¸³æˆåŠŸï¼');
}

// ========== Modal & ç·¨è¼¯ ==========

function renderCategories() {
    const container = document.getElementById('cat-list');
    container.innerHTML = '';
    CATEGORIES.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'cat-chip';
        div.textContent = cat.label;
        div.onclick = () => {
            document.querySelectorAll('.cat-chip').forEach($=>$.classList.remove('active'));
            div.classList.add('active');
            document.getElementById('add-form').dataset.selectedCat = cat.key;
        };
        container.appendChild(div);
    });
}

function openModal(type = 'plan', data = null, idx = null) {
    if (!currentUser && type !== 'plan') {
        alert('è«‹å…ˆé¸æ“‡åå­—');
        return;
    }

    editingItem = data;
    editingType = type;

    const overlay = document.getElementById('modal-overlay');
    const form = document.getElementById('add-form');
    const modal = document.querySelector('.modal');

    // éš±è— / é¡¯ç¤ºæ¬„ä½
    document.getElementById('field-time').style.display = type === 'plan' ? 'block' : 'none';
    document.getElementById('expense-fields').style.display = type === 'expense' ? 'block' : 'none';
    document.getElementById('field-loc').style.display = type === 'plan' ? 'block' : 'none';
    document.getElementById('advance-field').style.display = type === 'expense' ? 'block' : 'none';
    document.getElementById('wish-fields').style.display = type === 'wish' ? 'block' : 'none';
    document.querySelector('.btn-del').style.display = data ? 'block' : 'none';

    // å¡«å…¥è³‡æ–™
    if (data) {
        document.getElementById('modal-title').textContent = 'ç·¨è¼¯é …ç›®';
        if (type === 'plan') {
            document.getElementById('add-time').value = data.time;
            document.getElementById('add-title').value = data.title;
            document.getElementById('add-loc').value = data.loc;
            const catChip = document.querySelector(`[data-cat="${data.cat}"]`);
            if (catChip) catChip.click();
        } else if (type === 'expense') {
            document.getElementById('add-title').value = data.title;
            document.getElementById('add-amt').value = data.amt;
            document.getElementById('add-pay-method').value = data.payMethod;
            document.getElementById('add-advance').checked = data.advanceFor && data.advanceFor.length > 0;
            const catChip = document.querySelector(`[data-cat="${data.cat}"]`);
            if (catChip) catChip.click();
        } else if (type === 'wish') {
            document.getElementById('add-title').value = data.title;
            document.getElementById('wish-img-url').value = data.img || '';
        }
    } else {
        document.getElementById('modal-title').textContent = type === 'wish' ? 'æ–°å¢é¡˜æœ›' : type === 'expense' ? 'æ–°å¢æ”¯å‡º' : 'æ–°å¢è¡Œç¨‹';
        form.reset();
    }

    form.onsubmit = (e) => {
        e.preventDefault();
        saveItem(type, idx);
    };

    overlay.classList.add('open');
}

function closeModal() {
    document.getElementById('modal-overlay').classList.remove('open');
}

function saveItem(type, idx) {
    const title = document.getElementById('add-title').value.trim();
    if (!title) {
        alert('è«‹è¼¸å…¥åç¨±');
        return;
    }

    if (type === 'plan') {
        const time = document.getElementById('add-time').value;
        const loc = document.getElementById('add-loc').value;
        const cat = document.getElementById('add-form').dataset.selectedCat || 'sight';

        if (!time) {
            alert('è«‹è¼¸å…¥æ™‚é–“');
            return;
        }

        if (editingItem && idx !== null) {
            PLAN[curDay][idx] = { time, cat, title, loc, id: editingItem.id };
        } else {
            PLAN[curDay].push({ time, cat, title, loc, id: 'p' + Date.now() });
        }
    } else if (type === 'expense') {
        const amt = parseInt(document.getElementById('add-amt').value) || 0;
        const payMethod = document.getElementById('add-pay-method').value;
        const isAdvance = document.getElementById('add-advance').checked;
        const cat = document.getElementById('add-form').dataset.selectedCat || 'food';

        if (amt <= 0) {
            alert('è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡');
            return;
        }

        const advanceFor = isAdvance ? ['other'] : [];

        if (editingItem) {
            Object.assign(editingItem, { cat, title, amt, payMethod, advanceFor });
        } else {
            EXPENSE[curDay].push({ cat, title, amt, payMethod, payBy: currentUser, advanceFor, id: 'e' + Date.now() });
        }
    } else if (type === 'wish') {
        const img = document.getElementById('wish-img-url').value.trim();
        if (editingItem) {
            Object.assign(editingItem, { title, img });
        } else {
            WISHLIST.push({ title, checked: false, img, id: 'w' + Date.now() });
        }
    }

    closeModal();
    if (type === 'plan') renderPlan();
    if (type === 'expense') renderExpense();
    if (type === 'wish') renderWishlist();
}

function deleteItem() {
    if (!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return;

    if (editingType === 'plan' && editingItem) {
        const idx = PLAN[curDay].findIndex(p => p.id === editingItem.id);
        if (idx >= 0) PLAN[curDay].splice(idx, 1);
    } else if (editingType === 'expense' && editingItem) {
        const idx = EXPENSE[curDay].findIndex(e => e.id === editingItem.id);
        if (idx >= 0) EXPENSE[curDay].splice(idx, 1);
    } else if (editingType === 'wish' && editingItem) {
        const idx = WISHLIST.findIndex(w => w.id === editingItem.id);
        if (idx >= 0) WISHLIST.splice(idx, 1);
    }

    closeModal();
    if (editingType === 'plan') renderPlan();
    if (editingType === 'expense') renderExpense();
    if (editingType === 'wish') renderWishlist();
}

// ========== é¡˜æœ›æ¸…å–® ==========

function renderWishlist() {
    const grid = document.getElementById('wish-list');
    grid.innerHTML = '';

    WISHLIST.forEach(item => {
        const div = document.createElement('div');
        div.className = 'wish-card';
        div.innerHTML = `
            <img src="${item.img}" alt="${item.title}" class="wish-img" onerror="this.style.display='none'">
            <div class="wish-check ${item.checked?'checked':''}" onclick="toggleWish(event, '${item.id}')">
                ${item.checked ? 'âœ“' : ''}
            </div>
            <div class="wish-content">
                <div style="font-weight:700; font-size:0.9rem;">${item.title}</div>
                <button type="button" onclick="openModal('wish', WISHLIST.find(w=>w.id==='${item.id}'))" style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:0.7rem; margin-top:4px; font-weight:700;">ç·¨è¼¯</button>
            </div>
        `;
        grid.appendChild(div);
    });
}

function toggleWish(event, id) {
    event.stopPropagation();
    const item = WISHLIST.find(w => w.id === id);
    if (item) item.checked = !item.checked;
    renderWishlist();
}

// ========== åˆå§‹åŒ–å…¥å£ ==========

document.addEventListener('DOMContentLoaded', () => {
    console.log('é é¢è¼‰å…¥');
    init();
});

// é—œé–‰ Modal çš„é»æ“ŠèƒŒæ™¯
document.getElementById('modal-overlay').onclick = (e) => {
    if (e.target.id === 'modal-overlay') closeModal();
};

// é˜²æ­¢æ­¡è¿å¡ç‰‡é®ç½©å¹²æ“¾
document.getElementById('welcome-card').addEventListener('click', (e) => {
    if (e.target === document.getElementById('welcome-card')) {
        // é»ç©ºç™½ä¸é—œé–‰
    }
}, false);

</script>
</body>
</html>
