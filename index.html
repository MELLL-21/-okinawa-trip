<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2C3E50">
    <title>沖繩行</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --primary: #2C3E50;
            --accent: #E76F51;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: var(--primary); }
        body { display: flex; flex-direction: column; }

        /* Header */
        header { padding: calc(1rem + var(--safe-top)) 1.5rem 0.5rem; flex-shrink: 0; z-index: 10; position: relative; }
        h1 { margin: 0; font-family: 'Noto Serif TC', serif; font-size: 2rem; font-weight: 900; }
        .subtitle { color: #607d8b; font-size: 0.8rem; font-weight: 600; margin-top: 5px; display: flex; align-items: center; gap: 6px; }
        .badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }

        /* Tabs */
        .tabs { display: flex; padding: 0 1.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); z-index: 10; justify-content: space-around; flex-shrink: 0; position: relative; }
        .tab { padding: 1rem 0; font-weight: 700; color: #999; font-size: 0.8rem; position: relative; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .tab svg { width: 24px; height: 24px; fill: currentColor; }
        .tab.active { color: var(--primary); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--accent); border-radius: 2px; }

        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 1rem 1rem calc(6rem + var(--safe-bottom)) 1rem; -webkit-overflow-scrolling: touch; position: relative; z-index: 1; }

        /* Day Scroll */
        .day-scroll { display: flex; gap: 0.8rem; overflow-x: auto; padding: 0.5rem 0 1rem; scroll-snap-type: x mandatory; z-index: 2; position: relative; }
        .day-scroll::-webkit-scrollbar { display: none; }
        .day-card { flex: 0 0 8.5rem; height: 6.5rem; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px); border-radius: 1rem; padding: 0.8rem; display: flex; flex-direction: column; justify-content: space-between; border: 2px solid transparent; transition: 0.2s; scroll-snap-align: start; box-shadow: 0 4px 12px rgba(0,0,0,0.03); cursor: pointer; position: relative; }
        .day-card:active { transform: scale(0.96); }
        .day-card.active { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(44,62,80,0.3); border-color: var(--primary); }
        .day-top { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: 800; opacity: 0.8; letter-spacing: 1px; }
        .day-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }
        .day-num { font-family: 'Noto Serif TC'; font-size: 1.8rem; font-weight: 700; line-height: 1; margin-top: auto; }
        .day-num span { font-size: 0.8rem; opacity: 0.6; font-family: 'Inter'; margin-left: 2px; }

        /* Weather Card */
        .weather { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); padding: 1rem 1.2rem; border-radius: 1.2rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .w-txt h3 { margin: 0 0 4px 0; font-family: 'Noto Serif TC'; font-size: 1rem; }
        .w-txt p { margin: 0; font-size: 0.7rem; color: #666; }
        .w-val { background: rgba(255,255,255,0.8); padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 1.2rem; }

        /* List Headers */
        .list-head { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 0.8rem; padding: 0 4px; }
        .list-head h2 { margin: 0; font-family: 'Noto Serif TC'; font-size: 1.2rem; }
        .hint { font-size: 0.65rem; background: rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 12px; color: #888; }

        /* Plan Card */
        .plan-card { background: white; padding: 1rem; border-radius: 1.2rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 8px 24px rgba(0,0,0,0.08); cursor: pointer; transition: transform 0.1s; height: 7.5rem; position: relative; z-index: 2; }
        .plan-card:active { transform: scale(0.98); }
        .plan-left { display: flex; flex-direction: column; justify-content: center; gap: 6px; flex: 1; min-width: 0; }
        .plan-time { font-size: 1.4rem; font-weight: 900; color: var(--primary); line-height: 1; }
        .plan-tag { display: inline-block; font-size: 0.7rem; padding: 3px 8px; border-radius: 12px; font-weight: 700; color: white; width: fit-content; }
        .plan-title { font-family: 'Noto Serif TC'; font-weight: 800; font-size: 1.1rem; color: var(--primary); margin-top: 2px; }
        .plan-loc { font-size: 0.75rem; color: #888; display: flex; align-items: center; gap: 4px; font-weight: 500; }
        .plan-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; margin-left: 1rem; flex-shrink: 0; }
        
		/* 修改導航按鈕樣式 */
	.nav-btn {
    padding: 6px 12px; /* 稍微加寬一點點 */
    border-radius: 999px;
    background: #3b82f6; /* 卡片藍底 (配合 bg-sight 的顏色) */
    color: #ffffff;      /* 白色文字與圖標 */
    font-size: 0.75rem;
    font-weight: 700;    /* 字體加粗 */
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;            /* 圖標與文字間距 */
    box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4); /* 增加一點藍色光暈陰影 */
    transition: transform 0.2s, box-shadow 0.2s;
}

	.nav-btn:active {
    transform: scale(0.95);
    box-shadow: 0 2px 5px rgba(59, 130, 246, 0.4);
}

.nav-btn svg {
    width: 14px;
    height: 14px;
    fill: currentColor; /* 讓圖標跟隨文字顏色變成白色 */
     /* 調整角度讓箭頭指向右上方 */
}
        .nav-btn svg { width: 14px; height: 14px;fill: currentColor; }

        /* Flight Ticket */
        .ticket-card { display: flex; background: #ffffff; border-radius: 18px; padding: 10px 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 12px; position: relative; overflow: hidden; }
        .ticket-left { border-right: 1px dashed #e5e7eb; padding-right: 12px; margin-right: 12px; display: flex; flex-direction: column; justify-content: center; font-size: 12px; }
        .ticket-left .flight { font-size: 1.2rem; font-weight: 800; margin-top: 4px; color: #111827; }
        .ticket-left .date { font-size: 0.75rem; margin-top: 4px; color: #9ca3af; }
        .ticket-right { display: flex; flex-direction: column; justify-content: center; flex: 1; }
        .ticket-route { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; font-weight: 700; color: #111827; }
        .ticket-time-row { margin-top: 4px; font-size: 0.75rem; color: #4b5563; display: flex; justify-content: space-between; }
        .ticket-meta { margin-top: 4px; font-size: 0.7rem; color: #9ca3af; display: flex; justify-content: space-between; }

        /* Expense Summary Card */
        .exp-summary-card { background: var(--primary); color: white; padding: 2rem; border-radius: 1.5rem; text-align: center; margin-bottom: 1rem; box-shadow: 0 8px 20px rgba(44,62,80,0.3); }
        .stat-tabs { display: flex; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 4px; margin-bottom: 1rem; }
        .stat-tab { flex: 1; text-align: center; padding: 6px; font-size: 0.8rem; color: rgba(255,255,255,0.6); border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .stat-tab.active { background: white; color: var(--primary); }

        /* Quick Expense Form */
        .quick-expense-card { background: rgba(255,255,255,0.9); border-radius: 1.2rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: 0.3s; border: 2px solid transparent; }
        .quick-expense-card.editing { border-color: var(--accent); background: #fff; box-shadow: 0 8px 24px rgba(231, 111, 81, 0.15); }
        .quick-expense-row { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 0.6rem; margin-bottom: 0.6rem; }
        .quick-expense-card label { font-size: 0.7rem; color: #888; margin-bottom: 2px; display: block; font-weight: 700; }
        .quick-expense-card input, .quick-expense-card select { width: 100%; padding: 0.55rem 0.7rem; border-radius: 0.7rem; border: 1px solid #e5e7eb; font-size: 0.8rem; }
        .quick-expense-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 0.3rem; }
        .btn-submit { padding: 0.5rem 1.2rem; border-radius: 999px; border: none; background: var(--primary); color: #fff; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .quick-expense-card.editing .btn-submit { background: var(--accent); }
        .edit-actions { display: none; gap: 6px; }
        .quick-expense-card.editing .edit-actions { display: flex; }
        .btn-cancel, .btn-delete-inline { padding: 0.5rem 0.8rem; border-radius: 999px; border: 1px solid #ddd; background: white; color: #666; font-size: 0.75rem; font-weight: 700; cursor: pointer; }
        .btn-delete-inline { color: #ef4444; border-color: #fee2e2; background: #fef2f2; }

        /* Expense List */
        .expense-row { background: white; padding: 0.8rem 1rem; border-radius: 1rem; margin-bottom: 0.8rem; display: block; box-shadow: 0 2px 8px rgba(0,0,0,0.03); cursor: pointer; transition: transform 0.1s; }
        .expense-row:active { transform: scale(0.98); }
        .expense-header { display: flex; justify-content: space-between; align-items: center; }
        .expense-detail-panel { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e5e7eb; animation: slideDown 0.2s ease-out; }
        .expense-row.expanded .expense-detail-panel { display: block; }
        .detail-list-item { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 6px; padding: 6px 10px; background: #f8fafc; border-radius: 8px; }
        .detail-user-name { font-weight: 700; color: #374151; }
        .detail-user-name.payer { background: rgba(44, 62, 80, 0.1); color: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: 800; border-left: 3px solid var(--primary); padding-left: 8px; }
        .detail-user-name.debtor { background: rgba(231, 111, 81, 0.08); color: var(--accent); padding: 2px 6px; border-radius: 4px; font-weight: 800; border-left: 3px solid var(--accent); padding-left: 8px; }
        .detail-amount { font-weight: 700; color: var(--accent); }
        .btn-edit-inline { width: 100%; margin-top: 10px; padding: 10px; background: white; color: var(--primary); border: 1.5px solid var(--primary); border-radius: 10px; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.15s; }
        .btn-edit-inline:active { transform: scale(0.98); background: #f1f5f9; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .pay-method-badge { font-size: 0.6rem; background: #eee; color: #666; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
        .advance-badge { font-size: 0.6rem; border: 1px solid var(--accent); color: var(--accent); padding: 1px 4px; border-radius: 4px; margin-left: 4px; }
        .repaid-badge { font-size: 0.6rem; background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: 700; }

        /* Wishlist */
        .wish-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .wish-card { background: white; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; cursor: pointer; }
        .wish-img { width: 100%; aspect-ratio: 1; object-fit: cover; background: #eee; display: block; }
        .wish-content { padding: 0.8rem; }
        .wish-check { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 5; }
        .wish-check.checked { background: var(--accent); color: white; }

        /* Colors */
        .bg-sight { background: #3b82f6; } .bg-food { background: #f97316; } .bg-shop { background: #ec4899; } .bg-trans { background: #64748b; } .bg-other { background: #10b981; }

        /* FAB & Modal */
        .fab { position: fixed; bottom: calc(2rem + var(--safe-bottom)); right: 1.5rem; width: 3.5rem; height: 3.5rem; background: var(--primary); border-radius: 50%; color: white; box-shadow: 0 8px 20px rgba(44,62,80,0.4); display: flex; align-items: center; justify-content: center; z-index: 100; transition: transform 0.2s; cursor: pointer; }
        .fab:active { transform: scale(0.9); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; display: flex; align-items: flex-end; }
        .overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: #FDFBF7; width: 100%; border-radius: 1.5rem 1.5rem 0 0; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 90dvh; overflow-y: auto; padding-bottom: calc(2rem + var(--safe-bottom)); }
        .overlay.open .modal { transform: translateY(0); }
        .form-row { margin-bottom: 1rem; }
        label { display: block; font-size: 0.75rem; color: #888; font-weight: 700; margin-bottom: 6px; }
        input, select, textarea { width: 100%; padding: 0.9rem; background: white; border: 1px solid #eee; border-radius: 0.8rem; font-size: 1rem; color: var(--primary); outline: none; appearance: none; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
        input:focus, select:focus { border-color: var(--primary); }
        .cats { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; }
        .cat-chip { padding: 8px 16px; background: white; border-radius: 20px; font-size: 0.8rem; color: #aaa; font-weight: 700; white-space: nowrap; border: 1px solid #eee; cursor: pointer; }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .split-person-btn { padding: 6px 10px; border-radius: 999px; border: 1px solid #e5e7eb; background: #f9fafb; font-size: 0.8rem; font-weight: 700; color: #374151; cursor: pointer; transition: 0.15s; }
        .split-person-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-save { width: 100%; padding: 1rem; background: var(--primary); color: white; border-radius: 1rem; font-size: 1rem; font-weight: 700; margin-top: 1.5rem; box-shadow: 0 4px 12px rgba(44,62,80,0.2); }
        .btn-del { width: 100%; padding: 1rem; color: #ef4444; font-weight: 700; background: transparent; margin-top: 0.5rem; }

        /* Expense Category Card */
        .exp-category-card { background: rgba(255,255,255,0.9); border-radius: 1.2rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .exp-category-card-title { font-size: 0.8rem; font-weight: 700; color: #666; margin-bottom: 0.8rem; padding-left: 4px; }
        .exp-category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; }
        .exp-category-item { padding: 1rem 0.8rem; border-radius: 1.2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.4rem; text-align: center; color: #fff; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 100px; }
        .exp-category-item span:first-child { font-size: 0.75rem; opacity: 0.9; letter-spacing: 0.5px; }
        .exp-category-item span:nth-child(2) { font-size: 1.3rem; font-weight: 900; line-height: 1; margin: 0.2rem 0; }
        .exp-category-item span:nth-child(3) { font-size: 0.7rem; opacity: 0.85; margin-top: 0.2rem; }

        /* Welcome Card */
        .welcome-card-wrapper { position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.18); backdrop-filter: blur(10px); }
        .welcome-card-inner { background: rgba(255,255,255,0.96); border-radius: 1.4rem; box-shadow: 0 12px 35px rgba(15,23,42,0.25); padding: 1.2rem 1.3rem 1.1rem; width: 88%; max-width: 320px; text-align: center; }
        .welcome-user-list { display: flex; flex-direction: column; gap: 8px; max-height: 220px; overflow-y: auto; margin-top: 0.4rem; padding-right: 2px; }
        .welcome-user-btn { align-self: center; min-width: 120px; max-width: 180px; padding: 6px 10px; border-radius: 999px; border: 1px solid #e5e7eb; background: #f9fafb; font-size: 0.8rem; font-weight: 700; color: #374151; cursor: pointer; transition: 0.15s; }
        .welcome-user-btn:active { transform: scale(0.95); }
        .welcome-user-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* Debt Modal */
        #debt-modal-overlay { display: flex; align-items: flex-end; }
        #debt-detail-list { margin-bottom: 1.5rem; }
        #debt-modal-footer { text-align: right; font-weight: 900; font-size: 1.2rem; color: var(--primary); border-top: 1px solid #eee; padding-top: 1rem; }
    </style>
</head>
<body>
    <!-- Welcome Card -->
    <div id="welcome-card" class="welcome-card-wrapper">
        <div class="welcome-card-inner">
            <div style="font-size:1.8rem;margin-bottom:0.4rem">✈️</div>
            <div style="font-family:'Noto Serif TC',serif;font-weight:800;font-size:1.1rem;margin-bottom:0.2rem">歡迎加入沖繩行</div>
            <div style="font-size:0.8rem;color:#6b7280;margin-bottom:0.4rem">請選擇你的名字，之後記帳會自動帶入</div>
            <div id="welcome-user-list" class="welcome-user-list"></div>
        </div>
    </div>

    <header>
        <h1>沖繩行</h1>
        <div class="subtitle"><span class="badge">5 Days</span></div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab(this, 'itinerary')">
            <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/></svg>
            行程
        </div>
        <div class="tab" onclick="switchTab(this, 'expense')">
            <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
            記帳
        </div>
        <div class="tab" onclick="switchTab(this, 'wishlist')">
            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            願望清單
        </div>
    </div>

    <!-- ITINERARY VIEW -->
    <main id="view-itinerary">
        <div class="day-scroll" id="day-list"></div>
        <div class="weather" id="weather-card">
            <div class="w-txt">
                <h3>沖繩．即時天氣</h3>
                <p id="weather-desc">載入中...</p>
                <p id="clothing-advice" style="font-size:0.7rem; color:var(--accent); margin-top:4px; font-weight:700"></p>
            </div>
            <div class="w-val" id="weather-temp">--°C</div>
        </div>
        <div class="list-head">
            <h2>行程表</h2>
            <span class="hint">點擊編輯 / 右側導航</span>
        </div>
        <div id="plan-list"></div>
    </main>

    <!-- EXPENSE VIEW -->
    <main id="view-expense" style="display:none">
        <!-- EXPENSE SUMMARY CARD -->
        <div class="exp-summary-card">
            <div class="stat-tabs">
                <div class="stat-tab active" onclick="toggleStat('personal')">個人消費</div>
                <div class="stat-tab" onclick="toggleStat('advance')">待收付款項</div>
            </div>
            <div id="summary-content">
                <div style="font-size:2.5rem;font-weight:900">NT$ <span id="total-exp">0</span></div>
                <div id="stat-label">個人總花費</div>
            </div>
        </div>

        <!-- QUICK EXPENSE FORM -->
        <div class="quick-expense-card" id="quick-expense-card">
            <div style="font-size:0.8rem;font-weight:700;margin-bottom:1rem;">
                <span id="quick-form-title">快速記帳</span>
            </div>
            <div class="quick-expense-row">
                <div>
                    <label>日期</label>
                    <select id="quick-date">
                        <option value="0">01/06 (第1天)</option>
                        <option value="1">01/07 (第2天)</option>
                        <option value="2">01/08 (第3天)</option>
                        <option value="3">01/09 (第4天)</option>
                        <option value="4">01/10 (第5天)</option>
                    </select>
                </div>
                <div>
                    <label>種類</label>
                    <select id="quick-cat">
                        <option value="food">美食</option>
                        <option value="sight">景點</option>
                        <option value="shop">購物</option>
                        <option value="trans">交通</option>
                        <option value="other">其他</option>
                    </select>
                </div>
            </div>
            <div class="quick-expense-row">
                <div>
                    <label>名稱</label>
                    <input type="text" id="quick-title" placeholder="例：午餐">
                </div>
                <div>
                    <label>金額</label>
                    <input type="number" id="quick-amt" min="1" placeholder="NT$">
                </div>
            </div>
            <div class="quick-expense-row">
                <div>
                    <label>付款方式</label>
                    <select id="quick-pay">
                        <option value="cash">現金</option>
                        <option value="card">信用卡</option>
                    </select>
                </div>
                <div>
                    <label>代付方式</label>
                    <select id="quick-split-mode" onchange="toggleQuickSplitMode(this.value)">
                        <option value="none">只有自己</option>
                        <option value="equal">平均分帳</option>
                        <option value="custom">自訂分帳</option>
                    </select>
                </div>
            </div>
            <div id="quick-split-options" style="display:none;margin-top:1rem;padding:1rem;background:#f9fafb;border-radius:0.8rem;border:1px solid #e5e7eb;">
                <div id="quick-equal-mode" style="display:none;">
                    <div style="font-size:0.7rem;color:#888;font-weight:700;margin-bottom:0.8rem;">選擇分帳人員</div>
                    <div id="quick-split-persons" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                </div>
                <div id="quick-custom-mode" style="display:none;">
                    <div style="font-size:0.7rem;color:#888;font-weight:700;margin-bottom:0.8rem;">自訂每人金額</div>
                    <div id="quick-custom-amounts"></div>
                </div>
                <div id="quick-split-preview" style="margin-top:0.8rem;padding:0.8rem;background:white;border-radius:0.6rem;border-left:3px solid var(--accent);font-size:0.75rem;color:#666;"></div>
            </div>
            <div class="quick-expense-footer">
                <div style="font-size:0.7rem;color:#9ca3af;" id="quick-hint"></div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <div class="edit-actions" id="edit-actions">
                        <button type="button" class="btn-delete-inline" onclick="deleteEditingItem()">刪除</button>
                        <button type="button" class="btn-cancel" onclick="cancelEdit()">取消</button>
                    </div>
                    <button type="button" class="btn-submit" id="btn-quick-submit" onclick="addQuickExpense()">新增</button>
                </div>
            </div>
        </div>

        <!-- CATEGORY SUMMARY -->
        <div class="exp-category-card" id="exp-category-card">
            <div class="exp-category-card-title"></div>
            <div class="exp-category-grid" id="exp-category-grid"></div>
        </div>

        <div class="list-head">
            <h2>支出明細</h2>
            <span class="hint">點擊查看 / 展開編輯</span>
        </div>
        <div id="expense-list"></div>
    </main>

    <!-- WISHLIST VIEW -->
    <main id="view-wishlist" style="display:none">
        <div class="list-head">
            <h2>願望清單</h2>
            <span class="hint">點擊打勾 / 新增照片</span>
        </div>
        <div class="wish-grid" id="wish-list"></div>
    </main>

    <!-- FAB & MODAL -->
    <div class="fab" id="btn-add" onclick="openModal()">
        <svg class="icon" style="width:2em;height:2em" viewBox="0 0 24 24"><path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
    </div>

    <div class="overlay" id="modal-overlay">
        <div class="modal">
            <h2 id="modal-title">新增項目</h2>
            <form id="add-form" autocomplete="off">
                <div class="form-row" id="field-time">
                    <label>時間</label>
                    <input type="time" id="add-time" required>
                </div>
                <div class="form-row">
                    <label>名稱 / 標題</label>
                    <input type="text" id="add-title" maxlength="32" required placeholder="例如：國際通逛街">
                </div>
                <div class="form-row" id="field-loc">
                    <label>地點</label>
                    <input type="text" id="add-loc" maxlength="64" placeholder="例如：單軌縣廳前站">
                    <div class="form-row">
    <label for="add-notes">備註</label>
    <input type="text" id="add-notes" maxlength="128" placeholder="例如：逛街購物、必吃美食">
</div>
                      
                </div>
                <div class="form-row">
                    <label>種類標籤</label>
                    <div class="cats" id="cat-list"></div>
                </div>
                <div id="wish-fields" style="display:none">
                    <div class="form-row">
                        <label>圖片 URL (選填)</label>
                        <input type="text" id="wish-img-url" placeholder="https://...">
                    </div>
                </div>
                <button type="submit" class="btn-save">儲存</button>
                <button type="button" class="btn-del" onclick="deleteItem()">刪除紀錄</button>
            </form>
        </div>
    </div>

    <!-- 欠款明細 Modal -->
    <div class="overlay" id="debt-modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2 id="debt-modal-title" style="margin:0;">欠款明細</h2>
                <button type="button" onclick="closeDebtModal()" style="background:none; border:none; font-size:1.5rem; color:#888;">&times;</button>
            </div>
            <div id="debt-detail-list"></div>
            <div id="debt-modal-footer">總計：<span>NT$0</span></div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const DAYS = [
            { num: 1, label: '01/06', week: '週二' },
            { num: 2, label: '01/07', week: '週三' },
            { num: 3, label: '01/08', week: '週四' },
            { num: 4, label: '01/09', week: '週五' },
            { num: 5, label: '01/10', week: '週六' }
        ];

        // ✅ 清空所有預設資料
        const PLAN = [
				[{ time: '04:10', cat: 'trans', title: '登機準備', loc: '桃園機場第一航廈', id: 101 },
                { time: '08:55', cat: 'trans', title: '抵達沖繩/拿行李', loc: '那霸機場', id: 103 },
                { time: '09:30', cat: 'food', title: '買麵包', loc: 'PANCHORI-NA 麵包店', id: 104 },
                { time: '11:15', cat: 'food', title: '吃海膽飯', loc: 'Shirasa 食堂', id: 105 },
                { time: '12:15', cat: 'sight', title: '古宇利島', loc: '古宇利島', id: 106 },
                { time: '14:30', cat: 'food', title: '咖啡廳休息', loc: 'Shinmei Coffee', id: 107 },
                { time: '15:00', cat: 'sight', title: '美麗海水族館', loc: '海洋博公園', id: 108 },
                { time: '17:30', cat: 'trans', title: '回程民宿', loc: '包車返回約2小時', id: 109 },
                { time: '20:00', cat: 'other', title: '民宿整備休息', loc: '民宿', id: 110 },
                { time: '21:00', cat: 'food', title: '晚餐：琉球之牛', loc: '那霸國際通 (3F)', id: 111 },
                { time: '23:00', cat: 'shop', title: '晚餐後逛街回家', loc: '國際通', id: 112 }], [], [], [], []
        ];

        const EXPENSE = [
            [], [], [], [], []
        ];

        const WISHLIST = [];

        const CATEGORIES = [
            { key:'sight', label:'景點', color:'bg-sight' },
            { key:'food', label:'美食', color:'bg-food' },
            { key:'shop', label:'購物', color:'bg-shop' },
            { key:'trans', label:'交通', color:'bg-trans' },
            { key:'other', label:'其他', color:'bg-other' }
        ];

        const MEMBERS = ['許波', '方吉', '千又', '侑焄', '家銘'];

        // --- STATE ---
        let currentUser = null;
        let curTab = 'itinerary';
        let curDay = 0;
        let editingItem = null;
        let editingType = null;
        let statMode = 'personal';
        let editingId = null;

        // --- INIT ---
        function init() {
            currentUser = null;
            showWelcomeCard();
            renderDays();
            renderPlan();
            renderWishlist();
            fetchWeather();
            renderCategories();
        }

        function showWelcomeCard() {
            const wrapper = document.getElementById('welcome-card');
            const list = document.getElementById('welcome-user-list');
            if(!wrapper || !list) return;

            list.innerHTML = '';
            MEMBERS.forEach(name => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'welcome-user-btn';
                btn.textContent = name;
                btn.onclick = (e) => { e.preventDefault(); selectUsername(name); };
                list.appendChild(btn);
            });
            wrapper.style.display = 'flex';
        }

        function selectUsername(name) {
            currentUser = name;
            updateSubtitleWithUser();
            renderExpense();
            renderExpenseCategories();
            
            const wrapper = document.getElementById('welcome-card');
            if(wrapper) wrapper.style.display = 'none';
        }

        function updateSubtitleWithUser() {
            const subtitle = document.querySelector('.subtitle');
            if(!subtitle || !currentUser) return;
            subtitle.innerHTML = `<span class="badge">${currentUser}</span> 5 Days `;
        }

        // --- WEATHER ---
        function fetchWeather() {
            updateWeatherUI(26, "晴時多雲");
        }

        function updateWeatherUI(temp, desc) {
            document.getElementById('weather-temp').textContent = temp + "°C";
            document.getElementById('weather-desc').textContent = desc;
            
            let advice = "";
            if(temp > 28) advice = "天氣炎熱，請穿著短袖並注意防曬！";
            else if(temp > 20) advice = "氣溫舒適，建議穿著薄長袖或短袖搭配薄外套。";
            else advice = "天氣較涼，請攜帶外套保暖。";
            
            document.getElementById('clothing-advice').textContent = advice;
        }

        // --- TABS ---
        function switchTab(tabBtn, name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tabBtn.classList.add('active');

            document.getElementById('view-itinerary').style.display = 'none';
            document.getElementById('view-expense').style.display = 'none';
            document.getElementById('view-wishlist').style.display = 'none';
            
            document.getElementById('view-' + name).style.display = 'block';
            curTab = name;
            
            const fab = document.getElementById('btn-add');
            fab.style.display = (name === 'expense') ? 'none' : 'flex';
            
            if(name === 'expense') {
                renderExpense();
                renderExpenseCategories();
            } else if(name === 'wishlist') {
                renderWishlist();
            }
        }

        // --- ITINERARY ---
        function renderDays() {
            const dayList = document.getElementById('day-list');
            dayList.innerHTML = '';
            DAYS.forEach((day, idx) => {
                const div = document.createElement('div');
                div.className = `day-card ${curDay===idx?'active':''}`;
                div.onclick = () => {
                    curDay = idx;
                    renderDays();
                    renderPlan();
                    if(curTab === 'expense') renderExpense();
                };
                div.innerHTML = `
                    <div class="day-top"><span>Day ${day.num}</span><span class="day-dot"></span></div>
                    <div class="day-num">${day.label}<span>${day.week}</span></div>
                `;
                dayList.appendChild(div);
            });
        }

        function renderPlan() {
    const list = document.getElementById('plan-list');
    list.innerHTML = '';

    const plans = PLAN[curDay] || [];
    if(plans.length===0) {
        list.innerHTML = '<div style="color:#888;text-align:center;margin:2rem 0">尚無行程</div>';
        return;
    }

    plans.forEach((item, idx) => {
        const cat = CATEGORIES.find(c=>c.key===item.cat) || CATEGORIES[4];
        // Google Maps 導航連結
        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.loc + ' ' + item.title)}`;
        
        const div = document.createElement('div');
        div.className = 'plan-card';
        div.onclick = (e) => {
            if(e.target.closest('.nav-btn')) return;
            openModal('plan', item, idx);
        };
        div.innerHTML = `
            <div class="plan-left">
                <div class="plan-time">${item.time}</div>
                <div class="plan-tag ${cat.color}">${cat.label}</div>
                <div class="plan-title">${item.title}</div>
                <div class="plan-loc">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    ${item.loc}
                </div>
            </div>
            <div class="plan-actions">
                <a href="${mapUrl}" target="_blank" rel="noopener noreferrer" style="text-decoration:none">
                    <button type="button" class="nav-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M1 11.6l19.6-9.3a1.3 1.3 0 0 1 1.7 1.7l-9.3 19.6c-.6 1.3-2.5 1.3-3.1 0l-2.7-6.2-6.2-2.7c-1.3-.6-1.3-2.5 0-3.1z"/>
                        </svg>
                        導航
                    </button>
                </a>
            </div>
        `;
        list.appendChild(div);
    });
}

        // --- EXPENSE ---
        function renderExpense() {
            if(!currentUser) return;

            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '';
            
            const list = EXPENSE[curDay] || [];
            
            if(list.length === 0) {
                expenseList.innerHTML = '<div style="color:#888;text-align:center;margin:2rem 0">尚無消費紀錄</div>';
                updateExpenseStats();
                return;
            }

            list.forEach(item => {
                const cat = CATEGORIES.find(c => c.key === item.cat) || CATEGORIES[4];
                
                const div = document.createElement('div');
                div.className = 'expense-row';
                div.onclick = (e) => {
                    if (e.target.closest('button')) return;
                    div.classList.toggle('expanded');
                };

                let advanceText = '';
                if (item.advanceFor && item.advanceFor.length > 0 && item.amt > 0) {
                    const othersCount = item.advanceFor.filter(name => name !== currentUser).length;
                    if (othersCount > 0) {
                        advanceText = `<span class="advance-badge">代墊${othersCount}</span>`;
                    }
                }

                let detailHtml = '';
                
                if (!item.advanceFor || item.advanceFor.length === 0) {
                    detailHtml = `<div style="font-size:0.75rem;font-weight:700;color:#888;margin-bottom:8px">個人消費</div>`;
                } else {
                    if(item.splitDetails && item.splitDetails.amounts) {
                        Object.entries(item.splitDetails.amounts).forEach(([name, amt]) => {
                            if(amt > 0) {
                                let userClass = item.payBy === name ? 'payer' : 'debtor';
                                let userLabel = item.payBy === name ? ' (本人)' : '';
                                
                                detailHtml += `
                                    <div class="detail-list-item">
                                        <span class="detail-user-name ${userClass}">${name}${userLabel}</span>
                                        <span class="detail-amount">NT${amt}</span>
                                    </div>
                                `;
                            }
                        });
                    } else {
                        const othersInThisSplit = item.advanceFor.filter(name => name !== currentUser);
                        const perPerson = othersInThisSplit.length > 0 
                            ? Math.floor(item.amt / (othersInThisSplit.length + 1))
                            : item.amt;
                        
                        if (item.payBy === currentUser) {
                            detailHtml += `
                                <div class="detail-list-item">
                                    <span class="detail-user-name payer">${currentUser} (本人)</span>
                                    <span class="detail-amount">NT${perPerson}</span>
                                </div>
                            `;
                        }
                        
                        othersInThisSplit.forEach((name) => {
                            detailHtml += `
                                <div class="detail-list-item">
                                    <span class="detail-user-name debtor">${name}</span>
                                    <span class="detail-amount">NT${perPerson}</span>
                                </div>
                            `;
                        });
                    }
                }

                div.innerHTML = `
                    <div class="expense-header">
                        <div>
                            <div style="font-weight:700; color:var(--primary)">${item.title}</div>
                            <div style="font-size:0.75rem; color:#888; margin-top:4px">
                                ${cat.label} 
                                <span class="pay-method-badge">${item.payMethod === 'cash' ? '現金' : '刷卡'}</span>
                                ${advanceText}
                            </div>
                        </div>
                        <div style="font-weight:700; font-size:1.1rem; color:var(--accent)">
                            NT$${item.amt}
                        </div>
                    </div>
                    <div class="expense-detail-panel">
                        ${detailHtml}
                        <button type="button" class="btn-edit-inline" onclick="editExpenseInQuickForm(EXPENSE[curDay].find(e=>e.id=='${item.id}'))">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            編輯 / 刪除
                        </button>
                    </div>
                `;
                expenseList.appendChild(div);
            });

            updateExpenseStats();
        }

        function updateExpenseStats() {
            if (!currentUser) return;
            
            const summaryContainer = document.getElementById('summary-content');
            if (!summaryContainer) return;

            let totalPersonal = 0;
            let totalReceivable = 0;
            let totalPayable = 0;

            EXPENSE.forEach(dayList => {
                dayList.forEach(item => {
                    if (item.payBy === currentUser) {
                        if (!item.advanceFor || item.advanceFor.length === 0) {
                            totalPersonal += item.amt;
                        }
                    }

                    if (item.payBy === currentUser && item.advanceFor && item.advanceFor.length > 0) {
                        if (item.splitDetails && item.splitDetails.amounts) {
                            Object.entries(item.splitDetails.amounts).forEach(([name, amt]) => {
                                if (name !== currentUser && amt > 0 && (!item.settled || !item.settled[name])) {
                                    totalReceivable += amt;
                                }
                            });
                        } else {
                            const perPerson = Math.floor(item.amt / item.advanceFor.length);
                            item.advanceFor.forEach(name => {
                                if (name !== currentUser && (!item.settled || !item.settled[name])) {
                                    totalReceivable += perPerson;
                                }
                            });
                        }
                    }

                    if (item.payBy !== currentUser && item.advanceFor && item.advanceFor.includes(currentUser)) {
                        let myAmt = 0;
                        if (item.splitDetails && item.splitDetails.amounts) {
                            myAmt = item.splitDetails.amounts[currentUser] || 0;
                        } else {
                            myAmt = Math.floor(item.amt / item.advanceFor.length);
                        }

                        if (myAmt > 0 && (!item.settled || !item.settled[currentUser])) {
                            totalPayable += myAmt;
                        }
                    }
                });
            });

            if (statMode === 'advance') {
                summaryContainer.innerHTML = `
                    <div style="display: flex; justify-content: space-around; align-items: center; padding-top: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 4px; font-weight:700;">應收</div>
                            <div style="font-size: 1.6rem; font-weight: 900; color: #10b981;">
                                <span style="font-size:0.9rem; margin-right:2px;">NT$</span>${totalReceivable}
                            </div>
                        </div>
                        <div style="width: 1px; height: 40px; background: rgba(255,255,255,0.2);"></div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 4px; font-weight:700;">應付</div>
                            <div style="font-size: 1.6rem; font-weight: 900; color: #E76F51;">
                                <span style="font-size:0.9rem; margin-right:2px;">NT$</span>${totalPayable}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                summaryContainer.innerHTML = `
                    <div style="font-size:2.5rem;font-weight:900">NT$ <span id="total-exp">${totalPersonal}</span></div>
                    <div id="stat-label">個人總花費</div>
                `;
            }
        }

        function toggleStat(mode) {
            statMode = mode;
            
            document.querySelectorAll('.stat-tab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            updateExpenseStats();
            renderExpenseCategories();
        }

        function renderQuickSplitPersons() {
            const container = document.getElementById('quick-split-persons');
            container.innerHTML = '';

            if (!currentUser || !MEMBERS.includes(currentUser)) return;

            const others = MEMBERS.filter(name => name !== currentUser);

            others.forEach(name => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'split-person-btn';
                btn.textContent = name;
                btn.dataset.name = name;
                btn.onclick = function (e) {
                    e.preventDefault();
                    this.classList.toggle('selected');
                    updateQuickSplitPreview();
                };
                container.appendChild(btn);
            });
        }

        function renderQuickCustomAmounts() {
            const container = document.getElementById('quick-custom-amounts');
            container.innerHTML = '';

            if (!currentUser || !MEMBERS.includes(currentUser)) return;

            const others = MEMBERS.filter(name => name !== currentUser);

            others.forEach(name => {
                const row = document.createElement('div');
                row.style.cssText = 'display:grid;grid-template-columns:0.6fr 1.4fr;gap:0.6rem;align-items:center;margin-bottom:0.6rem;';
                row.innerHTML = `
                    <label style="font-size:0.75rem;font-weight:700;color:#374151;white-space:nowrap;">${name}</label>
                    <input type="number" class="quick-custom-amt" data-name="${name}" min="0" placeholder="NT$" style="padding:0.5rem 0.6rem;font-size:0.8rem;border:1px solid #e5e7eb;border-radius:0.6rem;" oninput="updateQuickSplitPreview()">
                `;
                container.appendChild(row);
            });
        }

        function toggleQuickSplitMode(mode) {
            const container = document.getElementById('quick-split-options');
            const equalDiv = document.getElementById('quick-equal-mode');
            const customDiv = document.getElementById('quick-custom-mode');

            container.style.display = mode === 'none' ? 'none' : 'block';
            equalDiv.style.display = mode === 'equal' ? 'block' : 'none';
            customDiv.style.display = mode === 'custom' ? 'block' : 'none';

            if (mode === 'equal') {
                renderQuickSplitPersons();
            } else if (mode === 'custom') {
                renderQuickCustomAmounts();
            }
            updateQuickSplitPreview();
        }

        function updateQuickSplitPreview() {
            const previewDiv = document.getElementById('quick-split-preview');
            const modeSelect = document.getElementById('quick-split-mode');
            const mode = modeSelect.value;
            const amtInput = document.getElementById('quick-amt');
            const totalAmt = parseInt(amtInput.value || 0);

            if (totalAmt <= 0) {
                previewDiv.textContent = '';
                return;
            }

            if (mode === 'equal') {
                const selected = Array.from(document.querySelectorAll('#quick-split-persons .split-person-btn.selected'));
                if (selected.length === 0) {
                    previewDiv.textContent = '⚠ 請選擇分帳對象';
                    return;
                }
                const totalPeople = selected.length + 1;
                const perPerson = Math.floor(totalAmt / totalPeople);
                previewDiv.innerHTML = `共 NT$${totalAmt}÷ ${totalPeople} 人= 每人 NT$${perPerson}`;
            } else if (mode === 'custom') {
                const inputs = document.querySelectorAll('.quick-custom-amt');
                let totalCustom = 0;
                inputs.forEach(input => {
                    totalCustom += parseInt(input.value || 0);
                });
                const myShare = totalAmt - totalCustom;
                if (myShare < 0) {
                    previewDiv.style.borderLeftColor = '#ef4444';
                    previewDiv.textContent = '❌ 分帳金額超過總金額';
                } else {
                    previewDiv.style.borderLeftColor = 'var(--accent)';
                    previewDiv.innerHTML = `他人：NT$${totalCustom}<br>我的：NT$${myShare}`;
                }
            }
        }

        function addQuickExpense() {
            if (!currentUser) {
                alert('請先選擇使用者');
                return;
            }

            const dateSelect = document.getElementById('quick-date');
            curDay = parseInt(dateSelect.value);

            const title = document.getElementById('quick-title').value.trim();
            const amt = parseInt(document.getElementById('quick-amt').value || 0);
            const cat = document.getElementById('quick-cat').value;
            const payMethod = document.getElementById('quick-pay').value;
            const splitModeQuick = document.getElementById('quick-split-mode').value;

            if (!title || amt <= 0) {
                alert('請填寫名稱和金額');
                return;
            }

            let advanceFor = [];
            let splitDetails = null;

            if (splitModeQuick === 'equal') {
                const selected = Array.from(document.querySelectorAll('#quick-split-persons .split-person-btn.selected'));
                const selectedNames = selected.map(btn => btn.dataset.name);
                if (selectedNames.length > 0) {
                    advanceFor = [currentUser, ...selectedNames];
                }
            } else if (splitModeQuick === 'custom') {
                const inputs = document.querySelectorAll('.quick-custom-amt');
                let customMap = {};
                inputs.forEach(input => {
                    const val = parseInt(input.value || 0);
                    if (val > 0) {
                        customMap[input.dataset.name] = val;
                    }
                });
                const myShare = amt - Object.values(customMap).reduce((a, b) => a + b, 0);
                if (myShare > 0) {
                    customMap[currentUser] = myShare;
                    advanceFor = Object.keys(customMap);
                    splitDetails = { mode: 'custom', amounts: customMap };
                }
            }

            if (editingId) {
                const idx = EXPENSE[curDay].findIndex(e => e.id === editingId);
                if (idx >= 0) {
                    EXPENSE[curDay][idx] = { 
                        cat, title, amt, payMethod, 
                        payBy: currentUser, 
                        advanceFor, 
                        splitDetails, 
                        id: editingId 
                    };
                }
                cancelEdit();
            } else {
                const newExpense = {
                    cat, title, amt, payMethod,
                    payBy: currentUser,
                    advanceFor,
                    splitDetails,
                    id: '' + Date.now()
                };
                EXPENSE[curDay].push(newExpense);
            }

            document.getElementById('quick-title').value = '';
            document.getElementById('quick-amt').value = '';
            document.getElementById('quick-date').value = '0';
            document.getElementById('quick-cat').value = 'food';
            document.getElementById('quick-pay').value = 'cash';
            document.getElementById('quick-split-mode').value = 'none';
            toggleQuickSplitMode('none');

            renderExpense();
            updateExpenseStats();
            renderExpenseCategories();
        }

        function editExpenseInQuickForm(item) {
            editingId = item.id;
            document.getElementById('quick-title').value = item.title;
            document.getElementById('quick-amt').value = item.amt;
            document.getElementById('quick-cat').value = item.cat;
            document.getElementById('quick-pay').value = item.payMethod;
            
            const card = document.getElementById('quick-expense-card');
            card.classList.add('editing');
            document.getElementById('quick-form-title').textContent = '編輯消費';
            document.getElementById('btn-quick-submit').textContent = '更新';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            editingId = null;
            document.getElementById('quick-title').value = '';
            document.getElementById('quick-amt').value = '';
            document.getElementById('quick-expense-card').classList.remove('editing');
            document.getElementById('quick-form-title').textContent = '快速記帳';
            document.getElementById('btn-quick-submit').textContent = '新增';
        }

        function deleteEditingItem() {
            if(!editingId) return;
            if(!confirm('確定要刪除這筆消費嗎？')) return;
            
            const idx = EXPENSE[curDay].findIndex(e => e.id === editingId);
            if(idx >= 0) {
                EXPENSE[curDay].splice(idx, 1);
            }
            cancelEdit();
            renderExpense();
        }

        function renderExpenseCategories() {
            const grid = document.getElementById('exp-category-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            const cardTitle = document.querySelector('.exp-category-card-title');
            if (cardTitle) {
                cardTitle.textContent = (statMode === 'advance')
                    ? '分帳對象統計'
                    : '消費分類';
            }
            
            if (!currentUser) return;
            
            if (statMode === 'advance') {
                const debtorStats = {};
                
                EXPENSE.forEach(dayList => {
                    dayList.forEach(item => {
                        if (!item || item.amt === 0) return;
                        
                        if (item.payBy === currentUser && item.advanceFor && item.advanceFor.length > 0) {
                            if (item.splitDetails && item.splitDetails.amounts) {
                                Object.entries(item.splitDetails.amounts).forEach(([name, amt]) => {
                                    if (name === currentUser) return;
                                    if (amt <= 0) return;
                                    if (item.settled && item.settled[name]) return;
                                    
                                    if (!debtorStats[name]) {
                                        debtorStats[name] = { label: name, amount: 0, count: 0 };
                                    }
                                    debtorStats[name].amount += amt;
                                    debtorStats[name].count += 1;
                                });
                            } else {
                                const othersInThisSplit = item.advanceFor.filter(name => name !== currentUser);
                                const perPerson = othersInThisSplit.length > 0 
                                    ? Math.floor(item.amt / (othersInThisSplit.length + 1)) 
                                    : item.amt;
                                
                                othersInThisSplit.forEach(name => {
                                    if (perPerson <= 0) return;
                                    if (item.settled && item.settled[name]) return;
                                    
                                    if (!debtorStats[name]) {
                                        debtorStats[name] = { label: name, amount: 0, count: 0 };
                                    }
                                    debtorStats[name].amount += perPerson;
                                    debtorStats[name].count += 1;
                                });
                            }
                        }
                    });
                });
                
                renderDebtorGrid('exp-category-grid', debtorStats);
                return;
            }
            
            let stats = {};
            
            CATEGORIES.forEach(c => {
                stats[c.key] = { amount: 0, count: 0, color: c.color, label: c.label };
            });
            
            EXPENSE.forEach(dayList => {
                dayList.forEach(item => {
                    if (!item || item.amt === 0) return;
                    
                    let myShare = 0;
                    
                    if (item.payBy === currentUser) {
                        if (!item.advanceFor || item.advanceFor.length === 0) {
                            myShare = item.amt;
                        } else if (item.splitDetails && item.splitDetails.amounts) {
                            myShare = item.splitDetails.amounts[currentUser] || 0;
                        } else {
                            myShare = Math.floor(item.amt / item.advanceFor.length);
                        }
                    } else if (item.advanceFor && item.advanceFor.includes(currentUser)) {
                        if (item.splitDetails && item.splitDetails.amounts) {
                            myShare = item.splitDetails.amounts[currentUser] || 0;
                        } else {
                            myShare = Math.floor(item.amt / item.advanceFor.length);
                        }
                    }
                    
                    if (myShare > 0) {
                        const catKey = item.cat || 'other';
                        if (!stats[catKey]) {
                            stats[catKey] = { amount: 0, count: 0, color: 'bg-other', label: catKey };
                        }
                        stats[catKey].amount += myShare;
                        stats[catKey].count += 1;
                    }
                });
            });
            
            CATEGORIES.forEach(cat => {
                const s = stats[cat.key];
                if (!s || s.amount === 0) return;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `exp-category-item ${cat.color}`;
                itemDiv.innerHTML = `
                    <span>${cat.label}</span>
                    <span>NT$${s.amount}</span>
                    <span>${s.count}筆</span>
                `;
                grid.appendChild(itemDiv);
            });
            
            if (grid.innerHTML === '') {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:10px;">沒有支出</div>';
            }
        }

        function renderDebtorGrid(gridId, stats) {
            const grid = document.getElementById(gridId);
            if (!grid) return;

            grid.innerHTML = '';

            const list = Object.values(stats).filter(s => s.amount > 0);

            list.forEach((s) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'exp-category-item bg-other';
                itemDiv.style.cursor = 'pointer';
                itemDiv.onclick = () => openDebtModal(s.label);

                itemDiv.innerHTML = `
                    <span>${s.label}</span>
                    <span>NT$${s.amount}</span>
                    <span>${s.count}筆</span>
                `;
                grid.appendChild(itemDiv);
            });

            if (grid.innerHTML === '') {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:10px;">目前尚無消費紀錄 🎉</div>';
            }
        }

        function openDebtModal(debtorName) {
            const overlay = document.getElementById('debt-modal-overlay');
            const titleEl = document.getElementById('debt-modal-title');
            const listEl = document.getElementById('debt-detail-list');
            const footerEl = document.getElementById('debt-modal-footer');

            if (!overlay || !titleEl || !listEl || !footerEl) {
                console.error("找不到 Modal 元素");
                return;
            }

            overlay.classList.add('open');
            titleEl.textContent = `${debtorName} 的欠款明細`;
            listEl.innerHTML = '';

            let total = 0;
            let unpaidTotal = 0;

            EXPENSE.forEach((dayList, dayIdx) => {
                dayList.forEach((item) => {
                    if (!item || item.amt <= 0) return;
                    if (item.payBy !== currentUser) return;
                    if (!item.advanceFor || item.advanceFor.length === 0) return;

                    let debtAmt = 0;

                    if (item.splitDetails && item.splitDetails.amounts) {
                        debtAmt = item.splitDetails.amounts[debtorName] || 0;
                    } else if (item.advanceFor.includes(debtorName)) {
                        debtAmt = Math.floor(item.amt / item.advanceFor.length);
                    }

                    const isSettled = item.settled && item.settled[debtorName];

                    if (debtAmt > 0) {
                        total += debtAmt;
                        if (!isSettled) unpaidTotal += debtAmt;

                        const row = document.createElement('div');
                        row.style.cssText = `
                            display:flex; 
                            justify-content:space-between; 
                            align-items:center; 
                            padding:10px 0; 
                            border-bottom:1px dashed #eee;
                            ${isSettled ? 'opacity:0.5;' : ''}
                        `;
                        
                        row.innerHTML = `
                            <div>
                                <div style="font-weight:700; font-size:0.9rem;">
                                    ${item.title}
                                    ${isSettled ? '<span style="color:#10b981; font-size:0.7rem; margin-left:6px;">✓</span>' : ''}
                                </div>
                                <div style="font-size:0.75rem; color:#888;">
                                    ${DAYS[dayIdx].label}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:700; color:#E76F51; margin-bottom:4px;">NT$${debtAmt}</div>
                                ${isSettled 
                                    ? '<span style="background:#10b981; color:#fff; padding:4px 8px; border-radius:12px; font-size:0.7rem; font-weight:700;">已還款</span>'
                                    : `<button type="button" style="background:#10b981; color:#fff; border:none; padding:4px 8px; border-radius:12px; font-size:0.7rem; cursor:pointer;" onclick="settleSingleDebt(${dayIdx}, '${item.id}', '${debtorName}')">標記還款</button>`
                                }
                            </div>
                        `;
                        listEl.appendChild(row);
                    }
                });
            });

            footerEl.innerHTML = `
                <span style="font-size:0.7rem; color:#888; font-weight:600;">總計：NT$${total}</span><br>
                未還款：<span style="color:#E76F51;">NT$${unpaidTotal}</span>
            `;

            if (total === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">目前沒有欠款紀錄</div>';
            }
        }

        function closeDebtModal() {
            const overlay = document.getElementById('debt-modal-overlay');
            if (overlay) overlay.classList.remove('open');
        }

        document.getElementById('debt-modal-overlay').onclick = (e) => {
            if (e.target.id === 'debt-modal-overlay') {
                closeDebtModal();
            }
        };

        function settleSingleDebt(dayIdx, itemId, debtorName) {
            if (!confirm(`確認 ${debtorName} 已經還款這筆了嗎？`)) return;

            const item = EXPENSE[dayIdx].find(e => e.id === itemId);
            if (item) {
                if (!item.settled) item.settled = {};
                item.settled[debtorName] = true;

                renderExpense();
                renderExpenseCategories();
                openDebtModal(debtorName);
            }
        }

        function renderCategories() {
            const catList = document.getElementById('cat-list');
            if(catList) {
                catList.innerHTML = '';
                CATEGORIES.forEach(c => {
                    const chip = document.createElement('div');
                    chip.className = 'cat-chip';
                    chip.textContent = c.label;
                    chip.dataset.val = c.key;
                    chip.onclick = () => {
                        document.querySelectorAll('.cat-chip').forEach(x => x.classList.remove('active'));
                        chip.classList.add('active');
                    };
                    catList.appendChild(chip);
                });
            }
        }

        // --- MODAL & WISHLIST ---
        function openModal(type = 'plan', item = null, idx = null) {
            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('add-form');
            const wishFields = document.getElementById('wish-fields');
            
            overlay.classList.add('open');
            editingItem = item;
            editingType = type;
            
            renderCategories();

            if (type === 'wish') {
                title.textContent = item ? '編輯願望' : '新增願望';
                wishFields.style.display = 'block';
                document.getElementById('field-time').style.display = 'none';
                document.getElementById('field-loc').style.display = 'none';
                
                if (item) {
                    document.getElementById('add-title').value = item.title;
                    document.getElementById('wish-img-url').value = item.img || '';
                } else {
                    form.reset();
                }
            } else {
                title.textContent = item ? '編輯行程' : '新增行程';
                wishFields.style.display = 'none';
                document.getElementById('field-time').style.display = 'block';
                document.getElementById('field-loc').style.display = 'block';

                if (item) {
                    document.getElementById('add-time').value = item.time;
                    document.getElementById('add-title').value = item.title;
                    document.getElementById('add-loc').value = item.loc;
                    const chip = document.querySelector(`[data-val="${item.cat}"]`);
                    if(chip) chip.classList.add('active');
                } else {
                    form.reset();
                    const now = new Date();
                    const hh = String(now.getHours()).padStart(2, '0');
                    const mm = String(now.getMinutes()).padStart(2, '0');
                    document.getElementById('add-time').value = `${hh}:${mm}`;
                }
            }

            form.onsubmit = (e) => {
                e.preventDefault();
                saveItem(type, idx);
                overlay.classList.remove('open');
            };
            
            const btnDel = document.querySelector('.btn-del');
            if(item) {
                btnDel.style.display = 'block';
                btnDel.onclick = () => {
                    if(confirm('確定要刪除嗎？')) {
                        deleteItem(type, idx);
                        overlay.classList.remove('open');
                    }
                };
            } else {
                btnDel.style.display = 'none';
            }
        }
        
        document.getElementById('modal-overlay').onclick = (e) => {
            if(e.target === document.getElementById('modal-overlay')) {
                document.getElementById('modal-overlay').classList.remove('open');
            }
        };

        function saveItem(type, idx) {
            const title = document.getElementById('add-title').value;
            const activeChip = document.querySelector('.cat-chip.active');
            const cat = activeChip ? activeChip.dataset.val : 'other';

            if (type === 'wish') {
                const img = document.getElementById('wish-img-url').value;
                const newItem = { title, checked: false, img, id: 'w'+Date.now() };
                if (idx !== null) {
                    WISHLIST[idx] = { ...WISHLIST[idx], title, img };
                } else {
                    WISHLIST.push(newItem);
                }
                renderWishlist();
            } else {
                const time = document.getElementById('add-time').value;
                const loc = document.getElementById('add-loc').value;
                const newItem = { time, cat, title, loc, id: Date.now() };
                
                if (idx !== null) {
                    PLAN[curDay][idx] = newItem;
                } else {
                    PLAN[curDay].push(newItem);
                    PLAN[curDay].sort((a,b) => a.time.localeCompare(b.time));
                }
                renderPlan();
            }
        }

        function deleteItem(type, idx) {
            if (type === 'wish') {
                WISHLIST.splice(idx, 1);
                renderWishlist();
            } else {
                PLAN[curDay].splice(idx, 1);
                renderPlan();
            }
        }

        function renderWishlist() {
            const list = document.getElementById('wish-list');
            list.innerHTML = '';
            
            if(WISHLIST.length === 0) {
                list.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:20px;">尚無願望清單</div>';
                return;
            }

            WISHLIST.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'wish-card';
                div.onclick = (e) => {
                    if(e.target.closest('.wish-check')) return;
                    openModal('wish', item, idx);
                };
                div.innerHTML = `
                    <div class="wish-check ${item.checked?'checked':''}'' onclick="toggleWish(${idx})">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            ${item.checked ? '<polyline points="20 6 9 17 4 12"></polyline>' : ''}
                        </svg>
                    </div>
                    ${item.img ? `<img src="${item.img}" class="wish-img">` : '<div class="wish-img" style="display:flex;align-items:center;justify-content:center;color:#ccc"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>'}
                    <div class="wish-content">
                        <div style="font-weight:700; font-size:0.9rem; margin-bottom:4px; ${item.checked?'text-decoration:line-through;color:#aaa':''}">${item.title}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function toggleWish(idx) {
            WISHLIST[idx].checked = !WISHLIST[idx].checked;
            renderWishlist();
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
