<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#2C3E50">
<title>æ²–ç¹©è¡Œ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
--safe-top: env(safe-area-inset-top, 20px);
--safe-bottom: env(safe-area-inset-bottom, 20px);
--primary: #2C3E50;
--accent: #E76F51;
--bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}
* { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
html, body {margin: 0;
padding: 0;
height: 100%;        /* èˆŠç€è¦½å™¨å…¼å®¹ */
height: 100dvh;      /* é‡å°æ‰‹æ©Ÿå‹•æ…‹è¦–çª—é«˜åº¦å„ªåŒ– */
width: 100%;
overflow: hidden;    /* ç¦æ­¢ body æ²å‹• */
overscroll-behavior: none; /* é—œéµï¼šç¦æ­¢æ‰‹æ©Ÿæ»‘å‹•åˆ°åº•éƒ¨çš„å›å½ˆæ•ˆæœ */
position: fixed;     /* å¼·åˆ¶å›ºå®šï¼Œé¿å…æ•´é«”é é¢è¢«æ‹–å‹• */ font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: var(--primary); }
body { display: flex; flex-direction: column; }

/* Header */
header { padding: calc(1rem + var(--safe-top)) 1.5rem 0.5rem; flex-shrink: 0; z-index: 10; position: relative; }
h1 { margin: 0; font-family: 'Noto Serif TC', serif; font-size: 2rem; font-weight: 900; }
.subtitle { color: #607d8b; font-size: 0.8rem; font-weight: 600; margin-top: 5px; display: flex; align-items: center; gap: 6px; }
.badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }

/* Tabs */
.tabs { display: flex; padding: 0 1.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); z-index: 10; justify-content: space-around; flex-shrink: 0; position: relative; }
.tab { padding: 1rem 0; font-weight: 700; color: #999; font-size: 0.8rem; position: relative; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
.tab svg { width: 24px; height: 24px; fill: currentColor; }
.tab.active { color: var(--primary); }
.tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--accent); border-radius: 2px; }

/* Main Content */
main { flex: 1; overflow-y: auto; padding: 1rem 1rem calc(6rem + var(--safe-bottom)) 1rem; -webkit-overflow-scrolling: touch; position: relative; z-index: 1; }

/* Day Scroll */
.day-scroll { display: flex; gap: 0.8rem; overflow-x: auto; padding: 0.5rem 0 1rem; scroll-snap-type: x mandatory; z-index: 2; position: relative; }
.day-scroll::-webkit-scrollbar { display: none; }
.day-card {
    flex: 0 0 4.5rem;   /* å¯¬åº¦ï¼šçª„ä¸€é» */
    height: 5.5rem;     /* é«˜åº¦ï¼šæ‹‰é•·ï¼Œå½¢æˆå‚ç›´æ©¢åœ“ */
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(8px);
    border-radius: 999px; /* é—œéµï¼šè¶…å¤§åœ“è§’ = æ©¢åœ“è† å›Šæ•ˆæœ */
    padding: 0.7rem 0.5rem; /* ä¸Šä¸‹å…§è·è¼ƒå¤§ï¼Œå·¦å³è¼ƒå° */
    display: flex;
    flex-direction: column;
    justify-content: center; /* å‚ç›´ç½®ä¸­ */
    align-items: center;     /* æ°´å¹³ç½®ä¸­ */
    border: 2px solid transparent;
    transition: all 0.2s ease;
    scroll-snap-align: start;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    cursor: pointer;
    position: relative;
}

.day-card:active {
    transform: scale(0.96);
}

/* é¸ä¸­ç‹€æ…‹ */
.day-card.active {
    background: var(--primary);
    color: white;
    box-shadow: 0 6px 18px rgba(44,62,80,0.35);
    border-color: var(--primary);
}

/* å¡ç‰‡é ‚éƒ¨æ–‡å­— (Day 1) */
.day-top {
    font-size: 0.65rem;
    font-weight: 800;
    opacity: 0.7;
    letter-spacing: 0.5px;
    text-align: center;
    margin-bottom: 6px; /* èˆ‡ä¸‹æ–¹æ—¥æœŸä¿æŒé–“è· */
}


.day-dot {
    display: none;
}

/* æ—¥æœŸæ•¸å­—  */
.day-num {
    font-family: 'Noto Serif TC', serif;
    font-size: 1rem; 
    font-weight: 700;
    line-height: 1.1;
    text-align: center;
	
}

/* æ˜ŸæœŸå¹¾ (é€±äºŒ) */
.day-num span {
    font-size: 0.7rem;
    opacity: 0.65;
    font-family: 'Inter', sans-serif;
    display: block;
    margin-top: 12px;
    font-weight: 600;
}

/* é¸ä¸­æ™‚å¼·èª¿ */
.day-card.active .day-top {
    opacity: 0.9;
}


/* Weather Card */
.weather { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); padding: 1rem 1.2rem; border-radius: 1.2rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
.w-txt h3 { margin: 0 0 4px 0; font-family: 'Noto Serif TC'; font-size: 1rem; }
.w-txt p { margin: 0; font-size: 0.7rem; color: #666; }
.w-val { background: rgba(255,255,255,0.8); padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 1.2rem; }

/* List Headers */
.list-head { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 0.8rem; padding: 0 4px; }
.list-head h2 { margin: 0; font-family: 'Noto Serif TC'; font-size: 1.2rem; }
.hint { font-size: 0.65rem; background: rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 12px; color: #888; }

/* --- æ¨£å¼äº”ï¼šç·Šæ¹Šå‹å·¦å´è‰²å¡Šç‰ˆ --- */

/* 1. å¡ç‰‡å¤–æ¡†ï¼šé«˜åº¦ç¸®æ¸›ï¼Œé™°å½±æ›´æŸ”å’Œ */
.plan-card {
    background: #fff;
    border: none !important; 
    border-radius: 20px !important;
    
    padding: 0 !important; 
    
    /* å¢åŠ åº•éƒ¨é–“è·ï¼Œè®“å¡ç‰‡èˆ‡å¡ç‰‡(æˆ–å¡ç‰‡èˆ‡äº¤é€šå¡)ä¹‹é–“æ›´å¯¬é¬† */
    margin-bottom: 1.2rem; 
    
    display: flex;
    align-items: stretch;
    min-height: 4.8rem; /* é«˜åº¦ç¸®å° (åŸæœ¬ 5.5rem) */
    position: relative;
    overflow: hidden; 
    box-shadow: 0 4px 16px rgba(0,0,0,0.06); 
}

/* 2. å·¦å´ä½ˆå±€ï¼šæ™‚é–“å€å¯¬åº¦ç¨å¾®ç¸®å° */
.plan-left {
    display: grid;
    /* æ™‚é–“å€(72px) | å…§å®¹å€ (è‡ªå‹•) */
    grid-template-columns: 72px 1fr; 
    grid-template-rows: auto auto auto;
    align-items: center;
    padding: 0 !important;
    gap: 0 !important;
    flex: 1;
    min-width: 0;
}

/* 3. æ™‚é–“å€å¡Š */
.plan-time {
    grid-column: 1;
    grid-row: 1 / span 3;
    
    width: 100% !important;
    height: 100% !important;
    margin: 0 !important; 
    background: var(--card-color-light) !important; 
    border-radius: 0 !important;
    
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    
    /* å­—é«”èˆ‡é¡è‰² */
    color: var(--card-color) !important;
    font-size: 1.3rem !important; /* éš¨é«˜åº¦ç¨å¾®ç¸®å°å­—é«” */
    font-weight: 800 !important;
    line-height: 1;
    letter-spacing: 0px;
}

.plan-time::after {
    content: 'â—';
    font-size: 0.35rem; /* é»é»ä¹Ÿç¸®å° */
    color: var(--card-color);
    margin-top: 4px;
    opacity: 0.5;
}

.plan-left::before { display: none !important; }

/* 4. å…§å®¹å€ï¼šé–“è·å¾®èª¿ */
.plan-tag {
    grid-column: 2;
    justify-self: start;
    font-size: 0.65rem !important; /* å­—é«”å¾®èª¿ */
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: 700;
    color: white !important;
    background: var(--card-color);
    /* ä¸Šé‚Šè·æ¸›å°‘ï¼Œé…åˆé«˜åº¦ç¸®å° */
    margin: 0.8rem 0 2px 1rem !important; 
}

.plan-title {
    grid-column: 2;
    font-weight: 800;
    font-size: 1rem !important;
    color: #1e293b !important;
    margin: 0 0 0 1rem !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 0.5rem;
}

.plan-loc {
    grid-column: 2;
    font-size: 0.75rem !important;
    color: #94a3b8 !important;
    display: flex;
    align-items: center;
    gap: 4px;
    /* ä¸‹é‚Šè·æ¸›å°‘ */
    margin: 2px 0 0.8rem 1rem !important; 
}

/* 5. å°èˆªæŒ‰éˆ•å€ (äº®é¢æ´»æ½‘ç‰ˆ) */
.plan-actions {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    flex-shrink: 0;
    margin: 0 !important;
    padding-right: 12px;
    background: transparent !important;
}

.nav-btn {
    padding: 0 !important;
    width: 34px;
    height: 34px;
    border-radius: 50%;
    
    /* äº®é¢èƒŒæ™¯ï¼šç´”ç™½ */
    background: white !important;
    
    /* ç§»é™¤é™°å½± */
    box-shadow: none !important;
    
    /* ä½¿ç”¨éå¸¸æ·¡çš„é‚Šæ¡†ä¾†ç¶­æŒè¼ªå»“ (å¦‚æœä¸æƒ³è¦é‚Šæ¡†å¯è¨­ç‚º transparent) */
    border: 1px solid #f1f5f9 !important; 
    
    color: transparent !important;
    font-size: 0 !important;
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* é»æ“Šæ™‚è¼•å¾®ç¸®æ”¾æ•ˆæœ */
    transition: transform 0.1s;
}

.nav-btn:active {
    transform: scale(0.9);
}

/* åœ–ç¤ºé¡è‰²ï¼šæ”¹æˆæ´»æ½‘çš„é¡è‰² */
.nav-btn svg {
    width: 16px;
    height: 16px;
    fill: #3b82f6 !important; 
}


/* Expense Summary Card */
.exp-summary-card { background: var(--primary); color: white; padding: 2rem; border-radius: 1.5rem; text-align: center; margin-bottom: 1rem; box-shadow: 0 8px 20px rgba(44,62,80,0.3); }
.stat-tabs { display: flex; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 4px; margin-bottom: 1rem; }
.stat-tab { flex: 1; text-align: center; padding: 6px; font-size: 0.8rem; color: rgba(255,255,255,0.6); border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
.stat-tab.active { background: white; color: var(--primary); }

/* Quick Expense Form */
.quick-expense-card { background: rgba(255,255,255,0.9); border-radius: 1.2rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: 0.3s; border: 2px solid transparent; }
.quick-expense-card.editing { border-color: var(--accent); background: #fff; box-shadow: 0 8px 24px rgba(231, 111, 81, 0.15); }
.quick-expense-row {display: flex; /* æ”¹ç‚º flex */flex-wrap: wrap; /* å…è¨±æ›è¡Œ */gap: 0.8rem;margin-bottom: 0.8rem;}.quick-expense-row > div {flex: 1 1 120px; /* å¯¬åº¦ä¸è¶³æ™‚è‡ªå‹•æ›è¡Œ */}
.quick-expense-card label { font-size: 0.7rem; color: #888; margin-bottom: 2px; display: block; font-weight: 700; }
.quick-expense-card input, .quick-expense-card select { width: 100%; padding: 0.55rem 0.7rem; border-radius: 0.7rem; border: 1px solid #e5e7eb; font-size: 0.8rem; }
.quick-expense-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 0.3rem; }
.btn-submit { padding: 0.5rem 1.2rem; border-radius: 999px; border: none; background: var(--primary); color: #fff; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
.quick-expense-card.editing .btn-submit { background: var(--accent); }
.edit-actions { display: none; gap: 6px; }
.quick-expense-card.editing .edit-actions { display: flex; }
.btn-cancel, .btn-delete-inline { padding: 0.5rem 0.8rem; border-radius: 999px; border: 1px solid #ddd; background: white; color: #666; font-size: 0.75rem; font-weight: 700; cursor: pointer; }
.btn-delete-inline { color: #ef4444; border-color: #fee2e2; background: #fef2f2; }

/* Expense List */
.expense-row { 
    background: white; 
    padding: 0.8rem 1rem; 
    border-radius: 1rem; 
    margin-bottom: 0.8rem; 
    display: block; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
    cursor: pointer; 
    transition: transform 0.1s;
    
    /* âš ï¸ å‹™å¿…åŠ å…¥é€™å…©è¡Œï¼Œé€™æ˜¯è§£æ±ºè·‘ä½çš„é—œéµ */
    position: relative; 
    overflow: hidden; 
}
.expense-row:active { transform: scale(0.98); }
.expense-header { display: flex; justify-content: space-between; align-items: center; }
.expense-detail-panel { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e5e7eb; animation: slideDown 0.2s ease-out; }
.expense-row.expanded .expense-detail-panel { display: block; }
.detail-list-item { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 6px; padding: 6px 10px; background: #f8fafc; border-radius: 8px; }
.detail-user-name { font-weight: 700; color: #374151; }
.detail-user-name.payer { background: rgba(44, 62, 80, 0.1); color: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: 800; border-left: 3px solid var(--primary); padding-left: 8px; }
.detail-user-name.debtor { background: rgba(231, 111, 81, 0.08); color: var(--accent); padding: 2px 6px; border-radius: 4px; font-weight: 800; border-left: 3px solid var(--accent); padding-left: 8px; }
.detail-amount { font-weight: 700; color: var(--accent); }
.btn-edit-inline { width: 100%; margin-top: 10px; padding: 10px; background: white; color: var(--primary); border: 1.5px solid var(--primary); border-radius: 10px; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.15s; }
.btn-edit-inline:active { transform: scale(0.98); background: #f1f5f9; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
.pay-method-badge { font-size: 0.6rem; background: #eee; color: #666; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
.advance-badge { font-size: 0.6rem; border: 1px solid var(--accent); color: var(--accent); padding: 1px 4px; border-radius: 4px; margin-left: 4px; }


/* Wishlist */
.wish-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.wish-card { background: white; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; cursor: pointer; }
.wish-img { width: 100%; aspect-ratio: 1; object-fit: cover; background: #eee; display: block; }
.wish-content { padding: 0.8rem; }
.wish-check { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 5; }
.wish-check.checked { background: var(--accent); color: white; }

/* Colors */
.bg-sight { background: #3b82f6; } .bg-food { background: #f97316; } .bg-shop { background: #ec4899; } .bg-trans { background: #64748b; } .bg-other { background: #10b981; }

/* FAB & Modal */
.fab { position: fixed; bottom: calc(2rem + var(--safe-bottom)); right: 1.5rem; width: 3.5rem; height: 3.5rem; background: var(--primary); border-radius: 50%; color: white; box-shadow: 0 8px 20px rgba(44,62,80,0.4); display: flex; align-items: center; justify-content: center; z-index: 100; transition: transform 0.2s; cursor: pointer; }
.fab:active { transform: scale(0.9); }
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; display: flex; align-items: flex-end; }
.overlay.open { opacity: 1; pointer-events: auto; }
.modal { background: #FDFBF7; width: 100%; border-radius: 1.5rem 1.5rem 0 0; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 90dvh; overflow-y: auto; padding-bottom: calc(2rem + var(--safe-bottom)); }
.overlay.open .modal { transform: translateY(0); }
.form-row { margin-bottom: 1rem; }
label { display: block; font-size: 0.75rem; color: #888; font-weight: 700; margin-bottom: 6px; }
input, select, textarea { width: 100%; padding: 0.9rem; background: white; border: 1px solid #eee; border-radius: 0.8rem; font-size: 1rem; color: var(--primary); outline: none; appearance: none; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
input:focus, select:focus { border-color: var(--primary); }
.cats { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; }
.cat-chip { padding: 8px 16px; background: white; border-radius: 20px; font-size: 0.8rem; color: #aaa; font-weight: 700; white-space: nowrap; border: 1px solid #eee; cursor: pointer; }
.cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
.split-person-btn { padding: 6px 10px; border-radius: 999px; border: 1px solid #e5e7eb; background: #f9fafb; font-size: 0.8rem; font-weight: 700; color: #374151; cursor: pointer; transition: 0.15s; }
.split-person-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
.btn-save { width: 100%; padding: 1rem; background: var(--primary); color: white; border-radius: 1rem; font-size: 1rem; font-weight: 700; margin-top: 1.5rem; box-shadow: 0 4px 12px rgba(44,62,80,0.2); }
.btn-del { width: 100%; padding: 1rem; color: #ef4444; font-weight: 700; background: transparent; margin-top: 0.5rem; }

/* Expense Category Card */
.exp-category-card { background: rgba(255,255,255,0.9); border-radius: 1.2rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.exp-category-card-title { font-size: 0.8rem; font-weight: 700; color: #666; margin-bottom: 0.8rem; padding-left: 4px; }
.exp-category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; }
.exp-category-item { padding: 1rem 0.8rem; border-radius: 1.2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.4rem; text-align: center; color: #fff; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 100px; }
.exp-category-item span:first-child { font-size: 0.75rem; opacity: 0.9; letter-spacing: 0.5px; }
.exp-category-item span:nth-child(2) { font-size: 1.3rem; font-weight: 900; line-height: 1; margin: 0.2rem 0; }
.exp-category-item span:nth-child(3) { font-size: 0.7rem; opacity: 0.85; margin-top: 0.2rem; }

/* Welcome Card */
.welcome-card-wrapper { position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.18); backdrop-filter: blur(10px); }
.welcome-card-inner { background: rgba(255,255,255,0.96); border-radius: 1.4rem; box-shadow: 0 12px 35px rgba(15,23,42,0.25); padding: 1.2rem 1.3rem 1.1rem; width: 88%; max-width: 320px; text-align: center; }
.welcome-user-list { display: flex; flex-direction: column; gap: 8px; max-height: 220px; overflow-y: auto; margin-top: 0.4rem; padding-right: 2px; }
.welcome-user-btn { align-self: center; min-width: 120px; max-width: 180px; padding: 6px 10px; border-radius: 999px; border: 1px solid #e5e7eb; background: #f9fafb; font-size: 0.8rem; font-weight: 700; color: #374151; cursor: pointer; transition: 0.15s; }
.welcome-user-btn:active { transform: scale(0.95); }
.welcome-user-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

/* Debt Modal */
#debt-modal-overlay { display: flex; align-items: flex-end; }
#debt-detail-list { margin-bottom: 1.5rem; }
#debt-modal-footer { text-align: right; font-weight: 900; font-size: 1.2rem; color: var(--primary); border-top: 1px solid #eee; padding-top: 1rem; }

/* --- ä¿®æ”¹å¾Œï¼šåœ“å¼§èˆ‡æ´»æ½‘é¢¨æ ¼ --- */

.plan-wrapper {
position: relative;
/* é€™è£¡ä¸éœ€è¦ç•™ç™½ï¼Œç”±å…§å®¹æ’é–‹ */
}

/* 1. å¡ç‰‡æ¨£å¼ï¼šåœ“å¼§å·¦å´é‚Šæ¢ */
.plan-card {
background: white;
padding: 1rem;
border-radius: 1.2rem; /* ä¿æŒåŸæœ¬åœ“è§’ */
margin-bottom: 0;
display: flex;
align-items: center;
justify-content: space-between;
box-shadow: 0 4px 16px rgba(0,0,0,0.05);
cursor: pointer;
position: relative;
z-index: 2;
/* é—œéµä¿®æ”¹ï¼šåˆ©ç”¨ border-left å¯¦ä½œé‚Šæ¢ï¼Œæœƒè‡ªå‹•è·Ÿéš¨ border-radius */
border: 1px solid white; /* é è¨­é‚Šæ¡† */
border-left: 6px solid var(--card-color, #ccc); /* å·¦å´è®Šç²—ä¸”æœ‰é¡è‰² */
transition: transform 0.1s;
}

.plan-card:active {
transform: scale(0.98);
}

.plan-left {
padding-left: 8px; /* ç¨å¾®æ¨é–‹ä¸€é»ï¼Œé¿é–‹å·¦å´é‚Šæ¢ */
flex: 1; /* ç¢ºä¿ä½”æ»¿å‰©é¤˜ç©ºé–“ */
min-width: 0; /* é˜²æ­¢æ–‡å­—æº¢å‡º */
}

/* --- æµç¨‹åœ–è¨»è§£é¢¨æ ¼ï¼šé€£æ¥é»è¨­è¨ˆ --- */

/* --- ä¸€é«”æˆå‹ï¼šé¡è‰²è·Ÿéš¨ç‰ˆ --- */

/* 1. å®¹å™¨èˆ‡è²«ç©¿ç·šæ¢ */
.trans-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.5em 0;
    margin: 0;
    width: 100%;
    z-index: 1;
}

/* ç·šæ¢ï¼šä½¿ç”¨ var(--card-color) è·Ÿéš¨ä¸»é¡Œè‰² */
.trans-container::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 2px;
    
    /* é—œéµï¼šä½¿ç”¨è®Šæ•¸ï¼Œä¸¦åŠ ä¸Šä¸€é»é€æ˜åº¦è®“ç·šæ¢ä¸è¦å¤ªæ¶çœ¼ */
    background: var(--card-color, #cbd5e1); 
    opacity: 0.5; /* è®“ç·šæ¢ç¨å¾®æ·¡ä¸€é»ï¼Œæ¯”è¼ƒæœ‰å±¤æ¬¡ */
    
    z-index: 0;
}

/* ç§»é™¤åœ“é» */
.trans-container::after { display: none; }

/* 2. äº¤é€šè† å›Šï¼šçŸ­å°ç‰ˆ */
.trans-badge {
    position: relative;
    z-index: 2;
    margin: 0 auto;
    
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px; /* ç¸®å°åœ–ç¤ºå’Œæ–‡å­—é–“è· */
    
    background: white;
    
    /* é‚Šæ¡†é¡è‰²è·Ÿéš¨ä¸»é¡Œè‰²ï¼Œä¸”ä¸é€æ˜ */
    border: 1.6px solid var(--card-color, #cbd5e1); 
    border-radius: 10px; /* ç¨å¾®æ–¹ä¸€é»ï¼Œæ›´æœ‰ã€Œé€£æ¥å™¨ã€çš„æ„Ÿè¦º */
    
    /* ç¸®å°å…§è·ï¼Œè®“è† å›Šè®ŠçŸ­ */
    padding: 2px 8px; 
    
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    
    /* æ•´é«”å­—é«”å¾®èª¿ */
    font-size: 0.7rem;
    font-weight: 700;
    color: #555;
    
    /* ç¢ºä¿è† å›Šå¤ å¯¬èƒ½è“‹ä½ç·šæ¢ï¼Œä½†åˆä¸æœƒå¤ªé•· */
    min-width: 60px; 
}

/* 3. å…§éƒ¨å…ƒä»¶ï¼šç·Šæ¹ŠåŒ– */
.trans-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    font-size: 0.9rem; /* åœ–ç¤ºå¤§å° */
    
    background: transparent; 
    color: var(--card-color, #555); /* åœ–ç¤ºä¹Ÿè·Ÿéš¨é¡è‰² */
}

.trans-time {
    background: transparent;
    padding: 0;
    color: #555;
    white-space: nowrap; /* é˜²æ­¢æ›è¡Œ */
}


/* 6. æ™‚é–“æ–‡å­—ï¼šç´”æ–‡å­—ï¼Œç„¡èƒŒæ™¯ */
.trans-time {
    background: transparent;
    padding: 0;
    cursor: pointer;
    color: #475569;
    font-size: 0.75rem;
    font-weight: 700;
}

/* 7. Hover æ•ˆæœ (é¸ç”¨ï¼Œè®“äº’å‹•æ›´æ˜ç¢º) */
.trans-badge:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    border-color: var(--card-color, #cbd5e1);
}

.trans-icon:active,
.trans-time:active {
    transform: scale(0.95);
}



/* 3. æ–°å¢ï¼šäº¤é€šé¸æ“‡ Action Sheet çš„æ–°æ¨£å¼ (5å€‹ä¸¦æ’ï¼Œé«˜åº¦çŸ­) */
.trans-grid {
display: grid;
grid-template-columns: repeat(5, 1fr); /* 5æ ¼ä¸¦æ’ */
gap: 8px; /* é–“è·ç¸®å° */
margin-bottom: 1rem;
}

.trans-option {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 8px 4px; /* é«˜åº¦ç¸®å° */
border-radius: 12px;
background: #f8fafc;
cursor: pointer;
border: 1px solid #f1f5f9;
transition: all 0.2s;
}
.trans-option:active {
background: #e2e8f0;
transform: scale(0.95);
}
.trans-opt-icon {
font-size: 1.6rem; /* åœ–ç¤ºå¤§å°é©ä¸­ */
margin-bottom: 2px;
filter: drop-shadow(0 2px 2px rgba(0,0,0,0.05));
}
.trans-opt-label {
font-size: 0.7rem; /* æ–‡å­—ç¸®å° */
font-weight: 700;
color: #475569;
white-space: nowrap; /* ä¸æ›è¡Œ */
}
.currency-capsule {
display: inline-flex;
background: #f0f0f0;
border-radius: 20px;
padding: 4px;
cursor: pointer;
font-size: 0.8rem;
font-weight: 700;
user-select: none;
border: 1px solid #e5e7eb;
gap: 0;
}

.currency-capsule span {
padding: 6px 10px;
border-radius: 16px;
transition: 0.2s;
color: #666;
font-size: 0.75rem;
font-weight: 800;
min-width: 30px;
text-align: center;
}

.currency-capsule span.active {
background: var(--primary);
color: white;
}


/* å®¹å™¨è¨­å®šç‚ºå‚ç›´æ’åˆ—ï¼Œè®“æŒ‡ç¤ºé»æ’åœ¨æœ€ä¸‹æ–¹ */
#summary-content {
display: flex;
flex-direction: column;
justify-content: space-between;
height: 100%; /* ç¢ºä¿é«˜åº¦æ’é–‹ */
}

.stat-swipe-wrapper {
flex: 1;
display: flex;
overflow-x: auto;
scroll-snap-type: x mandatory;
scrollbar-width: none;

/* æ–°å¢é€™è¡Œï¼šç¢ºä¿å®¹å™¨å¯¬åº¦æ˜ç¢º */
width: 100%; 
}

.swipe-card {

/* å¼·åˆ¶æ¯å¼µå¡ç‰‡å¯¬åº¦ç‚ºå®¹å™¨çš„ 100%ï¼Œä¸å…è¨±å£“ç¸®æˆ–æ”¾å¤§ */
flex: 0 0 100% !important;
width: 100% !important;
min-width: 100% !important;

scroll-snap-align: start; /* æ»‘å‹•æ™‚è‡ªå‹•å°é½Šèµ·é» */
padding: 10px 15px;      /* ç¶­æŒæ‚¨åŸæœ¬çš„å…§è· */
box-sizing: border-box;  /* ç¢ºä¿ padding ä¸æœƒæ’å¤§å¯¬åº¦ */


}


/* 6é»é˜æ–¹å‘æŒ‡ç¤ºé» [image:1] */
.swipe-dots {
display: flex;
justify-content: center;
align-items: center;
gap: 6px;
padding: 8px 0 12px 0; /* å¢åŠ åº•éƒ¨é–“è·ï¼Œä½¿å…¶ä½æ–¼å¡ç‰‡åº•éƒ¨ä¸­å¤® */
}

.dot {
width: 5px;
height: 5px;
background: rgba(255, 255, 255, 0.2);
border-radius: 50%;
transition: all 0.3s ease;
}

/* å•Ÿå‹•ç‹€æ…‹çš„é»è®Šé•·ä¸”è®Šäº® */
.dot.active {
background: #ffb731; /* èˆ‡ç¸½é¡é‡‘é»ƒè‰²çµ±ä¸€ */
width: 15px;
border-radius: 3px;
opacity: 1;
}

.dot.category-dot.active {
    background-color: #2C3E50 !important; /* æ”¹æˆæ·±è—è‰² (æˆ–æ‚¨å–œæ­¡çš„å…¶ä»–é¡è‰²) */
    opacity: 0.8;
}

/* ğŸ†• ç™»å…¥æˆåŠŸå‹•ç•« */
@keyframes fadeOut {
from {
opacity: 1;
transform: scale(1);
}
to {
opacity: 0;
transform: scale(0.95);
}
}

@keyframes slideUp {
from {
opacity: 0;
transform: translateY(20px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

/* --- ä¿®æ­£ç‰ˆï¼šæ­¡è¿ç•«é¢èˆ‡æˆåŠŸå‹•ç•« --- * gemini 12/27 15:29/

/* 1. ç¢ºä¿èƒŒæ™¯é®ç½©æ°¸é ç½®ä¸­ä¸”è¦†è“‹å…¨è¢å¹• */
#welcome-card {
position: fixed;
inset: 0;
z-index: 998;
display: flex;
align-items: center;
justify-content: center;
background: rgba(0,0,0,0.2);
backdrop-filter: blur(10px);
transition: opacity 0.5s ease;
}

/* 2. èƒŒæ™¯å¡ç‰‡å…§å®¹ï¼šé»æ“Šå¾Œæœƒå¹³æ»‘æ¶ˆå¤± */
.welcome-card-inner {
transition: all 0.4s ease;
}
.welcome-card-inner.hide-content {
opacity: 0;
transform: scale(0.9);
pointer-events: none;
}

/* 3. æˆåŠŸè¨Šæ¯ï¼šå¼·åˆ¶å›ºå®šåœ¨è¢å¹•æ­£ä¸­å¤®ï¼Œä¸éš¨å®¹å™¨è·³å‹• */
.login-success-message {
position: fixed;
top: 50% !important;
left: 50% !important;
transform: translate(-50%, -50%) !important; /* å¼·åˆ¶ä¿®æ­£ä½ç§» */
background: white;
padding: 2.5rem 2rem;
border-radius: 1.5rem;
box-shadow: 0 20px 50px rgba(0,0,0,0.25);
text-align: center;
z-index: 999;
width: 280px;
animation: slideInCenter 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

/* 4. å‹•ç•«ï¼šç”±å°è®Šå¤§ä¸¦ä¿æŒåœ¨ä¸­å¿ƒ */
@keyframes slideInCenter {
from {
opacity: 0;
transform: translate(-50%, -45%) scale(0.85);
}
to {
opacity: 1;
transform: translate(-50%, -50%) scale(1);
}
}

/* 5. æˆåŠŸè¨Šæ¯æ¶ˆå¤±å‹•ç•« */
@keyframes fadeOutMsg {
to {
opacity: 0;
transform: translate(-50%, -50%) scale(0.95);
}
}

/* 6. å…¨åŸŸæ·¡å‡ºæ•ˆæœ */
.welcome-fade-out {
opacity: 0 !important;
}

.welcome-card-wrapper.exit-animation {
animation: fadeOut 0.6s ease-out forwards;
}

/* ä½¿ç”¨è€…æŒ‰éˆ•æ¨£å¼ */
.welcome-user-btn {
padding: 8px 16px;
border-radius: 20px;
border: 1px solid #eee;
background: white;
color: #555;
font-weight: 700;
cursor: pointer;
transition: 0.2s;
font-size: 0.9rem;
}

/* ç•¶è¢«é¸ä¸­æ™‚çš„æ¨£å¼ */
.welcome-user-btn.selected {
background: #2C3E50;
color: white;
border-color: #2C3E50;
transform: scale(1.05);
box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2);
}

/* 1. æ»‘å‹•å¡ç‰‡å®¹å™¨ (ç”¨æ–¼æ¶ˆè²»åˆ†é¡ & åˆ†å¸³çµ±è¨ˆ) */
.exp-category-card-wrapper {
background: rgba(255,255,255,0.9);
border-radius: 1.5rem;
padding: 1rem 0; /* ä¸Šä¸‹ç•™ç™½ï¼Œå·¦å³ç”±å…§éƒ¨å¡ç‰‡æ§åˆ¶ */
margin-bottom: 1rem;
box-shadow: 0 4px 12px rgba(0,0,0,0.05);
position: relative;
overflow: hidden;
}

/* 2. æ”¯å‡ºåˆ—è¡¨æ”¶åˆå‹•ç•«å®¹å™¨ */
#expense-list-container {
transition: max-height 0.3s ease-out;
overflow: hidden;
}
#expense-list-container.collapsed {
max-height: 0;
}


/* 1. åˆªé™¤å¾Œçš„æ•´åˆ—æ¨£å¼ï¼šæ·¡åŒ–è™•ç† */
.expense-row.deleted {
    opacity: 0.5;                /* æ•´é«”è®Šæ·¡ */
    background: #f9fafb;         /* èƒŒæ™¯è®Šç° */
    pointer-events: none;        /* ç¦æ­¢é»æ“Šå±•é–‹ */
    position: relative;          /* ç¢ºä¿æ¨™ç±¤å®šä½æ­£ç¢º */
    filter: grayscale(0.8);      /* ç¨å¾®å»è‰²ï¼Œå¼·åŒ–ã€Œå¤±æ•ˆã€æ„Ÿ */
}

/* 2. åˆªé™¤å¾Œçš„æ–‡å­—æ¨£å¼ï¼šåŠ ä¸Šåˆªé™¤ç·š */
.expense-row.deleted .expense-header {
    text-decoration: line-through;
    color: #9ca3af;
}

/* 3. å·²åˆªé™¤å°æ¨™ç±¤ (å–ä»£åŸæœ¬çš„å¤§å°ç« ) */
.deleted-badge {
    display: none;               /* é è¨­éš±è— */
    position: absolute;
    top: 10px;                   /* å›ºå®šåœ¨å³ä¸Šè§’ */
    right: 10px;
    z-index: 10;
}

/* æ¨™ç±¤æœ¬é«”è¨­è¨ˆ */
.deleted-badge-inner {
    background: #fee2e2;         /* æ·ºç´…åº• */
    color: #ef4444;              /* ç´…å­— */
    border: 1px solid #fca5a5;   /* ç´…é‚Šæ¡† */
    font-size: 0.65rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 4px;
    white-space: nowrap;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transform: none;             /* ç§»é™¤æ—‹è½‰ */
}

/* ç•¶æœ‰ deleted class æ™‚é¡¯ç¤ºæ¨™ç±¤ */
.expense-row.deleted .deleted-badge {
    display: block;
}





/* === æ¸…å–®åˆ‡æ›éˆ• (è—è‰²ä¸»é¡Œ) === */

.wishlist-tabs {
    display: flex;
    background: rgba(255,255,255,0.7);
    padding: 5px;
    border-radius: 12px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.wish-tab {
    flex: 1;
    text-align: center;
    padding: 10px 8px;
    font-weight: 700;
    font-size: 0.9rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    
    /* æœªé»æ“Šç‹€æ…‹ï¼šæ·¡è‰²æ–‡å­— + é€æ˜èƒŒæ™¯ */
    color: #999;
    background: transparent;
    /* ç§»é™¤èˆŠæœ‰çš„ border æˆ–å…¶ä»–å¯èƒ½å¹²æ“¾çš„è¨­å®š */
    border: none;
}

/* å·²é»æ“Šç‹€æ…‹ï¼šè—è‰²åº•  + ç™½å­— */
.wish-tab.active {
    background: #ebb074; /*  Blue-600 */
    color: white !important;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    transform: scale(1.02);
}


.wish-tab:active {
    transform: scale(0.98);
}



/* è¡Œææ¸…å–®å®¹å™¨ */
#luggage-list-container {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    margin-bottom: 1rem;
}

/* åˆ†é¡å¡ç‰‡å®¹å™¨ */
.luggage-category-card {
    background: white;
    border-radius: 1.2rem;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    border: 1px solid rgba(0, 0, 0, 0.04);
}

/* åˆ†é¡æ¨™é¡Œ */
.luggage-cat-title {
    font-size: 0.95rem;
    font-weight: 800;
    color: #2C3E50;
    padding: 12px 16px;
    margin: 0;
    border-bottom: 1px solid #f0f0f0;
    background: #fafafa;
    display: flex;
    align-items: center;
    gap: 8px;
}

.luggage-cat-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: #E76F51;
    border-radius: 2px;
}

/* è¡Œæé …ç›®åˆ—è¡¨ */
.luggage-grid {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding: 0;
    margin: 0;
    background: white;
}

/* å–®ä¸€è¡Œæé …ç›® */
.luggage-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
    transition: background-color 0.15s, opacity 0.2s;
    background: white;
    gap: 10px;
    position: relative;
}

.luggage-item:last-child {
    border-bottom: none;
}

/* åœ“å½¢ Checkbox */
.luggage-checkbox {
    width: 24px;
    height: 24px;
    min-width: 24px;
    border-radius: 50%;
    border: 2px solid #D0D0D0;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;



    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

/* é¸ä¸­ç‹€æ…‹ - å¡«æ»¿æ©˜è‰² */
.luggage-item.checked .luggage-checkbox {
    background: #E76F51;
    border-color: #E76F51;
    box-shadow: 0 2px 6px rgba(231, 111, 81, 0.3);
}

/* Checkbox å…§éƒ¨çš„æ‰“å‹¾ */
.luggage-checkbox::after {
    content: 'âœ“';
    color: white;
    font-size: 14px;
    font-weight: 900;
    opacity: 0;
    transition: opacity 0.2s;
}

.luggage-item.checked .luggage-checkbox::after {
    opacity: 1;
}

/* é …ç›®æ–‡å­— */
.luggage-item-text {
    flex: 1;
    font-size: 0.95rem;
    font-weight: 500;
    color: #1f2937;
    transition: color 0.2s, opacity 0.2s;
    line-height: 1.4;
}

/* é¸ä¸­æ™‚çš„æ–‡å­—æ¨£å¼ */
.luggage-item.checked .luggage-item-text {
    color: #CBD5E1;
    text-decoration: line-through;
    opacity: 0.6;
}

/* é …ç›®äº’å‹•ç‹€æ…‹ */
.luggage-item:active {
    background: #f9f9f9;
}

.luggage-item.checked {
    background: #fafafa;
}

/* è‡ªè¨‚é …ç›®åˆªé™¤æŒ‰éˆ• */
.luggage-delete-btn {
    background: none;
    border: none;
    color: #cbd5e1;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0 4px;
    transition: color 0.2s;
    opacity: 0.5;
}

.luggage-delete-btn:hover,
.luggage-delete-btn:active {
    color: #ef4444;
    opacity: 1;
}

/* æ–°å¢æ¬„ä½å®¹å™¨ */
#luggage-input-container {
    background: white;
    border-top: 1px solid #f0f0f0;
    padding: 12px 16px;
    display: flex;
    gap: 8px;
    border-radius: 0 0 1.2rem 1.2rem;
}

#luggage-input-container input {
    flex: 1;
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 0.9rem;
    outline: none;
    background: #f9f9f9;
    transition: border-color 0.2s;
}

#luggage-input-container input:focus {
    border-color: #E76F51;
    background: white;
}

#luggage-input-container button {
    background: #E76F51;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0 16px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 0.9rem;
}

#luggage-input-container button:active {
    background: #D85C3A;
}

/* å¡ç‰‡å…§çš„æ–°å¢æ¬„ä½ */
.luggage-add-row {
    display: flex;
    align-items: center;
    padding: 16px 16px;       /* å¢åŠ ä¸Šä¸‹å…§è·ï¼Œçµ¦æ–‡å­—æ›´å¤šå‘¼å¸ç©ºé–“ */
    border-top: 1px solid #f5f5f5;
    gap: 12px;                /* å¢åŠ åœ–æ¨™èˆ‡æ–‡å­—çš„é–“è· */
    background: #fafafa;
    transition: background-color 0.2s;
    height: 56px;             /* å¼·åˆ¶è¨­å®šä¸€å€‹è¶³å¤ çš„é«˜åº¦ */
    box-sizing: border-box;   /* ç¢ºä¿ padding ä¸æœƒæ’ç ´é«˜åº¦ */
}

/* æ–°å¢æ¬„ä½çš„è¼¸å…¥æ¡† */
.luggage-add-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 0.9rem;        /* ç¨å¾®ç¸®å°å­—é«” (åŸæœ¬ 0.95rem) */
    color: #9CA3AF;
    outline: none;
    padding: 0;
    font-weight: 500;
    transition: color 0.2s;
    line-height: normal;      /* è®“ç€è¦½å™¨è‡ªå‹•è¨ˆç®—è¡Œé«˜ï¼Œé¿å…åˆ‡å­— */
    height: 100%;             /* å¡«æ»¿çˆ¶å®¹å™¨é«˜åº¦ */
    display: flex;
    align-items: center;      /* ç¢ºä¿è¼¸å…¥æ™‚æ¸¸æ¨™å‚ç›´ç½®ä¸­ */
}



/* è¼¸å…¥æ¡†æœ‰ç„¦é»æ™‚çš„æ¨£å¼ */
.luggage-add-input:focus,
.luggage-add-input.focused {
    color: #1f2937;
}

.luggage-add-row:has(.luggage-add-input:focus),
.luggage-add-row:has(.luggage-add-input.focused) {
    background: #f0f9ff;  /* æ·ºè—è‰²é«˜äº® */
}

/* è¼¸å…¥æ¡†æœ‰å…§å®¹æ™‚ */
.luggage-add-input:not(:placeholder-shown) {
    color: #1f2937;
    font-weight: 600;
}

/* è®“ placeholder å‚ç›´ç½®ä¸­ */
.luggage-add-input::placeholder {
    line-height: 1.5 !important;
    color: #9CA3AF;
    opacity: 1;
}

/* --- æ—…éŠè³‡è¨Šé æ¨£å¼ --- */

.info-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-bottom: 2rem;
}

.info-card {
    background: white;
    border-radius: 16px;
    overflow: hidden; /* é—œéµï¼šéš±è—æ”¶åˆçš„å…§å®¹ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

/* å±•é–‹æ™‚åŠ æ·±é™°å½±æˆ–æ”¹è®Šé‚Šæ¡† */
.info-card:not(.collapsed) {
    box-shadow: 0 8px 24px rgba(44,62,80,0.12);
    border-color: rgba(44,62,80,0.1);
}

.info-header {
    display: flex;
    align-items: center;
    padding: 16px;
    cursor: pointer;
    background: white;
    position: relative;
    z-index: 2; /* ç¢ºä¿æ¨™é¡Œå±¤ç´šè¼ƒé«˜ */
}

.info-icon {
    font-size: 1.4rem;
    margin-right: 12px;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
}

.info-title {
    font-size: 1rem;
    font-weight: 800;
    color: var(--primary);
    flex: 1;
}

.info-arrow {
    font-size: 0.8rem;
    color: #9ca3af;
    transition: transform 0.3s ease;
}

/* å±•é–‹æ™‚ç®­é ­æ—‹è½‰ */
.info-card:not(.collapsed) .info-arrow {
    transform: rotate(180deg);
}

/* å…§å®¹å€å¡Šå‹•ç•« */
.info-content {
    background: #f8fafc;
    padding: 0 16px;
    max-height: 1000px; /* è¨­å®šä¸€å€‹è¶³å¤ å¤§çš„é«˜åº¦ */
    opacity: 1;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

/* æ”¶åˆç‹€æ…‹ */
.info-card.collapsed .info-content {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
    opacity: 0;
}

/* å…§å®¹æ’ç‰ˆ */
.info-block {
    padding: 16px 4px;
}

.info-sub-title {
    font-size: 0.9rem;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    margin-bottom: 8px;
    border-bottom: 1px dashed #e2e8f0;
    padding-bottom: 4px;
}
.info-row:last-child {
    border-bottom: none;
}

.info-row span:first-child {
    color: #64748b;
    font-weight: 600;
}
.info-row span:last-child {
    color: #334151;
    font-weight: 700;
    text-align: right;
    max-width: 70%;
}

.info-divider {
    border: none;
    border-top: 1px solid #e2e8f0;
    margin: 0;
}

.info-text {
    font-size: 0.85rem;
    color: #475569;
    line-height: 1.6;
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.info-link-btn {
    display: block;
    width: 100%;
    text-align: center;
    background: white;
    border: 1px solid #cbd5e1;
    color: #475569;
    padding: 10px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 700;
    font-size: 0.85rem;
    margin-top: 12px;
    transition: 0.2s;
}
.info-link-btn:active {
    background: #f1f5f9;
    transform: scale(0.98);
}

/* ============================================
   ğŸ›’ è³¼ç‰©æ¸…å–®å°ˆç”¨æ¨£å¼ (iOS é¢¨æ ¼)
   ============================================ */

/* è¼¸å…¥å€å¡Šå¡ç‰‡ */
.shop-input-card {
    background: white;
    border-radius: 1.2rem;
    padding: 16px;
    margin-bottom: 1.2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.04);
}

.shop-input-row {
    margin-bottom: 12px;
}

.shop-input-row:last-child {
    margin-bottom: 0;
}

/* è¼¸å…¥æ¡†æ¨£å¼ */
.shop-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #E5E7EB;
    border-radius: 10px;
    font-size: 0.9rem;
    background: #F9FAFB;
    outline: none;
    transition: border-color 0.2s;
}

.shop-input:focus {
    border-color: #E76F51;
    background: white;
}

/* æ–°å¢æŒ‰éˆ• */
.btn-add-shop {
    width: 100%;
    padding: 12px;
    background: #E76F51;
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    font-size: 0.95rem;
    box-shadow: 0 4px 10px rgba(231, 111, 81, 0.2);
    transition: transform 0.1s;
}

.btn-add-shop:active {
    transform: scale(0.98);
}

/* === ğŸ›’ è³¼ç‰©æ¸…å–® (ä¸‰æ¬„å°å¡ç‰ˆ) === */

.shop-list-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* é€™è£¡æ”¹æˆ 3 æ¬„ */
    gap: 8px;      /* é–“è·ç¸®å° */
    padding-bottom: 20px;
}

.shop-item-card {
    background: white;
    border-radius: 12px;
    padding: 6px;  /* å…§è·ç¸®å° */
    display: flex;
    flex-direction: column;
    gap: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    position: relative;
    border: 1px solid #f0f0f0;
}

.shop-item-card.checked {
    opacity: 0.6;
    filter: grayscale(0.8);
}

.shop-thumb {
    width: 100%;
    aspect-ratio: 1; /* æ­£æ–¹å½¢ */
    border-radius: 8px;
    object-fit: cover;
    background: #f5f5f5;
}

/* è¿·ä½ åˆªé™¤éˆ• */
.btn-del-mini {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(0,0,0,0.4); /* åŠé€æ˜é»‘åº• */
    border: none;
    color: white;
    font-size: 1rem;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 2;
    padding-bottom: 2px; /* å¾®èª¿ x ä½ç½® */
}

/* å…§å®¹å€ */
.shop-content-mini {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* è¿·ä½ å‹¾å‹¾æŒ‡ç¤º */
.shop-check-mini {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1.5px solid #ccc;
    font-size: 0;
    flex-shrink: 0;
}
.shop-check-mini.checked {
    background: #E76F51;
    border-color: #E76F51;
}

.shop-name-mini {
    font-size: 0.75rem; /* å­—é«”ç¸®å° */
    font-weight: 700;
    color: #444;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* å¤ªé•·çœç•¥ */
}

/* === ğŸ›’ æ”¶åˆå¼è¼¸å…¥ Bar === */

.shop-input-bar-wrapper {
    position: fixed; /* å›ºå®šåœ¨åº•éƒ¨ï¼Œæˆ–è€…ä½ å¯ä»¥é¸æ“‡æ”¾åœ¨åˆ—è¡¨ä¸Šæ–¹ static */
    bottom: calc(2rem + var(--safe-bottom)); /* æ”¾åœ¨åŸæœ¬ FAB çš„ä½ç½®é™„è¿‘ */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 360px;
    z-index: 100;
}

/* 1. æ”¶åˆç‹€æ…‹ (åƒä¸€å€‹æŒ‰éˆ•æ¢) */
.shop-input-collapsed {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-radius: 99px; /* è† å›Šå½¢ç‹€ */
    padding: 12px 20px;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.05);
    transition: transform 0.2s;
}

.shop-input-collapsed:active {
    transform: scale(0.98);
}

/* 2. å±•é–‹ç‹€æ…‹ (å½ˆçª—æ¨£å¼å„ªåŒ–) */
.shop-input-expanded {
    background: white;
    border-radius: 20px;
    padding: 24px 20px; /* å¢åŠ å…§éƒ¨é–“è·ï¼Œè®“å…§å®¹ä¸æ“æ“  */
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    animation: slideUpInput 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    
    width: 90%;          /* ä¿æŒ 90% å¯¬åº¦ */
    max-width: 360px;    /*ç¨å¾®æ”¾å¯¬ä¸€é» */
    margin: 0 auto;      /* æ°´å¹³å±…ä¸­ */
    
    position: relative;  /* ç‚ºäº†æ”¾ç½®é—œé–‰æŒ‰éˆ• */
}

/* æ–°å¢ï¼šå³ä¸Šè§’é—œé–‰æŒ‰éˆ•æ¨£å¼ */
.shop-close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    font-size: 1.5rem;
    color: #999;
    line-height: 1;
    cursor: pointer;
    padding: 4px;
}

@keyframes slideUpInput {
    from { opacity: 0; transform: translateY(20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* ç‚ºäº†é¿å…åº•éƒ¨å…§å®¹è¢«é®ä½ï¼Œçµ¦åˆ—è¡¨åº•éƒ¨åŠ å¤šä¸€é» padding */
.shop-list-container {
    padding-bottom: 100px !important;
}


/* === ğŸ›’ è³¼ç‰©æ¸…å–®æ¨£å¼ === */

/* 1. é ‚éƒ¨éæ¿¾å™¨åˆ— */
.shop-filter-bar {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 4px 2px 12px 2px;
    margin-bottom: 4px;
    /* éš±è—æ²è»¸ä½†å¯æ»‘å‹• */
    scrollbar-width: none; 
    -webkit-overflow-scrolling: touch;
}
.shop-filter-bar::-webkit-scrollbar { display: none; }

.filter-chip {
    padding: 6px 12px;
    background: white;
    border: 1px solid #eee;
    border-radius: 20px;
    font-size: 0.75rem;
    color: #666;
    font-weight: 700;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

/* é¸ä¸­ç‹€æ…‹ï¼šè®Šæˆè—è‰² */
.filter-chip.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
}

/* 2. è¼¸å…¥æ¡†å…§çš„å¿«é€Ÿæ¨™ç±¤åˆ— */
.quick-tag-row {
    display: flex;
    gap: 6px;
    margin-top: 6px;
    overflow-x: auto;
    padding-bottom: 4px;
}

.quick-tag-row span {
    font-size: 0.65rem;
    color: #3b82f6; /* è—è‰²æ–‡å­— */
    background: #eff6ff; /* æ·ºè—åº• */
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
    font-weight: 600;
}

.quick-tag-row span:active {
    background: #dbeafe;
    transform: scale(0.95);
}

/* === ğŸ“ è¡Œææ¸…å–®ç·¨è¼¯å„ªåŒ– === */
.luggage-item-text {
    flex: 1;
    font-size: 0.95rem;
    padding: 6px 4px; /* å¢åŠ é»æ“Šå€åŸŸ */
    margin: 0 4px;
    outline: none;  /* ç§»é™¤é è¨­è—æ¡† */
    border-bottom: 1px solid transparent;
    transition: all 0.2s;
    border-radius: 4px;
}

/* ç·¨è¼¯ä¸­ (Focus) çš„ç‹€æ…‹ */
.luggage-item-text:focus {
    border-bottom: 1px solid #E76F51; /* åº•éƒ¨æ©˜è‰²ç·šæ¢ */
    background: rgba(231, 111, 81, 0.08); /* å¾®å¾®çš„æ©˜è‰²åº• */
    color: #2C3E50;
}

/* å·²å‹¾é¸çš„é …ç›® (åŠƒæ‰æ•ˆæœ + ç°è‰²) */
.luggage-item.checked .luggage-item-text {
    color: #cbd5e1;
    text-decoration: line-through;
    pointer-events: none; /* å‹¾é¸å¾Œç¦æ­¢ç·¨è¼¯ï¼Œé¿å…èª¤è§¸ */
}

/* å³ä¸Šè§’é—œé–‰æŒ‰éˆ•æ¨£å¼ */
.modal-close-btn {
    position: absolute;
    top: 1.2rem;          /* è·é›¢é ‚éƒ¨ */
    right: 1.2rem;        /* è·é›¢å³å´ */
    width: 32px;
    height: 32px;
    background: #f3f4f6;  /* æ·ºç°èƒŒæ™¯ */
    color: #64748b;       /* æ·±ç°æ–‡å­— */
    border-radius: 50%;   /* åœ“å½¢ */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;    /* ç¬¦è™Ÿå¤§å° */
    cursor: pointer;
    z-index: 10;
    transition: 0.2s;
    font-family: sans-serif;
    line-height: 1;
}
.modal-close-btn:active {
    background: #e5e7eb;
    transform: scale(0.9);
}
/* æ—¥æœŸè† å›Šæ¨™ç±¤å®¹å™¨ */
.date-capsule-scroll {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 0 4px 8px 4px; /* ä¸‹æ–¹ç•™é»ç©ºéš™ */
    margin-bottom: 0.5rem;
    -webkit-overflow-scrolling: touch; /* è®“æ»‘å‹•æ›´é †æš¢ */
}
.date-capsule-scroll::-webkit-scrollbar {
    display: none; /* éš±è—æ²è»¸ */
}

/* è† å›ŠæŒ‰éˆ•æ¨£å¼ */
.date-capsule {
    padding: 6px 14px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 700;
    color: #64748b;
    white-space: nowrap;
    cursor: pointer;
    transition: 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* è† å›Šé¸ä¸­ç‹€æ…‹ (æ¨¡ä»¿åœ–ä¸­çš„è—åº•ç™½å­—) */
.date-capsule.active {
    background: #3b82f6; /* äº®è—è‰² */
    color: white;
    border-color: #3b82f6;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

/* è† å›Šå…§çš„æ˜ŸæœŸå¹¾å°å­— */
.date-capsule small {
    font-size: 0.75rem;
    opacity: 0.8;
    font-weight: 500;
}



</style>
</head>
<body>
<!-- Welcome Card -->
<div id="welcome-card" class="welcome-card-wrapper">
<div class="welcome-card-inner">
<div style="font-size: 1.5rem; margin-bottom: 0.4rem; font-weight: 900; color: #2C3E50;">æ²–ç¹©è¨˜å¸³</div>
<div style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">è«‹é¸æ“‡èº«åˆ†ä¸¦é©—è­‰</div>

<!-- 1. ä½¿ç”¨è€…é¸æ“‡å€ (æ”¹ç‚ºé»é¸å¾Œè®Šè‰²) -->
<div id="welcome-user-list" class="welcome-user-list" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 1rem;">
<!-- JS æœƒè‡ªå‹•åœ¨é€™è£¡ç”¢ç”ŸæŒ‰éˆ• -->
</div>

<!-- 2. å¯†ç¢¼è¼¸å…¥å€ -->
<div style="margin-bottom: 1rem;">
<input
type="password"
id="entry-password"
placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; text-align: center; font-size: 1rem; background: #f9f9f9; outline: none; transition: 0.2s;"
>
</div>


<!-- 3. ç¢ºèªæŒ‰éˆ• -->
<button id="btn-login-confirm" onclick="handleLogin()" 
style="width: 100%; padding: 12px; background: #E76F51; color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 12px rgba(231, 111, 81, 0.3);">
ç¢ºèªç™»å…¥
</button>
</div>

</div>


<header style="display: flex; justify-content: space-between; align-items: flex-start;">
<div>
<h1>æ²–ç¹©è¡Œ</h1>
<div class="subtitle">
<span class="badge" id="current-user-badge">5 Days</span>
</div>
</div>

<!-- ğŸ†• æ–°å¢çš„åŒæ­¥æŒ‰éˆ• (æ©˜è‰²æ¡†è™•) -->
<button id="btn-header-sync" onclick="manualSync()" 
style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 8px 12px; 
             box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 6px; 
             font-size: 0.8rem; font-weight: 700; color: #4b5563; transition: transform 0.1s;">
<span id="sync-icon">ğŸ”„</span>
<span id="sync-text">åŒæ­¥</span>
</button>
</header>


<div class="tabs">
  <!-- è¡Œç¨‹ -->
  <div class="tab active" onclick="switchTab(this, 'itinerary')">
    <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/></svg>
    è¡Œç¨‹
  </div>

  <!-- è¨˜å¸³ -->
  <div class="tab" onclick="switchTab(this, 'expense')">
    <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
    è¨˜å¸³
  </div>

 <div class="tab" onclick="switchTab(this, 'breakdown')">
    <svg viewBox="0 0 24 24" fill="currentColor">
        <!-- ä¸»é«” -->
        <path d="M5 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v19l-3-2-2 2-2-2-2 2-2-2-2 2V3z"/>
        <!-- å…§å®¹ç·šæ¢ï¼Œç”¨æ·ºè‰²æˆ–é€æ˜é¤ç©ºå‘ˆç¾ -->
        <path d="M8 6h8M8 10h8M8 14h5" stroke="white" stroke-width="2" stroke-linecap="round"/>
    </svg>
    æ˜ç´°
</div>


  <!-- æ¸…å–® (åŸé¡˜æœ›æ¸…å–®) -->
  <div class="tab" onclick="switchTab(this, 'wishlist')">
    <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
    æ¸…å–®
  </div>

  <!-- è³‡è¨Š (åœ“å½¢ç¶“å…¸ç‰ˆ) -->
<div class="tab" onclick="switchTab(this, 'info')">
    <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
    </svg>
    è³‡è¨Š
</div>

</div>


<!-- ITINERARY VIEW -->
<main id="view-itinerary">
<div class="day-scroll" id="day-list"></div>

<!-- æ–°çš„å¤©æ°£å€å¡Š (WeatherWidget.io) -->
<!-- Weather Widget (ä¿®æ”¹ç‰ˆ) -->
<div class="weather" style="padding: 0; overflow: hidden; display: block; min-height: 98px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px);">
    <a class="weatherwidget-io" 
       href="https://forecast7.com/zh-tw/26d21127d68/okinawa-prefecture/" 
       data-label_1="æ²–ç¹©ãƒ»" 
       data-label_2="å³æ™‚å¤©æ°£" 
       data-font="Arial" 
       data-mode="Current" 
       data-days="5" 
       data-theme="original" 
       data-basecolor=""  
       data-textcolor="#2C3E50" 
       data-highcolor="#d73f45" 
       data-lowcolor="#1b69ad" 
       data-mooncolor="#febc2f" 
       data-cloudcolor="#727272" 
       data-cloudfill="#711515" 
       data-raincolor="#255fb8" >æ²–ç¹©ãƒ»å³æ™‚å¤©æ°£</a>
    <script>
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='https://weatherwidget.io/js/widget.min.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','weatherwidget-io-js');
    </script>
</div>

<div class="list-head">
<h2>è¡Œç¨‹è¡¨</h2>
<span class="hint">é»æ“Šç·¨è¼¯ / å³å´å°èˆª</span>
</div>
<div id="plan-list"></div>
</main>

<!-- EXPENSE VIEW -->
<main id="view-expense" style="display:none">
<div class="exp-summary-card">
<div id="summary-content" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 0;">



<!-- å·¦å´ï¼šåŸå§‹å¹£åˆ¥åˆ†è¡Œ -->
<div style="flex: 1; text-align: left; padding-left: 10px; border-right: 1px solid rgba(255,255,255,0.2);">
<div style="margin-bottom: 8px;">
<span style="font-size: 0.75rem; opacity: 0.8; display: block; margin-bottom: 2px;">ğŸ‡¯ğŸ‡µ æ—¥å¹£æ¶ˆè²»</span>
<span style="font-size: 1.2rem; font-weight: 700;">Â¥ 0</span>
</div>
<div>
<span style="font-size: 0.75rem; opacity: 0.8; display: block; margin-bottom: 2px;">ğŸ‡¹ğŸ‡¼ å°å¹£æ¶ˆè²»</span>
<span style="font-size: 1.2rem; font-weight: 700;">NT$ 0</span>
</div>
</div>

<!-- å³å´ï¼šåŠ ç¸½çµæœ -->
<div style="flex: 1; text-align: center;">
<div style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 4px;">ç¸½è¨ˆç´„ (Total)</div>
<div style="font-size: 1.8rem; font-weight: 900; color: #FFD700;"> <!-- ä½¿ç”¨é‡‘é»ƒè‰²å¼·èª¿ç¸½é¡ -->
<span style="font-size: 1rem; margin-right: 2px;">NT$</span>0
</div>
</div>
</div>

</div>

<!-- QUICK EXPENSE FORM -->
<div class="quick-expense-card" id="quick-expense-card">
<div style="font-size:0.8rem; font-weight:700; margin-bottom:1rem;">
<span id="quick-form-title">å¿«é€Ÿè¨˜å¸³</span>
</div>

<!-- Row 1: æ—¥æœŸã€ç¨®é¡ -->
<div class="quick-expense-row">
<div>
<label>æ—¥æœŸ</label>
<select id="quick-date">
<option value="0">01/06 (ç¬¬1å¤©)</option>
<option value="1">01/07 (ç¬¬2å¤©)</option>
<option value="2">01/08 (ç¬¬3å¤©)</option>
<option value="3">01/09 (ç¬¬4å¤©)</option>
<option value="4">01/10 (ç¬¬5å¤©)</option>
</select>
</div>
<div>
<label>ç¨®é¡</label>
<select id="quick-cat">
<option value="food">ç¾é£Ÿ</option>
<option value="sight">æ™¯é»</option>
<option value="shop">è³¼ç‰©</option>
<option value="trans">äº¤é€š</option>
<option value="other">å…¶ä»–</option>
</select>
</div>
</div>

<!-- Row 2: åç¨±ã€æ”¯ä»˜æ–¹å¼ -->
<div class="quick-expense-row">
<div>
<label>åç¨±</label>
<input type="text" id="quick-title" placeholder="ä¾‹ï¼šåˆé¤">
</div>
<div>
<label>æ”¯ä»˜æ–¹å¼</label>
<select id="quick-pay">
<option value="cash">ç¾é‡‘</option>
<option value="card">ä¿¡ç”¨å¡</option>
</select>
</div>
</div>

<!-- Row 3: é‡‘é¡ã€å¹£åˆ¥ã€è½‰æ› -->
<div class="quick-expense-row" style="align-items: flex-end;">
<div style="flex: 1; position: relative;">
<label>é‡‘é¡</label>
<div style="display: flex; align-items: center; gap: 6px;">
<!-- è† å›Šå‹å¹£åˆ¥åˆ‡æ› -->
<div class="currency-capsule" onclick="toggleCurrency()" style="min-width: 70px; justify-content: center;">
<span id="btn-jpy" class="active" style="cursor: pointer;">Â¥</span>
<span id="btn-twd" style="cursor: pointer;">NT$</span>
</div>
<input type="number" id="quick-amt" min="0" placeholder="0" oninput="updateConversion()" style="flex: 1;">
</div>
<div id="conversion-hint" style="font-size:0.7rem; color:#999; margin-top:4px; min-height:1rem;"></div>
</div>
</div>

<!-- Row 4: åªä¿ç•™åˆ†å¸³æ¨¡å¼ -->
<div class="quick-expense-row">
<div style="flex: 1;">  <!-- è®“åˆ†å¸³æ¨¡å¼ç¨ä½”æ•´è¡Œ -->
<label>åˆ†å¸³æ¨¡å¼</label>
<select id="quick-split-mode" onchange="toggleQuickSplitMode(this.value)">
<option value="none">ä¸åˆ†å¸³</option>
<option value="equal">å¹³å‡åˆ†å¸³</option>
<option value="custom">è‡ªè¨‚åˆ†å¸³</option>
</select>
</div>
</div>


<!-- åˆ†å¸³é¸é … (ç•¶é¸æ“‡åˆ†å¸³æ™‚é¡¯ç¤º) -->
<div id="quick-split-options" style="display:none; margin-top:1rem; padding:1rem; background:#f9fafb; border-radius:0.8rem; border: 1px solid #e5e7eb;">
<div id="quick-equal-mode" style="display:none;">
<div style="font-size:0.7rem; color:#888; font-weight:700; margin-bottom:0.8rem;">é¸æ“‡åƒèˆ‡å¹³å‡åˆ†å¸³çš„äºº</div>
<div id="quick-split-persons" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
</div>
<div id="quick-custom-mode" style="display:none;">
<div style="font-size:0.7rem; color:#888; font-weight:700; margin-bottom:0.8rem;">è‡ªè¨‚æ¯äººåˆ†å¸³é‡‘é¡</div>
<div id="quick-custom-amounts"></div>
</div>
<!-- åˆ†å¸³é è¦½ -->
<div id="quick-split-preview" style="margin-top:0.8rem; padding:0.8rem; background:white; border-radius:0.6rem; border-left:3px solid var(--accent); font-size:0.75rem; color:#666;"></div>
</div>

<!-- æŒ‰éˆ•å€ -->
<div class="quick-expense-footer">
<div style="font-size:0.7rem; color:#9ca3af;" id="quick-hint"></div>
<div style="display:flex; gap:6px; align-items:center;">
<div class="edit-actions" id="edit-actions">
<button type="button" class="btn-delete-inline" onclick="deleteEditingItem()">åˆªé™¤</button>
<button type="button" class="btn-cancel" onclick="cancelEdit()">å–æ¶ˆ</button>
</div>
<button type="button" class="btn-submit" id="btn-quick-submit" onclick="addQuickExpense()">æ–°å¢</button>
</div>
</div>
</div>

	

<!-- å°‡åŸæœ¬çš„ exp-category-card æ›¿æ›ç‚ºæ­¤å€å¡Š  geminiä¿®æ”¹æ¶ˆè²»åˆ†é¡å¡ç‰‡ -->

<div class="exp-category-card-wrapper">
<div class="stat-swipe-wrapper" id="cat-swipe-wrapper" style="display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none;">

<!-- ç¬¬ä¸€é ï¼šæ¶ˆè²»åˆ†é¡ -->
<div class="swipe-card" style="flex: 0 0 100%; min-width: 100%; scroll-snap-align: start; padding: 0 1rem;">
<div style="font-size:0.8rem; font-weight:700; color:#666; margin-bottom:0.8rem;">æ¶ˆè²»åˆ†é¡</div>
<div class="exp-category-grid" id="exp-category-grid"></div>
</div>

<!-- ç¬¬äºŒé ï¼šåˆ†å¸³å°è±¡çµ±è¨ˆ -->
<div class="swipe-card" style="flex: 0 0 100%; min-width: 100%; scroll-snap-align: start; padding: 0 1rem;">
<div style="font-size:0.8rem; font-weight:700; color:#666; margin-bottom:0.8rem;">åˆ†å¸³å°è±¡çµ±è¨ˆ</div>
<div class="exp-category-grid" id="debtor-grid"></div>
</div>

</div>
<!-- æŒ‡ç¤ºé» -->
<div class="swipe-dots" id="cat-swipe-dots" style="display:flex; justify-content:center; gap:6px; margin-top:8px;">
<span class="dot active"></span>
<span class="dot"></span>
</div>
</div>
</main>


<!-- ğŸ†• æ˜ç´° VIEW -->
<main id="view-breakdown" style="display:none">
  <div class="list-head">
    <h2>æ”¯ä»˜æ˜ç´°</h2>
    <span class="hint">é»æ“ŠæŸ¥çœ‹è©³ç´°åˆ†å¸³</span>
  </div>
  
		<!-- [æ–°å¢] æ—¥æœŸæ¨™ç±¤å®¹å™¨ -->
		<div id="expense-day-scroll" class="date-capsule-scroll">
  </div>
  
  <div id="expense-list-container">
    <div id="expense-list"></div>
  </div>
</main>


  
<!-- æ¸…å–® VIEW (åŸé¡˜æœ›æ¸…å–®) -->
<main id="view-wishlist" style="display:none">
   
    <!-- é ‚éƒ¨åˆ‡æ›å™¨ -->
    <div class="wishlist-tabs" style="display:flex; background:rgba(255,255,255,0.5); padding:4px; border-radius:12px; margin-bottom:1rem;">
        <div class="wish-tab active" onclick="switchWishTab('luggage')" style="flex:1; text-align:center; padding:8px; font-weight:700; font-size:0.9rem; border-radius:10px; cursor:pointer; transition:0.2s;">ğŸ§³ è¡Œææ¸…å–®</div>
        <div class="wish-tab" onclick="switchWishTab('shopping')" style="flex:1; text-align:center; padding:8px; font-weight:700; font-size:0.9rem; border-radius:10px; cursor:pointer; transition:0.2s; color:#888;">ğŸ›ï¸ è³¼ç‰©æ¸…å–®</div>
    </div>

    <!-- è¡Œææ¸…å–®å€å¡Š -->
    <div id="wish-view-luggage">
  <div class="hint" style="margin-bottom:10px; display:inline-block;">é»æ“Šæ–‡å­—å¯åˆªé™¤è‡ªè¨‚é …ç›®</div>
  <div id="luggage-list-container"></div>
</div>

<div id="wish-view-shopping" style="display:none;">
  <div id="shopping-list-container"></div>
  <div class="hint" style="margin-bottom:10px; display:inline-block;">é»æ“Šå¡ç‰‡ç·¨è¼¯ / æ‰“å‹¾æ¨™è¨˜å·²è³¼</div>
  <div class="wish-grid" id="wish-list"></div>
</div>

</main>


<!-- ğŸ†• è³‡è¨Š VIEW (æ”¹ç‰ˆï¼šæ—…éŠé‡è¦è³‡è¨Š) -->
<main id="view-info" style="display:none">
 

  <div class="info-container">
    
<!-- 1. èˆªç­è³‡è¨Š -->
<div class="info-card collapsed" onclick="toggleInfoCard(this)">
    <div class="info-header">
        <span class="info-icon">âœˆï¸</span>
        <span class="info-title">èˆªç­è³‡è¨Š</span>
        <span class="info-arrow">â–¼</span>
    </div>
    <div class="info-content">
        
        <!-- å»ç¨‹ -->
        <div class="info-block">
            <div class="info-sub-title" style="color:#E76F51;">å»ç¨‹ (TPE â†’ OKA)</div>
            <div class="info-row"><span>æ—¥æœŸ</span><span>01/06 (äºŒ)</span></div>
            <div class="info-row"><span>æ™‚é–“</span><span>06:35 æ¡ƒåœ’ â†’ 08:55 é‚£éœ¸</span></div>
            <div class="info-row"><span>èˆªç­</span><span>è™èˆª IT230</span></div>
            
            <!-- æ–°å¢ï¼šèˆªç­å‹•æ…‹é€£çµ -->
            <a href="https://www.google.com/search?q=IT230+èˆªç­å‹•æ…‹" target="_blank" class="info-link-btn" style="margin-top:8px;">
                ğŸ” æŸ¥è©¢å‹•æ…‹
            </a>
        </div>
        
        <hr class="info-divider">
        
        <!-- å›ç¨‹ -->
        <div class="info-block">
            <div class="info-sub-title" style="color:#E76F51;">å›ç¨‹ (OKA â†’ TPE)</div>
            <div class="info-row"><span>æ—¥æœŸ</span><span>01/10 (å…­)</span></div>
            <div class="info-row"><span>æ™‚é–“</span><span>09:45 é‚£éœ¸ â†’ 10:20 æ¡ƒåœ’</span></div>
            <div class="info-row"><span>èˆªç­</span><span>è™èˆª IT231</span></div>
            
            <!-- æ–°å¢ï¼šèˆªç­å‹•æ…‹é€£çµ -->
            <a href="https://www.google.com/search?q=IT231+èˆªç­å‹•æ…‹" target="_blank" class="info-link-btn" style="margin-top:8px;">
                ğŸ” æŸ¥è©¢å‹•æ…‹
            </a>
        </div>

    </div>
</div>


    <!-- 2. ä½å®¿è³‡è¨Š -->
    <div class="info-card collapsed" onclick="toggleInfoCard(this)">
      <div class="info-header">
        <span class="info-icon">ğŸ </span>
        <span class="info-title">ä½å®¿è³‡è¨Š</span>
        <span class="info-arrow">â–¼</span>
      </div>
      <div class="info-content">
        <div class="info-block">
          <div class="info-sub-title">Chateau TIIDA</div>
          <div class="info-row"><span>åœ°å€</span><span>æ²–ç¹©ç¸£é‚£éœ¸å¸‚å®‰é‡Œ3ä¸ç›®12-13</span></div>
          <div class="info-row"><span>å…¥ä½</span><span>16:00 å¾Œ (å¯†ç¢¼é–)</span></div>
          <div class="info-row"><span>é€€æˆ¿</span><span>10:00 å‰</span></div>
          <div class="info-row"><span>å‚™è¨»</span><span>åƒåœ¾éœ€åˆ†é¡ï¼Œä¿æŒæ•´æ½”</span></div>
        </div>
      </div>
    </div>

    <!-- 3. ç§Ÿè»Šè³‡è¨Š -->
    <div class="info-card collapsed" onclick="toggleInfoCard(this)">
      <div class="info-header">
        <span class="info-icon">ğŸš—</span>
        <span class="info-title">ç§Ÿè»Š</span>
        <span class="info-arrow">â–¼</span>
      </div>
	  
	  <div class="info-content">
	   
        <div class="info-block">
          <div class="info-sub-title">OTS ç§Ÿè»Š(è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€)</div>
          <div class="info-row"><span>é ç´„è™Ÿ</span><span>OTS1396720</span></div>
          <div class="info-row"><span>å–è»Š</span><span>01/06 10:00</span></div>
          <div class="info-row"><span>é‚„è»Š</span><span>01/09 19:00</span></div>
          <div class="info-row"><span>è»Šå‹</span><span>Toyota Sienta(7äººåº§)</span></div>
          
		  <div class="info-text">
            <b>âš ï¸ æ³¨æ„äº‹é …ï¼š</b><br>
            1. å–è»Šéœ€å‚™å¦¥ï¼šå°ç£é§•ç…§ã€æ—¥æ–‡è­¯æœ¬ã€è­·ç…§ã€‚<br>
            2. é‚„è»Šå‰è«‹åŠ æ»¿æ²¹ (Regular ç´…è‰²æ²¹æ§)ã€‚<br>
			3.ã€Œå·¦è½‰è½‰å°å½ã€å³è½‰è½‰å¤§å½ï¼›é›¨åˆ·åœ¨å·¦ã€æ–¹å‘ç‡ˆåœ¨å³ã€
          </div>
        </div>
		
      </div>
	  
    </div>

<!-- === æ–°å¢ï¼šæŠ˜åƒ¹åˆ¸ (åœ–ç‰‡ç‰ˆ) === -->
<div class="info-card collapsed" onclick="toggleInfoCard(this)">
    <div class="info-header">
        <span class="info-icon">ğŸŸï¸</span>
        <span class="info-title">æŠ˜åƒ¹åˆ¸</span>
        <span class="info-arrow">â–¼</span>
    </div>
    <div class="info-content">
        <div class="info-block" style="padding: 10px;">
            
            <div style="display: flex; flex-direction: column; gap: 10px;">

                <!-- 1. å”å‰è¨¶å¾· (ç™½åº•æ¨£å¼) -->
                <a href="https://reurl.cc/54yOlV" target="_blank" 
                   style="display: flex; justify-content: space-between; align-items: center; background: white; color: #2C3E50; border: 1px solid #eee; padding: 12px 16px; border-radius: 10px; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2rem;">ğŸ§</span>
                        <span style="font-weight: 500;">å”å‰è¨¶å¾·</span>
                    </div>
                    <span style="font-size: 0.7rem; background: #E76F51; color: white; padding: 3px 6px; border-radius: 999px; font-weight: 550;">æœ€é«˜ 17%</span>
                </a>

                <!-- 2. Bic Camera -->
                <a href="https://d1grca2t3zpuug.cloudfront.net/2025/06/biccameracoupontwhk-1787x2527-1750209030.webp" target="_blank" 
                   style="display: flex; justify-content: space-between; align-items: center; background: white; color: #2C3E50; border: 1px solid #eee; padding: 12px 16px; border-radius: 10px; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2rem;">ğŸ“·</span>
                        <span style="font-weight: 505;">Bic Camera</span>
                    </div>
                    <span style="font-size: 0.7rem; background: #E76F51; color: white; padding: 3px 6px; border-radius: 999px; font-weight: 550;">æœ€é«˜ 17%</span>
                </a>

                <!-- 3. æ¾æœ¬æ¸… -->
                <a href="https://d1grca2t3zpuug.cloudfront.net/2025/01/20250131matsucoupontw-1631x2475.webp" target="_blank" 
                   style="display: flex; justify-content: space-between; align-items: center; background: white; color: #2C3E50; border: 1px solid #eee; padding: 12px 16px; border-radius: 10px; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2rem;">ğŸ’Š</span>
                        <span style="font-weight: 500;">æ¾æœ¬æ¸…</span>
                    </div>
                    <span style="font-size: 0.7rem; background: #E76F51; color: white; padding: 3px 6px; border-radius: 999px; font-weight: 550;">æœ€é«˜ 17%</span>
                </a>

                <!-- 4. å¤§åœ‹è—¥å¦ -->
                <a href="https://d1grca2t3zpuug.cloudfront.net/2023/08/daikokucoupon-1751874722.webp" target="_blank" 
                   style="display: flex; justify-content: space-between; align-items: center; background: white; color: #2C3E50; border: 1px solid #eee; padding: 12px 16px; border-radius: 10px; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2rem;">ğŸ’Š</span>
                        <span style="font-weight: 500;">å¤§åœ‹è—¥å¦</span>
                    </div>
                    <span style="font-size: 0.7rem; background: #E76F51; color: white; padding: 3px 6px; border-radius: 999px; font-weight: 550;">æœ€é«˜ 18%</span>
                </a>

                <!-- 5. æ›´å¤šå„ªæƒ åˆ¸æ•´ç† -->
                <a href="https://www.letsgojp.com/coupons" target="_blank" class="info-link-btn" style="margin-top:8px;">
                ğŸ” æŸ¥çœ‹æ›´å¤šå„ªæƒ åˆ¸
            </a>
            </div>
        </div>
    </div>
</div>


<!-- 4. é ç´„/è¨‚ä½ -->
<div class="info-card collapsed" onclick="toggleInfoCard(this)">
    <div class="info-header">
        <span class="info-icon">ğŸ«</span>
        <span class="info-title">é ç´„ / è¨‚ä½</span>
        <span class="info-arrow">â–¼</span>
    </div>
    <div class="info-content">
        
        <!-- ç‰çƒä¹‹ç‰› -->
        <div class="info-row" style="padding: 12px 0; border-bottom: 1px dashed #eee; align-items: center;">
            <span style="font-size: 0.85rem; font-weight: 700; color: #E76F51;">ç‰çƒä¹‹ç‰› åœ‹éš›é€š</span>
            <span style="font-size: 0.85rem; font-weight: 700; color: #2C3E50;">01/06 21:00</span>
        </div>
        
        <!-- ç‰è£ -->
        <div class="info-row" style="padding: 12px 0; border-bottom: 1px dashed #eee; align-items: center;">
            <span style="font-size: 0.85rem; font-weight: 700; color: #E76F51;">ç‰è£…ã‚¹ã‚¿ã‚¸ã‚ª ã¡ã‚…ã‚‰ç¾äºº</span>
            <span style="font-size: 0.85rem; font-weight: 700; color: #2C3E50;">01/07 14:30</span>
        </div>

        <!-- Gangala -->
        <div class="info-row" style="padding: 12px 0; border-bottom: none; align-items: center;">
            <span style="font-size: 0.85rem; font-weight: 700; color: #E76F51;">Gangalaä¹‹è°·</span>
            <span style="font-size: 0.85rem; font-weight: 700; color: #2C3E50;">01/09 11:00</span>
        </div>

    </div>
</div>

<!-- 5. ç·Šæ€¥è¯çµ¡ (ä¿®æ­£ç‰ˆ) -->
<div class="info-card collapsed" onclick="toggleInfoCard(this)">
    <div class="info-header">
        <span class="info-icon">âš ï¸</span>
        <span class="info-title">ç·Šæ€¥è¯çµ¡</span>
        <span class="info-arrow">â–¼</span>
    </div>
     <div class="info-content">
        <div class="info-block" style="padding: 10px;">
            <div class="info-text" style="line-height: 1.6; padding: 15px;">
                
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 1rem; color: #2C3E50;">
                        å ±è­¦ <span style="font-weight: 900; color: #E76F51;">110</span> / 
                        æ•‘è­·è»Š <span style="font-weight: 900; color: #E76F51;">119</span>
                    </div>
                </div>

                <div style="margin-bottom: 18px;">
                    <div style="font-weight: 700; color: #475569; font-size: 0.8rem;">å°åŒ—é§æ—¥ä»£è¡¨é‚£éœ¸åˆ†è™•ï¼š</div>
                    <a href="tel:098-862-7008" style="font-weight: 600; color: #E76F51; font-size: 0.8rem; text-decoration: none; letter-spacing: 0.5px;">
                        098-862-7008
                    </a>
                </div>

				<div style="margin-bottom: 18px;">
                    <div style="font-weight: 700; color: #475569; font-size: 0.8rem;">æ²–ç¹© OTSç§Ÿè»Šé ç´„ä¸­å¿ƒï¼š</div>
                    <a href="tel:022-719-1960" style="font-weight: 600; color: #E76F51; font-size: 0.8rem; text-decoration: none; letter-spacing: 0.5px;">
                        022-719-1960
                    </a>
                </div>


                <div>
                    <div style="font-weight: 700; color: #475569; font-size: 0.8rem;">ç·Šæ€¥è¯çµ¡é›»è©± (æ€¥é›£æ•‘åŠ©ç”¨)ï¼š</div>
                    <a href="tel:080-8056-0122" style="font-weight: 600; color: #E76F51; font-size: 0.8rem; text-decoration: none; letter-spacing: 0.5px;">
                        080-8056-0122
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>

  </div>
</main>




<div class="overlay" id="modal-overlay">
<div class="modal">
<h2 id="modal-title">æ–°å¢é …ç›®</h2>
<form id="add-form" autocomplete="off">
<div class="form-row" id="field-time">
<label>æ™‚é–“</label>
<input type="time" id="add-time" required>
</div>
<div class="form-row">
<label>åç¨± / æ¨™é¡Œ</label>
<input type="text" id="add-title" maxlength="32" required placeholder="ä¾‹å¦‚ï¼šåœ‹éš›é€šé€›è¡—">
</div>
<div class="form-row" id="field-loc">
<label>åœ°é» / å‚™è¨»</label>
<input type="text" id="add-loc" maxlength="64" placeholder="ä¾‹å¦‚ï¼šå–®è»Œç¸£å»³å‰ç«™">
</div>
<div class="form-row">
<label>ç¨®é¡æ¨™ç±¤</label>
<div class="cats" id="cat-list"></div>
</div>
<!-- åŸæœ¬çš„ç¨‹å¼ç¢¼ç‰‡æ®µ -->
<div id="wish-fields" style="display:none">
    <div class="form-row">
        <label>åœ–ç‰‡ URL (è²¼ä¸Šç¶²å€è‡ªå‹•é è¦½)</label> <!-- ä¿®æ”¹ label æç¤º -->
        
        <!-- ğŸ‘‡ ä¿®æ”¹é€™è¡Œï¼šåŠ å…¥ oninput äº‹ä»¶ -->
        <input type="text" id="wish-img-url" placeholder="é•·æŒ‰è²¼ä¸Šåœ–ç‰‡ç¶²å€..." oninput="handleImageInput(this)">
        
        <!-- ğŸ‘‡ æ–°å¢é€™è¡Œï¼šç”¨ä¾†é¡¯ç¤ºé è¦½åœ– -->
        <img id="preview-img" src="" style="display:none; width:100%; height:150px; object-fit:contain; margin-top:10px; border-radius:8px; background:#f0f0f0; border:1px dashed #ccc;">
        
        <!-- ğŸ‘‡ æ–°å¢é€™è¡Œï¼šéŒ¯èª¤æç¤ºè¨Šæ¯ -->
        <div id="img-error-msg" style="display:none; font-size:0.75rem; color:#ef4444; margin-top:4px;">âš ï¸ åœ–ç‰‡ç„¡æ³•è®€å–ï¼Œè«‹æ›ä¸€å¼µä¾†æº (æ¨è–¦ç¶­åŸºç™¾ç§‘/å¤§å‹é›»å•†)</div>
    </div>
</div>

<button type="submit" class="btn-save">å„²å­˜</button>
<button type="button" class="btn-del" onclick="deleteItem()">åˆªé™¤ç´€éŒ„</button>
</form>
</div>
</div>



<!-- 1. å¤–å±¤ div åŠ å…¥ onclickï¼šé»æ“Šç©ºç™½èƒŒæ™¯æ™‚é—œé–‰ -->
<div class="overlay" id="edit-expense-overlay" onclick="if(event.target === this) closeEditModal()">
    
    <!-- 2. å…§å±¤ modal åŠ å…¥ style="position:relative" ä»¥ä¾¿å®šä½é—œé–‰æŒ‰éˆ• -->
    <div class="modal" style="position: relative;">
        
        <!-- 3. æ–°å¢ï¼šå³ä¸Šè§’é—œé–‰æŒ‰éˆ• -->
        <div class="modal-close-btn" onclick="closeEditModal()">Ã—</div>

        <h2 style="margin-bottom:1rem;">ç·¨è¼¯æ¶ˆè²»</h2>

<!-- ç°¡å–®çš„ç·¨è¼¯è¡¨å–® -->
<div class="form-row">
<label>åç¨±</label>
<input type="text" id="edit-title">
</div>
<div class="form-row">
<label>é‡‘é¡</label>
<input type="number" id="edit-amt">
</div>
<div class="form-row">
<label>ç¨®é¡</label>
<select id="edit-cat">
<option value="food">ç¾é£Ÿ</option>
<option value="sight">æ™¯é»</option>
<option value="shop">è³¼ç‰©</option>
<option value="trans">äº¤é€š</option>
<option value="other">å…¶ä»–</option>
</select>
</div>
<div class="form-row">
<label>æ”¯ä»˜æ–¹å¼</label>
<select id="edit-pay">
<option value="cash">ç¾é‡‘</option>
<option value="card">ä¿¡ç”¨å¡</option>
</select>
</div>

<p style="font-size:0.7rem; color:#999; margin-bottom:1.5rem;">* å¦‚éœ€ä¿®æ”¹åˆ†å¸³ç´°ç¯€ï¼Œè«‹åˆªé™¤å¾Œé‡æ–°è¨˜å¸³ã€‚</p>

<button type="button" class="btn-save" onclick="saveEditedExpense()">å„²å­˜ä¿®æ”¹</button>
<button type="button" class="btn-del" onclick="softDeleteExpense()">åˆªé™¤</button>
</div>
</div>

<script>
// ===== Google Apps Script é€£å‹•ï¼ˆå«å¯†ç¢¼é©—è­‰ï¼‰=====

const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzBhwYQ5YJ49E87CnyxToegFM8v3jjjfPplyv0gyiG-eWqXQLoDjnaFm0mF-qAc-wXB/exec';
// ğŸ‘† æ›¿æ›æˆä½ éƒ¨ç½²å¾Œè¤‡è£½çš„ URL

let selectedUserForLogin = null; // æš«å­˜ç›®å‰é¸ä¸­çš„ç™»å…¥è€…

let sheetsReady = true;

// ğŸ†• åŒæ­¥è¨˜å¸³åˆ° Google Sheetsï¼ˆä½¿ç”¨ä½¿ç”¨è€…è¼¸å…¥çš„å¯†ç¢¼ï¼‰
async function syncExpenseToSheet(expense) {
try {
console.log('ğŸ”„ æ­£åœ¨åŒæ­¥è¨˜å¸³åˆ° Google Sheets...');

const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
method: 'POST',
body: JSON.stringify({
id: expense.id,
date: expense.date,
cat: expense.cat,
title: expense.title,
amt: expense.amt,
currency: expense.currency,
payBy: expense.payBy,
payMethod: expense.payMethod,
advanceFor: expense.advanceFor || [],
splitDetails: expense.splitDetails || null, 
secretKey: userEnteredSecret  // âœ… æ”¹ç”¨ä½¿ç”¨è€…è¼¸å…¥çš„å€¼
})
});

const result = await response.json();

if (result.status === 'success') {
console.log('âœ… è¨˜å¸³å·²åŒæ­¥åˆ° Google Sheets');
updateSyncStatus('âœ… å·²åŒæ­¥åˆ° Google Sheets');
} else {
console.error('âŒ åŒæ­¥å¤±æ•—:', result.message);
updateSyncStatus('âŒ ' + result.message);
}
} catch (err) {
console.error('âŒ ç¶²è·¯éŒ¯èª¤:', err);
updateSyncStatus('âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
}
}

// ğŸ†• å¾ Google Sheets è®€å–è³‡æ–™ï¼ˆä½¿ç”¨ä½¿ç”¨è€…è¼¸å…¥çš„å¯†ç¢¼ï¼‰
async function loadExpensesFromSheet() {
try {
console.log('ğŸ“– æ­£åœ¨è®€å– Google Sheets è³‡æ–™...');

const response = await fetch(
`${GOOGLE_APPS_SCRIPT_URL}?secretKey=${encodeURIComponent(userEnteredSecret)}`  // âœ… æ”¹ç”¨ä½¿ç”¨è€…è¼¸å…¥çš„å€¼
);

const result = await response.json();

if (result.status === 'success') {
console.log('âœ… æˆåŠŸè®€å–', result.count, 'ç­†è¨˜å¸³');
updateSyncStatus('âœ… å·²é€£æ¥ Google Sheets');
return result.data;
} else {
console.error('âŒ è®€å–å¤±æ•—:', result.message);
updateSyncStatus('âŒ ' + result.message);
return [];
}
} catch (err) {
console.log('âš ï¸ ç„¡æ³•é€£æ¥ Google Sheets');
return [];
}
}

// ğŸ†• æ›´æ–°åŒæ­¥ç‹€æ…‹é¡¯ç¤º
function updateSyncStatus(message) {
const statusEl = document.getElementById('sync-status');
if (statusEl) {
statusEl.textContent = message;
setTimeout(() => {
statusEl.textContent = '';
}, 3000);
}
}

// ===== çµæŸ Google Apps Script é€£å‹• =====



// --- DATA ---
const DAYS = [
{ num: 1, label: '01/06', week: 'é€±äºŒ' },
{ num: 2, label: '01/07', week: 'é€±ä¸‰' },
{ num: 3, label: '01/08', week: 'é€±å››' },
{ num: 4, label: '01/09', week: 'é€±äº”' },
{ num: 5, label: '01/10', week: 'é€±å…­' }
];

// âœ… æ¸…ç©ºæ‰€æœ‰é è¨­è³‡æ–™
const PLAN = [
[{ time: '04:10', cat: 'trans', title: 'ç™»æ©Ÿæº–å‚™', loc: 'æ¡ƒåœ’æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', id: 101 },
{ time: '08:55', cat: 'trans', title: 'æŠµé”æ²–ç¹©ï¼Œç­‰å¾…ç§Ÿè»Šå…¬å¸', loc: 'é‚£éœ¸æ©Ÿå ´', id: 102 },
{ time: '10:00', cat: 'food', title: 'A&W é£Ÿæ—©é¤', loc: 'A&W Makiminato ç‰§æ¸¯åº—', id: 103 },
{ time: '11:00', cat: 'sight', title: 'åƒè§€æ°´æ—é¤¨', loc: 'æ²–ç¸„ç¾ã‚‰æµ·æ°´æ—é¤¨', id: 104 },
{ time: '13:00', cat: 'food', title: 'åƒæµ·è†½é£¯', loc: 'Shirasa é£Ÿå ‚', id: 105 },
{ time: '14:00', cat: 'sight', title: 'å¤å®‡åˆ©å³¶', loc: 'å¤å®‡åˆ©å³¶', id: 106 },
{ time: '15:30', cat: 'food', title: 'å’–å•¡å»³ä¼‘æ¯', loc: 'Shinmei Coffee', id: 107 },
{ time: '17:30', cat: 'trans', title: 'å›æ°‘å®¿', loc: 'Chateau TIIDA', id: 108 },
{ time: '20:00', cat: 'other', title: 'æ°‘å®¿æ•´å‚™ä¼‘æ¯', loc: 'Chateau TIIDA', id: 109 },
{ time: '21:00', cat: 'food', title: 'æ™šé¤æ™‚é–“', loc: 'ç‰çƒä¹‹ç‰› é‚£éœ¸åœ‹éš›é€šï¼ˆ3Fï¼‰', id: 110 },
{ time: '23:00', cat: 'shop', title: 'æ™šé¤å¾Œé€›è¡—å›å®¶', loc: 'é‚£è¦‡å›½éš›é€š', id: 111 }], 

[{ time: '09:30', cat: 'trans', title: 'å‰å¾€èµ¤å¶ºç«™', loc: 'èµ¤å¶ºé§…ï¼ã‚ã‹ã¿ã­ãˆã', id: 201 },
{ time: '10:30', cat: 'sight', title: 'æ¼«ç•«å€‰', loc: 'æ¼«ç•«å€‰åº« é‚£éœ¸åº—', id: 202 },
{ time: '11:30', cat: 'sight', title: 'äºŒæ‰‹ç²¾å“', loc: 'ã‚»ã‚«ãƒ³ãƒ‰ã‚¹ãƒˆãƒªãƒ¼ãƒˆèµ¤å¶ºåº—', id: 203 },
{ time: '12:30', cat: 'food', title: 'åˆé¤', loc: 'é­šå±‹ç›´ç‡Ÿé£Ÿå ‚', id: 204 },
{ time: '13:00', cat: 'sight', title: 'æ°¸æ—ºAEON', loc: 'AEON MALL Okinawa Rycom', id: 205 },
{ time: '15:30', cat: 'sight', title: 'ç‰çƒæœ/å’Œæœ', loc: 'ç‰è£…ã‚¹ã‚¿ã‚¸ã‚ª ã¡ã‚…ã‚‰ç¾äºº ç‰æœç¾äºº', id: 206 },
{ time: '17:00', cat: 'food', title: 'æ³¢ä¸Šå®®', loc: 'æ³¢ä¸Šå®®', id: 207 },
{ time: '17:30', cat: 'trans', title: 'å›åœ‹éš›é€š', loc: 'é‚£è¦‡å›½éš›é€š', id: 208 },
{ time: '18:00', cat: 'food', title: 'æ™šé¤', loc: 'ç‰å®¶æ‹‰éºµ åœ‹éš›é€šæœ¬åº—', id: 209 },], 
[], 
[{ time: '09:30', cat: 'trans', title: 'å‰å¾€ç‰æ³‰æ´', loc: 'ç‰æ³‰æ´', id: 401 },
{ time: '10:00', cat: 'sight', title: 'ç‰æ³‰æ´è§€è³', loc: 'ç‰æ³‰æ´', id: 402 },
{ time: '11:00', cat: 'sight', title: 'Gangalaä¹‹è°·è§€è³', loc: 'Gangalaä¹‹è°·', id: 403 },], 
	
[{ time: '06:00', cat: 'trans', title: 'é€€æˆ¿å‰å¾€é‚£éœ¸æ©Ÿå ´', loc: 'é‚£éœ¸æ©Ÿå ´', id: 501 },
{ time: '8:30', cat: 'trans', title: 'ç™»æ©Ÿæº–å‚™', loc: 'é‚£éœ¸æ©Ÿå ´', id: 502 },
{ time: '10:20', cat: 'trans', title: 'å›æº«æš–çš„å®¶', loc: 'æ¡ƒåœ’æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', id: 503 },]
];

let EXPENSE = [
[], [], [], [], []
];

const WISHLIST = [];

const CATEGORIES = [
// é€™è£¡æ–°å¢äº† hex å±¬æ€§ï¼Œç”¨ä¾†åšå‹•æ…‹ä¸Šè‰²
{ key:'sight', label:'æ™¯é»', color:'bg-sight', hex:'#3b82f6', light:'#eff6ff' }, // è—
{ key:'food', label:'ç¾é£Ÿ', color:'bg-food', hex:'#f97316', light:'#fff7ed' },  // æ©˜
{ key:'shop', label:'è³¼ç‰©', color:'bg-shop', hex:'#ec4899', light:'#fdf2f8' },  // ç²‰
{ key:'trans', label:'äº¤é€š', color:'bg-trans', hex:'#64748b', light:'#f8fafc' }, // ç°
{ key:'other', label:'å…¶ä»–', color:'bg-other', hex:'#10b981', light:'#ecfdf5' }  // ç¶ 
];

let userEnteredSecret = ""; // åˆå§‹ç‚ºç©º

const MEMBERS = ['è¨±æ³¢', 'æ–¹å‰', 'åƒåˆ', 'ä¾‘ç„„', 'å®¶éŠ˜'];

// --- STATE ---
let currentUser = null;
let curTab = 'itinerary';
let curDay = 0;
let editingItem = null;
let editingType = null;
let statMode = 'personal';
let editingId = null;



// é è¨­è¡Œææ¸…å–®
const DEFAULT_LUGGAGE = [
    { cat: 'è­‰ä»¶éŒ¢åŒ…', items: ['è­·ç…§', 'æ—¥å¹£', 'å°å¹£', 'ä¿¡ç”¨å¡', 'è¥¿ç“œå¡', 'é§•ç…§(è­¯æœ¬)'] },
    { cat: 'é›»å­ç”¢å“', items: ['æ‰‹æ©Ÿ', 'å……é›»å™¨', 'è¡Œå‹•é›»æº', 'ç¶²å¡/æ¼«éŠ', 'è½‰æ¥é ­'] },
    { cat: 'è¡£ç‰©', items: ['å…§è¡£è¤²', 'è¥ªå­', 'ç¡è¡£', 'å¤–å¥—', 'å¸½å­', 'å¥½èµ°çš„é‹'] },
    { cat: 'ç›¥æ´—/ä¿é¤Š', items: ['ç‰™åˆ·ç‰™è†', 'æ¯›å·¾', 'æ´—é¢ä¹³', 'å¸å¦æ²¹', 'ä¿é¤Šå“', 'é˜²æ›¬'] },
    { cat: 'å…¶ä»–', items: ['å¸¸å‚™è—¥', 'é›¨å‚˜', 'å¡‘è† è¢‹(è£é«’è¡£)', 'ç­†'] }
];

// ä½¿ç”¨è€…è¡Œæç‹€æ…‹ (æœƒå­˜å…¥ LocalStorage)
let myLuggage = {
    checked: [], // å·²å‹¾é¸é …ç›®
    custom: []   // è‡ªè¨‚é …ç›®
};
let myShoppingList = JSON.parse(localStorage.getItem('my_shopping_list')) || [];

// åˆ‡æ›æ¸…å–®åˆ†é  (è¡Œæ vs è³¼ç‰©)
function switchWishTab(mode) {
    // 1. éš±è—æ‰€æœ‰è¦–åœ–
    document.getElementById('wish-view-luggage').style.display = 'none';
    document.getElementById('wish-view-shopping').style.display = 'none';

    // 2. ç§»é™¤æ‰€æœ‰ Tab çš„ active ç‹€æ…‹
    const tabs = document.querySelectorAll('.wish-tab');
    tabs.forEach(t => {
        t.classList.remove('active');
        // ç¢ºä¿é¡è‰²è¢« CSS æ§åˆ¶ï¼Œç§»é™¤è¡Œå…§æ¨£å¼å¹²æ“¾ (å¦‚æœæœ‰)
        t.style.color = ''; 
        t.style.background = '';
    });

    // 3. æ ¹æ“šé¸ä¸­çš„æ¨¡å¼è™•ç†
    if (mode === 'luggage') {
        document.getElementById('wish-view-luggage').style.display = 'block';
        // æ‰¾åˆ°ç¬¬ä¸€å€‹ tab (è¡Œæ) ä¸¦è¨­ç‚º active
        tabs[0].classList.add('active');
        
        // é¡¯ç¤º FAB (å¦‚æœæ˜¯è¡Œææ¸…å–®éœ€è¦çš„è©±)
        const fab = document.getElementById('btn-add');
        if(fab) fab.style.display = 'flex';

    } else {
        document.getElementById('wish-view-shopping').style.display = 'block';
        // æ‰¾åˆ°ç¬¬äºŒå€‹ tab (è³¼ç‰©) ä¸¦è¨­ç‚º active
        tabs[1].classList.add('active');
        
        renderWishlist(); // ç¢ºä¿è³¼ç‰©æ¸…å–®é‡æ–°æ¸²æŸ“
        
        // éš±è—ä¸» FAB (å› ç‚ºè³¼ç‰©æ¸…å–®æœ‰è‡ªå·±çš„è¼¸å…¥æ¡†)
        const fab = document.getElementById('btn-add');
        if(fab) fab.style.display = 'none';
    }
}


// âœ¨ æ”¹é€²ç‰ˆï¼šå¡ç‰‡å…§ç›´æ¥æ–°å¢ + çµ±ä¸€è¡¨å–®

function renderLuggageList() {
    const container = document.getElementById('luggage-list-container');
    if (!container) return;
    
    container.innerHTML = '';

    // A. æ¸²æŸ“é è¨­åˆ†é¡
    DEFAULT_LUGGAGE.forEach((group, groupIdx) => {
        // å»ºç«‹å¡ç‰‡å®¹å™¨
        const cardDiv = document.createElement('div');
        cardDiv.className = 'luggage-category-card';
        cardDiv.dataset.category = group.cat;  // æ¨™è¨˜åˆ†é¡åç¨±
        
        // æ¨™é¡Œ
        const titleDiv = document.createElement('div');
        titleDiv.className = 'luggage-cat-title';
        titleDiv.textContent = group.cat;
        
        // é …ç›®åˆ—è¡¨
        const gridDiv = document.createElement('div');
        gridDiv.className = 'luggage-grid';
        

// 1. é‡å° DEFAULTLUGGAGE çš„è¿´åœˆ
group.items.forEach(item => {
    const isChecked = myLuggage.checked.includes(item);
    const itemDiv = document.createElement('div');
    itemDiv.className = `luggage-item ${isChecked ? 'checked' : ''}`;

    // A. Checkbox
    const checkbox = document.createElement('div');
    checkbox.className = 'luggage-checkbox';
    checkbox.onclick = (e) => {
        e.stopPropagation(); // é˜»æ­¢å†’æ³¡
        toggleLuggageItem(item);
    };

    // B. å¯ç·¨è¼¯æ–‡å­— span
    const textSpan = document.createElement('span');
    textSpan.className = 'luggage-item-text';
    textSpan.innerText = item;
    
    // å¦‚æœæ²’æ‰“å‹¾ï¼Œå…è¨±ç·¨è¼¯
    if (!isChecked) {
        textSpan.contentEditable = true; 
        
        // é»æ“Šæ–‡å­—æ™‚ï¼Œä¸è¦è§¸ç™¼æ•´è¡Œçš„ toggleï¼Œè€Œæ˜¯é€²å…¥ç·¨è¼¯
        textSpan.onclick = (e) => e.stopPropagation(); 
        
        // æŒ‰ä¸‹ Enter -> ä¿å­˜
        textSpan.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // é˜²æ­¢æ›è¡Œ
                textSpan.blur();    // è§¸ç™¼ blur
            }
        };

        // å¤±ç„¦ -> è‡ªå‹•ä¿å­˜
        textSpan.onblur = () => {
            const newText = textSpan.innerText.trim();
            if (newText && newText !== item) {
                updateLuggageItem(item, newText, group.cat);
            } else if (!newText) {
                textSpan.innerText = item; // å¦‚æœæ¸…ç©ºï¼Œé‚„åŸåŸæœ¬æ–‡å­—
            }
        };
    } else {
        // å¦‚æœå·²æ‰“å‹¾ï¼Œé»æ“Šæ–‡å­—å°±åˆ‡æ›å‹¾é¸ç‹€æ…‹ (åƒåŸæœ¬ä¸€æ¨£)
        textSpan.onclick = (e) => {
            e.stopPropagation();
            toggleLuggageItem(item);
        }
    }

    // C. åˆªé™¤æŒ‰éˆ• (å¯é¸ï¼Œçœ‹ä½ è¦ä¸è¦ç•™)
    // é è¨­æ¸…å–®é€šå¸¸ä¸çµ¦åˆªé™¤ï¼Œä½†è‡ªè¨‚æ¸…å–®éœ€è¦ã€‚é€™è£¡å…ˆä¸æ”¾é è¨­æ¸…å–®çš„åˆªé™¤éˆ•ã€‚

    itemDiv.appendChild(checkbox);
    itemDiv.appendChild(textSpan);
    
    // é»æ“Šæ•´è¡Œ (ç©ºç™½è™•) -> åˆ‡æ›å‹¾é¸
    itemDiv.onclick = () => toggleLuggageItem(item);

    gridDiv.appendChild(itemDiv);
});

        
        // å†æ¸²æŸ“è©²åˆ†é¡çš„è‡ªè¨‚é …ç›®ï¼ˆå¦‚æœæœ‰ï¼‰
        if (myLuggage.customByCategory && myLuggage.customByCategory[group.cat]) {
            myLuggage.customByCategory[group.cat].forEach(item => {
                const isChecked = myLuggage.checked.includes(item);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `luggage-item custom ${isChecked ? 'checked' : ''}`;
                
                itemDiv.innerHTML = `
                    <div class="luggage-checkbox"></div>
                    <span class="luggage-item-text" style="flex: 1;">${item}</span>
                    <button class="luggage-delete-btn" onclick="removeLuggageItem('${item}')">Ã—</button>
                `;
                
                itemDiv.onclick = (e) => {
                    if (e.target.classList.contains('luggage-delete-btn')) return;
                    e.stopPropagation();
                    toggleLuggageItem(item);
                };
                
                gridDiv.appendChild(itemDiv);
            });
        }
        
       const addRowDiv = document.createElement('div');
	addRowDiv.className = 'luggage-add-row';
	addRowDiv.innerHTML = `
		<div class="luggage-checkbox" style="opacity: 0.3;"></div>
		<div 
        class="luggage-add-input" 
        contenteditable="true" 
        data-placeholder="é»æ“Šæ–°å¢..." 
        data-category="${group.cat}"
		></div>
	`;

        
      const addInput = addRowDiv.querySelector('.luggage-add-input');

addInput.onclick = (e) => {
    e.stopPropagation();
    addInput.classList.add('focused');
    addInput.focus();
};

addInput.onkeydown = (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();  // é˜²æ­¢æ›è¡Œ
        const text = addInput.innerText.trim();
        if (text) {
            addLuggageItemToCategory(text, group.cat);
            addInput.innerText = '';  // æ¸…ç©º
        }
        addInput.classList.remove('focused');
    }
};

addInput.onblur = () => {
    if (addInput.innerText.trim() === '') {
        addInput.classList.remove('focused');
    }
};

        
        gridDiv.appendChild(addRowDiv);
        cardDiv.appendChild(titleDiv);
        cardDiv.appendChild(gridDiv);
        container.appendChild(cardDiv);
    });

    // B. æ¸²æŸ“è‡ªè¨‚è¿½åŠ åˆ†é¡ï¼ˆé›œé …ï¼‰
    if (myLuggage.custom && myLuggage.custom.length > 0) {
        const customCardDiv = document.createElement('div');
        customCardDiv.className = 'luggage-category-card';
        
        const customTitleDiv = document.createElement('div');
        customTitleDiv.className = 'luggage-cat-title';
        customTitleDiv.textContent = 'è‡ªè¨‚è¿½åŠ ';
        customTitleDiv.style.color = 'var(--accent)';
        
        const customGridDiv = document.createElement('div');
        customGridDiv.className = 'luggage-grid';
        
        myLuggage.custom.forEach(item => {
            const isChecked = myLuggage.checked.includes(item);
            
            const itemDiv = document.createElement('div');
            itemDiv.className = `luggage-item custom ${isChecked ? 'checked' : ''}`;
            
            itemDiv.innerHTML = `
                <div class="luggage-checkbox"></div>
                <span class="luggage-item-text" style="flex: 1;">${item}</span>
                <button class="luggage-delete-btn" onclick="removeLuggageItem('${item}')">Ã—</button>
            `;
            
            itemDiv.onclick = (e) => {
                if (e.target.classList.contains('luggage-delete-btn')) return;
                e.stopPropagation();
                toggleLuggageItem(item);
            };
            
            customGridDiv.appendChild(itemDiv);
        });
        
        customCardDiv.appendChild(customTitleDiv);
        customCardDiv.appendChild(customGridDiv);
        container.appendChild(customCardDiv);
    }
    
    // C. çµ±ä¸€çš„æ–°å¢è¡¨å–®
    const inputCardDiv = document.createElement('div');
    inputCardDiv.className = 'luggage-category-card';
    
    const inputContainerDiv = document.createElement('div');
    inputContainerDiv.id = 'luggage-input-container';
    
    const inputEl = document.createElement('input');
    inputEl.type = 'text';
    inputEl.id = 'new-luggage-item';
    inputEl.placeholder = 'æ–°å¢å…¶ä»–é …ç›®...';
    
    const btnEl = document.createElement('button');
    btnEl.textContent = 'ï¼‹';
    btnEl.onclick = addLuggageItem;
    
    inputContainerDiv.appendChild(inputEl);
    inputContainerDiv.appendChild(btnEl);
    inputCardDiv.appendChild(inputContainerDiv);
    container.appendChild(inputCardDiv);
}

// ğŸ¯ åˆ‡æ›å‹¾é¸ç‹€æ…‹
function toggleLuggageItem(item) {
    const idx = myLuggage.checked.indexOf(item);
    if (idx > -1) {
        myLuggage.checked.splice(idx, 1);
    } else {
        myLuggage.checked.push(item);
    }
    renderLuggageList();
    saveLuggageData();
}

// â• åœ¨æŒ‡å®šåˆ†é¡å…§æ–°å¢é …ç›®
function addLuggageItemToCategory(newItem, category) {
    if (newItem === '') return;
    
    // æª¢æŸ¥é‡è¤‡
    const allItems = [
        ...DEFAULT_LUGGAGE.flatMap(g => g.items),
        ...(myLuggage.custom || []),
        ...(myLuggage.customByCategory ? 
            Object.values(myLuggage.customByCategory).flat() : [])
    ];
    
    if (allItems.includes(newItem)) {
        alert('é€™å€‹é …ç›®å·²ç¶“å­˜åœ¨');
        return;
    }
    
    // åˆå§‹åŒ–è‡ªè¨‚ç‰©å“ç‰©ä»¶
    if (!myLuggage.customByCategory) {
        myLuggage.customByCategory = {};
    }
    
    // åˆå§‹åŒ–è©²åˆ†é¡çš„è‡ªè¨‚ç‰©å“é™£åˆ—
    if (!myLuggage.customByCategory[category]) {
        myLuggage.customByCategory[category] = [];
    }
    
    // æ–°å¢åˆ°è©²åˆ†é¡
    myLuggage.customByCategory[category].push(newItem);
    
    renderLuggageList();
    saveLuggageData();
}

// ğŸ—‘ï¸ åˆªé™¤é …ç›®
function removeLuggageItem(item) {
    // å¾è‡ªè¨‚æ¸…å–®åˆªé™¤
    if (myLuggage.custom) {
        const idx = myLuggage.custom.indexOf(item);
        if (idx > -1) {
            myLuggage.custom.splice(idx, 1);
        }
    }
    
	// === æ–°å¢ï¼šæ›´æ–°è¡Œæé …ç›®æ–‡å­— ===
function updateLuggageItem(oldText, newText, category) {
    if (oldText === newText) return; // æ²’è®Šå°±ä¸è™•ç†

    // 1. æª¢æŸ¥æ˜¯å¦é‡è¤‡ (é¿å…æ”¹åæˆå·²å­˜åœ¨çš„é …ç›®)
    const allItems = [...DEFAULTLUGGAGE.flatMap(g => g.items), ...(myLuggage.custom || []), ...(myLuggage.customByCategory ? Object.values(myLuggage.customByCategory).flat() : [])];
    if (allItems.includes(newText)) {
        alert('é€™å€‹é …ç›®å·²ç¶“å­˜åœ¨å›‰ï¼');
        renderLuggageList(); //é‚„åŸä»‹é¢
        return;
    }

    let found = false;

    // 2. å˜—è©¦åœ¨ DEFAULTLUGGAGE (é è¨­æ¸…å–®) æ‰¾ä¸¦æ›´æ–°
    // æ³¨æ„ï¼šDEFAULTLUGGAGE æ˜¯ constï¼Œå¦‚æœä½ æƒ³æ°¸ä¹…ä¿®æ”¹é è¨­å€¼ï¼Œé€™è£¡å¯ä»¥å‹•ã€‚
    // ä½†é€šå¸¸é è¨­å€¼æ˜¯å”¯è®€ã€‚å¦‚æœä½ çš„éœ€æ±‚æ˜¯ã€Œä¿®æ”¹é è¨­æ¸…å–®ã€ï¼Œè«‹ç¢ºä¿ DEFAULTLUGGAGE çš„ items æ˜¯å¯è®Šçš„ã€‚
    const defaultGroup = DEFAULTLUGGAGE.find(g => g.cat === category);
    if (defaultGroup) {
        const idx = defaultGroup.items.indexOf(oldText);
        if (idx !== -1) {
            defaultGroup.items[idx] = newText;
            found = true;
        }
    }

    // 3. å˜—è©¦åœ¨ è‡ªè¨‚æ¸…å–® (Custom) æ‰¾ä¸¦æ›´æ–°
    if (!found && myLuggage.custom) {
        const idx = myLuggage.custom.indexOf(oldText);
        if (idx !== -1) {
            myLuggage.custom[idx] = newText;
            found = true;
        }
    }

    // 4. å˜—è©¦åœ¨ åˆ†é¡è‡ªè¨‚æ¸…å–® (CustomByCategory) æ‰¾ä¸¦æ›´æ–°
    if (!found && myLuggage.customByCategory && myLuggage.customByCategory[category]) {
        const list = myLuggage.customByCategory[category];
        const idx = list.indexOf(oldText);
        if (idx !== -1) {
            list[idx] = newText;
            found = true;
        }
    }

    // 5. é€£å‹•æ›´æ–° Checked (å¦‚æœåŸæœ¬æœ‰æ‰“å‹¾ï¼Œæ”¹åå¾Œä¹Ÿè¦æ‰“å‹¾)
    const checkedIdx = myLuggage.checked.indexOf(oldText);
    if (checkedIdx !== -1) {
        myLuggage.checked[checkedIdx] = newText;
    }

    // 6. å­˜æª”ä¸¦åˆ·æ–°
    saveLuggageData();
    renderLuggageList();
}

	
    // å¾åˆ†é¡æ¸…å–®åˆªé™¤
    if (myLuggage.customByCategory) {
        Object.keys(myLuggage.customByCategory).forEach(cat => {
            const idx = myLuggage.customByCategory[cat].indexOf(item);
            if (idx > -1) {
                myLuggage.customByCategory[cat].splice(idx, 1);
                // åˆªé™¤ç©ºçš„åˆ†é¡
                if (myLuggage.customByCategory[cat].length === 0) {
                    delete myLuggage.customByCategory[cat];
                }
            }
        });
    }
    
    // ç§»é™¤å‹¾é¸è¨˜éŒ„
    const checkedIdx = myLuggage.checked.indexOf(item);
    if (checkedIdx > -1) {
        myLuggage.checked.splice(checkedIdx, 1);
    }
    
    renderLuggageList();
    saveLuggageData();
}

// â• çµ±ä¸€è¡¨å–®æ–°å¢ï¼ˆé›œé …ç”¨ï¼‰
function addLuggageItem() {
    const input = document.getElementById('new-luggage-item');
    const newItem = input.value.trim();
    
    if (newItem === '') {
        alert('è«‹è¼¸å…¥é …ç›®åç¨±');
        return;
    }
    
    // æª¢æŸ¥é‡è¤‡
    const allItems = [
        ...DEFAULT_LUGGAGE.flatMap(g => g.items),
        ...(myLuggage.custom || []),
        ...(myLuggage.customByCategory ? 
            Object.values(myLuggage.customByCategory).flat() : [])
    ];
    
    if (allItems.includes(newItem)) {
        alert('é€™å€‹é …ç›®å·²ç¶“å­˜åœ¨');
        input.value = '';
        return;
    }
    
    // æ–°å¢åˆ°è‡ªè¨‚æ¸…å–®ï¼ˆä¸åˆ†é¡ï¼‰
    if (!myLuggage.custom) {
        myLuggage.custom = [];
    }
    myLuggage.custom.push(newItem);
    
    input.value = '';
    renderLuggageList();
    saveLuggageData();
}

// ğŸ’¾ å„²å­˜è³‡æ–™
function saveLuggageData() {
    localStorage.setItem('myLuggage', JSON.stringify(myLuggage));
}






// ===== åˆå§‹åŒ–èˆ‡ç™»å…¥é‚è¼¯ (å”¯ä¸€ç‰ˆæœ¬) =====

// 1. åˆå§‹åŒ– (è‡ªå‹•ç™»å…¥é‚è¼¯)
function init() {
console.log('ğŸ” æ‡‰ç”¨åˆå§‹åŒ–é–‹å§‹...');
console.log('MEMBERS:', MEMBERS);

// å˜—è©¦å¾æœ¬åœ°å„²å­˜è®€å–
const savedUser = localStorage.getItem('expense_user');
const savedKey = localStorage.getItem('expense_secret_key');

// å¦‚æœæœ‰ä½¿ç”¨è€…ç´€éŒ„ ä¸” æœ‰å¯†ç¢¼ç´€éŒ„
if (savedUser && savedKey) {
console.log('âœ… è‡ªå‹•ç™»å…¥:', savedUser);

// 1. æ¢å¾©å…¨åŸŸè®Šæ•¸
currentUser = savedUser;
userEnteredSecret = savedKey;

// 2. æ›´æ–°ä»‹é¢
updateSubtitleWithUser();

// 3. éš±è—æ­¡è¿é 
const wrapper = document.getElementById('welcome-card');
if (wrapper) wrapper.style.display = 'none';

   // ğŸ‘‡ åŠ å…¥é€™æ®µè®€å–è¡Œææ¸…å–®
    const savedLuggage = localStorage.getItem('my_luggage');
    if (savedLuggage) {
        try {
            myLuggage = JSON.parse(savedLuggage);
        } catch(e) {
            console.error('è®€å–è¡Œææ¸…å–®å¤±æ•—', e);
        }
    }

// 4. è¼‰å…¥è³‡æ–™
renderDays();
renderPlan();
renderWishlist();
renderLuggageList(); 
fetchWeather();

// å»¶é²è¼‰å…¥è¨˜å¸³è³‡æ–™
setTimeout(() => {
renderExpense();
renderExpenseCategories();
loadExpensesFromSheet();
}, 100);

} else {
console.log('ğŸ”‘ é¦–æ¬¡é€²å…¥ï¼Œé¡¯ç¤ºç™»å…¥é ');
showWelcomeCard();

// èƒŒæ™¯çµæ§‹
renderDays();
renderPlan();
renderWishlist();
fetchWeather();
}
setupSwipeObserver('cat-swipe-wrapper', '#cat-swipe-dots .dot');
}

// 2. é¡¯ç¤ºæ­¡è¿é  (ç”¢ç”Ÿé¸äººæŒ‰éˆ•)
function showWelcomeCard() {
console.log('ğŸ“‹ showWelcomeCard åŸ·è¡Œ...');

const wrapper = document.getElementById('welcome-card');
const list = document.getElementById('welcome-user-list');

console.log('wrapper:', wrapper);
console.log('list:', list);
console.log('MEMBERS:', MEMBERS);

if (!wrapper || !list) {
console.error('âŒ æ‰¾ä¸åˆ°æ­¡è¿ç•«é¢å…ƒç´ ï¼');
return;
}

// ç¢ºä¿æ­¡è¿é é¡¯ç¤º
wrapper.style.display = 'flex';
wrapper.style.opacity = '1';
wrapper.classList.remove('welcome-fade-out');

// æ¸…ç©ºèˆŠå…§å®¹
list.innerHTML = '';
selectedUserForLogin = null;

// ğŸ›¡ï¸ é˜²å‘†æª¢æŸ¥
if (!MEMBERS || MEMBERS.length === 0) {
list.innerHTML = '<div style="color: #ef4444; font-weight: 700; padding: 20px; text-align: center;">âš ï¸ æœªè¨­å®šæˆå“¡åå–® (MEMBERS)</div>';
console.error('âŒ MEMBERS é™£åˆ—æ˜¯ç©ºçš„ï¼');
return;
}

// ç”¢ç”ŸæŒ‰éˆ•
console.log('ç”¢ç”Ÿ ' + MEMBERS.length + ' å€‹æŒ‰éˆ•...');
MEMBERS.forEach(name => {
const btn = document.createElement('button');
btn.type = 'button';
btn.className = 'welcome-user-btn';
btn.textContent = name;
btn.style.display = 'block';

btn.onclick = (e) => {
e.preventDefault();
console.log('é»æ“Šä½¿ç”¨è€…:', name);

// ç§»é™¤å…¶ä»–äººçš„é¸å–
document.querySelectorAll('.welcome-user-btn').forEach(b => b.classList.remove('selected'));
// é¸å–è‡ªå·±
btn.classList.add('selected');
// ç´€éŒ„
selectedUserForLogin = name;
};
list.appendChild(btn);
});

console.log('âœ… æŒ‰éˆ•ç”¢ç”Ÿå®Œæˆ');
}

// ğŸ†• é©—è­‰å¯†ç¢¼æ˜¯å¦æ­£ç¢º
async function validateSecretKey(secretKey) {
try {
const response = await fetch(
`${GOOGLE_APPS_SCRIPT_URL}?secretKey=${encodeURIComponent(secretKey)}`
);

const result = await response.json();

// å¦‚æœ Google Apps Script è¿”å› errorï¼Œè¡¨ç¤ºå¯†ç¢¼éŒ¯èª¤
return result.status === 'success';

} catch (err) {
return false;
}
}


async function handleLogin() {
console.log('ğŸ”‘ é–‹å§‹ç™»å…¥æµç¨‹...');

const pwdInput = document.getElementById('entry-password');
const enteredPwd = pwdInput.value;
const selectedUser = selectedUserForLogin;  // å·²é¸ä¸­çš„ä½¿ç”¨è€…

if (!selectedUser) {
alert('âŒ è«‹å…ˆé¸æ“‡ä½¿ç”¨è€…');
return;
}

if (!enteredPwd || enteredPwd.trim() === '') {
alert('âŒ å¯†ç¢¼ä¸èƒ½ç‚ºç©º');
return;
}

// ğŸ†• é©—è­‰å¯†ç¢¼
const btn = document.getElementById('btn-login-confirm');
const originalBtnText = btn.textContent; // æš«å­˜æŒ‰éˆ•æ–‡å­—
btn.textContent = 'é©—è­‰ä¸­...';
btn.disabled = true;

const isValid = await validateSecretKey(enteredPwd);

if (!isValid) {
alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦');
btn.textContent = originalBtnText;
btn.disabled = false;
return;
}

// âœ… å¯†ç¢¼æ­£ç¢ºï¼Œå…è¨±ç™»å…¥
currentUser = selectedUser;
userEnteredSecret = enteredPwd;

localStorage.setItem('expense_user', currentUser);
localStorage.setItem('expense_secret_key', userEnteredSecret);

// --- âœ¨ é€™è£¡é–‹å§‹æ˜¯æ–°å¢çš„å‹•ç•«æ•ˆæœ ---

// 1. å»ºç«‹æˆåŠŸè¨Šæ¯å°å¡ç‰‡
const successMsg = document.createElement('div');
successMsg.className = 'login-success-message';
successMsg.innerHTML = `
  <div style="font-size:3rem; margin-bottom:10px;">âœ…</div>
  <div style="font-size:1.2rem; font-weight:900; color:#2C3E50;">ç™»å…¥æˆåŠŸï¼</div>
  <div style="font-size:0.9rem; color:#666; margin-top:4px;">Helloï¼Œ${currentUser}</div>
`;
document.body.appendChild(successMsg);

// 2. éš±è—æ­¡è¿å¡ç‰‡å…§åŸæœ¬çš„å…§å®¹ (è®“èƒŒæ™¯é‚„åœ¨ï¼Œä½†æŒ‰éˆ•æ¶ˆå¤±ï¼Œå°ˆæ³¨çœ‹æˆåŠŸè¨Šæ¯)
const wrapperInner = document.querySelector('.welcome-card-inner');
if(wrapperInner) wrapperInner.classList.add('hide-content');

// 3. å»¶é² 1.2 ç§’å¾Œï¼Œé€£åŒèƒŒæ™¯ä¸€èµ·æ·¡å‡º
setTimeout(() => {
// è®“æˆåŠŸè¨Šæ¯æ·¡å‡º
successMsg.style.animation = 'fadeOutMsg 0.4s forwards';

// è®“æ•´å€‹æ­¡è¿èƒŒæ™¯æ·¡å‡º (è§¸ç™¼ä½ çš„ exit-animation)
const wrapper = document.getElementById('welcome-card');
wrapper.classList.add('exit-animation');

// 4. å‹•ç•«è·‘å®Œå¾Œï¼ŒçœŸæ­£ç§»é™¤å…ƒç´ ä¸¦è¼‰å…¥è³‡æ–™
setTimeout(() => {
wrapper.style.display = 'none';
successMsg.remove();

// è¼‰å…¥èˆ‡æ¸²æŸ“è³‡æ–™
updateSubtitleWithUser();
renderExpense();
renderExpenseCategories();
renderLuggageList();
loadExpensesFromSheet();

}, 500); // é…åˆ CSS exit-animation çš„ 0.6s ç¨å¾®ææ—©ä¸€é»åˆ‡æ›
}, 1200); // è®“æˆåŠŸè¨Šæ¯åœç•™ 1.2 ç§’
}







function updateSubtitleWithUser() {
const subtitle = document.querySelector('.subtitle');
if(!subtitle || !currentUser) return;
subtitle.innerHTML = `<span class="badge">${currentUser}</span> 5 Days `;
}

// --- WEATHER ---
function fetchWeather() {
    // æ”¹ç”¨ WeatherWidget.ioï¼Œæ­¤è™•ä¸å†éœ€è¦é‚è¼¯
    console.log("Weather widget loaded.");
}


/* --- TABS --- */
function switchTab(tabBtn, name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tabBtn.classList.add('active');

    // 2. éš±è—æ‰€æœ‰é é¢
    document.getElementById('view-itinerary').style.display = 'none';
    document.getElementById('view-expense').style.display = 'none';
    document.getElementById('view-breakdown').style.display = 'none';
    document.getElementById('view-wishlist').style.display = 'none';
    document.getElementById('view-info').style.display = 'none';

    // 3. é¡¯ç¤ºç›®æ¨™é é¢
    const targetView = document.getElementById('view-' + name);
    if (targetView) targetView.style.display = 'block';
    
    curTab = name;

    // 4. æ§åˆ¶ FAB æŒ‰éˆ• (å®‰å…¨æª¢æŸ¥ç‰ˆ)
    const fab = document.getElementById('btn-add');
    if (fab) {
        // åªæœ‰ã€Œè¨˜å¸³ã€é é¢ (expense) æ‰é¡¯ç¤º FABï¼Œå…¶ä»–éƒ½éš±è—
        // âš ï¸ ä¿®æ­£ï¼šæ‚¨åŸæœ¬å¯«çš„æ˜¯ itinerary é¡¯ç¤ºï¼Œé€šå¸¸è¨˜å¸³æŒ‰éˆ•æ˜¯åœ¨ expense é é¡¯ç¤º
        // å¦‚æœæ‚¨çš„æŒ‰éˆ•æ˜¯ç”¨ä¾†æ–°å¢è¡Œç¨‹çš„ï¼Œé‚£å°±ä¿ç•™ itinerary
        // é€™è£¡å‡è¨­ btn-add æ˜¯ã€Œè¨˜å¸³æŒ‰éˆ•ã€ï¼š
        if (name === 'expense') {
            fab.style.display = 'flex';
        } else {
            fab.style.display = 'none';
        }
    }

    // 5. æ¸²æŸ“å°æ‡‰å…§å®¹ (ä¿®æ­£åŸ·è¡Œé †åº)
    // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM åˆ‡æ›å®Œæˆå¾Œå†æ¸²æŸ“ï¼Œé¿å…ç•«é¢é–ƒçˆæˆ–è¨ˆç®—éŒ¯èª¤
    setTimeout(() => {
        if(name === 'expense') {
            renderExpense();
            renderExpenseCategories(); 
		if (typeof updateExpenseStats === 'function') updateExpenseStats(); 
        } else if(name === 'breakdown') {
		renderExpenseDays(); // [æ–°å¢] ç”¢ç”Ÿæ—¥æœŸæ¨™ç±¤
		renderExpense();     // ç¢ºä¿æ•¸æ“šæ˜¯æœ€æ–°çš„
        } else if(name === 'wishlist') {
            renderWishlist();
            if (typeof renderLuggageList === 'function') renderLuggageList();
        } else if(name === 'info') {
            if (typeof updateInfoView === 'function') updateInfoView();
        }
    }, 0);
}


// --- ITINERARY ---
	function renderDays() {
	const dayList = document.getElementById('day-list');
	dayList.innerHTML = '';
	DAYS.forEach((day, idx) => {
	const div = document.createElement('div');
	div.className = `day-card ${curDay===idx?'active':''}`;
	div.onclick = () => {
	curDay = idx;
	renderDays();
	renderPlan();
	if(curTab === 'expense') renderExpense();
	};
	div.innerHTML = `
                <div class="day-top"><span>Day ${day.num}</span><span class="day-dot"></span></div>
                <div class="day-num">${day.label}<span>${day.week}</span></div>
            `;
dayList.appendChild(div);
});
}

function renderPlan() {
const list = document.getElementById('plan-list');
list.innerHTML = '';

const plans = PLAN[curDay] || [];
if(plans.length === 0) {
list.innerHTML = '<div style="color:#888;text-align:center;margin:2rem 0">å°šç„¡è¡Œç¨‹</div>';
return;
}

plans.forEach((item, idx) => {
const cat = CATEGORIES.find(c => c.key === item.cat) || CATEGORIES[4];

// äº¤é€šè³‡æ–™
const trans = item.trans || { mode: 'car', hour: 0, min: 10 };
const transIcons = { 'car': 'ğŸš—', 'train': 'ğŸšƒ', 'walk': 'ğŸš¶', 'bus': 'ğŸšŒ', 'airplane': 'âœˆï¸' };
const iconSymbol = transIcons[trans.mode] || 'ğŸš—';

let timeStr = '';
if(trans.hour > 0) timeStr += `${trans.hour}å°æ™‚`;
if(trans.min > 0) timeStr += `${trans.min}åˆ†`;
if(trans.hour===0 && trans.min===0) timeStr = '0åˆ†';

const isNotLast = idx < plans.length - 1;

const wrapper = document.createElement('div');
wrapper.className = 'plan-wrapper';

// è¨­å®šé¡è‰²è®Šæ•¸
wrapper.style.setProperty('--card-color', cat.hex || '#ccc');
wrapper.style.setProperty('--card-color-light', cat.light || '#eee');

wrapper.innerHTML = `
        <div class="plan-card" onclick="if(!event.target.closest('.nav-btn')) openModal('plan', PLAN[curDay][${idx}], ${idx})">
            <div class="plan-left">
                <div class="plan-time">${item.time}</div>
                <div class="plan-tag" style="background:${cat.hex}">${cat.label}</div>
                <div class="plan-title">${item.title}</div>
                <div class="plan-loc">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    ${item.loc}
                </div>
            </div>
            <div class="plan-actions">
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.loc)}" target="_blank" style="text-decoration:none">
                    <button type="button" class="nav-btn">
                         <svg viewBox="0 0 24 24"><path d="M1 11.6l19.6-9.3a1.3 1.3 0 0 1 1.7 1.7l-9.3 19.6c-.6 1.3-2.5 1.3-3.1 0l-2.7-6.2-6.2-2.7c-1.3-.6-1.3-2.5 0-3.1z"/></svg>
                        å°èˆª
                    </button>
                </a>
            </div>
        </div>

        ${isNotLast ? `
            <!-- æ–°çš„äº¤é€šå€å¡Šçµæ§‹ -->
            <div class="trans-container" style="--card-color: ${cat.hex || '#ccc'}">
            <div class="trans-badge">
                <div class="trans-icon" onclick="openTransModePicker(${idx})">
                    ${iconSymbol}
                </div>
                <div class="trans-time" onclick="openTransTimePicker(${idx})">
                    ${timeStr}
                </div>
            </div>
        </div>
            ` : ''} 
        `;
        list.appendChild(wrapper);
});
}

function renderExpenseDays() {
    const scrollContainer = document.getElementById('expense-day-scroll');
    if (!scrollContainer) return;

    scrollContainer.innerHTML = ''; 

    DAYS.forEach((day, idx) => {
        const btn = document.createElement('div');
        // å¥—ç”¨æ–°çš„è† å›Šæ¨£å¼
        btn.className = `date-capsule ${curDay === idx ? 'active' : ''}`;
        
        btn.onclick = () => {
            curDay = idx;
            renderExpenseDays(); // æ›´æ–°è† å›Šç‹€æ…‹
            renderExpense();     // æ›´æ–°æ˜ç´°åˆ—è¡¨
            
            // åŒæ­¥å…¶ä»–é é¢ (é¸ç”¨)
            if (typeof renderDays === 'function') renderDays();
            if (typeof renderPlan === 'function') renderPlan();
        };

        // è† å›Šå…§å®¹ï¼šæ—¥æœŸ + æ˜ŸæœŸ (ä¾‹å¦‚: 01/06 (äºŒ))
        // æ‚¨å¯ä»¥ä¾å–œå¥½èª¿æ•´é¡¯ç¤ºæ ¼å¼
        btn.innerHTML = `
            ${day.label} <small>
        `;
        scrollContainer.appendChild(btn);
    });
}



// âœ… ä¿®æ­£ç‰ˆ renderExpenseï¼šåªé¡¯ç¤ºèˆ‡æˆ‘æœ‰é—œçš„å¸³ç›® + æ¨™ç¤ºä»˜æ¬¾äºº
function renderExpense() {
    const list = document.getElementById('expense-list');
    if (!list) return;
    
    list.innerHTML = '';
    const items = EXPENSE[curDay] || [];

    // 1. éæ¿¾ï¼šåªç•™ä¸‹ã€Œè·Ÿæˆ‘æœ‰é—œã€çš„å¸³ç›®
    // æ¢ä»¶ï¼šæˆ‘æ˜¯ä»˜æ¬¾äºº OR æˆ‘åœ¨åˆ†å¸³åå–® (advanceFor) è£¡é¢
    const myItems = items.filter(item => {
        if (item.isDeleted) return true; // å·²åˆªé™¤çš„æš«æ™‚ä¿ç•™é¡¯ç¤º (æˆ–æ‚¨å¯ä»¥é¸æ“‡ç›´æ¥ä¸é¡¯ç¤º)
        
        const isPayer = item.payBy === currentUser;
        const isInvolved = item.advanceFor && item.advanceFor.includes(currentUser);
        
        return isPayer || isInvolved;
    });

    if (myItems.length === 0) {
        list.innerHTML = '<div style="color:#888;text-align:center;margin:2rem 0">å°šç„¡ç›¸é—œæ¶ˆè²»ç´€éŒ„</div>';
        if (typeof updateExpenseStats === 'function') updateExpenseStats();
        return;
    }

    myItems.forEach(item => {
        const div = document.createElement('div');
        const isDeleted = item.isDeleted ? ' deleted' : '';
        div.className = `expense-row${isDeleted}`;
        div.style.padding = "1rem 1.2rem";

        const cat = CATEGORIES.find(c => c.key === item.cat) || CATEGORIES[4];
        const currencySymbol = item.currency === 'JPY' ? 'Â¥' : 'NT$';
        const displayAmt = item.amt.toLocaleString();

        const hasSplit = item.splitDetails && item.splitDetails.mode !== 'none';
        
        let advanceHtml = '';
        if (hasSplit && item.advanceFor) {
            const othersCount = item.advanceFor.filter(p => p !== currentUser).length;
            if (othersCount > 0) {
                advanceHtml = `<span class="advance-badge">ä»£å¢Š: ${othersCount}äºº</span>`;
            }
        }

        // ğŸ†• æ–°å¢ï¼šä»˜æ¬¾äººæ¨™ç¤º
        // å¦‚æœä»˜æ¬¾äººæ˜¯æˆ‘ï¼Œé¡¯ç¤ºã€Œæˆ‘ä»˜çš„ã€ï¼›å¦‚æœæ˜¯åˆ¥äººï¼Œé¡¯ç¤ºã€ŒæŸæŸä»˜çš„ã€
        let payerBadge = '';
        if (item.payBy === currentUser) {
            payerBadge = `<span style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:700;">æˆ‘ä»˜çš„</span>`;
        } else {
            payerBadge = `<span style="background:#fef3c7; color:#b45309; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:700;">${item.payBy} ä»˜æ¬¾</span>`;
        }

        let actionBtnHtml = '';
        if (!item.isDeleted) {
            actionBtnHtml = `<div style="text-align:right; margin-top:8px;"><span style="font-size:0.75rem; color:#aaa; cursor:pointer; font-weight:600;" onclick="event.stopPropagation(); openEditModal('${item.id}')">âœï¸ ç·¨è¼¯ / åˆªé™¤</span></div>`;
        }

        div.innerHTML = `
            <!-- ä¸ŠåŠéƒ¨ï¼šæ¨™é¡Œèˆ‡ç¸½é‡‘é¡ -->
            <div class="expense-header" onclick="this.parentElement.classList.toggle('expanded')">
                <div>
                    <div style="font-weight:800; font-size:1.1rem; color:var(--primary); margin-bottom:4px; display:flex; align-items:center; gap:6px;">
                        ${item.title || 'æœªå‘½å'}
                    </div>
                    <div style="font-size:0.75rem; color:#888; display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                        <!-- ä»˜æ¬¾äººæ¨™ç±¤æ”¾åœ¨æœ€å‰é¢ -->
                        ${payerBadge}
                        <span style="background:#f3f4f6; padding:2px 6px; border-radius:4px;">${cat.label}</span>
                        <span style="background:#f3f4f6; padding:2px 6px; border-radius:4px;">${item.payMethod === 'cash' ? 'ç¾é‡‘' : 'ä¿¡ç”¨å¡'}</span>
                        ${advanceHtml}
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:900; font-size:1.3rem; color:#E76F51;">
                        ${currencySymbol}${displayAmt}
                    </div>
                </div>
            </div>
            
            <div class="deleted-badge">
                <div class="deleted-badge-inner">å·²åˆªé™¤</div>
            </div>
            
            <!-- ä¸‹åŠéƒ¨ï¼šå±•é–‹å€å¡Š -->
            <div class="expense-detail-panel">
                ${renderSplitDetails(item)}
                ${actionBtnHtml}
            </div>
        `;
        list.appendChild(div);
    });

    const container = document.getElementById('expense-list-container');
    if (container) {
        container.style.maxHeight = 'none';
        container.style.overflow = 'visible';
    }

    if (typeof updateExpenseStats === 'function') {
        updateExpenseStats();
    }
}



// âœ… ä¿®æ­£ç‰ˆ renderSplitDetailsï¼šåªè² è²¬ç”¢ç”Ÿåˆ†å¸³åˆ—è¡¨ HTML
function renderSplitDetails(item) {
    // 1. å¦‚æœæ²’æœ‰ splitDetails æˆ– mode ç‚º noneï¼Œç›´æ¥å›å‚³ç©ºå­—ä¸² (ä¸é¡¯ç¤ºåˆ†å¸³å€å¡Š)
    if (!item.splitDetails || item.splitDetails.mode === 'none') {
        return ''; 
    }

    let detailMap = {};
    const currencySymbol = item.currency === 'JPY' ? 'Â¥' : 'NT$';

    // 2. æº–å‚™æ•¸æ“š
    if (item.splitDetails.mode === 'custom') {
        detailMap = item.splitDetails.amounts;
    } else {
        // å¹³å‡åˆ†å¸³
        const count = item.advanceFor.length;
        const avg = Math.floor(item.amt / count);
        item.advanceFor.forEach(p => detailMap[p] = avg);
    }

    // 3. ç”¢ç”Ÿ HTML
    let rowsHtml = '';
    Object.keys(detailMap).forEach(name => {
        const amount = detailMap[name];
        // æ¨™è¨˜æœ¬äºº
        const isMe = (name === currentUser) ? '(æˆ‘)' : '';
     
        // åˆ¤æ–·æ¨£å¼ï¼šå¦‚æœæ˜¯è‡ªå·±åˆ†æ”¤çš„éƒ¨åˆ†
        const nameStyle = (name === currentUser) 
            ? 'background:#f1f5f9; color:#64748b;'  // è‡ªå·±ï¼šç°åº•
            : 'background:#fef2f2; color:#E76F51;'; // åˆ¥äººï¼šç´…åº•

        rowsHtml += `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <div style="font-weight:700; font-size:0.85rem; padding:2px 8px; border-radius:4px; ${nameStyle}">
                    ${name} ${isMe}
                </div>
                <div style="font-weight:700; color:#666; font-size:0.9rem;">
                    ${currencySymbol}${amount.toLocaleString()}
                </div>
            </div>
        `;
    });

    // å›å‚³åŒ…è£å¥½çš„ HTMLï¼Œä¸Šæ–¹åŠ ä¸€æ¢è™›ç·šå€éš”
    return `<div style="margin-top:4px; margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed #eee;">${rowsHtml}</div>`;
}



// è«‹ç”¨æ­¤å‡½å¼å®Œæ•´è¦†è“‹åŸæœ¬çš„ updateExpenseStats
function updateExpenseStats() {
if (!currentUser) return;
const summaryContainer = document.getElementById('summary-content');
if (!summaryContainer) return;

// A. åˆå§‹åŒ–çµ±è¨ˆè®Šæ•¸
let totals = { JPY: 0, TWD: 0 };      // å®šç¾©ï¼šæˆ‘çš„å¯¦éš›æ¶ˆè²» (Cost)
let receivable = { JPY: 0, TWD: 0 };  // å®šç¾©ï¼šæ‡‰æ”¶ (å¹«åˆ¥äººå¢Š)
let payable = { JPY: 0, TWD: 0 };     // å®šç¾©ï¼šæ‡‰ä»˜ (æ¬ åˆ¥äºº)
const EX_RATE = 0.215; // åŒ¯ç‡ (åƒ…ä¾›é¡¯ç¤ºåƒè€ƒ)

// B. è¨ˆç®—é‚è¼¯ (ä¿®æ­£ç‚ºã€Œå¯¦éš›æ¶ˆè²»ã€é‚è¼¯ï¼Œèˆ‡å¾Œç«¯ GAS ä¸€è‡´)
EXPENSE.forEach(dayList => {
dayList.forEach(item => {
if (item.isDeleted) return; 
const c = item.currency || 'TWD'; // é è¨­ TWD

// 1. è¨ˆç®—ã€Œæˆ‘çš„å¯¦éš›æ¶ˆè²»ã€ (Cost)
// åªè¦æˆ‘åœ¨åˆ†å¸³åå–®å…§ï¼Œä¸ç®¡èª°ä»˜éŒ¢ï¼Œé€™ç­†éƒ½ç®—æˆ‘çš„æ¶ˆè²»
if (item.advanceFor && item.advanceFor.includes(currentUser)) {
let myShare = 0;
if (item.splitDetails && item.splitDetails.amounts) {
// è‡ªè¨‚åˆ†å¸³ï¼šå–æˆ‘è‡ªå·±çš„éƒ¨åˆ†
myShare = item.splitDetails.amounts[currentUser] || 0;
} else {
// å¹³å‡åˆ†å¸³ï¼šç¸½é‡‘é¡ / äººæ•¸
myShare = Math.floor(item.amt / item.advanceFor.length);
}
totals[c] += myShare;
}

// 2. è¨ˆç®—ã€Œæ‡‰æ”¶ã€ (Receivable)
// æ¢ä»¶ï¼šæ˜¯æˆ‘ä»˜éŒ¢ï¼Œä¸”å¹«åˆ¥äººå¢Šäº† (åå–®è£¡æœ‰åˆ¥äºº)
if (item.payBy === currentUser && item.advanceFor && item.advanceFor.length > 0) {
if (item.splitDetails && item.splitDetails.amounts) {
// è‡ªè¨‚åˆ†å¸³æ¨¡å¼ï¼šåŠ ç¸½æ‰€æœ‰ã€Œéæœ¬äººã€çš„é‡‘é¡
Object.entries(item.splitDetails.amounts).forEach(([name, amt]) => {
if (name !== currentUser && amt > 0) {
receivable[c] += amt;
}
});
} else {
// å¹³å‡åˆ†å¸³æ¨¡å¼ï¼š(å¹³å‡é‡‘é¡ * åˆ¥äººäººæ•¸)
const perPerson = Math.floor(item.amt / item.advanceFor.length);
const othersCount = item.advanceFor.filter(name => name !== currentUser).length;
receivable[c] += (perPerson * othersCount);
}
}


});
});

// C. å®šç¾©å¡ç‰‡ HTML ç”Ÿæˆå™¨ (æœ€çµ‚ç¢ºèªç‰ˆï¼šå‚ç›´ç·š + å°å¹£å°0.2rem + ä¸æ›è¡Œ)
const getCardHtml = (title, jpy, twd, color) => {
    // è¨ˆç®—æ—¥å¹£ç´„ç•¶å°å¹£
    const jpyToTwd = Math.round(jpy * EX_RATE);

    return `
    <div class="swipe-card" style="text-align: center;">
        <!-- æ¨™é¡Œ -->
        <div style="font-size:0.9rem; font-weight:700; color:${color}; margin-bottom:12px; opacity:0.9;">${title}</div>
        
        <!-- å…§å®¹å€ -->
        <div style="display: flex; align-items: flex-start; justify-content: center; gap: 15px;">
            
            <!-- å·¦å´ï¼šæ—¥å¹£ (JP) -->
            <div style="flex: 1; text-align: right;">
                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                    <div style="font-size: 0.7rem; opacity: 0.6; font-weight: 600; margin-bottom: 2px;">ğŸ‡¯ğŸ‡µ</div>
                    <!-- æ—¥å¹£å­—é«” 1.6remï¼ŒåŠ ç²— -->
                    <div style="font-size: 1.4rem; font-weight: 900; color: #FFFFFF; line-height: 1.2; white-space: nowrap;">Â¥ ${jpy.toLocaleString()}</div>
                    <div style="font-size: 0.75rem; color: #aaa; font-weight: 500; margin-top: 4px; white-space: nowrap;">
                        (ç´„ NT$ ${jpyToTwd.toLocaleString()})
                    </div>
                </div>
            </div>

            <!-- å‚ç›´åˆ†éš”ç·š -->
            <div style="width: 1px; height: 50px; background: rgba(255,255,255,0.2); margin-top: 5px;"></div>

            <!-- å³å´ï¼šå°å¹£ (TW) -->
            <div style="flex: 1; text-align: left;">
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                    <div style="font-size: 0.7rem; opacity: 0.6; font-weight: 600; margin-bottom: 2px;">ğŸ‡¹ğŸ‡¼</div>
                    <!-- å°å¹£å­—é«” 1.4rem (å°0.2rem)ï¼Œå¼·åˆ¶ä¸æ›è¡Œ -->
                    <div style="font-size: 1.1rem; font-weight: 700; color: #FFFFFF; line-height: 1.2; white-space: nowrap;">NT$ ${twd.toLocaleString()}</div>
                </div>
            </div>

        </div>
    </div>
    `;
};



// D. æ¸²æŸ“ç•«é¢
summaryContainer.style.overflow = "hidden";
summaryContainer.innerHTML = `
    <!-- æ»‘å‹•å…§å®¹ -->
    <div class="stat-swipe-wrapper" id="stat-swipe-wrapper">
        ${getCardHtml('å€‹äººèŠ±è²»ç¸½é¡', totals.JPY, totals.TWD, '#fff')}
        ${getCardHtml('æ‡‰æ”¶ç¸½é¡', receivable.JPY, receivable.TWD, '#10b981')}
    </div>
    
    <!-- æ»‘å‹•æŒ‡ç¤ºé» -->
    <div class="swipe-dots">
        <span class="dot active"></span>
        <span class="dot"></span>
    </div>
	
`;

// E. é‡æ–°ç¶å®šæ»‘å‹•ç›£è½ (ç¢ºä¿æŒ‡ç¤ºé»æœƒå‹•)
const wrapper = document.getElementById('stat-swipe-wrapper');
if (wrapper) {
wrapper.onscroll = function() {
// è¨ˆç®—ç›®å‰æ»‘åˆ°ç¬¬å¹¾å¼µå¡ç‰‡
const idx = Math.round(this.scrollLeft / this.offsetWidth);
const dots = summaryContainer.querySelectorAll('.dot'); // ä¿®æ­£ï¼šé™å®šåœ¨ summaryContainer å…§æ‰¾
dots.forEach((d, i) => d.classList.toggle('active', i === idx));
};
}
}




function toggleStat(mode) {
statMode = mode;

document.querySelectorAll('.stat-tab').forEach(b => b.classList.remove('active'));
event.target.classList.add('active');

updateExpenseStats();
renderExpenseCategories();
}

function renderQuickSplitPersons() {
const container = document.getElementById('quick-split-persons');
container.innerHTML = '';

if (!currentUser || !MEMBERS.includes(currentUser)) return;

const others = MEMBERS.filter(name => name !== currentUser);

others.forEach(name => {
const btn = document.createElement('button');
btn.type = 'button';
btn.className = 'split-person-btn';
btn.textContent = name;
btn.dataset.name = name;
btn.onclick = function (e) {
e.preventDefault();
this.classList.toggle('selected');
updateQuickSplitPreview();
};
container.appendChild(btn);
});
}

function renderQuickCustomAmounts() {
    const container = document.getElementById('quick-custom-amounts');
    container.innerHTML = '';

    if (!currentUser || !MEMBERS.includes(currentUser)) return;

    const others = MEMBERS.filter(name => name !== currentUser);

    // 1. åˆ¤æ–·ç•¶å‰å¹£åˆ¥ç¬¦è™Ÿ
    const symbol = (typeof currentCurrency !== 'undefined' && currentCurrency === 'JPY') ? 'Â¥' : 'NT$';

    others.forEach(name => {
        const row = document.createElement('div');
        row.style.cssText = 'display:grid;grid-template-columns:0.6fr 1.4fr;gap:0.6rem;align-items:center;margin-bottom:0.6rem;';
        
        // 2. å°‡ placeholder æ”¹ç‚ºå‹•æ…‹è®Šæ•¸ ${symbol}
        row.innerHTML = `
                <label style="font-size:0.75rem;font-weight:700;color:#374151;white-space:nowrap;">${name}</label>
                <input type="number" class="quick-custom-amt" data-name="${name}" min="0" placeholder="${symbol}" style="padding:0.5rem 0.6rem;font-size:0.8rem;border:1px solid #e5e7eb;border-radius:0.6rem;" oninput="updateQuickSplitPreview()">
            `;
        container.appendChild(row);
    });
}


function toggleQuickSplitMode(mode) {
const container = document.getElementById('quick-split-options');
const equalDiv = document.getElementById('quick-equal-mode');
const customDiv = document.getElementById('quick-custom-mode');

container.style.display = mode === 'none' ? 'none' : 'block';
equalDiv.style.display = mode === 'equal' ? 'block' : 'none';
customDiv.style.display = mode === 'custom' ? 'block' : 'none';

if (mode === 'equal') {
renderQuickSplitPersons();
} else if (mode === 'custom') {
renderQuickCustomAmounts();
}
updateQuickSplitPreview();
}

// æ›´æ–°åˆ†å¸³é è¦½æ–‡å­— (å«å¹£åˆ¥ä¿®æ­£)
function updateQuickSplitPreview() {
const previewDiv = document.getElementById('quick-split-preview');
const modeSelect = document.getElementById('quick-split-mode');
const mode = modeSelect.value;
const amtInput = document.getElementById('quick-amt');
const totalAmt = parseInt(amtInput.value) || 0;

// âœ… æ–°å¢ï¼šåˆ¤æ–·ç•¶å‰å¹£åˆ¥
const isJPY = document.getElementById('btn-jpy').classList.contains('active');
const currencySymbol = isJPY ? 'Â¥' : 'NT$';

if (totalAmt === 0) {
previewDiv.textContent = '';
return;
}

if (mode === 'equal') {
const selected = Array.from(
document.querySelectorAll('#quick-split-persons .split-person-btn.selected')
);

// å¹³å‡äººæ•¸ = é¸ä¸­çš„å…¶ä»–äºº + ä½¿ç”¨è€…è‡ªå·± (1äºº)
const totalPeople = selected.length + 1;

// è¨ˆç®—æ¯äººé‡‘é¡ (ç„¡æ¢ä»¶æ¨å»å°æ•¸é»)
const perPerson = Math.floor(totalAmt / totalPeople);

// âœ… ä¿®æ”¹è™•ï¼šä½¿ç”¨ currencySymbol è®Šæ•¸
previewDiv.innerHTML = `å…± ${currencySymbol}${totalAmt} Ã· ${totalPeople} äºº <span style="font-size:0.7rem;opacity:0.7">(å«æœ¬äºº)</span> = æ¯äºº ${currencySymbol}${perPerson}`;

} else if (mode === 'custom') {
const inputs = document.querySelectorAll('.quick-custom-amt');
let totalCustom = 0;
inputs.forEach(input => {
totalCustom += parseInt(input.value) || 0;
});
const myShare = totalAmt - totalCustom;

if (myShare < 0) {
previewDiv.style.borderLeftColor = '#ef4444';
// âœ… ä¿®æ”¹è™•ï¼šä½¿ç”¨ currencySymbol è®Šæ•¸ (éŒ¯èª¤è¨Šæ¯ä¸ä¸€å®šéœ€è¦ç¬¦è™Ÿï¼Œä½†åŠ ä¸Šæ¯”è¼ƒçµ±ä¸€)
previewDiv.innerHTML = `<span style="color:#ef4444;font-weight:bold">åˆ†å¸³ç¸½é¡ (${totalCustom}) è¶…é ç¸½æ”¯å‡º (${totalAmt})</span>`;
} else {
previewDiv.style.borderLeftColor = 'var(--accent)';
// âœ… ä¿®æ”¹è™•ï¼šä½¿ç”¨ currencySymbol è®Šæ•¸
previewDiv.innerHTML = `å…¶ä»–äººåˆè¨ˆ ${currencySymbol}${totalCustom}<br>æˆ‘éœ€è² æ“” ${currencySymbol}${myShare}`;
}
} else {
previewDiv.textContent = '';
}
}




function addQuickExpense() {
// 1) åŸºç¤é©—è­‰
if (!currentUser) {
alert('è«‹å…ˆé¸æ“‡ä½¿ç”¨è€… (ç™»å…¥)');
return;
}

// 2) æŠ“å–è¡¨å–®è³‡æ–™
const dateSelect = document.getElementById('quick-date');
const dayIndex = parseInt(dateSelect.value, 10); // 0~4
const dateLabel = DAYS[dayIndex].label;          // ä¾‹å¦‚ "01/06"

const cat = document.getElementById('quick-cat').value;
const title = document.getElementById('quick-title').value.trim();
const payMethod = document.getElementById('quick-pay').value;
const amt = parseInt(document.getElementById('quick-amt').value || 0, 10);
const currency = currentCurrency; // 'JPY' or 'TWD'

const modeSelect = document.getElementById('quick-split-mode');
const currentSplitMode = modeSelect ? modeSelect.value : 'none';

// ä½ çš„æµç¨‹é è¨­ã€Œä»˜æ¬¾äººå°±æ˜¯è‡ªå·±ã€
const payBy = currentUser;

// 3) æ¬„ä½æª¢æŸ¥
if (!title) {
alert('è«‹å¡«å¯«åç¨±');
return;
}
if (isNaN(amt) || amt <= 0) {
alert('é‡‘é¡å¿…é ˆå¤§æ–¼ 0');
return;
}

// 4) åˆ†å¸³é‚è¼¯
let finalAdvanceFor = [];
let splitDetails = null;

if (currentSplitMode === 'none') {
// ä¸åˆ†å¸³ï¼šä»£è¡¨åªæœ‰è‡ªå·±åƒèˆ‡
finalAdvanceFor = [currentUser];
splitDetails = { mode: 'none' };

} else if (currentSplitMode === 'equal') {
// å¹³å‡åˆ†å¸³ï¼šä½¿ç”¨è€…é¸åˆ°çš„äºº = åƒèˆ‡åˆ†å¸³çš„äºº
const selected = document.querySelectorAll('#quick-split-persons .split-person-btn.selected');
selected.forEach(btn => finalAdvanceFor.push(btn.dataset.name));

// é˜²å‘†ï¼šè‹¥æ²’é¸ä»»ä½•äººï¼Œè‡³å°‘åŒ…å«è‡ªå·±
if (finalAdvanceFor.length === 0) finalAdvanceFor = [currentUser];

// âœ… å»ºè­°ï¼šå¹³å‡åˆ†å¸³é€šå¸¸ä¹Ÿè¦åŒ…å«è‡ªå·±ï¼Œå¦å‰‡æœƒè®Šæˆã€Œåªç®—åˆ¥äººã€ã€‚
// å¦‚æœä½ ç¢ºå®šã€Œåªåˆ†åˆ¥äººã€æ‰æŠŠä¸‹ä¸€è¡Œè¨»è§£æ‰ã€‚
if (!finalAdvanceFor.includes(currentUser)) finalAdvanceFor.unshift(currentUser);

splitDetails = { mode: 'equal' };

} else if (currentSplitMode === 'custom') {
// è‡ªè¨‚åˆ†å¸³ï¼šæ¯å€‹äººè¼¸å…¥é‡‘é¡ï¼Œå‰©é¤˜è‡ªå‹•è£œåˆ°è‡ªå·±
let customAmounts = {};
let totalCustom = 0;

const inputs = document.querySelectorAll('.quick-custom-amt');
inputs.forEach(input => {
const val = parseInt(input.value || 0, 10);
if (val > 0) {
const name = input.dataset.name;
customAmounts[name] = val;
totalCustom += val;
if (!finalAdvanceFor.includes(name)) finalAdvanceFor.push(name);
}
});

const remaining = amt - totalCustom;
if (remaining < 0) {
alert(`åˆ†å¸³é‡‘é¡ç¸½å’Œ (${totalCustom}) è¶…é ç¸½æ”¯å‡º (${amt})ï¼Œè«‹æª¢æŸ¥ã€‚`);
return;
}

if (remaining > 0) {
customAmounts[currentUser] = (customAmounts[currentUser] || 0) + remaining;
if (!finalAdvanceFor.includes(currentUser)) finalAdvanceFor.push(currentUser);
}

// è‹¥å…¨éƒ¨éƒ½æ²’å¡«ï¼Œä¹Ÿè‡³å°‘è¦åŒ…å«è‡ªå·±ï¼ˆä¸ç„¶çµ±è¨ˆæœƒå‡ºç¾æ€ªç‹€æ³ï¼‰
if (finalAdvanceFor.length === 0) finalAdvanceFor = [currentUser];

splitDetails = { mode: 'custom', amounts: customAmounts };

} else {
// ä¸æ˜æ¨¡å¼ï¼Œå›é€€è™•ç†
finalAdvanceFor = [currentUser];
splitDetails = { mode: 'none' };
}

// 5) å»ºç«‹è¨˜å¸³ç‰©ä»¶
const targetId = editingId ? editingId : Date.now().toString();

const expenseObj = {
id: targetId,
date: dateLabel,
cat,
title,
amt,
currency,
payBy,
payMethod,
advanceFor: finalAdvanceFor,
splitDetails,
createdAt: new Date().toISOString()
};

// 6) å¯«å…¥ EXPENSE
if (!EXPENSE[dayIndex]) EXPENSE[dayIndex] = [];

if (editingId) {
const idx = EXPENSE[dayIndex].findIndex(e => e.id === editingId);
if (idx >= 0) EXPENSE[dayIndex][idx] = expenseObj;
cancelEdit();
} else {
EXPENSE[dayIndex].push(expenseObj);
}

// âœ… åŒæ­¥ç›®å‰æ—¥æœŸé¸æ“‡èˆ‡å…¨åŸŸ curDayï¼ˆç¢ºä¿ç•«é¢ä¸€è‡´ï¼‰
curDay = dayIndex;
renderDays();

// 7) æ›´æ–° UIï¼ˆç”¨ä½ ç¾æœ‰çš„å‡½å¼ï¼‰
renderExpense();
updateExpenseStats();
renderExpenseCategories();

// 8) æ¸…ç©ºè¡¨å–®
document.getElementById('quick-title').value = '';
document.getElementById('quick-amt').value = '';
document.getElementById('quick-hint').textContent = '';

// åŒæ­¥æç¤ºæ›ç®—
updateConversion();

// 9) åŒæ­¥åˆ° Google Sheets
syncExpenseToSheet(expenseObj);

console.log('âœ… è¨˜å¸³å®Œæˆä¸¦åŒæ­¥ä¸­:', expenseObj);
}



function editExpenseInQuickForm(item) {
editingId = item.id;
document.getElementById('quick-title').value = item.title;
document.getElementById('quick-amt').value = item.amt;
document.getElementById('quick-cat').value = item.cat;
document.getElementById('quick-pay').value = item.payMethod;

const card = document.getElementById('quick-expense-card');
card.classList.add('editing');
document.getElementById('quick-form-title').textContent = 'ç·¨è¼¯æ¶ˆè²»';
document.getElementById('btn-quick-submit').textContent = 'æ›´æ–°';

window.scrollTo({ top: 0, behavior: 'smooth' });
}

function cancelEdit() {
editingId = null;
document.getElementById('quick-title').value = '';
document.getElementById('quick-amt').value = '';
document.getElementById('quick-expense-card').classList.remove('editing');
document.getElementById('quick-form-title').textContent = 'å¿«é€Ÿè¨˜å¸³';
document.getElementById('btn-quick-submit').textContent = 'æ–°å¢';
}

async function restoreExpense(id) {
    if (!confirm('ç¢ºå®šè¦å¾©åŸé€™ç­†æ¶ˆè²»å—ï¼Ÿ')) return;

    // åœ¨ç•¶å¤©çš„è³‡æ–™ä¸­å°‹æ‰¾è©²ç­†å¸³ç›®
    const item = EXPENSE[curDay].find(e => e.id === id);

    if (item) {
        // 1. è§£é™¤åˆªé™¤æ¨™è¨˜
        item.isDeleted = false;

        // 2. é‡æ–°è¨ˆç®—æ‰€æœ‰ç•«é¢
        renderExpense();
        updateExpenseStats();
        renderExpenseCategories();

        // 3. åŒæ­¥åˆ°é›²ç«¯
        console.log('æ­£åœ¨åŒæ­¥å¾©åŸ:', item.title);
        if (typeof syncExpenseToSheet === 'function') {
            await syncExpenseToSheet(item);
        }
    }
}


async function syncDeleteToSheet(id) {
try {
await fetch(GOOGLE_APPS_SCRIPT_URL, {
method: 'POST',
body: JSON.stringify({
action: 'delete',
id: id,
secretKey: userEnteredSecret
})
});
console.log('âœ… Google Sheet åˆªé™¤åŒæ­¥æˆåŠŸ');
} catch (e) {
console.error('âŒ Google Sheet åˆªé™¤åŒæ­¥å¤±æ•—', e);
}
}


//æ–°å¢æ»‘å‹•åŠŸèƒ½-å¾…ç¢ºèª//
function renderExpenseCategories() {
const catGrid = document.getElementById('exp-category-grid');
const debtorGrid = document.getElementById('debtor-grid');

// å¦‚æœæ‰¾ä¸åˆ°å®¹å™¨å‰‡é€€å‡º
if (!catGrid || !debtorGrid) return;

// æ¸…ç©ºå…§å®¹
catGrid.innerHTML = '';
debtorGrid.innerHTML = '';

if (!currentUser) return;

// --- 1. è¨ˆç®—ã€Œæ¶ˆè²»åˆ†é¡ã€çµ±è¨ˆ (ä¿ç•™æ‚¨åŸæœ¬çš„è¨ˆç®—é‚è¼¯) ---
let catStats = {};
CATEGORIES.forEach(c => {
catStats[c.key] = { JPY: 0, TWD: 0, count: 0, color: c.color, label: c.label };
});

// --- 2. è¨ˆç®—ã€Œåˆ†å¸³å°è±¡ã€çµ±è¨ˆ (ä¿ç•™æ‚¨åŸæœ¬çš„è¨ˆç®—é‚è¼¯) ---
const debtorStats = {};

EXPENSE.forEach(dayList => {
dayList.forEach(item => {
if (!item || item.amt === 0 || item.isDeleted) return;

// --- æ¶ˆè²»åˆ†é¡è¨ˆç®—é‚è¼¯ ---
let myShare = 0;
if (item.payBy === currentUser) {
if (!item.advanceFor || item.advanceFor.length === 0) {
myShare = item.amt;
} else if (item.splitDetails && item.splitDetails.amounts) {
myShare = item.splitDetails.amounts[currentUser] || 0;
} else {
myShare = Math.floor(item.amt / item.advanceFor.length);
}
} else if (item.advanceFor && item.advanceFor.includes(currentUser)) {
if (item.splitDetails && item.splitDetails.amounts) {
myShare = item.splitDetails.amounts[currentUser] || 0;
} else {
myShare = Math.floor(item.amt / item.advanceFor.length);
}
}

if (myShare > 0) {
const catKey = item.cat || 'other';
const c = item.currency || 'TWD';
catStats[catKey][c] += myShare;
catStats[catKey].count += 1;
}

// --- åˆ†å¸³å°è±¡è¨ˆç®—é‚è¼¯ ---
if (item.payBy === currentUser && item.advanceFor && item.advanceFor.length > 0) {
if (item.splitDetails && item.splitDetails.amounts) {
Object.entries(item.splitDetails.amounts).forEach(([name, amt]) => {
if (name === currentUser || amt <= 0) return;
if (item.settled && item.settled[name]) return;

if (!debtorStats[name]) debtorStats[name] = { label: name, JPY: 0, TWD: 0, count: 0 };
const c = item.currency || 'TWD';
debtorStats[name][c] += amt;
debtorStats[name].count += 1;
});
} else {
const othersInThisSplit = item.advanceFor.filter(name => name !== currentUser);
const perPerson = othersInThisSplit.length > 0 
? Math.floor(item.amt / (othersInThisSplit.length + 1)) 
: item.amt;

othersInThisSplit.forEach(name => {
if (perPerson <= 0) return;
if (item.settled && item.settled[name]) return;

if (!debtorStats[name]) debtorStats[name] = { label: name, JPY: 0, TWD: 0, count: 0 };
const c = item.currency || 'TWD';
debtorStats[name][c] += perPerson;
debtorStats[name].count += 1;
});
}
}
});
});

// --- 3. æ¸²æŸ“æ¶ˆè²»åˆ†é¡ UI ---
CATEGORIES.forEach(cat => {
const s = catStats[cat.key];
if (!s || (s.JPY === 0 && s.TWD === 0)) return;

const itemDiv = document.createElement('div');
itemDiv.className = `exp-category-item ${cat.color}`;
let amountHtml = '';
if (s.JPY > 0) amountHtml += `<div style="font-size:1.1rem; font-weight:900;">Â¥${s.JPY.toLocaleString()}</div>`;
if (s.TWD > 0) amountHtml += `<div style="font-size:0.8rem; opacity:0.8;">NT$${s.TWD.toLocaleString()}</div>`;

itemDiv.innerHTML = `
         <span style="font-size:0.85rem; margin-bottom:4px; display:block;">${cat.label}</span>
         ${amountHtml}
         <span style="font-size:0.7rem; margin-top:4px; display:block;">${s.count}ç­†</span>
     `;
catGrid.appendChild(itemDiv);
});
if (catGrid.innerHTML === '') catGrid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:10px;">æ²’æœ‰æ”¯å‡º</div>';

// --- 4. æ¸²æŸ“åˆ†å¸³å°è±¡ UI ---
Object.values(debtorStats).forEach(s => {
if (s.JPY === 0 && s.TWD === 0) return;

const itemDiv = document.createElement('div');
itemDiv.className = 'exp-category-item bg-other';
itemDiv.style.cursor = 'pointer';
itemDiv.onclick = () => openDebtModal(s.label);

let amtHtml = '';
if (s.JPY > 0) amtHtml += `<div style="font-size:1.1rem; font-weight:900;">Â¥${s.JPY.toLocaleString()}</div>`;
if (s.TWD > 0) amtHtml += `<div style="font-size:0.8rem; opacity:0.8;">NT$${s.TWD.toLocaleString()}</div>`;

itemDiv.innerHTML = `
         <span style="font-size:0.85rem; margin-bottom:4px; display:block;">${s.label}</span>
         ${amtHtml}
         <span style="font-size:0.7rem; margin-top:4px; display:block;">${s.count}ç­†ç´€éŒ„</span>
     `;
debtorGrid.appendChild(itemDiv);
});
if (debtorGrid.innerHTML === '') debtorGrid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:10px;">ç›®å‰å°šç„¡åˆ†å¸³ç´€éŒ„ ğŸ‰</div>';
}


function renderCategories() {
const catList = document.getElementById('cat-list');
if(catList) {
catList.innerHTML = '';
CATEGORIES.forEach(c => {
const chip = document.createElement('div');
chip.className = 'cat-chip';
chip.textContent = c.label;
chip.dataset.val = c.key;
chip.onclick = () => {
document.querySelectorAll('.cat-chip').forEach(x => x.classList.remove('active'));
chip.classList.add('active');
};
catList.appendChild(chip);
});
}
}

// --- MODAL & WISHLIST ---
function openModal(type = 'plan', item = null, idx = null) {
const overlay = document.getElementById('modal-overlay');
const title = document.getElementById('modal-title');
const form = document.getElementById('add-form');
const wishFields = document.getElementById('wish-fields');

overlay.classList.add('open');
editingItem = item;
editingType = type;

renderCategories();

if (type === 'wish') {
title.textContent = item ? 'ç·¨è¼¯é¡˜æœ›' : 'æ–°å¢é¡˜æœ›';
wishFields.style.display = 'block';
document.getElementById('field-time').style.display = 'none';
document.getElementById('field-loc').style.display = 'none';

if (item) {
document.getElementById('add-title').value = item.title;
document.getElementById('wish-img-url').value = item.img || '';
} else {
form.reset();
}
} else {
title.textContent = item ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹';
wishFields.style.display = 'none';
document.getElementById('field-time').style.display = 'block';
document.getElementById('field-loc').style.display = 'block';

if (item) {
document.getElementById('add-time').value = item.time;
document.getElementById('add-title').value = item.title;
document.getElementById('add-loc').value = item.loc;
const chip = document.querySelector(`[data-val="${item.cat}"]`);
if(chip) chip.classList.add('active');
} else {
form.reset();
const now = new Date();
const hh = String(now.getHours()).padStart(2, '0');
const mm = String(now.getMinutes()).padStart(2, '0');
document.getElementById('add-time').value = `${hh}:${mm}`;
}
}

form.onsubmit = (e) => {
e.preventDefault();
saveItem(type, idx);
overlay.classList.remove('open');
};

const btnDel = document.querySelector('.btn-del');
if(item) {
btnDel.style.display = 'block';
btnDel.onclick = () => {
if(confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
deleteItem(type, idx);
overlay.classList.remove('open');
}
};
} else {
btnDel.style.display = 'none';
}
}

document.getElementById('modal-overlay').onclick = (e) => {
if(e.target === document.getElementById('modal-overlay')) {
document.getElementById('modal-overlay').classList.remove('open');
}
};

function saveItem(type, idx) {
const title = document.getElementById('add-title').value;
const activeChip = document.querySelector('.cat-chip.active');
const cat = activeChip ? activeChip.dataset.val : 'other';

if (type === 'wish') {
const img = document.getElementById('wish-img-url').value;
const newItem = { title, checked: false, img, id: 'w'+Date.now() };
if (idx !== null) {
WISHLIST[idx] = { ...WISHLIST[idx], title, img };
} else {
WISHLIST.push(newItem);
}
renderWishlist();
} else {
const time = document.getElementById('add-time').value;
const loc = document.getElementById('add-loc').value;
const newItem = { time, cat, title, loc, id: Date.now() };

if (idx !== null) {
PLAN[curDay][idx] = newItem;
} else {
PLAN[curDay].push(newItem);
PLAN[curDay].sort((a,b) => a.time.localeCompare(b.time));
}
renderPlan();
}
}

function deleteItem(type, idx) {
if (type === 'wish') {
WISHLIST.splice(idx, 1);
renderWishlist();
} else {
PLAN[curDay].splice(idx, 1);
renderPlan();
}
}


function handleImageInput(input) {
    const url = input.value.trim();
    const preview = document.getElementById('preview-img');
    const errorMsg = document.getElementById('img-error-msg');
    
    // å¦‚æœæ¸…ç©ºäº†è¼¸å…¥æ¡†ï¼Œå°±éš±è—é è¦½
    if (!url) {
        if (preview) preview.style.display = 'none';
        if (errorMsg) errorMsg.style.display = 'none';
        return;
    }

    // 1. å˜—è©¦æ¸…ç†ç¶²å€ (é‡å° Google æœå°‹çµæœçš„å†—é•·ç¶²å€)
    // å¾ˆå¤šæ™‚å€™ä½¿ç”¨è€…è¤‡è£½çš„ç¶²å€æœƒåŒ…å«ç„¡æ•ˆçš„ Base64 é ­ï¼Œæˆ–æ˜¯éé•·çš„åƒæ•¸
    // é€™è£¡åšä¸€å€‹ç°¡å–®çš„å„ªåŒ–ï¼šå¦‚æœç¶²å€é•·åº¦å¤ªèª‡å¼µ (>10000å­—)ï¼Œæç¤ºä½¿ç”¨è€…
    if (url.length > 8000) {
        if (errorMsg) {
            errorMsg.textContent = 'âš ï¸ ç¶²å€å¤ªé•·äº†ï¼è«‹é»é–‹åœ–ç‰‡å¾Œï¼Œé¸æ“‡ã€Œè¤‡è£½åœ–ç‰‡ä½å€ã€å†è©¦è©¦ã€‚';
            errorMsg.style.display = 'block';
        }
        return;
    }

    // 2. é¡¯ç¤ºé è¦½
    if (preview) {
        // é‡ç½®éŒ¯èª¤ç‹€æ…‹
        if (errorMsg) errorMsg.style.display = 'none';
        
        preview.style.display = 'block';
        preview.src = url;

        // 3. ç¶å®šè¼‰å…¥å¤±æ•—äº‹ä»¶ (é˜²ç›œé€£åµæ¸¬)
        preview.onerror = function() {
            // åœ–ç‰‡è¼‰å…¥å¤±æ•— (403 Forbidden æˆ– 404)
            preview.style.display = 'none'; // éš±è—ç ´åœ–
            if (errorMsg) {
                errorMsg.textContent = 'âš ï¸ é€™å¼µåœ–ç‰‡æœ‰é˜²ç›œé€£ä¿è­·ï¼Œç„¡æ³•é¡¯ç¤ºã€‚è«‹æ›ä¸€å¼µåœ– (ä¾‹å¦‚ä¾†è‡ªç¶­åŸºç™¾ç§‘æˆ–è³¼ç‰©ç¶²ç«™)ã€‚';
                errorMsg.style.display = 'block';
            }
        };
        
        // ç¶å®šè¼‰å…¥æˆåŠŸäº‹ä»¶ (ç¢ºä¿æˆåŠŸæ™‚éš±è—éŒ¯èª¤è¨Šæ¯)
        preview.onload = function() {
             if (errorMsg) errorMsg.style.display = 'none';
        };
    }
}

// æ¸²æŸ“è³¼ç‰©æ¸…å–® 
// å…¨åŸŸè®Šæ•¸ï¼šè¨˜éŒ„ç•¶å‰é¸ä¸­çš„éæ¿¾æ¨™ç±¤ (é è¨­ null ä»£è¡¨é¡¯ç¤ºå…¨éƒ¨)
let currentShopFilter = null;

function renderWishlist() {
    const viewContainer = document.getElementById('wish-view-shopping');
    if (!viewContainer) return;

    // 1. æ”¶é›†æ‰€æœ‰å‡ºç¾éçš„ Hashtag (å¾åç¨±å’Œå‚™è¨»è£¡æŠ“)
    const allTags = new Set();
    myShoppingList.forEach(item => {
        const text = (item.name + ' ' + (item.desc || '')).toLowerCase();
        const matches = text.match(/#[\w\u4e00-\u9fa5]+/g); // æŠ“å– #é–‹é ­çš„ä¸­æ–‡æˆ–è‹±æ•¸å­—
        if (matches) {
            matches.forEach(tag => allTags.add(tag));
        }
    });

    // 2. ç”¢ç”Ÿéæ¿¾å™¨ HTML
    let filterHtml = `
        <div class="shop-filter-bar">
            <div class="filter-chip ${currentShopFilter === null ? 'active' : ''}" 
                 onclick="filterShopList(null)">å…¨éƒ¨</div>
    `;
    allTags.forEach(tag => {
        filterHtml += `
            <div class="filter-chip ${currentShopFilter === tag ? 'active' : ''}" 
                 onclick="filterShopList('${tag}')">${tag}</div>
        `;
    });
    filterHtml += `</div>`;

    // 3. æº–å‚™éæ¿¾å¾Œçš„æ¸…å–®è³‡æ–™
    const filteredList = currentShopFilter 
        ? myShoppingList.filter(item => {
            const text = (item.name + ' ' + (item.desc || '')).toLowerCase();
            return text.includes(currentShopFilter);
        })
        : myShoppingList;

    // 4. çµ„åˆä¸»ç•«é¢ HTML
    viewContainer.innerHTML = `
    <!-- éæ¿¾å™¨åˆ— -->
    ${filterHtml}

    <!-- B. å•†å“åˆ—è¡¨å®¹å™¨ (List) -->
    <div id="shopping-list-content" class="shop-list-container">
        <!-- JS æœƒè‡ªå‹•ç”¢ç”Ÿå…§å®¹æ”¾åœ¨é€™è£¡ -->
    </div>

    <!-- A. æ–°å¢å•†å“å¿«é€Ÿ Bar (é è¨­æ”¶åˆ) -->
    <div class="shop-input-bar-wrapper">
   <!-- æ”¶åˆç‹€æ…‹ -->
        <div id="shop-input-collapsed" class="shop-input-collapsed" onclick="toggleShopInput(true)">
            <span style="font-size:1.2rem; margin-right:8px;">ï¼‹</span>
            <span style="font-weight:700; font-size:0.9rem;">æ–°å¢è³¼ç‰©é …ç›®...</span>
        </div>

        <!-- å±•é–‹ç‹€æ…‹ -->
        <div id="shop-input-expanded" class="shop-input-expanded" style="display:none;">
            <!-- æ¨™é¡Œèˆ‡é—œé–‰æŒ‰éˆ• -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                 <div style="font-size:1.1rem; font-weight:800; color:#333;">æ–°å•†å“</div>
                 <div class="shop-close-btn" onclick="toggleShopInput(false)" style="font-size:1.5rem; color:#999; cursor:pointer; padding:4px;">Ã—</div>
            </div>

            <!-- å“åè¼¸å…¥æ¡† -->
            <div class="shop-input-row">
                <input type="text" id="shop-name-input" class="shop-input" placeholder="å“å (ä¾‹å¦‚: åˆåˆ©ä»–å‘½)" style="font-size:1rem; padding:12px;">
            </div>

            <!-- å‚™è¨»è¼¸å…¥æ¡† -->
            <div class="shop-input-row" style="margin-bottom:12px;">
                <input type="text" id="shop-desc-input" class="shop-input" placeholder="åƒ¹æ ¼ / å‚™è¨» / æ¨™ç±¤">
                <!-- å¿«é€Ÿæ¨™ç±¤ -->
                <div class="quick-tag-row">
                    <span onclick="addTagToDesc('#è—¥å¦')">#è—¥å¦</span>
                    <span onclick="addTagToDesc('#é›¶é£Ÿ')">#é›¶é£Ÿ</span>
                    <span onclick="addTagToDesc('#é›»å™¨')">#é›»å™¨</span>
                    <span onclick="addTagToDesc('#ä¼´æ‰‹ç¦®')">#ä¼´æ‰‹ç¦®</span>
                    <span onclick="addTagToDesc('#ä»£è³¼')">#å…¶ä»–</span>
                </div>
            </div>

            <!-- åœ–ç‰‡é€£çµ (é¸å¡«) -->
            <div class="shop-input-row">
                 <input type="text" id="shop-img-input" class="shop-input" placeholder="åœ–ç‰‡é€£çµ (é¸å¡«)">
            </div>

            <!-- åŠ å…¥æŒ‰éˆ• -->
            <button class="btn-add-shop" onclick="addShoppingItem()">åŠ å…¥æ¸…å–®</button>
        </div>
    `;
    // 5. æ¸²æŸ“åˆ—è¡¨å…§å®¹ (è·Ÿä¹‹å‰ä¸€æ¨£ï¼Œä½†ç”¨ filteredList)
    const listContainer = document.getElementById('shopping-list-content');
    
    if (filteredList.length === 0) {
        listContainer.innerHTML = `
            <div style="grid-column: 1 / -1; text-align:center; padding: 3rem 1rem; color:#ccc; font-size:0.8rem;">
                ${currentShopFilter ? `æ²’æœ‰æ‰¾åˆ° ${currentShopFilter} çš„å•†å“` : 'æ¸…å–®ç©ºç©ºçš„<br>å¿«å»ä¸‹é¢æ–°å¢å§ ğŸ‘‡'}
            </div>
        `;
        return;
    }

    filteredList.forEach((item, index) => {
        // æ³¨æ„ï¼šé€™è£¡çš„ index æ˜¯éæ¿¾å¾Œçš„ indexï¼Œ
        // å¦‚æœè¦æ“ä½œåˆªé™¤/æ‰“å‹¾ï¼Œæœ€å¥½æ”¹ç”¨ item.id ä¾†æ‰¾åŸå§‹é™£åˆ—ï¼Œ
        // ä½†ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘å…ˆç”¨ myShoppingList.indexOf(item) ä¾†æ‰¾å›åŸå§‹ç´¢å¼•ã€‚
        const originalIndex = myShoppingList.indexOf(item);

        const imgDisplay = item.image 
            ? `<img src="${item.image}" class="shop-thumb" onerror="this.src='https://placehold.co/100x100?text=No+Img'">`
            : `<div class="shop-thumb" style="display:flex;align-items:center;justify-content:center;color:#ddd;font-size:1.5rem;background:#f5f5f5;">ğŸ›ï¸</div>`;

        const itemCard = document.createElement('div');
        itemCard.className = `shop-item-card ${item.checked ? 'checked' : ''}`;
        
        itemCard.onclick = (e) => {
            if(e.target.closest('.btn-del-mini')) return;
            toggleShoppingItem(originalIndex);
        };

        // æ¨™ç¤ºå‡º Hashtag é¡è‰²
        let displayDesc = item.desc || '';
        displayDesc = displayDesc.replace(/(#[\w\u4e00-\u9fa5]+)/g, '<span style="color:#3b82f6;font-weight:bold;">$1</span>');

        itemCard.innerHTML = `
            <button class="btn-del-mini" onclick="removeShoppingItem(${originalIndex})">Ã—</button>
            ${imgDisplay}
            <div class="shop-content-mini" style="flex-direction:column; align-items:flex-start; gap:2px;">
                <div style="display:flex;align-items:center;gap:4px;width:100%;">
                    <div class="shop-check-mini ${item.checked ? 'checked' : ''}">âœ“</div>
                    <div class="shop-name-mini">${item.name}</div>
                </div>
                ${displayDesc ? `<div style="font-size:0.65rem;color:#888;padding-left:16px;">${displayDesc}</div>` : ''}
            </div>
        `;
        listContainer.appendChild(itemCard);
    });
}

// è¼”åŠ©å‡½å¼ï¼šåˆ‡æ›éæ¿¾å™¨
function filterShopList(tag) {
    currentShopFilter = tag;
    renderWishlist();
}

// è¼”åŠ©å‡½å¼ï¼šé»æ“Šå¿«é€Ÿæ¨™ç±¤å¸¶å…¥è¼¸å…¥æ¡†
function addTagToDesc(tag) {
    const input = document.getElementById('shop-desc-input');
    if (input.value.includes(tag)) return; // é¿å…é‡è¤‡
    input.value = input.value ? input.value + ' ' + tag : tag;
    input.focus(); // è®“ç„¦é»å›åˆ°è¼¸å…¥æ¡†
}

// åˆ‡æ›è¼¸å…¥æ¡†çš„å±•é–‹/æ”¶åˆ
function toggleShopInput(show) {
    const collapsed = document.getElementById('shop-input-collapsed');
    const expanded = document.getElementById('shop-input-expanded');
    
    if (show) {
        collapsed.style.display = 'none';
        expanded.style.display = 'block';
        // è‡ªå‹•èšç„¦å“å
        setTimeout(() => document.getElementById('shop-name-input').focus(), 100);
    } else {
        collapsed.style.display = 'flex';
        expanded.style.display = 'none';
    }
}


// ä¿®æ”¹ï¼šæ–°å¢è³¼ç‰©æ¸…å–®é …ç›® (æ”¯æ´ Hashtag)
function addShoppingItem() {
    const nameInput = document.getElementById('shop-name-input');
    const descInput = document.getElementById('shop-desc-input');
    const imgInput = document.getElementById('shop-img-input');

    const name = nameInput.value.trim();
    const desc = descInput.value.trim();
    const image = imgInput.value.trim();

    if (!name) {
        alert('è«‹è¼¸å…¥å•†å“åç¨±ï¼');
        return;
    }

    // é€™è£¡ä¸åšç‰¹æ®Šè™•ç†ï¼Œç›´æ¥æŠŠå­—ä¸²å­˜é€²å»
    // ä¹‹å¾Œ render æ™‚æˆ‘å€‘å†ç”¨ Regex æŠ“å‡º #hashtags
    myShoppingList.unshift({
        id: Date.now(), // çµ¦æ¯å€‹å•†å“ä¸€å€‹å”¯ä¸€ ID
        name: name,
        desc: desc, // æ¨™ç±¤æœƒè·Ÿè‘—å‚™è¨»ä¸€èµ·å­˜ï¼Œä¾‹å¦‚ "çµ¦é˜¿å§¨ #ä¼´æ‰‹ç¦®"
        image: image,
        checked: false
    });

    saveShoppingList();
    renderWishlist();

    // æ¸…ç©ºè¼¸å…¥æ¡†
    nameInput.value = '';
    descInput.value = '';
    imgInput.value = '';
}


// 4. åˆªé™¤å•†å“
function removeShoppingItem(index) {
    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ')) {
        myShoppingList.splice(index, 1);
        saveShoppingList();
        renderWishlist();
    }
}

// 5. åˆ‡æ›å‹¾é¸ç‹€æ…‹
function toggleShoppingItem(index) {
    myShoppingList[index].checked = !myShoppingList[index].checked;
    saveShoppingList();
    renderWishlist();
}

// 6. å„²å­˜åˆ° LocalStorage
function saveShoppingList() {
    localStorage.setItem('my_shopping_list', JSON.stringify(myShoppingList));
}


// åœ¨é—œé–‰è¦–çª—æˆ–é€å‡ºæˆåŠŸå¾Œï¼š
const preview = document.getElementById('preview-img');
if (preview) {
    preview.src = '';
    preview.style.display = 'none';
}
const errorMsg = document.getElementById('img-error-msg');
if (errorMsg) errorMsg.style.display = 'none';


function toggleWish(idx) {
WISHLIST[idx].checked = !WISHLIST[idx].checked;
renderWishlist();
}

window.addEventListener('load', init);
// ==========================================
// NEW: äº¤é€šè³‡è¨Šç·¨è¼¯åŠŸèƒ½ (Action Sheet UI)
// ==========================================

// --- ä¿®æ”¹å¾Œçš„äº¤é€šé¸å–®å‡½å¼ ---
function openTransModePicker(idx) {
const overlay = document.createElement('div');
overlay.className = 'temp-overlay';
// é®ç½©æ¨£å¼
overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:999;display:flex;align-items:flex-end;backdrop-filter:blur(2px);';

// 5å€‹é¸é …
const options = [
{ key: 'car', icon: 'ğŸš—', label: 'é–‹è»Š' },
{ key: 'train', icon: 'ğŸšƒ', label: 'é›»è»Š' },
{ key: 'bus', icon: 'ğŸšŒ', label: 'å…¬è»Š' },
{ key: 'airplane', icon: 'âœˆï¸', label: 'é£›è¡Œ' }, // æ–°å¢
{ key: 'walk', icon: 'ğŸš¶', label: 'æ­¥è¡Œ' }
];

let itemsHtml = '';
options.forEach(opt => {
itemsHtml += `
        <div class="trans-option" onclick="saveTransMode(${idx}, '${opt.key}')">
            <span class="trans-opt-icon">${opt.icon}</span>
            <span class="trans-opt-label">${opt.label}</span>
        </div>
    `;
});

const menu = document.createElement('div');
// é¸å–®å®¹å™¨æ¨£å¼ï¼šç¨å¾®ç¸®æ¸› paddingï¼Œè®“æ•´é«”çœ‹èµ·ä¾†æ›´ç·Šæ¹Š
menu.style.cssText = 'width:100%;background:white;border-radius:1.5rem 1.5rem 0 0;padding:1.2rem;padding-bottom:calc(1.5rem + env(safe-area-inset-bottom));animation:slideUp 0.2s ease-out;';

menu.innerHTML = `
    <h3 style="margin:0 0 1rem 0;text-align:center;color:#334155;font-size:1rem;">é¸æ“‡äº¤é€šæ–¹å¼</h3>
    <div class="trans-grid">${itemsHtml}</div>
    <button onclick="this.closest('.temp-overlay').remove()" style="width:100%;padding:10px;border:none;background:#f1f5f9;color:#64748b;border-radius:12px;font-weight:700;font-size:0.9rem;">å–æ¶ˆ</button>
`;

overlay.appendChild(menu);
document.body.appendChild(overlay);
overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };
}


// 2. æ‰“é–‹æ™‚é–“é¸æ“‡é¸å–® (æ¨¡æ“¬æ»¾è¼ªé¸æ“‡)
function openTransTimePicker(idx) {
const item = PLAN[curDay][idx];
const cur = item.trans || { hour: 0, min: 10 }; // é è¨­å€¼

const overlay = document.createElement('div');
overlay.className = 'temp-overlay';
overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:999;display:flex;align-items:flex-end;backdrop-filter:blur(2px);';

// ç”¢ç”Ÿ 0-60 åˆ†é˜çš„é¸é …
let minOptions = '';
for(let i=0; i<=60; i+=5) { // é è¨­5åˆ†é˜ä¸€è·³ï¼Œæ¯”è¼ƒå¥½é¸
minOptions += `<option value="${i}">${i}</option>`;
}

const menu = document.createElement('div');
menu.style.cssText = 'width:100%;background:white;border-radius:1.5rem 1.5rem 0 0;padding:1.5rem;padding-bottom:calc(2rem + env(safe-area-inset-bottom));animation:slideUp 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);';

menu.innerHTML = `
    <h3 style="margin:0 0 1.5rem 0;text-align:center;color:#334155;">äº¤é€šæ™‚é–“</h3>
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:1.5rem;">
        <div style="flex:1;">
            <label style="display:block;text-align:center;font-size:0.75rem;color:#94a3b8;margin-bottom:6px;font-weight:700;">å°æ™‚</label>
            <div style="position:relative;">
                <select id="pk-hour" style="width:100%;padding:12px;border-radius:12px;border:1px solid #e2e8f0;font-size:1.4rem;text-align:center;font-weight:800;color:#334155;background:#f8fafc;appearance:none;">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>
            </div>
        </div>
        <div style="font-weight:900;color:#cbd5e1;font-size:1.5rem;margin-top:1.2rem">:</div>
        <div style="flex:1;">
            <label style="display:block;text-align:center;font-size:0.75rem;color:#94a3b8;margin-bottom:6px;font-weight:700;">åˆ†é˜</label>
            <div style="position:relative;">
                <select id="pk-min" style="width:100%;padding:12px;border-radius:12px;border:1px solid #e2e8f0;font-size:1.4rem;text-align:center;font-weight:800;color:#334155;background:#f8fafc;appearance:none;">
                    ${minOptions}
                </select>
            </div>
        </div>
    </div>
    <button id="btn-save-time" style="width:100%;padding:14px;border:none;background:var(--primary);color:white;border-radius:12px;font-weight:700;font-size:1rem;box-shadow:0 4px 12px rgba(44,62,80,0.2);">ç¢ºå®šä¿®æ”¹</button>
`;

overlay.appendChild(menu);
document.body.appendChild(overlay);

// è¨­å®šç›®å‰é¸ä¸­çš„å€¼
document.getElementById('pk-hour').value = cur.hour || 0;
// å¦‚æœç›®å‰åˆ†é˜æ•¸ä¸æ˜¯5çš„å€æ•¸ï¼Œé‚„æ˜¯è¦èƒ½é¡¯ç¤ºå‡ºä¾†
let safeMin = cur.min || 0;
const minSelect = document.getElementById('pk-min');
// å¦‚æœç¾æœ‰å€¼ä¸åœ¨é¸é …å…§ï¼ˆä¾‹å¦‚ 13åˆ†ï¼‰ï¼Œå‹•æ…‹åŠ é€²å»
if(!minSelect.querySelector(`option[value="${safeMin}"]`)){
const opt = document.createElement('option');
opt.value = safeMin;
opt.text = safeMin;
minSelect.add(opt);
}
minSelect.value = safeMin;

// ç¶å®šå„²å­˜æŒ‰éˆ•
document.getElementById('btn-save-time').onclick = () => {
saveTransTime(idx, 
parseInt(document.getElementById('pk-hour').value), 
parseInt(document.getElementById('pk-min').value)
);
overlay.remove();
};
overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };
}

// 3. å„²å­˜è³‡æ–™çš„ Helper Functions
function saveTransMode(idx, mode) {
if(!PLAN[curDay][idx].trans) PLAN[curDay][idx].trans = { hour:0, min:10 }; // é è¨­çµæ§‹
PLAN[curDay][idx].trans.mode = mode;
document.querySelector('.temp-overlay').remove(); // é—œé–‰é¸å–®
renderPlan(); // é‡æ–°æ¸²æŸ“ç•«é¢
}

function saveTransTime(idx, hour, min) {
if(!PLAN[curDay][idx].trans) PLAN[curDay][idx].trans = { mode:'car' }; // é è¨­çµæ§‹
PLAN[curDay][idx].trans.hour = hour;
PLAN[curDay][idx].trans.min = min;
renderPlan(); // é‡æ–°æ¸²æŸ“ç•«é¢
}

let currentCurrency = 'JPY';
const EXCHANGE_RATE = 0.215; // æ‚¨å¯åœ¨æ­¤ä¿®æ”¹åŒ¯ç‡

function toggleCurrency() {
currentCurrency = (currentCurrency === 'JPY') ? 'TWD' : 'JPY';

// åˆ‡æ›æŒ‰éˆ•æ¨£å¼
document.getElementById('btn-jpy').classList.toggle('active');
document.getElementById('btn-twd').classList.toggle('active');

// æ›´æ–°è¼¸å…¥æ¡†æç¤ºèˆ‡æ¨™ç±¤
const unit = currentCurrency === 'JPY' ? 'Â¥' : 'NT$';
document.getElementById('quick-amt').placeholder = unit;

updateQuickSplitPreview(); 

updateConversion();
if (document.getElementById('quick-split-mode').value === 'custom') {
    renderQuickCustomAmounts();
}
}

/// åªæ›ç®—æ—¥å¹£ -> å°å¹£ Gemini ///
function updateConversion() {
const val = parseFloat(document.getElementById('quick-amt').value) || 0;
const hint = document.getElementById('conversion-hint');

// åªæœ‰ç•¶å¹£åˆ¥æ˜¯ JPY ä¸”é‡‘é¡å¤§æ–¼ 0 æ™‚ï¼Œæ‰é¡¯ç¤ºå°å¹£æ›ç®—
if (currentCurrency === 'JPY' && val > 0) {
// EX_RATE è«‹ç¢ºèªæ‚¨çš„å…¨åŸŸè®Šæ•¸è¨­å®š (ä¾‹å¦‚ 0.215)
const twd = Math.round(val * 0.215); 
hint.innerText = `ç´„ NT$ ${twd.toLocaleString()}`;
} else {
hint.innerText = ''; // å°å¹£æ¨¡å¼æˆ–ç„¡é‡‘é¡æ™‚ï¼Œæ¸…ç©ºæç¤º
}
}

document.getElementById('summary-content').addEventListener('scroll', function(e) {
const scrollLeft = e.target.scrollLeft;
const width = e.target.offsetWidth;
const index = Math.round(scrollLeft / width);
const dots = document.querySelectorAll('.dot');
dots.forEach((dot, i) => {
dot.classList.toggle('active', i === index);
});
}, { passive: true });

// âœ… ä¿®æ­£ç‰ˆï¼šæ ¹æ“šæ—¥æœŸè‡ªå‹•åˆ†é…å¤©æ•¸ (å®Œç¾è§£æ±ºæ ¼å¼éŒ¯èª¤)
async function manualSync() {
    // 1. å–å¾—æŒ‰éˆ•èˆ‡åœ–ç¤º
    const btn = document.getElementById('btn-header-sync');
    const icon = document.getElementById('sync-icon');
    const text = document.getElementById('sync-text');

    // 2. é–å®šæŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
    if (icon) icon.innerHTML = 'â³';
    if (text) text.innerText = 'åŒæ­¥ä¸­...';
    if (btn) btn.disabled = true;

    try {
        if (typeof GOOGLE_APPS_SCRIPT_URL === 'undefined') {
            alert("éŒ¯èª¤ï¼šå°šæœªè¨­å®š GOOGLE_APPS_SCRIPT_URL");
            return;
        }

        console.log("ğŸš€ é–‹å§‹æ‰‹å‹•åŒæ­¥...");

        // 3. å‘¼å« GAS (å¸¶ä¸Šå¯†ç¢¼)
        const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getAll&secretKey=${encodeURIComponent(userEnteredSecret)}`);
        const json = await response.json();

        if (json.status === 'success') {
            console.log("âœ… é›²ç«¯è³‡æ–™æ‹‰å–æˆåŠŸ", json.data);

            if (json.data && Array.isArray(json.data)) {
                
                // ğŸ”„ åˆå§‹åŒ– 5 å¤©çš„ç©ºé™£åˆ— (æº–å‚™é‡æ–°åˆ†é…)
                // é€™è£¡æˆ‘å€‘é è¨­ 5 å¤©ï¼Œå¦‚æœæ‚¨è¡Œç¨‹æ›´å¤šå¤©å¯ä»¥åŠ é•·
                let newExpense = [[], [], [], [], []];

                // ğŸ—“ï¸ å®šç¾©æ—¥æœŸå°ç…§è¡¨ (å°æ‡‰å‰ç«¯çš„ DAYS é™£åˆ—)
                // æ³¨æ„ï¼šé€™è£¡åªæ¯”å° "æœˆ/æ—¥"ï¼Œå¿½ç•¥å¹´ä»½
                const TRIP_DATES = ['01/06', '01/07', '01/08', '01/09', '01/10'];

                json.data.forEach(item => {
                    // 1. è§£ææ—¥æœŸ
                    // é›²ç«¯å›å‚³å¯èƒ½æ˜¯ "2026-01-05T16:00:00.000Z" (UTC) æˆ–å…¶ä»–æ ¼å¼
                    // æˆ‘å€‘éœ€è¦æŠŠå®ƒè½‰æˆç•¶åœ°çš„ "MM/DD"
                    let dateStr = "";
                    
                    if (item.date) {
                        const d = new Date(item.date);
                        // ä¿®æ­£æ™‚å€å•é¡Œï¼šç›´æ¥ç”¨ item.date å­—ä¸²è™•ç†æ¯”è¼ƒä¿éšª
                        // å‡è¨­ GAS å­˜çš„æ˜¯ UTC æ™‚é–“ï¼Œæˆ‘å€‘åªè¦å–æ—¥æœŸéƒ¨åˆ†
                        // ä½†ä¿éšªèµ·è¦‹ï¼Œæˆ‘å€‘å˜—è©¦æŠŠå®ƒè½‰æˆ "01/06" æ ¼å¼
                        
                        // æ–¹æ³•ï¼šç›´æ¥ç”¨ item.date å¦‚æœå®ƒæ˜¯ ISO æ ¼å¼ï¼Œæœƒæœ‰æ™‚å·®å•é¡Œ
                        // æœ€ç©©çš„æ˜¯çœ‹æ‚¨ GAS å­˜é€²å»æ™‚æ˜¯å¦å·²ç¶“æœ‰ç´”æ—¥æœŸå­—ä¸²
                        // å¦‚æœæ²’æœ‰ï¼Œæˆ‘å€‘ç”¨ç°¡å–®çš„æ—¥æœŸæ¯”å°
                        
                        // ç°¡å–®æš´åŠ›è§£ï¼šæ¯”å° timestamps æˆ–æ—¥æœŸå­—ä¸²
                        // é€™è£¡å‡è¨­æ‚¨çš„ trip é–‹å§‹æ–¼ 2026/01/06
                        // æ‚¨å¯ä»¥æ ¹æ“š item.date çš„å…§å®¹ä¾†æ±ºå®š index
                        
                        // ä¿®æ­£æ–¹æ¡ˆï¼šç›´æ¥æ¯”å°æ—¥æœŸå­—ä¸² (MM-DD)
                        // ä½¿ç”¨ç€è¦½å™¨æœ¬åœ°æ™‚é–“è½‰æ›
                        const month = (d.getMonth() + 1).toString().padStart(2, '0');
                        const day = d.getDate().toString().padStart(2, '0');
                        dateStr = `${month}/${day}`;
                    }

                    // 2. æ‰¾å‡ºå®ƒæ˜¯ç¬¬å¹¾å¤© (0 ~ 4)
                    let dayIndex = TRIP_DATES.indexOf(dateStr);
                    
                    // å¦‚æœæ—¥æœŸæ²’å°ä¸Š (å¯èƒ½æ˜¯æ™‚å€å°è‡´è®Šæˆå‰ä¸€å¤©)ï¼Œåšå€‹æ¨¡ç³Šæ¯”å°æˆ–é è¨­ Day 1
                    if (dayIndex === -1) {
                         // å˜—è©¦ç”¨ item.dayIndex å¦‚æœæœ‰çš„è©±
                         if (typeof item.dayIndex !== 'undefined') {
                             dayIndex = item.dayIndex;
                         } else {
                             // å¦‚æœçœŸçš„æ‰¾ä¸åˆ°ï¼Œæš«æ™‚æ­¸é¡åˆ° Day 1 (index 0) æˆ–ç•¶å¤©
                             // é€™è£¡å»ºè­°æª¢æŸ¥ console çœ‹çœ‹æ—¥æœŸè§£æå‡ºä¾†æ˜¯ä»€éº¼
                             console.warn(`æ—¥æœŸç„¡æ³•åŒ¹é…: ${item.date} -> è§£æç‚º ${dateStr}ï¼Œæ­¸é¡è‡³ç¬¬ä¸€å¤©`);
                             dayIndex = 0; 
                         }
                    }

                    // 3. å¡å…¥å°æ‡‰é™£åˆ—
                    if (dayIndex >= 0 && dayIndex < 5) {
                        newExpense[dayIndex].push(item);
                    }
                });

                // 4. æ›´æ–°å…¨åŸŸè®Šæ•¸
                EXPENSE = newExpense;
                
                // 5. å­˜å…¥ LocalStorage
                localStorage.setItem('EXPENSE_DATA', JSON.stringify(EXPENSE));

                // 6. é‡æ–°æ¸²æŸ“
                renderExpense();
                updateExpenseStats();

                alert('âœ… åŒæ­¥æˆåŠŸï¼è³‡æ–™å·²æ›´æ–°');
            } else {
                console.warn("âš ï¸ é›²ç«¯å›å‚³è³‡æ–™æ ¼å¼éŒ¯èª¤ (éé™£åˆ—)", json.data);
                alert("åŒæ­¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤");
            }
        } else {
            console.error("âŒ åŒæ­¥å¤±æ•—", json);
            alert('åŒæ­¥å¤±æ•—ï¼š' + (json.message || 'æœªçŸ¥éŒ¯èª¤'));
        }

    } catch (e) {
        console.error("âŒ ç¶²è·¯/ç¨‹å¼éŒ¯èª¤", e);
        alert('ç¶²è·¯éŒ¯èª¤ï¼Œè©³ç´°è«‹çœ‹ Console');
    } finally {
        // 7. å¾©åŸæŒ‰éˆ•
        if (icon) icon.innerHTML = 'ğŸ”„';
        if (text) text.innerText = 'åŒæ­¥';
        if (btn) btn.disabled = false;
    }
}



  
function toggleExpenseList() {
  const container = document.getElementById('expense-list-container');
  const headerEl = document.querySelector('#view-expense .list-head'); // é¿å…æŠ“åˆ°å…¶ä»–é çš„ .list-head
  if (!container) return;

  const expanded = container.style.maxHeight && container.style.maxHeight !== '0px';
  if (expanded) {
    container.style.maxHeight = null;
    if (headerEl) headerEl.classList.add('collapsed');
  } else {
    container.style.maxHeight = container.scrollHeight + 'px';
    if (headerEl) headerEl.classList.remove('collapsed');
  }
}

// ç·¨è¼¯ Modal - å…¨åŸŸè®Šæ•¸åªå®£å‘Šä¸€æ¬¡
let editingExpenseId = null;

function openEditModal(id) {
    if (typeof EXPENSE === 'undefined' || !EXPENSE[curDay]) return;
    
    const item = EXPENSE[curDay].find(e => e.id === id);
    if (!item) return;
    
    editingExpenseId = id;
    
    // å¡«å…¥è³‡æ–™
    const titleInput = document.getElementById('edit-title');
    const amtInput = document.getElementById('edit-amt');
    const catSelect = document.getElementById('edit-cat');
    const paySelect = document.getElementById('edit-pay');
    
    if (titleInput) titleInput.value = item.title;
    if (amtInput) amtInput.value = item.amt;
    if (catSelect) catSelect.value = item.cat;
    if (paySelect) paySelect.value = item.payMethod;
    
    // é¡¯ç¤º Modal
    const overlay = document.getElementById('edit-expense-overlay');
    if (overlay) overlay.classList.add('open');
}

// å„²å­˜ç·¨è¼¯
function saveEditedExpense() {
    if (!editingExpenseId) return;
    const item = EXPENSE[curDay].find(e => e.id === editingExpenseId);
    
    if (item) {
        item.title = document.getElementById('edit-title').value;
        item.amt = parseInt(document.getElementById('edit-amt').value);
        item.cat = document.getElementById('edit-cat').value;
        item.payMethod = document.getElementById('edit-pay').value;
        
        // é—œé–‰ Modal
        const overlay = document.getElementById('edit-expense-overlay');
        if (overlay) overlay.classList.remove('open');
        
        // é‡æ–°æ¸²æŸ“
        renderExpense();
        renderExpenseCategories();
        updateExpenseStats();
    }
}

// è»Ÿåˆªé™¤
function softDeleteExpense() {
    if (!editingExpenseId) return;
      // [æ–°å¢] åˆªé™¤ç¢ºèªè¦–çª—
    // å¦‚æœä½¿ç”¨è€…æŒ‰ã€Œå–æ¶ˆã€ï¼Œç¨‹å¼å°±æœƒåœ¨é€™è£¡åœæ­¢ï¼Œä¸æœƒåŸ·è¡Œåˆªé™¤
    const isConfirmed = confirm("ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ");
    if (!isConfirmed) return;
	const item = EXPENSE[curDay].find(e => e.id === editingExpenseId);
    
    if (item) {
        item.isDeleted = true;
        
        // é—œé–‰ Modal
        const overlay = document.getElementById('edit-expense-overlay');
        if (overlay) overlay.classList.remove('open');
        
        // é‡æ–°æ¸²æŸ“
        renderExpense();
        renderExpenseCategories();
        updateExpenseStats();
	
	}
}

// é—œé–‰ç·¨è¼¯è¦–çª—
function closeEditModal() {
    const overlay = document.getElementById('edit-expense-overlay');
    if (overlay) {
        overlay.classList.remove('open');
    }
    editingExpenseId = null; // æ¸…ç©ºç•¶å‰ç·¨è¼¯ ID
}


// åˆå§‹åŒ–æ»‘å‹•ç›£è½
function setupSwipeObserver(elementId, dotSelector) {
    const el = document.getElementById(elementId);
    if(!el) return;
    
    el.addEventListener('scroll', () => {
        const index = Math.round(el.scrollLeft / el.offsetWidth);
        const dots = document.querySelectorAll(dotSelector);
        dots.forEach((d, i) => d.classList.toggle('active', i === index));
    }, { passive: true });
}


 
 
 // ==========================================
// â„¹ï¸ æ–°å¢ï¼šè³‡è¨Šé å±•é–‹æ”¶åˆåŠŸèƒ½
// ==========================================

function toggleInfoCard(card) {
    // 1. åˆ‡æ›ç•¶å‰å¡ç‰‡çš„ç‹€æ…‹
    const wasCollapsed = card.classList.contains('collapsed');
    
    // (é¸ç”¨) å¦‚æœå¸Œæœ›ã€Œä¸€æ¬¡åªå±•é–‹ä¸€å€‹ã€ï¼Œè«‹åŠ å…¥é€™è¡Œï¼š
    // document.querySelectorAll('.info-card').forEach(c => c.classList.add('collapsed'));
    
    if (wasCollapsed) {
        card.classList.remove('collapsed');
    } else {
        card.classList.add('collapsed');
    }
}

 
 
</script>
</body>
</html> 
