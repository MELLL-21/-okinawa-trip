<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2C3E50">
    <title>æ²–ç¹©è¡Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --primary: #2C3E50;
            --accent: #E76F51;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: var(--primary); }
        body { display: flex; flex-direction: column; }

        /* Header */
        header { padding: calc(1rem + var(--safe-top)) 1.5rem 0.5rem; flex-shrink: 0; z-index: 10; position: relative; }
        h1 { margin: 0; font-family: 'Noto Serif TC', serif; font-size: 2rem; font-weight: 900; }
        .subtitle { color: #607d8b; font-size: 0.8rem; font-weight: 600; margin-top: 5px; display: flex; align-items: center; gap: 6px; }
        .badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }

        /* Tabs */
        .tabs { display: flex; padding: 0 1.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); z-index: 10; justify-content: space-around; flex-shrink: 0; position: relative; }
        .tab { padding: 1rem 0; font-weight: 700; color: #999; font-size: 0.8rem; position: relative; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .tab svg { width: 24px; height: 24px; fill: currentColor; }
        .tab.active { color: var(--primary); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--accent); border-radius: 2px; }

        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 1rem 1rem calc(6rem + var(--safe-bottom)) 1rem; -webkit-overflow-scrolling: touch; position: relative; z-index: 1; }

        /* Day Scroll */
        .day-scroll { display: flex; gap: 0.8rem; overflow-x: auto; padding: 0.5rem 0 1rem; scroll-snap-type: x mandatory; z-index: 2; position: relative; }
        .day-scroll::-webkit-scrollbar { display: none; }
        .day-card { flex: 0 0 8.5rem; height: 6.5rem; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px); border-radius: 1rem; padding: 0.8rem; display: flex; flex-direction: column; justify-content: space-between; border: 2px solid transparent; transition: 0.2s; scroll-snap-align: start; box-shadow: 0 4px 12px rgba(0,0,0,0.03); cursor: pointer; position: relative; }
        .day-card:active { transform: scale(0.96); }
        .day-card.active { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(44,62,80,0.3); border-color: var(--primary); }
        .day-top { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: 800; opacity: 0.8; letter-spacing: 1px; }
        .day-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }
        .day-num { font-family: 'Noto Serif TC'; font-size: 1.8rem; font-weight: 700; line-height: 1; margin-top: auto; }
        .day-num span { font-size: 0.8rem; opacity: 0.6; font-family: 'Inter'; margin-left: 2px; }

        /* Weather Card */
        .weather { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); padding: 1rem 1.2rem; border-radius: 1.2rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .w-txt h3 { margin: 0 0 4px 0; font-family: 'Noto Serif TC'; font-size: 1rem; }
        .w-txt p { margin: 0; font-size: 0.7rem; color: #666; }
        .w-val { background: rgba(255,255,255,0.8); padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 1.2rem; }

        /* List Headers */
        .list-head { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 0.8rem; padding: 0 4px; }
        .list-head h2 { margin: 0; font-family: 'Noto Serif TC'; font-size: 1.2rem; }
        .hint { font-size: 0.65rem; background: rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 12px; color: #888; }

        /* Plan Card */
        .plan-card { background: white; padding: 1rem; border-radius: 1.2rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 8px 24px rgba(0,0,0,0.08); cursor: pointer; transition: transform 0.1s; height: 7.5rem; position: relative; z-index: 2; }
        .plan-card:active { transform: scale(0.98); }
        .plan-left { display: flex; flex-direction: column; justify-content: center; gap: 6px; flex: 1; min-width: 0; }
        .plan-time { font-size: 1.4rem; font-weight: 900; color: var(--primary); line-height: 1; }
        .plan-tag { display: inline-block; font-size: 0.7rem; padding: 3px 8px; border-radius: 12px; font-weight: 700; color: white; width: fit-content; }
        .plan-title { font-family: 'Noto Serif TC'; font-weight: 800; font-size: 1.1rem; color: var(--primary); margin-top: 2px; }
        .plan-loc { font-size: 0.75rem; color: #888; display: flex; align-items: center; gap: 4px; font-weight: 500; }
        .plan-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; margin-left: 1rem; flex-shrink: 0; }

		/* ä¿®æ”¹å°èˆªæŒ‰éˆ•æ¨£å¼ */
	.nav-btn {
    padding: 6px 12px; /* ç¨å¾®åŠ å¯¬ä¸€é»é» */
    border-radius: 999px;
    background: #3b82f6; /* å¡ç‰‡è—åº• (é…åˆ bg-sight çš„é¡è‰²) */
    color: #ffffff;      /* ç™½è‰²æ–‡å­—èˆ‡åœ–æ¨™ */
    font-size: 0.75rem;
    font-weight: 700;    /* å­—é«”åŠ ç²— */
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;            /* åœ–æ¨™èˆ‡æ–‡å­—é–“è· */
    box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4); /* å¢åŠ ä¸€é»è—è‰²å…‰æšˆé™°å½± */
    transition: transform 0.2s, box-shadow 0.2s;
}

	.nav-btn:active {
    transform: scale(0.95);
    box-shadow: 0 2px 5px rgba(59, 130, 246, 0.4);
}

.nav-btn svg {
    width: 14px;
    height: 14px;
    fill: currentColor; /* è®“åœ–æ¨™è·Ÿéš¨æ–‡å­—é¡è‰²è®Šæˆç™½è‰² */
     /* èª¿æ•´è§’åº¦è®“ç®­é ­æŒ‡å‘å³ä¸Šæ–¹ */
}
        .nav-btn svg { width: 14px; height: 14px;fill: currentColor; }

        /* Flight Ticket */
        .ticket-card { display: flex; background: #ffffff; border-radius: 18px; padding: 10px 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 12px; position: relative; overflow: hidden; }
        .ticket-left { border-right: 1px dashed #e5e7eb; padding-right: 12px; margin-right: 12px; display: flex; flex-direction: column; justify-content: center; font-size: 12px; }
        .ticket-left .flight { font-size: 1.2rem; font-weight: 800; margin-top: 4px; color: #111827; }
        .ticket-left .date { font-size: 0.75rem; margin-top: 4px; color: #9ca3af; }
        .ticket-right { display: flex; flex-direction: column; justify-content: center; flex: 1; }
        .ticket-route { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; font-weight: 700; color: #111827; }
        .ticket-time-row { margin-top: 4px; font-size: 0.75rem; color: #4b5563; display: flex; justify-content: space-between; }
        .ticket-meta { margin-top: 4px; font-size: 0.7rem; color: #9ca3af; display: flex; justify-content: space-between; }

        /* Expense Summary Card */
        .exp-summary-card { background: var(--primary); color: white; padding: 2rem; border-radius: 1.5rem; text-align: center; margin-bottom: 1rem; box-shadow: 0 8px 20px rgba(44,62,80,0.3); }
        .stat-tabs { display: flex; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 4px; margin-bottom: 1rem; }
        .stat-tab { flex: 1; text-align: center; padding: 6px; font-size: 0.8rem; color: rgba(255,255,255,0.6); border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .stat-tab.active { background: white; color: var(--primary); }

        /* Quick Expense Form */
        .quick-expense-card { background: rgba(255,255,255,0.9); border-radius: 1.2rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: 0.3s; border: 2px solid transparent; }
        .quick-expense-card.editing { border-color: var(--accent); background: #fff; box-shadow: 0 8px 24px rgba(231, 111, 81, 0.15); }
        .quick-expense-row {display: flex; /* æ”¹ç‚º flex */flex-wrap: wrap; /* å…è¨±æ›è¡Œ */gap: 0.8rem;margin-bottom: 0.8rem;}.quick-expense-row > div {flex: 1 1 120px; /* å¯¬åº¦ä¸è¶³æ™‚è‡ªå‹•æ›è¡Œ */}
        .quick-expense-card label { font-size: 0.7rem; color: #888; margin-bottom: 2px; display: block; font-weight: 700; }
        .quick-expense-card input, .quick-expense-card select { width: 100%; padding: 0.55rem 0.7rem; border-radius: 0.7rem; border: 1px solid #e5e7eb; font-size: 0.8rem; }
        .quick-expense-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 0.3rem; }
        .btn-submit { padding: 0.5rem 1.2rem; border-radius: 999px; border: none; background: var(--primary); color: #fff; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .quick-expense-card.editing .btn-submit { background: var(--accent); }
        .edit-actions { display: none; gap: 6px; }
        .quick-expense-card.editing .edit-actions { display: flex; }
        .btn-cancel, .btn-delete-inline { padding: 0.5rem 0.8rem; border-radius: 999px; border: 1px solid #ddd; background: white; color: #666; font-size: 0.75rem; font-weight: 700; cursor: pointer; }
        .btn-delete-inline { color: #ef4444; border-color: #fee2e2; background: #fef2f2; }

        /* Expense List */
        .expense-row { background: white; padding: 0.8rem 1rem; border-radius: 1rem; margin-bottom: 0.8rem; display: block; box-shadow: 0 2px 8px rgba(0,0,0,0.03); cursor: pointer; transition: transform 0.1s; }
        .expense-row:active { transform: scale(0.98); }
        .expense-header { display: flex; justify-content: space-between; align-items: center; }
        .expense-detail-panel { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e5e7eb; animation: slideDown 0.2s ease-out; }
        .expense-row.expanded .expense-detail-panel { display: block; }
        .detail-list-item { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 6px; padding: 6px 10px; background: #f8fafc; border-radius: 8px; }
        .detail-user-name { font-weight: 700; color: #374151; }
        .detail-user-name.payer { background: rgba(44, 62, 80, 0.1); color: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: 800; border-left: 3px solid var(--primary); padding-left: 8px; }
        .detail-user-name.debtor { background: rgba(231, 111, 81, 0.08); color: var(--accent); padding: 2px 6px; border-radius: 4px; font-weight: 800; border-left: 3px solid var(--accent); padding-left: 8px; }
        .detail-amount { font-weight: 700; color: var(--accent); }
        .btn-edit-inline { width: 100%; margin-top: 10px; padding: 10px; background: white; color: var(--primary); border: 1.5px solid var(--primary); border-radius: 10px; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.15s; }
        .btn-edit-inline:active { transform: scale(0.98); background: #f1f5f9; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .pay-method-badge { font-size: 0.6rem; background: #eee; color: #666; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
        .advance-badge { font-size: 0.6rem; border: 1px solid var(--accent); color: var(--accent); padding: 1px 4px; border-radius: 4px; margin-left: 4px; }
        .repaid-badge { font-size: 0.6rem; background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: 700; }

        /* Wishlist */
        .wish-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .wish-card { background: white; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; cursor: pointer; }
        .wish-img { width: 100%; aspect-ratio: 1; object-fit: cover; background: #eee; display: block; }
        .wish-content { padding: 0.8rem; }
        .wish-check { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 5; }
        .wish-check.checked { background: var(--accent); color: white; }

        /* Colors */
        .bg-sight { background: #3b82f6; } .bg-food { background: #f97316; } .bg-shop { background: #ec4899; } .bg-trans { background: #64748b; } .bg-other { background: #10b981; }

        /* FAB & Modal */
        .fab { position: fixed; bottom: calc(2rem + var(--safe-bottom)); right: 1.5rem; width: 3.5rem; height: 3.5rem; background: var(--primary); border-radius: 50%; color: white; box-shadow: 0 8px 20px rgba(44,62,80,0.4); display: flex; align-items: center; justify-content: center; z-index: 100; transition: transform 0.2s; cursor: pointer; }
        .fab:active { transform: scale(0.9); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; display: flex; align-items: flex-end; }
        .overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: #FDFBF7; width: 100%; border-radius: 1.5rem 1.5rem 0 0; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 90dvh; overflow-y: auto; padding-bottom: calc(2rem + var(--safe-bottom)); }
        .overlay.open .modal { transform: translateY(0); }
        .form-row { margin-bottom: 1rem; }
        label { display: block; font-size: 0.75rem; color: #888; font-weight: 700; margin-bottom: 6px; }
        input, select, textarea { width: 100%; padding: 0.9rem; background: white; border: 1px solid #eee; border-radius: 0.8rem; font-size: 1rem; color: var(--primary); outline: none; appearance: none; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
        input:focus, select:focus { border-color: var(--primary); }
        .cats { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; }
        .cat-chip { padding: 8px 16px; background: white; border-radius: 20px; font-size: 0.8rem; color: #aaa; font-weight: 700; white-space: nowrap; border: 1px solid #eee; cursor: pointer; }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .split-person-btn { padding: 6px 10px; border-radius: 999px; border: 1px solid #e5e7eb; background: #f9fafb; font-size: 0.8rem; font-weight: 700; color: #374151; cursor: pointer; transition: 0.15s; }
        .split-person-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-save { width: 100%; padding: 1rem; background: var(--primary); color: white; border-radius: 1rem; font-size: 1rem; font-weight: 700; margin-top: 1.5rem; box-shadow: 0 4px 12px rgba(44,62,80,0.2); }
        .btn-del { width: 100%; padding: 1rem; color: #ef4444; font-weight: 700; background: transparent; margin-top: 0.5rem; }

        /* Expense Category Card */
        .exp-category-card { background: rgba(255,255,255,0.9); border-radius: 1.2rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .exp-category-card-title { font-size: 0.8rem; font-weight: 700; color: #666; margin-bottom: 0.8rem; padding-left: 4px; }
        .exp-category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; }
        .exp-category-item { padding: 1rem 0.8rem; border-radius: 1.2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.4rem; text-align: center; color: #fff; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 100px; }
        .exp-category-item span:first-child { font-size: 0.75rem; opacity: 0.9; letter-spacing: 0.5px; }
        .exp-category-item span:nth-child(2) { font-size: 1.3rem; font-weight: 900; line-height: 1; margin: 0.2rem 0; }
        .exp-category-item span:nth-child(3) { font-size: 0.7rem; opacity: 0.85; margin-top: 0.2rem; }

        /* Welcome Card */
        .welcome-card-wrapper { position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.18); backdrop-filter: blur(10px); }
        .welcome-card-inner { background: rgba(255,255,255,0.96); border-radius: 1.4rem; box-shadow: 0 12px 35px rgba(15,23,42,0.25); padding: 1.2rem 1.3rem 1.1rem; width: 88%; max-width: 320px; text-align: center; }
        .welcome-user-list { display: flex; flex-direction: column; gap: 8px; max-height: 220px; overflow-y: auto; margin-top: 0.4rem; padding-right: 2px; }
        .welcome-user-btn { align-self: center; min-width: 120px; max-width: 180px; padding: 6px 10px; border-radius: 999px; border: 1px solid #e5e7eb; background: #f9fafb; font-size: 0.8rem; font-weight: 700; color: #374151; cursor: pointer; transition: 0.15s; }
        .welcome-user-btn:active { transform: scale(0.95); }
        .welcome-user-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* Debt Modal */
        #debt-modal-overlay { display: flex; align-items: flex-end; }
        #debt-detail-list { margin-bottom: 1.5rem; }
        #debt-modal-footer { text-align: right; font-weight: 900; font-size: 1.2rem; color: var(--primary); border-top: 1px solid #eee; padding-top: 1rem; }

/* --- ä¿®æ”¹å¾Œï¼šåœ“å¼§èˆ‡æ´»æ½‘é¢¨æ ¼ --- */

.plan-wrapper {
    position: relative;
    /* é€™è£¡ä¸éœ€è¦ç•™ç™½ï¼Œç”±å…§å®¹æ’é–‹ */
}

/* 1. å¡ç‰‡æ¨£å¼ï¼šåœ“å¼§å·¦å´é‚Šæ¢ */
.plan-card {
    background: white;
    padding: 1rem;
    border-radius: 1.2rem; /* ä¿æŒåŸæœ¬åœ“è§’ */
    margin-bottom: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 16px rgba(0,0,0,0.05);
    cursor: pointer;
    position: relative;
    z-index: 2;
    /* é—œéµä¿®æ”¹ï¼šåˆ©ç”¨ border-left å¯¦ä½œé‚Šæ¢ï¼Œæœƒè‡ªå‹•è·Ÿéš¨ border-radius */
    border: 1px solid white; /* é è¨­é‚Šæ¡† */
    border-left: 6px solid var(--card-color, #ccc); /* å·¦å´è®Šç²—ä¸”æœ‰é¡è‰² */
    transition: transform 0.1s;
}

.plan-card:active {
    transform: scale(0.98);
}

.plan-left {
    padding-left: 8px; /* ç¨å¾®æ¨é–‹ä¸€é»ï¼Œé¿é–‹å·¦å´é‚Šæ¢ */
    flex: 1; /* ç¢ºä¿ä½”æ»¿å‰©é¤˜ç©ºé–“ */
    min-width: 0; /* é˜²æ­¢æ–‡å­—æº¢å‡º */
}

/* 2. äº¤é€šæŒ‰éˆ•ï¼šæ›´ç²¾ç·»çš„ç‰ˆæœ¬ */
.trans-badge {
    position: relative;
    z-index: 2;
    margin: 4px auto; /* ç¸®å°ä¸Šä¸‹é–“è· */
    width: fit-content;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: 99px;
    border: 2px solid var(--card-color, #e2e8f0);
    box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    font-size: 0.75rem; /* å­—é«”ç¨å¾®ç¸®å° */
    color: #555;
    font-weight: 800;
}

/* äº¤é€šè³‡è¨Šçš„çŸ­é€£æ¥ç·š */
.trans-line {
    height: 14px; /* çŸ­ä¸€é» */
    width: 2px;
    background: #e2e8f0;
    margin: 0 auto;
    border-radius: 2px;
}

.trans-icon, .trans-time {
    padding: 5px 10px; /* ç¸®å°å…§è· */
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: background 0.2s;
}

.trans-icon {
    background: var(--card-color-light, #f1f5f9);
    color: var(--card-color, #64748b);
    border-radius: 99px 0 0 99px;
    padding-left: 12px;
}
.trans-time {
    padding-right: 12px;
    border-radius: 0 99px 99px 0;
}
.trans-icon:active, .trans-time:active {
    filter: brightness(0.95);
}

/* 3. æ–°å¢ï¼šäº¤é€šé¸æ“‡ Action Sheet çš„æ–°æ¨£å¼ (5å€‹ä¸¦æ’ï¼Œé«˜åº¦çŸ­) */
.trans-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr); /* 5æ ¼ä¸¦æ’ */
    gap: 8px; /* é–“è·ç¸®å° */
    margin-bottom: 1rem;
}

.trans-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px 4px; /* é«˜åº¦ç¸®å° */
    border-radius: 12px;
    background: #f8fafc;
    cursor: pointer;
    border: 1px solid #f1f5f9;
    transition: all 0.2s;
}
.trans-option:active {
    background: #e2e8f0;
    transform: scale(0.95);
}
.trans-opt-icon {
    font-size: 1.6rem; /* åœ–ç¤ºå¤§å°é©ä¸­ */
    margin-bottom: 2px;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.05));
}
.trans-opt-label {
    font-size: 0.7rem; /* æ–‡å­—ç¸®å° */
    font-weight: 700;
    color: #475569;
    white-space: nowrap; /* ä¸æ›è¡Œ */
}
.currency-capsule {
  display: inline-flex;
  background: #f0f0f0;
  border-radius: 20px;
  padding: 4px;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 700;
  user-select: none;
  border: 1px solid #e5e7eb;
  gap: 0;
}

.currency-capsule span {
  padding: 6px 10px;
  border-radius: 16px;
  transition: 0.2s;
  color: #666;
  font-size: 0.75rem;
  font-weight: 800;
  min-width: 30px;
  text-align: center;
}

.currency-capsule span.active {
  background: var(--primary);
  color: white;
}


	/* å®¹å™¨è¨­å®šç‚ºå‚ç›´æ’åˆ—ï¼Œè®“æŒ‡ç¤ºé»æ’åœ¨æœ€ä¸‹æ–¹ */
#summary-content {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%; /* ç¢ºä¿é«˜åº¦æ’é–‹ */
}

.stat-swipe-wrapper {
    flex: 1;
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;

    /* æ–°å¢é€™è¡Œï¼šç¢ºä¿å®¹å™¨å¯¬åº¦æ˜ç¢º */
    width: 100%; 
}

.swipe-card {
    /* å¼·åˆ¶æ¯å¼µå¡ç‰‡å¯¬åº¦ç‚ºå®¹å™¨çš„ 100%ï¼Œä¸å…è¨±å£“ç¸®æˆ–æ”¾å¤§ */
    flex: 0 0 100% !important;
    width: 100% !important;
    min-width: 100% !important;

    scroll-snap-align: start; /* æ»‘å‹•æ™‚è‡ªå‹•å°é½Šèµ·é» */
    padding: 10px 15px;      /* ç¶­æŒæ‚¨åŸæœ¬çš„å…§è· */
    box-sizing: border-box;  /* ç¢ºä¿ padding ä¸æœƒæ’å¤§å¯¬åº¦ */
}


/* 6é»é˜æ–¹å‘æŒ‡ç¤ºé» [image:1] */
.swipe-dots {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 6px;
    padding: 8px 0 12px 0; /* å¢åŠ åº•éƒ¨é–“è·ï¼Œä½¿å…¶ä½æ–¼å¡ç‰‡åº•éƒ¨ä¸­å¤® */
}

.dot {
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    transition: all 0.3s ease;
}

/* å•Ÿå‹•ç‹€æ…‹çš„é»è®Šé•·ä¸”è®Šäº® */
.dot.active {
    background: #FFD700; /* èˆ‡ç¸½é¡é‡‘é»ƒè‰²çµ±ä¸€ */
    width: 15px;
    border-radius: 3px;
    opacity: 1;
}

/* ğŸ†• ç™»å…¥æˆåŠŸå‹•ç•« */
@keyframes fadeOut {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.95);
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* --- ä¿®æ­£ç‰ˆï¼šæ­¡è¿ç•«é¢èˆ‡æˆåŠŸå‹•ç•« --- */

/* 1. ç¢ºä¿èƒŒæ™¯é®ç½©æ°¸é ç½®ä¸­ä¸”è¦†è“‹å…¨è¢å¹• */
#welcome-card {
    position: fixed;
    inset: 0;
    z-index: 998;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
    transition: opacity 0.5s ease;
}

/* 2. èƒŒæ™¯å¡ç‰‡å…§å®¹ï¼šé»æ“Šå¾Œæœƒå¹³æ»‘æ¶ˆå¤± */
.welcome-card-inner {
    transition: all 0.4s ease;
}
.welcome-card-inner.hide-content {
    opacity: 0;
    transform: scale(0.9);
    pointer-events: none;
}

/* 3. æˆåŠŸè¨Šæ¯ï¼šå¼·åˆ¶å›ºå®šåœ¨è¢å¹•æ­£ä¸­å¤®ï¼Œä¸éš¨å®¹å™¨è·³å‹• */
.login-success-message {
    position: fixed;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important; /* å¼·åˆ¶ä¿®æ­£ä½ç§» */
    background: white;
    padding: 2.5rem 2rem;
    border-radius: 1.5rem;
    box-shadow: 0 20px 50px rgba(0,0,0,0.25);
    text-align: center;
    z-index: 999;
    width: 280px;
    animation: slideInCenter 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

/* 4. å‹•ç•«ï¼šç”±å°è®Šå¤§ä¸¦ä¿æŒåœ¨ä¸­å¿ƒ */
@keyframes slideInCenter {
    from {
        opacity: 0;
        transform: translate(-50%, -45%) scale(0.85);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

/* 5. æˆåŠŸè¨Šæ¯æ¶ˆå¤±å‹•ç•« */
@keyframes fadeOutMsg {
    to {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.95);
    }
}

/* 6. å…¨åŸŸæ·¡å‡ºæ•ˆæœ */
.welcome-fade-out {
    opacity: 0 !important;
}

.welcome-card-wrapper.exit-animation {
  animation: fadeOut 0.6s ease-out forwards;
}

/* ä½¿ç”¨è€…æŒ‰éˆ•æ¨£å¼ */
.welcome-user-btn {
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid #eee;
  background: white;
  color: #555;
  font-weight: 700;
  cursor: pointer;
  transition: 0.2s;
  font-size: 0.9rem;
}

/* ç•¶è¢«é¸ä¸­æ™‚çš„æ¨£å¼ */
.welcome-user-btn.selected {
  background: #2C3E50;
  color: white;
  border-color: #2C3E50;
  transform: scale(1.05);
  box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2);
}







    </style>
</head>
<body>
    <!-- Welcome Card -->
<div id="welcome-card" class="welcome-card-wrapper">
 <div class="welcome-card-inner">
  <div style="font-size: 1.5rem; margin-bottom: 0.4rem; font-weight: 900; color: #2C3E50;">æ²–ç¹©è¨˜å¸³</div>
  <div style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">è«‹é¸æ“‡èº«åˆ†ä¸¦é©—è­‰</div>

  <!-- 1. ä½¿ç”¨è€…é¸æ“‡å€ (æ”¹ç‚ºé»é¸å¾Œè®Šè‰²) -->
  <div id="welcome-user-list" class="welcome-user-list" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 1rem;">
    <!-- JS æœƒè‡ªå‹•åœ¨é€™è£¡ç”¢ç”ŸæŒ‰éˆ• -->
  </div>

  <!-- 2. å¯†ç¢¼è¼¸å…¥å€ -->
  <div style="margin-bottom: 1rem;">
    <input type="password" id="entry-password" placeholder="è¼¸å…¥é€šé—œå¯†ç¢¼" 
    <input type="password" id="entry-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" 
           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; text-align: center; font-size: 1rem; background: #f9f9f9; outline: none; transition: 0.2s;">
  </div>

  <!-- 3. ç¢ºèªæŒ‰éˆ• -->
  <button id="btn-login-confirm" onclick="handleLogin()" 
          style="width: 100%; padding: 12px; background: #E76F51; color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 12px rgba(231, 111, 81, 0.3);">
    ç¢ºèªç™»å…¥
  </button>
</div>

</div>


    <header style="display: flex; justify-content: space-between; align-items: flex-start;">
  <div>
    <h1>æ²–ç¹©è¡Œ</h1>
    <div class="subtitle">
      <span class="badge" id="current-user-badge">5 Days</span>
    </div>
  </div>

  <!-- ğŸ†• æ–°å¢çš„åŒæ­¥æŒ‰éˆ• (æ©˜è‰²æ¡†è™•) -->
  <button id="btn-header-sync" onclick="manualSync()" 
          style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 8px 12px; 
                 box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 6px; 
                 font-size: 0.8rem; font-weight: 700; color: #4b5563; transition: transform 0.1s;">
    <span id="sync-icon">ğŸ”„</span>
    <span id="sync-text">åŒæ­¥</span>
  </button>
</header>


    <div class="tabs">
        <div class="tab active" onclick="switchTab(this, 'itinerary')">
            <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/></svg>
            è¡Œç¨‹
        </div>
        <div class="tab" onclick="switchTab(this, 'expense')">
            <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
            è¨˜å¸³
        </div>
        <div class="tab" onclick="switchTab(this, 'wishlist')">
            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            é¡˜æœ›æ¸…å–®
        </div>
    </div>

    <!-- ITINERARY VIEW -->
    <main id="view-itinerary">
        <div class="day-scroll" id="day-list"></div>
        <div class="weather" id="weather-card">
            <div class="w-txt">
                <h3>æ²–ç¹©ï¼å³æ™‚å¤©æ°£</h3>
                <p id="weather-desc">è¼‰å…¥ä¸­...</p>
                <p id="clothing-advice" style="font-size:0.7rem; color:var(--accent); margin-top:4px; font-weight:700"></p>
            </div>
            <div class="w-val" id="weather-temp">--Â°C</div>
        </div>
        <div class="list-head">
            <h2>è¡Œç¨‹è¡¨</h2>
            <span class="hint">é»æ“Šç·¨è¼¯ / å³å´å°èˆª</span>
        </div>
        <div id="plan-list"></div>
    </main>

    <!-- EXPENSE VIEW -->
    <main id="view-expense" style="display:none">
        <!-- EXPENSE SUMMARY CARD -->
        <div class="exp-summary-card">
            <!-- è«‹æ›¿æ› id="summary-content" å…§éƒ¨çš„å…§å®¹æ¨£æ¿ -->
<div id="summary-content" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 0;">
    <!-- å·¦å´ï¼šåŸå§‹å¹£åˆ¥åˆ†è¡Œ -->
    <div style="flex: 1; text-align: left; padding-left: 10px; border-right: 1px solid rgba(255,255,255,0.2);">
        <div style="margin-bottom: 8px;">
            <span style="font-size: 0.75rem; opacity: 0.8; display: block; margin-bottom: 2px;">ğŸ‡¯ğŸ‡µ æ—¥å¹£æ¶ˆè²»</span>
            <span style="font-size: 1.2rem; font-weight: 700;">Â¥ ${totals.JPY.toLocaleString()}</span>
        </div>
        <div>
            <span style="font-size: 0.75rem; opacity: 0.8; display: block; margin-bottom: 2px;">ğŸ‡¹ğŸ‡¼ å°å¹£æ¶ˆè²»</span>
            <span style="font-size: 1.2rem; font-weight: 700;">NT$ ${totals.TWD.toLocaleString()}</span>
        </div>
    </div>

    <!-- å³å´ï¼šåŠ ç¸½çµæœ -->
    <div style="flex: 1; text-align: center;">
        <div style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 4px;">ç¸½è¨ˆç´„ (Total)</div>
        <div style="font-size: 1.8rem; font-weight: 900; color: #FFD700;"> <!-- ä½¿ç”¨é‡‘é»ƒè‰²å¼·èª¿ç¸½é¡ -->
            <span style="font-size: 1rem; margin-right: 2px;">NT$</span>${combinedTwd.toLocaleString()}
        </div>
    </div>
</div>

        </div>

        <!-- QUICK EXPENSE FORM -->
<div class="quick-expense-card" id="quick-expense-card">
  <div style="font-size:0.8rem; font-weight:700; margin-bottom:1rem;">
    <span id="quick-form-title">å¿«é€Ÿè¨˜å¸³</span>
  </div>

  <!-- Row 1: æ—¥æœŸã€ç¨®é¡ -->
  <div class="quick-expense-row">
    <div>
      <label>æ—¥æœŸ</label>
      <select id="quick-date">
        <option value="0">01/06 (ç¬¬1å¤©)</option>
        <option value="1">01/07 (ç¬¬2å¤©)</option>
        <option value="2">01/08 (ç¬¬3å¤©)</option>
        <option value="3">01/09 (ç¬¬4å¤©)</option>
        <option value="4">01/10 (ç¬¬5å¤©)</option>
      </select>
    </div>
    <div>
      <label>ç¨®é¡</label>
      <select id="quick-cat">
        <option value="food">ç¾é£Ÿ</option>
        <option value="sight">æ™¯é»</option>
        <option value="shop">è³¼ç‰©</option>
        <option value="trans">äº¤é€š</option>
        <option value="other">å…¶ä»–</option>
      </select>
    </div>
  </div>

  <!-- Row 2: åç¨±ã€æ”¯ä»˜æ–¹å¼ -->
  <div class="quick-expense-row">
    <div>
      <label>åç¨±</label>
      <input type="text" id="quick-title" placeholder="ä¾‹ï¼šåˆé¤">
    </div>
    <div>
      <label>æ”¯ä»˜æ–¹å¼</label>
      <select id="quick-pay">
        <option value="cash">ç¾é‡‘</option>
        <option value="card">ä¿¡ç”¨å¡</option>
      </select>
    </div>
  </div>

  <!-- Row 3: é‡‘é¡ã€å¹£åˆ¥ã€è½‰æ› -->
  <div class="quick-expense-row" style="align-items: flex-end;">
    <div style="flex: 1; position: relative;">
      <label>é‡‘é¡</label>
      <div style="display: flex; align-items: center; gap: 6px;">
        <!-- è† å›Šå‹å¹£åˆ¥åˆ‡æ› -->
        <div class="currency-capsule" onclick="toggleCurrency()" style="min-width: 70px; justify-content: center;">
          <span id="btn-jpy" class="active" style="cursor: pointer;">Â¥</span>
          <span id="btn-twd" style="cursor: pointer;">NT$</span>
        </div>
        <input type="number" id="quick-amt" min="0" placeholder="0" oninput="updateConversion()" style="flex: 1;">
      </div>
      <div id="conversion-hint" style="font-size:0.7rem; color:#999; margin-top:4px; min-height:1rem;"></div>
    </div>
  </div>

 <!-- Row 4: åªä¿ç•™åˆ†å¸³æ¨¡å¼ -->
<div class="quick-expense-row">
    <div style="flex: 1;">  <!-- è®“åˆ†å¸³æ¨¡å¼ç¨ä½”æ•´è¡Œ -->
        <label>åˆ†å¸³æ¨¡å¼</label>
        <select id="quick-split-mode" onchange="toggleQuickSplitMode(this.value)">
            <option value="none">ä¸åˆ†å¸³</option>
            <option value="equal">å¹³å‡åˆ†å¸³</option>
            <option value="custom">è‡ªè¨‚åˆ†å¸³</option>
        </select>
    </div>
</div>


  <!-- åˆ†å¸³é¸é … (ç•¶é¸æ“‡åˆ†å¸³æ™‚é¡¯ç¤º) -->
  <div id="quick-split-options" style="display:none; margin-top:1rem; padding:1rem; background:#f9fafb; border-radius:0.8rem; border: 1px solid #e5e7eb;">
    <div id="quick-equal-mode" style="display:none;">
      <div style="font-size:0.7rem; color:#888; font-weight:700; margin-bottom:0.8rem;">é¸æ“‡åƒèˆ‡å¹³å‡åˆ†å¸³çš„äºº</div>
      <div id="quick-split-persons" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
    </div>
    <div id="quick-custom-mode" style="display:none;">
      <div style="font-size:0.7rem; color:#888; font-weight:700; margin-bottom:0.8rem;">è‡ªè¨‚æ¯äººåˆ†å¸³é‡‘é¡</div>
      <div id="quick-custom-amounts"></div>
    </div>
    <!-- åˆ†å¸³é è¦½ -->
    <div id="quick-split-preview" style="margin-top:0.8rem; padding:0.8rem; background:white; border-radius:0.6rem; border-left:3px solid var(--accent); font-size:0.75rem; color:#666;"></div>
  </div>

  <!-- æŒ‰éˆ•å€ -->
  <div class="quick-expense-footer">
    <div style="font-size:0.7rem; color:#9ca3af;" id="quick-hint"></div>
    <div style="display:flex; gap:6px; align-items:center;">
      <div class="edit-actions" id="edit-actions">
        <button type="button" class="btn-delete-inline" onclick="deleteEditingItem()">åˆªé™¤</button>
        <button type="button" class="btn-cancel" onclick="cancelEdit()">å–æ¶ˆ</button>
      </div>
      <button type="button" class="btn-submit" id="btn-quick-submit" onclick="addQuickExpense()">æ–°å¢</button>
    </div>
  </div>
</div>



        <!-- CATEGORY SUMMARY -->
        <div class="exp-category-card" id="exp-category-card">
            <div class="exp-category-card-title"></div>
            <div class="exp-category-grid" id="exp-category-grid"></div>
        </div>

        <div class="list-head">
            <h2>æ”¯å‡ºæ˜ç´°</h2>
            <span class="hint">é»æ“ŠæŸ¥çœ‹</span>
        </div>
        <div id="expense-list"></div>
    </main>

    <!-- WISHLIST VIEW -->
    <main id="view-wishlist" style="display:none">
        <div class="list-head">
            <h2>é¡˜æœ›æ¸…å–®</h2>
            <span class="hint">é»æ“Šæ‰“å‹¾ / æ–°å¢ç…§ç‰‡</span>
        </div>
        <div class="wish-grid" id="wish-list"></div>
    </main>

    <!-- FAB & MODAL -->
    <div class="fab" id="btn-add" onclick="openModal()">
        <svg class="icon" style="width:2em;height:2em" viewBox="0 0 24 24"><path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
    </div>

    <div class="overlay" id="modal-overlay">
        <div class="modal">
            <h2 id="modal-title">æ–°å¢é …ç›®</h2>
            <form id="add-form" autocomplete="off">
                <div class="form-row" id="field-time">
                    <label>æ™‚é–“</label>
                    <input type="time" id="add-time" required>
                </div>
                <div class="form-row">
                    <label>åç¨± / æ¨™é¡Œ</label>
                    <input type="text" id="add-title" maxlength="32" required placeholder="ä¾‹å¦‚ï¼šåœ‹éš›é€šé€›è¡—">
                </div>
                <div class="form-row" id="field-loc">
                    <label>åœ°é» / å‚™è¨»</label>
                    <input type="text" id="add-loc" maxlength="64" placeholder="ä¾‹å¦‚ï¼šå–®è»Œç¸£å»³å‰ç«™">
                </div>
                <div class="form-row">
                    <label>ç¨®é¡æ¨™ç±¤</label>
                    <div class="cats" id="cat-list"></div>
                </div>
                <div id="wish-fields" style="display:none">
                    <div class="form-row">
                        <label>åœ–ç‰‡ URL (é¸å¡«)</label>
                        <input type="text" id="wish-img-url" placeholder="https://...">
                    </div>
                </div>
                <button type="submit" class="btn-save">å„²å­˜</button>
                <button type="button" class="btn-del" onclick="deleteItem()">åˆªé™¤ç´€éŒ„</button>
            </form>
        </div>
    </div>

    <!-- æ¬ æ¬¾æ˜ç´° Modal -->
    <div class="overlay" id="debt-modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2 id="debt-modal-title" style="margin:0;">æ¬ æ¬¾æ˜ç´°</h2>
                <button type="button" onclick="closeDebtModal()" style="background:none; border:none; font-size:1.5rem; color:#888;">&times;</button>
            </div>
            <div id="debt-detail-list"></div>
            <div id="debt-modal-footer">ç¸½è¨ˆï¼š<span>NT$0</span></div>
        </div>
    </div>

    <script>
	// ===== Google Apps Script é€£å‹•ï¼ˆå«å¯†ç¢¼é©—è­‰ï¼‰=====

const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzBhwYQ5YJ49E87CnyxToegFM8v3jjjfPplyv0gyiG-eWqXQLoDjnaFm0mF-qAc-wXB/exec';
// ğŸ‘† æ›¿æ›æˆä½ éƒ¨ç½²å¾Œè¤‡è£½çš„ URL

let selectedUserForLogin = null; // æš«å­˜ç›®å‰é¸ä¸­çš„ç™»å…¥è€…

let sheetsReady = true;

// ğŸ†• åŒæ­¥è¨˜å¸³åˆ° Google Sheetsï¼ˆä½¿ç”¨ä½¿ç”¨è€…è¼¸å…¥çš„å¯†ç¢¼ï¼‰
async function syncExpenseToSheet(expense) {
  try {
    console.log('ğŸ”„ æ­£åœ¨åŒæ­¥è¨˜å¸³åˆ° Google Sheets...');

    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({
        id: expense.id,
        date: expense.date,
        cat: expense.cat,
        title: expense.title,
        amt: expense.amt,
        currency: expense.currency,
        payBy: expense.payBy,
        payMethod: expense.payMethod,
        advanceFor: expense.advanceFor || [],
		splitDetails: expense.splitDetails || null, 
        secretKey: userEnteredSecret  // âœ… æ”¹ç”¨ä½¿ç”¨è€…è¼¸å…¥çš„å€¼
      })
    });

    const result = await response.json();

    if (result.status === 'success') {
      console.log('âœ… è¨˜å¸³å·²åŒæ­¥åˆ° Google Sheets');
      updateSyncStatus('âœ… å·²åŒæ­¥åˆ° Google Sheets');
    } else {
      console.error('âŒ åŒæ­¥å¤±æ•—:', result.message);
      updateSyncStatus('âŒ ' + result.message);
    }
  } catch (err) {
    console.error('âŒ ç¶²è·¯éŒ¯èª¤:', err);
    updateSyncStatus('âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
  }
}

// ğŸ†• å¾ Google Sheets è®€å–è³‡æ–™ï¼ˆä½¿ç”¨ä½¿ç”¨è€…è¼¸å…¥çš„å¯†ç¢¼ï¼‰
async function loadExpensesFromSheet() {
  try {
    console.log('ğŸ“– æ­£åœ¨è®€å– Google Sheets è³‡æ–™...');

    const response = await fetch(
      `${GOOGLE_APPS_SCRIPT_URL}?secretKey=${encodeURIComponent(userEnteredSecret)}`  // âœ… æ”¹ç”¨ä½¿ç”¨è€…è¼¸å…¥çš„å€¼
    );

    const result = await response.json();

    if (result.status === 'success') {
      console.log('âœ… æˆåŠŸè®€å–', result.count, 'ç­†è¨˜å¸³');
      updateSyncStatus('âœ… å·²é€£æ¥ Google Sheets');
      return result.data;
    } else {
      console.error('âŒ è®€å–å¤±æ•—:', result.message);
      updateSyncStatus('âŒ ' + result.message);
      return [];
    }
  } catch (err) {
    console.log('âš ï¸ ç„¡æ³•é€£æ¥ Google Sheets');
    return [];
  }
}

// ğŸ†• æ›´æ–°åŒæ­¥ç‹€æ…‹é¡¯ç¤º
function updateSyncStatus(message) {
  const statusEl = document.getElementById('sync-status');
  if (statusEl) {
    statusEl.textContent = message;
    setTimeout(() => {
      statusEl.textContent = '';
    }, 3000);
  }
}

// ===== çµæŸ Google Apps Script é€£å‹• =====



        // --- DATA ---
        const DAYS = [
            { num: 1, label: '01/06', week: 'é€±äºŒ' },
            { num: 2, label: '01/07', week: 'é€±ä¸‰' },
            { num: 3, label: '01/08', week: 'é€±å››' },
            { num: 4, label: '01/09', week: 'é€±äº”' },
            { num: 5, label: '01/10', week: 'é€±å…­' }
        ];

        // âœ… æ¸…ç©ºæ‰€æœ‰é è¨­è³‡æ–™
        const PLAN = [
				[{ time: '04:10', cat: 'trans', title: 'ç™»æ©Ÿæº–å‚™', loc: 'æ¡ƒåœ’æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', id: 101 },
                { time: '08:55', cat: 'trans', title: 'æŠµé”æ²–ç¹©/æ‹¿è¡Œæ', loc: 'é‚£éœ¸æ©Ÿå ´', id: 102 },
                { time: '09:30', cat: 'food', title: 'è²·éºµåŒ…', loc: 'PANCHORI-NA éºµåŒ…åº—', id: 103 },
                { time: '11:15', cat: 'food', title: 'åƒæµ·è†½é£¯', loc: 'Shirasa é£Ÿå ‚', id: 104 },
                { time: '12:15', cat: 'sight', title: 'å¤å®‡åˆ©å³¶', loc: 'å¤å®‡åˆ©å³¶', id: 105 },
                { time: '14:30', cat: 'food', title: 'å’–å•¡å»³ä¼‘æ¯', loc: 'Shinmei Coffee', id: 106 },
                { time: '15:00', cat: 'sight', title: 'ç¾éº—æµ·æ°´æ—é¤¨', loc: 'æ²–ç¸„ç¾ã‚‰æµ·æ°´æ—é¤¨', id: 107 },
                { time: '17:30', cat: 'trans', title: 'å›ç¨‹æ°‘å®¿', loc: 'Chateau TIIDA', id: 108 },
                { time: '20:00', cat: 'other', title: 'æ°‘å®¿æ•´å‚™ä¼‘æ¯', loc: 'Chateau TIIDA', id: 109 },
                { time: '21:00', cat: 'food', title: 'æ™šé¤ï¼šç‰çƒä¹‹ç‰›', loc: 'ç‡’è‚‰ ç‰çƒä¹‹ç‰› é‚£éœ¸åœ‹éš›é€šï¼ˆ3Fï¼‰', id: 110 },
                { time: '23:00', cat: 'shop', title: 'æ™šé¤å¾Œé€›è¡—å›å®¶', loc: 'é‚£è¦‡å›½éš›é€šã‚Š(ãªã¯ã“ãã•ã„ã¨ãŠã‚Š)', id: 111 }], 

				[{ time: '09:30', cat: 'trans', title: 'æ­å–®è»Œåˆ—è»Š', loc: 'å®‰é‡Œé§…', id: 201 },
                { time: '10:30', cat: 'sight', title: 'æ¼«ç•«å€‰', loc: 'æ¼«ç•«å€‰åº« é‚£éœ¸åº—', id: 202 },
                { time: '11:30', cat: 'sight', title: 'äºŒæ‰‹ç²¾å“', loc: 'ã‚»ã‚«ãƒ³ãƒ‰ã‚¹ãƒˆãƒªãƒ¼ãƒˆèµ¤å¶ºåº—', id: 203 },
                { time: '12:30', cat: 'food', title: 'åˆé¤', loc: 'é­šå±‹ç›´ç‡Ÿé£Ÿå ‚', id: 204 },
                { time: '13:00', cat: 'sight', title: 'æ°¸æ—ºAEON', loc: 'AEON MALL Okinawa Rycom', id: 205 },
                { time: '15:30', cat: 'sight', title: 'ç‰çƒæœ/å’Œæœ', loc: 'ç‰è£…ã‚¹ã‚¿ã‚¸ã‚ª ã¡ã‚…ã‚‰ç¾äºº ç‰æœç¾äºº', id: 206 },
                { time: '17:00', cat: 'food', title: 'æ³¢ä¸Šå®®', loc: 'æ³¢ä¸Šå®®', id: 207 },
                { time: '17:30', cat: 'trans', title: 'å›åœ‹éš›é€š', loc: 'èµ¤å¶ºé§…ï¼ã‚ã‹ã¿ã­ãˆã', id: 208 },
                { time: '18:00', cat: 'food', title: 'æ™šé¤', loc: 'ç‰å®¶æ‹‰éºµ åœ‹éš›é€šæœ¬åº—', id: 209 },], 
				[], 
				[], 
				[]
        ];

        const EXPENSE = [
            [], [], [], [], []
        ];

        const WISHLIST = [];

        const CATEGORIES = [
    // é€™è£¡æ–°å¢äº† hex å±¬æ€§ï¼Œç”¨ä¾†åšå‹•æ…‹ä¸Šè‰²
    { key:'sight', label:'æ™¯é»', color:'bg-sight', hex:'#3b82f6', light:'#eff6ff' }, // è—
    { key:'food', label:'ç¾é£Ÿ', color:'bg-food', hex:'#f97316', light:'#fff7ed' },  // æ©˜
    { key:'shop', label:'è³¼ç‰©', color:'bg-shop', hex:'#ec4899', light:'#fdf2f8' },  // ç²‰
    { key:'trans', label:'äº¤é€š', color:'bg-trans', hex:'#64748b', light:'#f8fafc' }, // ç°
    { key:'other', label:'å…¶ä»–', color:'bg-other', hex:'#10b981', light:'#ecfdf5' }  // ç¶ 
];

	let userEnteredSecret = ""; // åˆå§‹ç‚ºç©º

        const MEMBERS = ['è¨±æ³¢', 'æ–¹å‰', 'åƒåˆ', 'ä¾‘ç„„', 'å®¶éŠ˜'];

        // --- STATE ---
        let currentUser = null;
        let curTab = 'itinerary';
        let curDay = 0;
        let editingItem = null;
        let editingType = null;
        let statMode = 'personal';
        let editingId = null;

        // ===== åˆå§‹åŒ–èˆ‡ç™»å…¥é‚è¼¯ (å”¯ä¸€ç‰ˆæœ¬) =====

// 1. åˆå§‹åŒ– (è‡ªå‹•ç™»å…¥é‚è¼¯)
function init() {
  console.log('ğŸ” æ‡‰ç”¨åˆå§‹åŒ–é–‹å§‹...');
  console.log('MEMBERS:', MEMBERS);

  // å˜—è©¦å¾æœ¬åœ°å„²å­˜è®€å–
  const savedUser = localStorage.getItem('expense_user');
  const savedKey = localStorage.getItem('expense_secret_key');

  // å¦‚æœæœ‰ä½¿ç”¨è€…ç´€éŒ„ ä¸” æœ‰å¯†ç¢¼ç´€éŒ„
  if (savedUser && savedKey) {
    console.log('âœ… è‡ªå‹•ç™»å…¥:', savedUser);

    // 1. æ¢å¾©å…¨åŸŸè®Šæ•¸
    currentUser = savedUser;
    userEnteredSecret = savedKey;

    // 2. æ›´æ–°ä»‹é¢
    updateSubtitleWithUser();

    // 3. éš±è—æ­¡è¿é 
    const wrapper = document.getElementById('welcome-card');
    if (wrapper) wrapper.style.display = 'none';

    // 4. è¼‰å…¥è³‡æ–™
    renderDays();
    renderPlan();
    renderWishlist();
    fetchWeather();

    // å»¶é²è¼‰å…¥è¨˜å¸³è³‡æ–™
    setTimeout(() => {
      renderExpense();
      renderExpenseCategories();
      loadExpensesFromSheet();
    }, 100);

  } else {
    console.log('ğŸ”‘ é¦–æ¬¡é€²å…¥ï¼Œé¡¯ç¤ºç™»å…¥é ');
    showWelcomeCard();

    // èƒŒæ™¯çµæ§‹
    renderDays();
    renderPlan();
    renderWishlist();
    fetchWeather();
  }
}

// 2. é¡¯ç¤ºæ­¡è¿é  (ç”¢ç”Ÿé¸äººæŒ‰éˆ•)
function showWelcomeCard() {
  console.log('ğŸ“‹ showWelcomeCard åŸ·è¡Œ...');

  const wrapper = document.getElementById('welcome-card');
  const list = document.getElementById('welcome-user-list');

  console.log('wrapper:', wrapper);
  console.log('list:', list);
  console.log('MEMBERS:', MEMBERS);

  if (!wrapper || !list) {
    console.error('âŒ æ‰¾ä¸åˆ°æ­¡è¿ç•«é¢å…ƒç´ ï¼');
    return;
  }

  // ç¢ºä¿æ­¡è¿é é¡¯ç¤º
  wrapper.style.display = 'flex';
  wrapper.style.opacity = '1';
  wrapper.classList.remove('welcome-fade-out');

  // æ¸…ç©ºèˆŠå…§å®¹
  list.innerHTML = '';
  selectedUserForLogin = null;

  // ğŸ›¡ï¸ é˜²å‘†æª¢æŸ¥
  if (!MEMBERS || MEMBERS.length === 0) {
    list.innerHTML = '<div style="color: #ef4444; font-weight: 700; padding: 20px; text-align: center;">âš ï¸ æœªè¨­å®šæˆå“¡åå–® (MEMBERS)</div>';
    console.error('âŒ MEMBERS é™£åˆ—æ˜¯ç©ºçš„ï¼');
    return;
  }

  // ç”¢ç”ŸæŒ‰éˆ•
  console.log('ç”¢ç”Ÿ ' + MEMBERS.length + ' å€‹æŒ‰éˆ•...');
  MEMBERS.forEach(name => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'welcome-user-btn';
    btn.textContent = name;
    btn.style.display = 'block';

    btn.onclick = (e) => {
      e.preventDefault();
      console.log('é»æ“Šä½¿ç”¨è€…:', name);

      // ç§»é™¤å…¶ä»–äººçš„é¸å–
      document.querySelectorAll('.welcome-user-btn').forEach(b => b.classList.remove('selected'));
      // é¸å–è‡ªå·±
      btn.classList.add('selected');
      // ç´€éŒ„
      selectedUserForLogin = name;
    };
    list.appendChild(btn);
  });

  console.log('âœ… æŒ‰éˆ•ç”¢ç”Ÿå®Œæˆ');
}

// ğŸ†• é©—è­‰å¯†ç¢¼æ˜¯å¦æ­£ç¢º
async function validateSecretKey(secretKey) {
  try {
    const response = await fetch(
      `${GOOGLE_APPS_SCRIPT_URL}?secretKey=${encodeURIComponent(secretKey)}`
    );

    const result = await response.json();

    // å¦‚æœ Google Apps Script è¿”å› errorï¼Œè¡¨ç¤ºå¯†ç¢¼éŒ¯èª¤
    return result.status === 'success';

  } catch (err) {
    return false;
  }
}


async function handleLogin() {
  console.log('ğŸ”‘ é–‹å§‹ç™»å…¥æµç¨‹...');

  const pwdInput = document.getElementById('entry-password');
  const enteredPwd = pwdInput.value;
  const selectedUser = selectedUserForLogin;  // å·²é¸ä¸­çš„ä½¿ç”¨è€…

  if (!selectedUser) {
    alert('âŒ è«‹å…ˆé¸æ“‡ä½¿ç”¨è€…');
    return;
  }

  if (!enteredPwd || enteredPwd.trim() === '') {
    alert('âŒ å¯†ç¢¼ä¸èƒ½ç‚ºç©º');
    return;
  }

  // ğŸ†• é©—è­‰å¯†ç¢¼
  const btn = document.getElementById('btn-login-confirm');
  const originalBtnText = btn.textContent; // æš«å­˜æŒ‰éˆ•æ–‡å­—
  btn.textContent = 'é©—è­‰ä¸­...';
  btn.disabled = true;

  const isValid = await validateSecretKey(enteredPwd);

  if (!isValid) {
    alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦');
    btn.textContent = originalBtnText;
    btn.disabled = false;
    return;
  }

  // âœ… å¯†ç¢¼æ­£ç¢ºï¼Œå…è¨±ç™»å…¥
  currentUser = selectedUser;
  userEnteredSecret = enteredPwd;

  localStorage.setItem('expense_user', currentUser);
  localStorage.setItem('expense_secret_key', userEnteredSecret);

  // --- âœ¨ é€™è£¡é–‹å§‹æ˜¯æ–°å¢çš„å‹•ç•«æ•ˆæœ ---

  // 1. å»ºç«‹æˆåŠŸè¨Šæ¯å°å¡ç‰‡
  const successMsg = document.createElement('div');
  successMsg.className = 'login-success-message';
  successMsg.innerHTML = `
      <div style="font-size:3rem; margin-bottom:10px;">âœ…</div>
      <div style="font-size:1.2rem; font-weight:900; color:#2C3E50;">ç™»å…¥æˆåŠŸï¼</div>
      <div style="font-size:0.9rem; color:#666; margin-top:4px;">Helloï¼Œ${currentUser}</div>
  `;
  document.body.appendChild(successMsg);

  // 2. éš±è—æ­¡è¿å¡ç‰‡å…§åŸæœ¬çš„å…§å®¹ (è®“èƒŒæ™¯é‚„åœ¨ï¼Œä½†æŒ‰éˆ•æ¶ˆå¤±ï¼Œå°ˆæ³¨çœ‹æˆåŠŸè¨Šæ¯)
  const wrapperInner = document.querySelector('.welcome-card-inner');
  if(wrapperInner) wrapperInner.classList.add('hide-content');

  // 3. å»¶é² 1.2 ç§’å¾Œï¼Œé€£åŒèƒŒæ™¯ä¸€èµ·æ·¡å‡º
  setTimeout(() => {
    // è®“æˆåŠŸè¨Šæ¯æ·¡å‡º
    successMsg.style.animation = 'fadeOutMsg 0.4s forwards';

    // è®“æ•´å€‹æ­¡è¿èƒŒæ™¯æ·¡å‡º (è§¸ç™¼ä½ çš„ exit-animation)
    const wrapper = document.getElementById('welcome-card');
    wrapper.classList.add('exit-animation');

    // 4. å‹•ç•«è·‘å®Œå¾Œï¼ŒçœŸæ­£ç§»é™¤å…ƒç´ ä¸¦è¼‰å…¥è³‡æ–™
    setTimeout(() => {
        wrapper.style.display = 'none';
        successMsg.remove();

        // è¼‰å…¥èˆ‡æ¸²æŸ“è³‡æ–™
        updateSubtitleWithUser();
        renderExpense();
        renderExpenseCategories();
        loadExpensesFromSheet();

    }, 500); // é…åˆ CSS exit-animation çš„ 0.6s ç¨å¾®ææ—©ä¸€é»åˆ‡æ›
  }, 1200); // è®“æˆåŠŸè¨Šæ¯åœç•™ 1.2 ç§’
}







        function updateSubtitleWithUser() {
            const subtitle = document.querySelector('.subtitle');
            if(!subtitle || !currentUser) return;
            subtitle.innerHTML = `<span class="badge">${currentUser}</span> 5 Days `;
        }

        // --- WEATHER ---
        function fetchWeather() {
            updateWeatherUI(26, "æ™´æ™‚å¤šé›²");
        }

        function updateWeatherUI(temp, desc) {
            document.getElementById('weather-temp').textContent = temp + "Â°C";
            document.getElementById('weather-desc').textContent = desc;

            let advice = "";
            if(temp > 28) advice = "å¤©æ°£ç‚ç†±ï¼Œè«‹ç©¿è‘—çŸ­è¢–ä¸¦æ³¨æ„é˜²æ›¬ï¼";
            else if(temp > 20) advice = "æ°£æº«èˆ’é©ï¼Œå»ºè­°ç©¿è‘—è–„é•·è¢–æˆ–çŸ­è¢–æ­é…è–„å¤–å¥—ã€‚";
            else advice = "å¤©æ°£è¼ƒæ¶¼ï¼Œè«‹æ”œå¸¶å¤–å¥—ä¿æš–ã€‚";

            document.getElementById('clothing-advice').textContent = advice;
        }

        // --- TABS ---
        function switchTab(tabBtn, name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tabBtn.classList.add('active');

            document.getElementById('view-itinerary').style.display = 'none';
            document.getElementById('view-expense').style.display = 'none';
            document.getElementById('view-wishlist').style.display = 'none';

            document.getElementById('view-' + name).style.display = 'block';
            curTab = name;

            const fab = document.getElementById('btn-add');
            fab.style.display = (name === 'expense') ? 'none' : 'flex';

            if(name === 'expense') {
                renderExpense();
                renderExpenseCategories();
            } else if(name === 'wishlist') {
                renderWishlist();
            }
        }

        // --- ITINERARY ---
        function renderDays() {
            const dayList = document.getElementById('day-list');
            dayList.innerHTML = '';
            DAYS.forEach((day, idx) => {
                const div = document.createElement('div');
                div.className = `day-card ${curDay===idx?'active':''}`;
                div.onclick = () => {
                    curDay = idx;
                    renderDays();
                    renderPlan();
                    if(curTab === 'expense') renderExpense();
                };
                div.innerHTML = `
                    <div class="day-top"><span>Day ${day.num}</span><span class="day-dot"></span></div>
                    <div class="day-num">${day.label}<span>${day.week}</span></div>
                `;
                dayList.appendChild(div);
            });
        }

       function renderPlan() {
    const list = document.getElementById('plan-list');
    list.innerHTML = '';

    const plans = PLAN[curDay] || [];
    if(plans.length === 0) {
        list.innerHTML = '<div style="color:#888;text-align:center;margin:2rem 0">å°šç„¡è¡Œç¨‹</div>';
        return;
    }

    plans.forEach((item, idx) => {
        const cat = CATEGORIES.find(c => c.key === item.cat) || CATEGORIES[4];

        // äº¤é€šè³‡æ–™
        const trans = item.trans || { mode: 'car', hour: 0, min: 10 };
        const transIcons = { 'car': 'ğŸš—', 'train': 'ğŸšƒ', 'walk': 'ğŸš¶', 'bus': 'ğŸšŒ', 'airplane': 'âœˆï¸' };
        const iconSymbol = transIcons[trans.mode] || 'ğŸš—';

        let timeStr = '';
        if(trans.hour > 0) timeStr += `${trans.hour}å°æ™‚`;
        if(trans.min > 0) timeStr += `${trans.min}åˆ†`;
        if(trans.hour===0 && trans.min===0) timeStr = '0åˆ†';

        const isNotLast = idx < plans.length - 1;

        const wrapper = document.createElement('div');
        wrapper.className = 'plan-wrapper';

        // è¨­å®šé¡è‰²è®Šæ•¸
        wrapper.style.setProperty('--card-color', cat.hex || '#ccc');
        wrapper.style.setProperty('--card-color-light', cat.light || '#eee');

        wrapper.innerHTML = `
            <div class="plan-card" onclick="if(!event.target.closest('.nav-btn')) openModal('plan', PLAN[curDay][${idx}], ${idx})">
                <div class="plan-left">
                    <div class="plan-time">${item.time}</div>
                    <div class="plan-tag" style="background:${cat.hex}">${cat.label}</div>
                    <div class="plan-title">${item.title}</div>
                    <div class="plan-loc">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        ${item.loc}
                    </div>
                </div>
                <div class="plan-actions">
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.loc)}" target="_blank" style="text-decoration:none">
                        <button type="button" class="nav-btn">
                             <svg viewBox="0 0 24 24"><path d="M1 11.6l19.6-9.3a1.3 1.3 0 0 1 1.7 1.7l-9.3 19.6c-.6 1.3-2.5 1.3-3.1 0l-2.7-6.2-6.2-2.7c-1.3-.6-1.3-2.5 0-3.1z"/></svg>
                            å°èˆª
                        </button>
                    </a>
                </div>
            </div>

            ${isNotLast ? `
            <div class="trans-line"></div>
            <div class="trans-badge">
                <div class="trans-icon" onclick="openTransModePicker(${idx})">
                    ${iconSymbol}
                </div>
                <div class="trans-time" onclick="openTransTimePicker(${idx})">
                    ${timeStr}
                </div>
            </div>
            <div class="trans-line"></div>
            ` : ''} 
        `;
        list.appendChild(wrapper);
    });
}





        // --- EXPENSE ---
        function renderExpense() {
            if(!currentUser) return;

            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '';

            const list = EXPENSE[curDay] || [];

            if(list.length === 0) {
                expenseList.innerHTML = '<div style="color:#888;text-align:center;margin:2rem 0">å°šç„¡æ¶ˆè²»ç´€éŒ„</div>';
                updateExpenseStats();
                return;
            }

            list.forEach(item => {
                const cat = CATEGORIES.find(c => c.key === item.cat) || CATEGORIES[4];

                const div = document.createElement('div');
                div.className = 'expense-row';
                div.onclick = (e) => {
                    if (e.target.closest('button')) return;
                    div.classList.toggle('expanded');
                };

                let advanceText = '';
                if (item.advanceFor && item.advanceFor.length > 0 && item.amt > 0) {
                    const othersCount = item.advanceFor.filter(name => name !== currentUser).length;
                    if (othersCount > 0) {
                        advanceText = `<span class="advance-badge">ä»£å¢Š${othersCount}</span>`;
                    }
                }

                let detailHtml = '';

                if (!item.advanceFor || item.advanceFor.length === 0) {
                    detailHtml = `<div style="font-size:0.75rem;font-weight:700;color:#888;margin-bottom:8px">å€‹äººæ¶ˆè²»</div>`;
                } else {
                    if(item.splitDetails && item.splitDetails.amounts) {
                        Object.entries(item.splitDetails.amounts).forEach(([name, amt]) => {
                            if(amt > 0) {
                                let userClass = item.payBy === name ? 'payer' : 'debtor';
                                let userLabel = item.payBy === name ? ' (æœ¬äºº)' : '';

                                detailHtml += `
                                    <div class="detail-list-item">
                                        <span class="detail-user-name ${userClass}">${name}${userLabel}</span>
                                        <span class="detail-amount">${item.currency === 'JPY' ? 'Â¥' : 'NT$'}${amt}</span>
                                    </div>
                                `;
                            }
                        });
                    } else {
                        const othersInThisSplit = item.advanceFor.filter(name => name !== currentUser);
                        const perPerson = othersInThisSplit.length > 0 
                            ? Math.floor(item.amt / (othersInThisSplit.length + 1))
                            : item.amt;

                        if (item.payBy === currentUser) {
                            detailHtml += `
                                <div class="detail-list-item">
                                    <span class="detail-user-name payer">${currentUser} (æœ¬äºº)</span>
                                    <span class="detail-amount">${item.currency === 'JPY' ? 'Â¥' : 'NT$'}${perPerson}</span>
                                </div>
                            `;
                        }

                        othersInThisSplit.forEach((name) => {
                            detailHtml += `
                                <div class="detail-list-item">
                                    <span class="detail-user-name debtor">${name}</span>
                                    <span class="detail-amount">${item.currency === 'JPY' ? 'Â¥' : 'NT$'}${perPerson}</span>
                                </div>
                            `;
                        });
                    }
                }

                div.innerHTML = `
                    <div class="expense-header">
                        <div>
                            <div style="font-weight:700; color:var(--primary)">${item.title}</div>
                            <div style="font-size:0.75rem; color:#888; margin-top:4px">
                                ${cat.label} 
                                <span class="pay-method-badge">${item.payMethod === 'cash' ? 'ç¾é‡‘' : 'åˆ·å¡'}</span>
                                ${advanceText}
                            </div>
                        </div>
                        <div style="font-weight:700; font-size:1.1rem; color:var(--accent)">
							${item.currency === 'JPY' ? 'Â¥' : 'NT$'}${item.amt}
						</div>
                    </div>
                    <div class="expense-detail-panel">
                        ${detailHtml}
                        <button type="button" class="btn-edit-inline" onclick="editExpenseInQuickForm(EXPENSE[curDay].find(e=>e.id=='${item.id}'))">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            ç·¨è¼¯ / åˆªé™¤
                        </button>
                    </div>
                `;
                expenseList.appendChild(div);
            });

            updateExpenseStats();
        }

        // è«‹ç”¨æ­¤å‡½å¼å®Œæ•´è¦†è“‹åŸæœ¬çš„ updateExpenseStats
function updateExpenseStats() {
    if (!currentUser) return;
    const summaryContainer = document.getElementById('summary-content');
    if (!summaryContainer) return;

    // A. åˆå§‹åŒ–çµ±è¨ˆè®Šæ•¸
    let totals = { JPY: 0, TWD: 0 };      // å®šç¾©ï¼šæˆ‘çš„å¯¦éš›æ¶ˆè²» (Cost)
    let receivable = { JPY: 0, TWD: 0 };  // å®šç¾©ï¼šæ‡‰æ”¶ (å¹«åˆ¥äººå¢Š)
    let payable = { JPY: 0, TWD: 0 };     // å®šç¾©ï¼šæ‡‰ä»˜ (æ¬ åˆ¥äºº)
    const EX_RATE = 0.215; // åŒ¯ç‡ (åƒ…ä¾›é¡¯ç¤ºåƒè€ƒ)

    // B. è¨ˆç®—é‚è¼¯ (ä¿®æ­£ç‚ºã€Œå¯¦éš›æ¶ˆè²»ã€é‚è¼¯ï¼Œèˆ‡å¾Œç«¯ GAS ä¸€è‡´)
    EXPENSE.forEach(dayList => {
        dayList.forEach(item => {
            const c = item.currency || 'TWD'; // é è¨­ TWD

            // 1. è¨ˆç®—ã€Œæˆ‘çš„å¯¦éš›æ¶ˆè²»ã€ (Cost)
            // åªè¦æˆ‘åœ¨åˆ†å¸³åå–®å…§ï¼Œä¸ç®¡èª°ä»˜éŒ¢ï¼Œé€™ç­†éƒ½ç®—æˆ‘çš„æ¶ˆè²»
            if (item.advanceFor && item.advanceFor.includes(currentUser)) {
                let myShare = 0;
                if (item.splitDetails && item.splitDetails.amounts) {
                    // è‡ªè¨‚åˆ†å¸³ï¼šå–æˆ‘è‡ªå·±çš„éƒ¨åˆ†
                    myShare = item.splitDetails.amounts[currentUser] || 0;
                } else {
                    // å¹³å‡åˆ†å¸³ï¼šç¸½é‡‘é¡ / äººæ•¸
                    myShare = Math.floor(item.amt / item.advanceFor.length);
                }
                totals[c] += myShare;
            }

            // 2. è¨ˆç®—ã€Œæ‡‰æ”¶ã€ (Receivable)
            // æ¢ä»¶ï¼šæ˜¯æˆ‘ä»˜éŒ¢ï¼Œä¸”å¹«åˆ¥äººå¢Šäº† (åå–®è£¡æœ‰åˆ¥äºº)
            if (item.payBy === currentUser && item.advanceFor && item.advanceFor.length > 0) {
                if (item.splitDetails && item.splitDetails.amounts) {
                    // è‡ªè¨‚åˆ†å¸³æ¨¡å¼ï¼šåŠ ç¸½æ‰€æœ‰ã€Œéæœ¬äººã€çš„é‡‘é¡
                    Object.entries(item.splitDetails.amounts).forEach(([name, amt]) => {
                        if (name !== currentUser && amt > 0) {
                            receivable[c] += amt;
                        }
                    });
                } else {
                    // å¹³å‡åˆ†å¸³æ¨¡å¼ï¼š(å¹³å‡é‡‘é¡ * åˆ¥äººäººæ•¸)
                    const perPerson = Math.floor(item.amt / item.advanceFor.length);
                    const othersCount = item.advanceFor.filter(name => name !== currentUser).length;
                    receivable[c] += (perPerson * othersCount);
                }
            }

            // 3. è¨ˆç®—ã€Œæ‡‰ä»˜ã€ (Payable)
            // æ¢ä»¶ï¼šä¸æ˜¯æˆ‘ä»˜éŒ¢ï¼Œä½†æˆ‘æœ‰åœ¨åå–®è£¡ (åˆ¥äººå¹«æˆ‘å¢Š)
            if (item.payBy !== currentUser && item.advanceFor && item.advanceFor.includes(currentUser)) {
                let myOwe = 0;
                if (item.splitDetails && item.splitDetails.amounts) {
                    myOwe = item.splitDetails.amounts[currentUser] || 0;
                } else {
                    myOwe = Math.floor(item.amt / item.advanceFor.length);
                }
                payable[c] += myOwe;
            }
        });
    });

    // C. å®šç¾©å¡ç‰‡ HTML ç”Ÿæˆå™¨ (ç½®ä¸­ç‰ˆï¼Œç§»é™¤å³å´ Total)
    const getCardHtml = (title, jpy, twd, color) => {
        // è¨ˆç®—æ—¥å¹£ç´„ç•¶å°å¹£ (åƒ…é¡¯ç¤ºç”¨)
        const jpyToTwd = Math.round(jpy * EX_RATE);

        return `
        <div class="swipe-card" style="text-align: center;">
            <!-- å¡ç‰‡æ¨™é¡Œ -->
            <div style="font-size:0.9rem; font-weight:700; color:${color}; margin-bottom:12px; opacity:0.9;">${title}</div>
            
            <!-- é‡‘é¡é¡¯ç¤ºå€ (å‚ç›´ç½®ä¸­æ’åˆ—) -->
            <div style="display: flex; flex-direction: column; gap: 12px; align-items: center;">
                
                <!-- æ—¥å¹£å€å¡Š -->
                <div>
                    <div style="display: flex; align-items: baseline; justify-content: center; gap: 6px;">
                        <span style="font-size: 0.7rem; opacity: 0.6; font-weight: 600;">ğŸ‡¯ğŸ‡µ JP</span>
                        <span style="font-size: 1.6rem; font-weight: 800;">Â¥ ${jpy.toLocaleString()}</span>
                    </div>
                    <!-- ç°è‰²å°å­—æç¤ºç´„ç•¶å°å¹£ -->
                    <div style="font-size: 0.75rem; color: #aaa; font-weight: 500; margin-top: 2px;">
                        (ç´„ NT$ ${jpyToTwd.toLocaleString()})
                    </div>
                </div>
                
                <!-- åˆ†éš”ç·š -->
                <div style="width: 40px; height: 1px; background: rgba(255,255,255,0.1);"></div>
                
                <!-- å°å¹£å€å¡Š -->
                <div>
                    <div style="display: flex; align-items: baseline; justify-content: center; gap: 6px;">
                        <span style="font-size: 0.7rem; opacity: 0.6; font-weight: 600;">ğŸ‡¹ğŸ‡¼ TW</span>
                        <span style="font-size: 1.6rem; font-weight: 800; color: #FFD700;">NT$ ${twd.toLocaleString()}</span>
                    </div>
                </div>

            </div>
        </div>
        `;
    };

    // D. æ¸²æŸ“ç•«é¢
    summaryContainer.style.overflow = "hidden";
    summaryContainer.innerHTML = `
        <!-- æ»‘å‹•å…§å®¹ -->
        <div class="stat-swipe-wrapper" id="stat-swipe-wrapper">
            ${getCardHtml('å€‹äººèŠ±è²»ç¸½é¡', totals.JPY, totals.TWD, '#fff')}
            ${getCardHtml('å¾…æ”¶ä»˜æ¬¾é … (æ‡‰æ”¶)', receivable.JPY, receivable.TWD, '#10b981')}
            ${getCardHtml('å¾…æ”¶ä»˜æ¬¾é … (æ‡‰ä»˜)', payable.JPY, payable.TWD, '#E76F51')}
        </div>
        
        <!-- æ»‘å‹•æŒ‡ç¤ºé» -->
        <div class="swipe-dots">
            <span class="dot active"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>
    `;

    // E. é‡æ–°ç¶å®šæ»‘å‹•ç›£è½ (ç¢ºä¿æŒ‡ç¤ºé»æœƒå‹•)
    const wrapper = document.getElementById('stat-swipe-wrapper');
    if (wrapper) {
        wrapper.onscroll = function() {
            // è¨ˆç®—ç›®å‰æ»‘åˆ°ç¬¬å¹¾å¼µå¡ç‰‡
            const idx = Math.round(this.scrollLeft / this.offsetWidth);
            const dots = document.querySelectorAll('.dot');
            dots.forEach((d, i) => d.classList.toggle('active', i === idx));
        };
    }
}




        function toggleStat(mode) {
            statMode = mode;

            document.querySelectorAll('.stat-tab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            updateExpenseStats();
            renderExpenseCategories();
        }

        function renderQuickSplitPersons() {
            const container = document.getElementById('quick-split-persons');
            container.innerHTML = '';

            if (!currentUser || !MEMBERS.includes(currentUser)) return;

            const others = MEMBERS.filter(name => name !== currentUser);

            others.forEach(name => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'split-person-btn';
                btn.textContent = name;
                btn.dataset.name = name;
                btn.onclick = function (e) {
                    e.preventDefault();
                    this.classList.toggle('selected');
                    updateQuickSplitPreview();
                };
                container.appendChild(btn);
            });
        }

        function renderQuickCustomAmounts() {
            const container = document.getElementById('quick-custom-amounts');
            container.innerHTML = '';

            if (!currentUser || !MEMBERS.includes(currentUser)) return;

            const others = MEMBERS.filter(name => name !== currentUser);

            others.forEach(name => {
                const row = document.createElement('div');
                row.style.cssText = 'display:grid;grid-template-columns:0.6fr 1.4fr;gap:0.6rem;align-items:center;margin-bottom:0.6rem;';
                row.innerHTML = `
                    <label style="font-size:0.75rem;font-weight:700;color:#374151;white-space:nowrap;">${name}</label>
                    <input type="number" class="quick-custom-amt" data-name="${name}" min="0" placeholder="NT$" style="padding:0.5rem 0.6rem;font-size:0.8rem;border:1px solid #e5e7eb;border-radius:0.6rem;" oninput="updateQuickSplitPreview()">
                `;
                container.appendChild(row);
            });
        }

        function toggleQuickSplitMode(mode) {
            const container = document.getElementById('quick-split-options');
            const equalDiv = document.getElementById('quick-equal-mode');
            const customDiv = document.getElementById('quick-custom-mode');

            container.style.display = mode === 'none' ? 'none' : 'block';
            equalDiv.style.display = mode === 'equal' ? 'block' : 'none';
            customDiv.style.display = mode === 'custom' ? 'block' : 'none';

            if (mode === 'equal') {
                renderQuickSplitPersons();
            } else if (mode === 'custom') {
                renderQuickCustomAmounts();
            }
            updateQuickSplitPreview();
        }

        function updateQuickSplitPreview() {
  const previewDiv = document.getElementById('quick-split-preview');
  const modeSelect = document.getElementById('quick-split-mode');
  const mode = modeSelect.value;
  const amtInput = document.getElementById('quick-amt');
  const totalAmt = parseInt(amtInput.value) || 0;

  if (totalAmt === 0) {
    previewDiv.textContent = '';
    return;
  }

  if (mode === 'equal') {
    const selected = Array.from(
      document.querySelectorAll('#quick-split-persons .split-person-btn.selected')
    );
    if (selected.length === 0) {
      previewDiv.textContent = '';
      return;
    }

    // âœ… ä¸å† +1ï¼Œç›´æ¥ç”¨é¸å–çš„äººæ•¸
    const totalPeople = selected.length;
    const perPerson = Math.floor(totalAmt / totalPeople);

    previewDiv.innerHTML = `å…± NT$${totalAmt} Ã· ${totalPeople} äºº = æ¯äºº NT$${perPerson}`;
  } else if (mode === 'custom') {
    // åŸæœ¬ custom çš„é‚è¼¯ä¿æŒä¸è®Š
    const inputs = document.querySelectorAll('.quick-custom-amt');
    let totalCustom = 0;
    inputs.forEach(input => {
      totalCustom += parseInt(input.value) || 0;
    });
    const myShare = totalAmt - totalCustom;
    if (myShare < 0) {
      previewDiv.style.borderLeftColor = '#ef4444';
      previewDiv.textContent = 'åˆ†å¸³ç¸½é¡è¶…éåŸå§‹é‡‘é¡';
    } else {
      previewDiv.style.borderLeftColor = 'var(--accent)';
      previewDiv.innerHTML = `å…¶ä»–äººåˆè¨ˆ NT$${totalCustom}<br>æˆ‘éœ€è² æ“” NT$${myShare}`;
    }
  } else {
    previewDiv.textContent = '';
  }
}


        function addQuickExpense() {
    // 1. åŸºç¤é©—è­‰
    if (!currentUser) {
        alert('è«‹å…ˆé¸æ“‡ä½¿ç”¨è€… (ç™»å…¥)');
        return;
    }

    // 2. æŠ“å–è¡¨å–®è³‡æ–™
    const dateSelect = document.getElementById('quick-date');
    const curDay = parseInt(dateSelect.value); // 0~4
    const dateLabel = DAYS[curDay].label; // ä¾‹å¦‚ "01/06"

    const cat = document.getElementById('quick-cat').value;
    const title = document.getElementById('quick-title').value.trim();
    const payMethod = document.getElementById('quick-pay').value;
    const amt = parseInt(document.getElementById('quick-amt').value || 0);
    const currency = currentCurrency; // å‡è¨­é€™æ˜¯å…¨åŸŸè®Šæ•¸ (JPY æˆ– TWD)

    // æŠ“å–åˆ†å¸³æ¨¡å¼
    const modeSelect = document.getElementById('quick-split-mode');
    const currentSplitMode = modeSelect ? modeSelect.value : 'none';

    // æŠ“å–æ”¯ä»˜äºº (è‹¥ä»‹é¢ä¸Šæœ‰é¸æ“‡æ”¯ä»˜äººçš„è©±ï¼Œæ²’æœ‰å‰‡é è¨­è‡ªå·±)
    // å‡è¨­æ‚¨çš„ä»‹é¢ä¸»è¦æ˜¯è‡ªå·±è¨˜å¸³ï¼Œé€™è£¡é è¨­ currentUser
    const payBy = currentUser; 

    // 3. æ¬„ä½æª¢æŸ¥
    if (!title) {
        alert('è«‹å¡«å¯«åç¨±');
        return;
    }
    if (isNaN(amt) || amt <= 0) {
        alert('é‡‘é¡å¿…é ˆå¤§æ–¼ 0');
        return;
    }

    // 4. è™•ç†åˆ†å¸³é‚è¼¯ (æ ¸å¿ƒä¿®æ”¹)
    let finalAdvanceFor = [];
    let splitDetails = null; // æº–å‚™é€çµ¦å¾Œç«¯çš„ JSON

    if (currentSplitMode === 'none') {
        // ä¸åˆ†å¸³ï¼šé€™ç­†éŒ¢ç®—æˆ‘è‡ªå·±çš„æ¶ˆè²»
        // advanceFor ç•™ç©ºæˆ–åªå¡«è‡ªå·±ï¼Œè¦–æ‚¨çš„çµ±è¨ˆé‚è¼¯è€Œå®š
        // å»ºè­°å¡«å…¥ [currentUser] ä»£è¡¨æˆ‘æœ‰åƒèˆ‡æ¶ˆè²»
        finalAdvanceFor = [currentUser];
        splitDetails = { mode: 'none' };

    } else if (currentSplitMode === 'equal') {
        // å¹³å‡åˆ†å¸³
        const selected = document.querySelectorAll('#quick-split-persons .split-person-btn.selected');
        // æ”¶é›†è¢«é¸ä¸­çš„äººå
        selected.forEach(btn => finalAdvanceFor.push(btn.dataset.name));

        // é˜²å‘†ï¼šå¦‚æœæ²’é¸äººï¼Œè‡³å°‘è¦ç®—è‡ªå·±
        if (finalAdvanceFor.length === 0) {
             finalAdvanceFor = [currentUser];
        }
        splitDetails = { mode: 'equal' };

    } else if (currentSplitMode === 'custom') {
       } else if (currentSplitMode === 'custom') {
        // è‡ªè¨‚åˆ†å¸³
        let customAmounts = {};
        let totalCustom = 0;

        // æŠ“å–æ‰€æœ‰è‡ªè¨‚é‡‘é¡è¼¸å…¥æ¡† (è«‹ç¢ºèª HTML ä¸­çš„ class æ˜¯ quick-custom-amt)
        const inputs = document.querySelectorAll('.quick-custom-amt');
        inputs.forEach(input => {
            const val = parseInt(input.value || 0);
            if (val > 0) {
                const name = input.dataset.name; // éœ€ç¢ºèª input æœ‰ data-name å±¬æ€§
                const name = input.dataset.name; 
                customAmounts[name] = val;
                finalAdvanceFor.push(name); // æœ‰å‡ºéŒ¢çš„äººåŠ å…¥åå–®
                // å¦‚æœé€™å€‹äººä¸æ˜¯ä½¿ç”¨è€…ï¼Œæˆ–è€…å³ä½¿æ˜¯ä½¿ç”¨è€…ä½†æœ‰æ‰‹å‹•å¡«ï¼Œéƒ½å…ˆç®—é€²å»
                totalCustom += val;
                
                // ç¢ºä¿æœ‰å‡ºéŒ¢çš„äººéƒ½åœ¨åå–®å…§
                if (!finalAdvanceFor.includes(name)) {
                    finalAdvanceFor.push(name);
                }
            }
        });

        // æª¢æŸ¥ç¸½é¡æ˜¯å¦å»åˆ (å…è¨± 1 å…ƒèª¤å·®)
        if (Math.abs(totalCustom - amt) > 1) {
            alert(`åˆ†å¸³ç¸½é¡ (${totalCustom}) èˆ‡ ç¸½é‡‘é¡ (${amt}) ä¸ç¬¦ï¼Œè«‹æª¢æŸ¥ã€‚`);
        // ğŸ’¡ æ™ºæ…§é‚è¼¯ï¼šè¨ˆç®—é¤˜é¡
        const remaining = amt - totalCustom;

        if (remaining < 0) {
            // é˜²å‘†ï¼šå¦‚æœè¼¸å…¥ç¸½å’Œè¶…éç¸½é‡‘é¡ï¼Œé‚„æ˜¯è¦æ“‹ä¸€ä¸‹
            alert(`åˆ†å¸³é‡‘é¡ç¸½å’Œ (${totalCustom}) è¶…é ç¸½æ”¯å‡º (${amt})ï¼Œè«‹æª¢æŸ¥ã€‚`);
            return;
        } else if (remaining > 0) {
            // ğŸ’¡ è‡ªå‹•è£œè¶³ï¼šå‰©ä¸‹çš„éŒ¢ç®—åœ¨ä½¿ç”¨è€… (currentUser) é ­ä¸Š
            // å¦‚æœä½¿ç”¨è€…å·²ç¶“æœ‰å¡«æ•¸å­—ï¼Œå°±åŠ ä¸Šå»ï¼›æ²’å¡«éå°±ç›´æ¥è¨­ç‚ºé¤˜é¡
            if (customAmounts[currentUser]) {
                customAmounts[currentUser] += remaining;
            } else {
                customAmounts[currentUser] = remaining;
                if (!finalAdvanceFor.includes(currentUser)) {
                    finalAdvanceFor.push(currentUser);
                }
            }
        }

        splitDetails = { 
            mode: 'custom', 
            amounts: customAmounts 
        };
    }


    // 5. å»ºç«‹è¨˜å¸³ç‰©ä»¶
    // åˆ¤æ–·æ˜¯ã€Œç·¨è¼¯èˆŠçš„ã€é‚„æ˜¯ã€Œæ–°å¢æ–°çš„ã€
    let targetId = editingId ? editingId : Date.now().toString();

    const expenseObj = {
        id: targetId,
        date: dateLabel, // å­˜ "01/06" æ ¼å¼
        cat: cat,
        title: title,
        amt: amt,
        currency: currency,
        payBy: payBy,
        payMethod: payMethod,
        advanceFor: finalAdvanceFor, // I æ¬„
        splitDetails: splitDetails,   // J æ¬„ (é€™è£¡ä¸€å®šè¦æœ‰ï¼)
        createdAt: new Date().toISOString()
    };

    // 6. æ›´æ–°æœ¬åœ°è³‡æ–™é™£åˆ— (EXPENSE)
    if (!EXPENSE[curDay]) EXPENSE[curDay] = [];

    if (editingId) {
        // ç·¨è¼¯æ¨¡å¼ï¼šæ‰¾åˆ°èˆŠçš„ä¸¦å–ä»£
        const idx = EXPENSE[curDay].findIndex(e => e.id === editingId);
        if (idx >= 0) {
            EXPENSE[curDay][idx] = expenseObj;
        }
        // é€€å‡ºç·¨è¼¯ç‹€æ…‹
        cancelEdit(); 
    } else {
        // æ–°å¢æ¨¡å¼ï¼šç›´æ¥ push
        EXPENSE[curDay].push(expenseObj);
    }

    // 7. æ›´æ–° UI
    renderExpenseList();       // æˆ– renderExpense()ï¼Œè¦–æ‚¨çš„å‡½å¼åç¨±è€Œå®š
    updateExpenseStats();      // æ›´æ–°çµ±è¨ˆå¡ç‰‡
    renderExpenseCategories(); // æ›´æ–°åˆ†é¡çµ±è¨ˆ

    // 8. é‡ç½®è¡¨å–®
    resetQuickForm(); // å»ºè­°æŠ½æˆä¸€å€‹å‡½å¼ä¾†æ¸…ç©ºè¼¸å…¥æ¡†
    // æˆ–è€…æ‰‹å‹•æ¸…ç©ºï¼š
    document.getElementById('quick-title').value = '';
    document.getElementById('quick-amt').value = '';
    // ... å…¶ä»–æ¬„ä½æ¸…ç©º

    // 9. ğŸš€ åŒæ­¥åˆ° Google Sheet
    // é€™è£¡ç›´æ¥å‚³å…¥ expenseObj å³å¯ï¼Œå› ç‚ºæ¬„ä½åç¨±éƒ½å°æ‡‰å¥½äº†
    syncExpenseToSheet(expenseObj);

    console.log('âœ… è¨˜å¸³å®Œæˆä¸¦åŒæ­¥ä¸­:', expenseObj);
}



        function editExpenseInQuickForm(item) {
            editingId = item.id;
            document.getElementById('quick-title').value = item.title;
            document.getElementById('quick-amt').value = item.amt;
            document.getElementById('quick-cat').value = item.cat;
            document.getElementById('quick-pay').value = item.payMethod;

            const card = document.getElementById('quick-expense-card');
            card.classList.add('editing');
            document.getElementById('quick-form-title').textContent = 'ç·¨è¼¯æ¶ˆè²»';
            document.getElementById('btn-quick-submit').textContent = 'æ›´æ–°';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            editingId = null;
            document.getElementById('quick-title').value = '';
            document.getElementById('quick-amt').value = '';
            document.getElementById('quick-expense-card').classList.remove('editing');
            document.getElementById('quick-form-title').textContent = 'å¿«é€Ÿè¨˜å¸³';
            document.getElementById('btn-quick-submit').textContent = 'æ–°å¢';
        }

        // è«‹ç”¨é€™å€‹ç‰ˆæœ¬
async function deleteEditingItem() {
    if (!editingId) return; // æ‚¨çš„è®Šæ•¸å« editingId
    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ¶ˆè²»å—ï¼Ÿ')) return;

    // æ‚¨çš„è³‡æ–™å­˜åœ¨ EXPENSE[curDay] è£¡
    const idx = EXPENSE[curDay].findIndex(e => e.id === editingId);
    let deletedId = editingId; 

    if (idx >= 0) {
        // 1. åˆªé™¤æœ¬åœ°
        EXPENSE[curDay].splice(idx, 1);

        // 2. æ›´æ–°ç•«é¢
        cancelEdit();
        renderExpense(); // æ‚¨çš„å‡½å¼å« renderExpense
        updateExpenseStats(); 

        // 3. åŒæ­¥åˆ°é›²ç«¯
        console.log('æ­£åœ¨åŒæ­¥åˆªé™¤ ID:', deletedId);
        await syncDeleteToSheet(deletedId);
    }
}

		async function syncDeleteToSheet(id) {
    try {
        await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'delete',
                id: id,
                secretKey: userEnteredSecret
            })
        });
        console.log('âœ… Google Sheet åˆªé™¤åŒæ­¥æˆåŠŸ');
    } catch (e) {
        console.error('âŒ Google Sheet åˆªé™¤åŒæ­¥å¤±æ•—', e);
    }
}



        function renderExpenseCategories() {
            const grid = document.getElementById('exp-category-grid');
            if (!grid) return;

            grid.innerHTML = '';

            const cardTitle = document.querySelector('.exp-category-card-title');
            if (cardTitle) {
                cardTitle.textContent = (statMode === 'advance')
                    ? 'åˆ†å¸³å°è±¡çµ±è¨ˆ'
                    : 'æ¶ˆè²»åˆ†é¡';
            }

            if (!currentUser) return;

            if (statMode === 'advance') {
                const debtorStats = {};

                EXPENSE.forEach(dayList => {
                    dayList.forEach(item => {
                        if (!item || item.amt === 0) return;

                        if (item.payBy === currentUser && item.advanceFor && item.advanceFor.length > 0) {
                            if (item.splitDetails && item.splitDetails.amounts) {
                                Object.entries(item.splitDetails.amounts).forEach(([name, amt]) => {
                                    if (name === currentUser) return;
                                    if (amt <= 0) return;
                                    if (item.settled && item.settled[name]) return;

                                   if (!debtorStats[name]) {
								debtorStats[name] = { label: name, JPY: 0, TWD: 0, count: 0 }; // æ”¹ç‚ºç‰©ä»¶å„²å­˜é›™å¹£
								}
									const c = item.currency || 'TWD';
									debtorStats[name][c] += amt; // ä¾å¹£åˆ¥ç´¯åŠ  (amt æˆ– perPerson)
									debtorStats[name].count += 1;
                                });
                            } else {
                                const othersInThisSplit = item.advanceFor.filter(name => name !== currentUser);
                                const perPerson = othersInThisSplit.length > 0 
                                    ? Math.floor(item.amt / (othersInThisSplit.length + 1)) 
                                    : item.amt;

                                othersInThisSplit.forEach(name => {
                                    if (perPerson <= 0) return;
                                    if (item.settled && item.settled[name]) return;

                                    if (!debtorStats[name]) {
								debtorStats[name] = { label: name, JPY: 0, TWD: 0, count: 0 }; // æ”¹ç‚ºç‰©ä»¶å„²å­˜é›™å¹£
								}
									const c = item.currency || 'TWD';
									debtorStats[name][c] += perPerson;
									debtorStats[name].count += 1;
                                });
                            }
                        }
                    });
                });

                renderDebtorGrid('exp-category-grid', debtorStats);
                return;
            }

            let stats = {};

            CATEGORIES.forEach(c => {
				stats[c.key] = { JPY: 0, TWD: 0, count: 0, color: c.color, label: c.label };
				});

            EXPENSE.forEach(dayList => {
                dayList.forEach(item => {
                    if (!item || item.amt === 0) return;

                    let myShare = 0;

                    if (item.payBy === currentUser) {
                        if (!item.advanceFor || item.advanceFor.length === 0) {
                            myShare = item.amt;
                        } else if (item.splitDetails && item.splitDetails.amounts) {
                            myShare = item.splitDetails.amounts[currentUser] || 0;
                        } else {
                            myShare = Math.floor(item.amt / item.advanceFor.length);
                        }
                    } else if (item.advanceFor && item.advanceFor.includes(currentUser)) {
                        if (item.splitDetails && item.splitDetails.amounts) {
                            myShare = item.splitDetails.amounts[currentUser] || 0;
                        } else {
                            myShare = Math.floor(item.amt / item.advanceFor.length);
                        }
                    }

                    if (myShare > 0) {
    const catKey = item.cat || 'other';
    const c = item.currency || 'TWD'; // åˆ¤æ–·å¹£åˆ¥
    stats[catKey][c] += myShare;
    stats[catKey].count += 1;
}
                });
            });

           CATEGORIES.forEach(cat => {
    const s = stats[cat.key];
    if (!s || (s.JPY === 0 && s.TWD === 0)) return;

    const itemDiv = document.createElement('div');
    itemDiv.className = `exp-category-item ${cat.color}`;

    // å‹•æ…‹çµ„æˆé‡‘é¡æ–‡å­—ï¼šæ—¥å¹£ç‚ºä¸»ï¼Œå°å¹£ç‚ºè¼” [memory:4]
    let amountHtml = '';
    if (s.JPY > 0) amountHtml += `<div style="font-size:1.1rem; font-weight:900;">Â¥${s.JPY.toLocaleString()}</div>`;
    if (s.TWD > 0) amountHtml += `<div style="font-size:0.8rem; opacity:0.8;">NT$${s.TWD.toLocaleString()}</div>`;

    itemDiv.innerHTML = `
        <span style="font-size:0.85rem; margin-bottom:4px; display:block;">${cat.label}</span>
        ${amountHtml}
        <span style="font-size:0.7rem; margin-top:4px; display:block;">${s.count}ç­†</span>
    `;
    grid.appendChild(itemDiv);
});


            if (grid.innerHTML === '') {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:10px;">æ²’æœ‰æ”¯å‡º</div>';
            }
        }

        function renderDebtorGrid(gridId, stats) {
    const grid = document.getElementById(gridId);
    if (!grid) return;
    grid.innerHTML = '';

    const list = Object.values(stats).filter(s => (s.JPY > 0 || s.TWD > 0));

    list.forEach((s) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'exp-category-item bg-other';
        itemDiv.style.cursor = 'pointer';
        itemDiv.onclick = () => openDebtModal(s.label);

        // å‹•æ…‹åˆ¤å®šé¡¯ç¤ºå“ªäº›å¹£åˆ¥
        let amtHtml = '';
        if (s.JPY > 0) amtHtml += `<div style="font-size:1.1rem; font-weight:900;">Â¥${s.JPY.toLocaleString()}</div>`;
        if (s.TWD > 0) amtHtml += `<div style="font-size:0.8rem; opacity:0.8;">NT$${s.TWD.toLocaleString()}</div>`;

        itemDiv.innerHTML = `
            <span style="font-size:0.85rem; margin-bottom:4px; display:block;">${s.label}</span>
            ${amtHtml}
            <span style="font-size:0.7rem; margin-top:4px; display:block;">${s.count}ç­†ç´€éŒ„</span>
        `;
        grid.appendChild(itemDiv);
    });

    if (grid.innerHTML === '') {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:10px;">ç›®å‰å°šç„¡æ¶ˆè²»ç´€éŒ„ ğŸ‰</div>';
    }
}


        function openDebtModal(debtorName) {
            const overlay = document.getElementById('debt-modal-overlay');
            const titleEl = document.getElementById('debt-modal-title');
            const listEl = document.getElementById('debt-detail-list');
            const footerEl = document.getElementById('debt-modal-footer');

            if (!overlay || !titleEl || !listEl || !footerEl) {
                console.error("æ‰¾ä¸åˆ° Modal å…ƒç´ ");
                return;
            }

            overlay.classList.add('open');
            titleEl.textContent = `${debtorName} çš„æ¬ æ¬¾æ˜ç´°`;
            listEl.innerHTML = '';

            let total = 0;
            let unpaidTotal = 0;

            EXPENSE.forEach((dayList, dayIdx) => {
                dayList.forEach((item) => {
                    if (!item || item.amt <= 0) return;
                    if (item.payBy !== currentUser) return;
                    if (!item.advanceFor || item.advanceFor.length === 0) return;

                    let debtAmt = 0;

                    if (item.splitDetails && item.splitDetails.amounts) {
                        debtAmt = item.splitDetails.amounts[debtorName] || 0;
                    } else if (item.advanceFor.includes(debtorName)) {
                        debtAmt = Math.floor(item.amt / item.advanceFor.length);
                    }

                    const isSettled = item.settled && item.settled[debtorName];

                    if (debtAmt > 0) {
                        total += debtAmt;
                        if (!isSettled) unpaidTotal += debtAmt;

                        const row = document.createElement('div');
                        row.style.cssText = `
                            display:flex; 
                            justify-content:space-between; 
                            align-items:center; 
                            padding:10px 0; 
                            border-bottom:1px dashed #eee;
                            ${isSettled ? 'opacity:0.5;' : ''}
                        `;

                        row.innerHTML = `
                            <div>
                                <div style="font-weight:700; font-size:0.9rem;">
                                    ${item.title}
                                    ${isSettled ? '<span style="color:#10b981; font-size:0.7rem; margin-left:6px;">âœ“</span>' : ''}
                                </div>
                                <div style="font-size:0.75rem; color:#888;">
                                    ${DAYS[dayIdx].label}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:700; color:#E76F51; margin-bottom:4px;">NT$${debtAmt}</div>
                                ${isSettled 
                                    ? '<span style="background:#10b981; color:#fff; padding:4px 8px; border-radius:12px; font-size:0.7rem; font-weight:700;">å·²é‚„æ¬¾</span>'
                                    : `<button type="button" style="background:#10b981; color:#fff; border:none; padding:4px 8px; border-radius:12px; font-size:0.7rem; cursor:pointer;" onclick="settleSingleDebt(${dayIdx}, '${item.id}', '${debtorName}')">æ¨™è¨˜é‚„æ¬¾</button>`
                                }
                            </div>
                        `;
                        listEl.appendChild(row);
                    }
                });
            });

            footerEl.innerHTML = `
                <span style="font-size:0.7rem; color:#888; font-weight:600;">ç¸½è¨ˆï¼šNT$${total}</span><br>
                æœªé‚„æ¬¾ï¼š<span style="color:#E76F51;">NT$${unpaidTotal}</span>
            `;

            if (total === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">ç›®å‰æ²’æœ‰æ¬ æ¬¾ç´€éŒ„</div>';
            }
        }

        function closeDebtModal() {
            const overlay = document.getElementById('debt-modal-overlay');
            if (overlay) overlay.classList.remove('open');
        }

        document.getElementById('debt-modal-overlay').onclick = (e) => {
            if (e.target.id === 'debt-modal-overlay') {
                closeDebtModal();
            }
        };

        function settleSingleDebt(dayIdx, itemId, debtorName) {
            if (!confirm(`ç¢ºèª ${debtorName} å·²ç¶“é‚„æ¬¾é€™ç­†äº†å—ï¼Ÿ`)) return;

            const item = EXPENSE[dayIdx].find(e => e.id === itemId);
            if (item) {
                if (!item.settled) item.settled = {};
                item.settled[debtorName] = true;

                renderExpense();
                renderExpenseCategories();
                openDebtModal(debtorName);
            }
        }

        function renderCategories() {
            const catList = document.getElementById('cat-list');
            if(catList) {
                catList.innerHTML = '';
                CATEGORIES.forEach(c => {
                    const chip = document.createElement('div');
                    chip.className = 'cat-chip';
                    chip.textContent = c.label;
                    chip.dataset.val = c.key;
                    chip.onclick = () => {
                        document.querySelectorAll('.cat-chip').forEach(x => x.classList.remove('active'));
                        chip.classList.add('active');
                    };
                    catList.appendChild(chip);
                });
            }
        }

        // --- MODAL & WISHLIST ---
        function openModal(type = 'plan', item = null, idx = null) {
            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('add-form');
            const wishFields = document.getElementById('wish-fields');

            overlay.classList.add('open');
            editingItem = item;
            editingType = type;

            renderCategories();

            if (type === 'wish') {
                title.textContent = item ? 'ç·¨è¼¯é¡˜æœ›' : 'æ–°å¢é¡˜æœ›';
                wishFields.style.display = 'block';
                document.getElementById('field-time').style.display = 'none';
                document.getElementById('field-loc').style.display = 'none';

                if (item) {
                    document.getElementById('add-title').value = item.title;
                    document.getElementById('wish-img-url').value = item.img || '';
                } else {
                    form.reset();
                }
            } else {
                title.textContent = item ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹';
                wishFields.style.display = 'none';
                document.getElementById('field-time').style.display = 'block';
                document.getElementById('field-loc').style.display = 'block';

                if (item) {
                    document.getElementById('add-time').value = item.time;
                    document.getElementById('add-title').value = item.title;
                    document.getElementById('add-loc').value = item.loc;
                    const chip = document.querySelector(`[data-val="${item.cat}"]`);
                    if(chip) chip.classList.add('active');
                } else {
                    form.reset();
                    const now = new Date();
                    const hh = String(now.getHours()).padStart(2, '0');
                    const mm = String(now.getMinutes()).padStart(2, '0');
                    document.getElementById('add-time').value = `${hh}:${mm}`;
                }
            }

            form.onsubmit = (e) => {
                e.preventDefault();
                saveItem(type, idx);
                overlay.classList.remove('open');
            };

            const btnDel = document.querySelector('.btn-del');
            if(item) {
                btnDel.style.display = 'block';
                btnDel.onclick = () => {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
                        deleteItem(type, idx);
                        overlay.classList.remove('open');
                    }
                };
            } else {
                btnDel.style.display = 'none';
            }
        }

        document.getElementById('modal-overlay').onclick = (e) => {
            if(e.target === document.getElementById('modal-overlay')) {
                document.getElementById('modal-overlay').classList.remove('open');
            }
        };

        function saveItem(type, idx) {
            const title = document.getElementById('add-title').value;
            const activeChip = document.querySelector('.cat-chip.active');
            const cat = activeChip ? activeChip.dataset.val : 'other';

            if (type === 'wish') {
                const img = document.getElementById('wish-img-url').value;
                const newItem = { title, checked: false, img, id: 'w'+Date.now() };
                if (idx !== null) {
                    WISHLIST[idx] = { ...WISHLIST[idx], title, img };
                } else {
                    WISHLIST.push(newItem);
                }
                renderWishlist();
            } else {
                const time = document.getElementById('add-time').value;
                const loc = document.getElementById('add-loc').value;
                const newItem = { time, cat, title, loc, id: Date.now() };

                if (idx !== null) {
                    PLAN[curDay][idx] = newItem;
                } else {
                    PLAN[curDay].push(newItem);
                    PLAN[curDay].sort((a,b) => a.time.localeCompare(b.time));
                }
                renderPlan();
            }
        }

        function deleteItem(type, idx) {
            if (type === 'wish') {
                WISHLIST.splice(idx, 1);
                renderWishlist();
            } else {
                PLAN[curDay].splice(idx, 1);
                renderPlan();
            }
        }

        function renderWishlist() {
            const list = document.getElementById('wish-list');
            list.innerHTML = '';

            if(WISHLIST.length === 0) {
                list.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:20px;">å°šç„¡é¡˜æœ›æ¸…å–®</div>';
                return;
            }

            WISHLIST.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'wish-card';
                div.onclick = (e) => {
                    if(e.target.closest('.wish-check')) return;
                    openModal('wish', item, idx);
                };
                div.innerHTML = `
                    <div class="wish-check ${item.checked?'checked':''}'' onclick="toggleWish(${idx})">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            ${item.checked ? '<polyline points="20 6 9 17 4 12"></polyline>' : ''}
                        </svg>
                    </div>
                    ${item.img ? `<img src="${item.img}" class="wish-img">` : '<div class="wish-img" style="display:flex;align-items:center;justify-content:center;color:#ccc"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>'}
                    <div class="wish-content">
                        <div style="font-weight:700; font-size:0.9rem; margin-bottom:4px; ${item.checked?'text-decoration:line-through;color:#aaa':''}">${item.title}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function toggleWish(idx) {
            WISHLIST[idx].checked = !WISHLIST[idx].checked;
            renderWishlist();
        }

        window.addEventListener('load', init);
    // ==========================================
// NEW: äº¤é€šè³‡è¨Šç·¨è¼¯åŠŸèƒ½ (Action Sheet UI)
// ==========================================

// --- ä¿®æ”¹å¾Œçš„äº¤é€šé¸å–®å‡½å¼ ---
function openTransModePicker(idx) {
    const overlay = document.createElement('div');
    overlay.className = 'temp-overlay';
    // é®ç½©æ¨£å¼
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:999;display:flex;align-items:flex-end;backdrop-filter:blur(2px);';

    // 5å€‹é¸é …
    const options = [
        { key: 'car', icon: 'ğŸš—', label: 'é–‹è»Š' },
        { key: 'train', icon: 'ğŸšƒ', label: 'é›»è»Š' },
        { key: 'bus', icon: 'ğŸšŒ', label: 'å…¬è»Š' },
        { key: 'airplane', icon: 'âœˆï¸', label: 'é£›è¡Œ' }, // æ–°å¢
        { key: 'walk', icon: 'ğŸš¶', label: 'æ­¥è¡Œ' }
    ];

    let itemsHtml = '';
    options.forEach(opt => {
        itemsHtml += `
            <div class="trans-option" onclick="saveTransMode(${idx}, '${opt.key}')">
                <span class="trans-opt-icon">${opt.icon}</span>
                <span class="trans-opt-label">${opt.label}</span>
            </div>
        `;
    });

    const menu = document.createElement('div');
    // é¸å–®å®¹å™¨æ¨£å¼ï¼šç¨å¾®ç¸®æ¸› paddingï¼Œè®“æ•´é«”çœ‹èµ·ä¾†æ›´ç·Šæ¹Š
    menu.style.cssText = 'width:100%;background:white;border-radius:1.5rem 1.5rem 0 0;padding:1.2rem;padding-bottom:calc(1.5rem + env(safe-area-inset-bottom));animation:slideUp 0.2s ease-out;';

    menu.innerHTML = `
        <h3 style="margin:0 0 1rem 0;text-align:center;color:#334155;font-size:1rem;">é¸æ“‡äº¤é€šæ–¹å¼</h3>
        <div class="trans-grid">${itemsHtml}</div>
        <button onclick="this.closest('.temp-overlay').remove()" style="width:100%;padding:10px;border:none;background:#f1f5f9;color:#64748b;border-radius:12px;font-weight:700;font-size:0.9rem;">å–æ¶ˆ</button>
    `;

    overlay.appendChild(menu);
    document.body.appendChild(overlay);
    overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };
}


// 2. æ‰“é–‹æ™‚é–“é¸æ“‡é¸å–® (æ¨¡æ“¬æ»¾è¼ªé¸æ“‡)
function openTransTimePicker(idx) {
    const item = PLAN[curDay][idx];
    const cur = item.trans || { hour: 0, min: 10 }; // é è¨­å€¼

    const overlay = document.createElement('div');
    overlay.className = 'temp-overlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:999;display:flex;align-items:flex-end;backdrop-filter:blur(2px);';

    // ç”¢ç”Ÿ 0-60 åˆ†é˜çš„é¸é …
    let minOptions = '';
    for(let i=0; i<=60; i+=5) { // é è¨­5åˆ†é˜ä¸€è·³ï¼Œæ¯”è¼ƒå¥½é¸
        minOptions += `<option value="${i}">${i}</option>`;
    }

    const menu = document.createElement('div');
    menu.style.cssText = 'width:100%;background:white;border-radius:1.5rem 1.5rem 0 0;padding:1.5rem;padding-bottom:calc(2rem + env(safe-area-inset-bottom));animation:slideUp 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);';

    menu.innerHTML = `
        <h3 style="margin:0 0 1.5rem 0;text-align:center;color:#334155;">äº¤é€šæ™‚é–“</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:1.5rem;">
            <div style="flex:1;">
                <label style="display:block;text-align:center;font-size:0.75rem;color:#94a3b8;margin-bottom:6px;font-weight:700;">å°æ™‚</label>
                <div style="position:relative;">
                    <select id="pk-hour" style="width:100%;padding:12px;border-radius:12px;border:1px solid #e2e8f0;font-size:1.4rem;text-align:center;font-weight:800;color:#334155;background:#f8fafc;appearance:none;">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>
            </div>
            <div style="font-weight:900;color:#cbd5e1;font-size:1.5rem;margin-top:1.2rem">:</div>
            <div style="flex:1;">
                <label style="display:block;text-align:center;font-size:0.75rem;color:#94a3b8;margin-bottom:6px;font-weight:700;">åˆ†é˜</label>
                <div style="position:relative;">
                    <select id="pk-min" style="width:100%;padding:12px;border-radius:12px;border:1px solid #e2e8f0;font-size:1.4rem;text-align:center;font-weight:800;color:#334155;background:#f8fafc;appearance:none;">
                        ${minOptions}
                    </select>
                </div>
            </div>
        </div>
        <button id="btn-save-time" style="width:100%;padding:14px;border:none;background:var(--primary);color:white;border-radius:12px;font-weight:700;font-size:1rem;box-shadow:0 4px 12px rgba(44,62,80,0.2);">ç¢ºå®šä¿®æ”¹</button>
    `;

    overlay.appendChild(menu);
    document.body.appendChild(overlay);

    // è¨­å®šç›®å‰é¸ä¸­çš„å€¼
    document.getElementById('pk-hour').value = cur.hour || 0;
    // å¦‚æœç›®å‰åˆ†é˜æ•¸ä¸æ˜¯5çš„å€æ•¸ï¼Œé‚„æ˜¯è¦èƒ½é¡¯ç¤ºå‡ºä¾†
    let safeMin = cur.min || 0;
    const minSelect = document.getElementById('pk-min');
    // å¦‚æœç¾æœ‰å€¼ä¸åœ¨é¸é …å…§ï¼ˆä¾‹å¦‚ 13åˆ†ï¼‰ï¼Œå‹•æ…‹åŠ é€²å»
    if(!minSelect.querySelector(`option[value="${safeMin}"]`)){
        const opt = document.createElement('option');
        opt.value = safeMin;
        opt.text = safeMin;
        minSelect.add(opt);
    }
    minSelect.value = safeMin;

    // ç¶å®šå„²å­˜æŒ‰éˆ•
    document.getElementById('btn-save-time').onclick = () => {
        saveTransTime(idx, 
            parseInt(document.getElementById('pk-hour').value), 
            parseInt(document.getElementById('pk-min').value)
        );
        overlay.remove();
    };
    overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };
}

// 3. å„²å­˜è³‡æ–™çš„ Helper Functions
function saveTransMode(idx, mode) {
    if(!PLAN[curDay][idx].trans) PLAN[curDay][idx].trans = { hour:0, min:10 }; // é è¨­çµæ§‹
    PLAN[curDay][idx].trans.mode = mode;
    document.querySelector('.temp-overlay').remove(); // é—œé–‰é¸å–®
    renderPlan(); // é‡æ–°æ¸²æŸ“ç•«é¢
}

function saveTransTime(idx, hour, min) {
    if(!PLAN[curDay][idx].trans) PLAN[curDay][idx].trans = { mode:'car' }; // é è¨­çµæ§‹
    PLAN[curDay][idx].trans.hour = hour;
    PLAN[curDay][idx].trans.min = min;
    renderPlan(); // é‡æ–°æ¸²æŸ“ç•«é¢
}

let currentCurrency = 'JPY';
const EXCHANGE_RATE = 0.215; // æ‚¨å¯åœ¨æ­¤ä¿®æ”¹åŒ¯ç‡

function toggleCurrency() {
    currentCurrency = (currentCurrency === 'JPY') ? 'TWD' : 'JPY';

    // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
    document.getElementById('btn-jpy').classList.toggle('active');
    document.getElementById('btn-twd').classList.toggle('active');

    // æ›´æ–°è¼¸å…¥æ¡†æç¤ºèˆ‡æ¨™ç±¤
    const unit = currentCurrency === 'JPY' ? 'Â¥' : 'NT$';
    document.getElementById('quick-amt').placeholder = unit;
    document.getElementById('unit-label').innerText = unit;

    updateConversion();
}

function updateConversion() {
    const val = parseFloat(document.getElementById('quick-amt').value) || 0;
    const hint = document.getElementById('conversion-hint');

    if (currentCurrency === 'JPY') {
        const twd = Math.round(val * EXCHANGE_RATE);
        hint.innerText = `ç´„ NT$ ${twd.toLocaleString()}`;
    } else {
        const jpy = Math.round(val / EXCHANGE_RATE);
        hint.innerText = `ç´„ Â¥ ${jpy.toLocaleString()}`;
    }
}

document.getElementById('summary-content').addEventListener('scroll', function(e) {
    const scrollLeft = e.target.scrollLeft;
    const width = e.target.offsetWidth;
    const index = Math.round(scrollLeft / width);
    const dots = document.querySelectorAll('.dot');
    dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
    });
}, { passive: true });
// ğŸ†• æ‰‹å‹•åŒæ­¥æŒ‰éˆ•é‚è¼¯
function manualSync() {
  const btn = document.getElementById('btn-header-sync');
  const icon = document.getElementById('sync-icon');
  const text = document.getElementById('sync-text');

  // 1. è®Šæ›´æŒ‰éˆ•ç‹€æ…‹ç‚ºã€ŒåŒæ­¥ä¸­...ã€
  icon.style.animation = 'spin 1s linear infinite';
  icon.style.display = 'inline-block';
  text.textContent = 'æ›´æ–°ä¸­...';
  btn.style.opacity = '0.7';
  btn.disabled = true; // é˜²æ­¢é‡è¤‡é»æ“Š

  // 2. åŸ·è¡ŒåŒæ­¥
  loadExpensesFromSheet().then(data => {
    mergeExpensesFromSheet(data);

    // 3. æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    setTimeout(() => {
      icon.style.animation = 'none';
      text.textContent = 'å·²æ›´æ–°';
      btn.style.opacity = '1';
      btn.disabled = false;

      // 4. é¡¯ç¤ºæˆåŠŸæç¤º 2 ç§’å¾Œè®Šå›ã€ŒåŒæ­¥ã€
      setTimeout(() => {
        text.textContent = 'åŒæ­¥';
      }, 2000);
    }, 500); // è‡³å°‘è½‰ 0.5 ç§’è®“ç”¨æˆ¶æœ‰æ„Ÿ
  }).catch(err => {
    // éŒ¯èª¤è™•ç†
    console.error(err);
    text.textContent = 'å¤±æ•—';
    icon.textContent = 'âŒ';
    setTimeout(() => {
      text.textContent = 'åŒæ­¥';
      icon.textContent = 'ğŸ”„';
      icon.style.animation = 'none';
      btn.disabled = false;
    }, 2000);
  });
}


</script>
</body>
</html> 
