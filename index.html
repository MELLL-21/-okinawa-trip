<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <!-- 強化 viewport 設定以禁止縮放 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2C3E50">
    <meta name="description" content="沖繩旅遊行程與記帳管理應用">
    <title>沖繩行</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --primary: #2C3E50;
            --accent: #E76F51;
            --bg-color: #FDFBF7;
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color); color: var(--primary);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
            position: fixed;
            inset: 0;
            user-select: none; 
            -webkit-user-select: none;
        }
        button { cursor: pointer; border: none; background: none; outline: none; touch-action: manipulation; }
        
        /* Header & Tabs */
        header { padding: calc(1rem + var(--safe-top)) 1.5rem 0.5rem; flex-shrink: 0; background: var(--bg-color); z-index: 10; }
        h1 { margin: 0; font-size: 2rem; font-weight: 900; }
        .subtitle { color: #889EAF; font-size: 0.8rem; font-weight: 600; margin-top: 5px; display: flex; align-items: center; gap: 6px; }
        .badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
        .tabs { display: flex; padding: 0 1.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); background: var(--bg-color); z-index: 10; }
        .tab { padding: 1rem 0; margin-right: 1.5rem; font-weight: 700; color: #ccc; font-size: 0.9rem; position: relative; transition: 0.2s; }
        .tab.active { color: var(--primary); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--accent); border-radius: 2px; }
        
        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 1rem 1rem calc(6rem + var(--safe-bottom)) 1rem; -webkit-overflow-scrolling: touch; }
        
        /* Day Scroll (Top) */
        .day-scroll { display: flex; gap: 0.8rem; overflow-x: auto; padding: 0.5rem 0 1rem; scroll-snap-type: x mandatory; }
        .day-scroll::-webkit-scrollbar { display: none; }
        .day-card { flex: 0 0 7rem; height: 5.5rem; background: white; border-radius: 1rem; padding: 0.8rem; display: flex; flex-direction: column; justify-content: space-between; border: 2px solid transparent; transition: 0.2s; scroll-snap-align: start; box-shadow: 0 4px 12px rgba(0,0,0,0.03); cursor: pointer; position: relative; }
        .day-card:active { transform: scale(0.96); }
        .day-card.active { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(44,62,80,0.2); border-color: var(--primary); }
        .day-top { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: 800; opacity: 0.8; letter-spacing: 1px; }
        .day-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }
        .day-num { font-size: 1.6rem; font-weight: 700; line-height: 1; margin-top: auto; }
        .day-num span { font-size: 0.8rem; opacity: 0.6; margin-left: 4px; }

        /* Weather */
        .weather { background: white; padding: 1rem 1.2rem; border-radius: 1.2rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .w-txt h3 { margin: 0 0 4px 0; font-size: 1rem; }
        .w-txt p { margin: 0; font-size: 0.7rem; color: #aaa; }
        .w-val { background: var(--bg-color); padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 1.2rem; }

        /* Lists */
        .list-head { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 0.8rem; padding: 0 4px; }
        .list-head h2 { margin: 0; font-size: 1.2rem; }
        .hint { font-size: 0.65rem; background: white; padding: 4px 8px; border-radius: 12px; color: #ccc; }

        .item { background: white; padding: 1rem; border-radius: 1rem; margin-bottom: 0.8rem; display: flex; gap: 1rem; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.02); cursor: pointer; transition: transform 0.1s; position: relative; }
        .item:active { transform: scale(0.98); background: #fcfcfc; }
        .time { font-weight: 700; font-size: 1.1rem; min-width: 3.5rem; text-align: center; border-right: 2px solid #f5f5f5; padding-right: 0.8rem; }
        .info { flex: 1; min-width: 0; }
        .tag { display: inline-block; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-bottom: 4px; }
        .title { font-weight: 700; font-size: 1.05rem; margin-bottom: 2px; }
        .loc { font-size: 0.7rem; color: #bbb; display: flex; align-items: center; gap: 4px; }
        .icon { width: 1em; height: 1em; fill: currentColor; vertical-align: middle; }

        /* Colors */
        .bg-sight { background: #eff6ff; color: #1e40af; }
        .bg-food { background: #fff7ed; color: #9a3412; }
        .bg-shop { background: #fdf2f8; color: #be185d; }
        .bg-trans { background: #f3f4f6; color: #374151; }
        .bg-other { background: #ecfdf5; color: #047857; }

        /* Floating Button */
        .fab { position: fixed; bottom: calc(2rem + var(--safe-bottom)); right: 1.5rem; width: 3.5rem; height: 3.5rem; background: var(--primary); border-radius: 50%; color: white; box-shadow: 0 8px 20px rgba(44,62,80,0.4); display: flex; align-items: center; justify-content: center; z-index: 100; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }
        
        /* Modal & Overlay */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; display: flex; align-items: flex-end; }
        .overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: white; width: 100%; border-radius: 1.5rem 1.5rem 0 0; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 85dvh; overflow-y: auto; padding-bottom: calc(2rem + var(--safe-bottom)); }
        .overlay.open .modal { transform: translateY(0); }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        label { display: block; font-size: 0.7rem; color: #ccc; font-weight: 700; margin-bottom: 4px; }
        input, textarea, select { width: 100%; padding: 0.8rem; background: #F8F9FA; border: 1px solid transparent; border-radius: 0.8rem; font-size: 1rem; color: var(--primary); outline: none; appearance: none; }
        input:focus, textarea:focus, select:focus { background: white; border-color: var(--primary); }
        .cats { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; }
        .cat-chip { padding: 8px 16px; background: #F8F9FA; border-radius: 20px; font-size: 0.8rem; color: #aaa; font-weight: 700; white-space: nowrap; border: 1px solid transparent; cursor: pointer; }
        .cat-chip.active { background: var(--primary); color: white; }
        .btn-save { width: 100%; padding: 1rem; background: var(--primary); color: white; border-radius: 1rem; font-size: 1rem; font-weight: 700; margin-top: 1rem; }
        .btn-del { width: 100%; padding: 1rem; color: #ef4444; font-weight: 700; background: transparent; margin-top: 0.5rem; }

        /* EXPENSE STYLES */
        .exp-card { background: var(--primary); color: white; padding: 2rem 1.5rem; border-radius: 1.5rem; text-align: center; margin-bottom: 1.5rem; }
        .twd-est { font-size: 0.85rem; opacity: 0.7; margin-top: 8px; font-weight: 400; }
        
        /* 放大版分類顯示 */
        .exp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .exp-item { background: white; padding: 1.5rem 1rem; border-radius: 1.2rem; cursor: pointer; transition: transform 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .exp-item:active { transform: scale(0.96); }
        .exp-item .tag { font-size: 0.9rem; padding: 4px 10px; }
        .exp-item .val { font-size: 1.4rem; font-weight: 800; color: var(--primary); }

        /* Quick Add */
        .quick-exp { background: white; padding: 1.2rem; border-radius: 1.2rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .quick-exp h3 { margin: 0 0 0.8rem 0; font-size: 1rem; }
        .quick-exp-form { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; font-size: 0.85rem; }
        .quick-exp-form .full { grid-column: 1 / 3; }
        .quick-exp-form button { width: 100%; padding: 1rem; border-radius: 0.8rem; background: var(--primary); color: #fff; font-weight: 700; font-size: 1rem; }
        
        /* 行程底部目前花費：改為純文字樣式 */
        .itinerary-footer {
            margin-top: 1.2rem;
            padding: 0.3rem 0;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            background: transparent;
            box-shadow: none;
            border-left: none;
            border-radius: 0;
        }
        .it-foot-label { font-size: 0.9rem; font-weight: 700; color: #888; margin-right: 0.5rem; }
        .it-foot-val { font-size: 1.2rem; font-weight: 900; color: var(--primary); }

        /* Drag & Preview */
        .item.dragging { opacity: 0.9; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(1.02); cursor: grabbing; z-index: 1000; }
        .drag-placeholder { border: 2px dashed #e5e7eb; background: transparent; border-radius: 1rem; margin-bottom: 0.8rem; }
        .preview-toast { position: fixed; left: 50%; bottom: calc(5rem + var(--safe-bottom)); transform: translateX(-50%); background: rgba(44,62,80,0.95); color: #fff; padding: 0.6rem 1rem; border-radius: 999px; font-size: 0.8rem; z-index: 400; max-width: 80vw; text-align: center; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .preview-toast.show { opacity: 1; }
    </style>
</head>
<body>
<header>
    <h1>沖繩行</h1>
    <div class="subtitle"><span class="badge">5 Days</span> 旅遊紀錄 · 記帳 (JPY)</div>
</header>
<div class="tabs">
    <button class="tab active" onclick="switchTab(this, 'itinerary')">行程</button>
    <button class="tab" onclick="switchTab(this, 'expense')">記帳</button>
    <button class="tab" onclick="alert('日記功能即將推出')">日記</button>
</div>

<main id="view-itinerary">
    <div class="day-scroll" id="day-list"></div>
    <div class="weather" id="weather-card">
        <div class="w-txt"><h3>天氣預報</h3><p id="weather-desc">天氣晴朗，適合去海邊</p></div>
        <div class="w-val" id="weather-temp">
            <svg class="icon" style="color:#E76F51" viewBox="0 0 24 24" width="24" height="24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20"></path></svg>
            <span>24°C</span>
        </div>
    </div>
    <div class="list-head">
        <h2>行程表</h2>
        <span class="hint">長按可拖曳排序</span>
    </div>
    <div id="plan-list"></div>

    <!-- 行程底部顯示當日花費（純文字） -->
    <div class="itinerary-footer">
        <span class="it-foot-label">目前花費</span>
        <span class="it-foot-val">¥ <span id="itinerary-day-cost">0</span></span>
    </div>
</main>

<main id="view-expense" style="display:none">
    <div class="exp-card">
        <div style="font-size:2.5rem;font-weight:900;">¥ <span id="total-exp">0</span></div>
        <div style="font-weight:700; opacity:0.9;">總花費</div>
        <div class="twd-est">約 NT$ <span id="total-exp-twd">0</span> (匯率 0.22)</div>
    </div>

    <!-- 快速記帳區 -->
    <div class="quick-exp">
        <h3>快速記帳</h3>
        <form id="quick-exp-form" class="quick-exp-form" autocomplete="off">
            <div>
                <label for="quick-date">日期</label>
                <select id="quick-date" style="background-image:none;">
                    <option value="01/06">01/06</option>
                    <option value="01/07">01/07</option>
                    <option value="01/08">01/08</option>
                    <option value="01/09">01/09</option>
                    <option value="01/10">01/10</option>
                </select>
            </div>
            <div>
                <label for="quick-place">地點</label>
                <input type="text" id="quick-place" placeholder="消費地點" maxlength="32" />
            </div>
            <div>
                <label for="quick-amt">金額 (日幣)</label>
                <input type="number" id="quick-amt" min="1" max="999999" step="1" inputmode="numeric" pattern="[0-9]*">
            </div>
            <div>
                <label for="quick-note">備註</label>
                <input type="text" id="quick-note" placeholder="備註事項" maxlength="32" />
            </div>
            <div class="full">
                <label>種類</label>
                <div class="cats" id="quick-cat-list"></div>
            </div>
            <div class="full">
                <button type="submit">新增記帳</button>
            </div>
        </form>
    </div>

    <div class="list-head">
        <h2>分類統計</h2>
        <span class="hint">點擊查看明細</span>
    </div>
    <!-- 放大版的分類顯示 -->
    <div class="exp-grid" id="exp-grid"></div>
    
    <!-- 類別明細區 -->
    <div id="exp-detail" style="margin-top:1.5rem; min-height: 2rem;"></div>

</main>

<!-- 只在「行程」頁顯示的新增 FAB -->
<button class="fab" id="btn-add" onclick="openModal()">
    <svg class="icon" style="width:2em;height:2em;" viewBox="0 0 24 24"><path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
</button>

<div class="overlay" id="modal-overlay">
    <div class="modal">
        <h2 id="modal-title">新增行程</h2>
        <form id="add-form" autocomplete="off">
            <div class="form-grid">
                <div>
                    <label for="add-time">時間</label>
                    <input type="time" id="add-time" required>
                </div>
                <div>
                    <label for="add-title">標題</label>
                    <input type="text" id="add-title" maxlength="32" required>
                </div>
            </div>
            <label for="add-loc">地點／備註</label>
            <input type="text" id="add-loc" maxlength="32">
            <div class="cats" id="cat-list"></div>
            <div id="expense-fields" style="display:none">
                <label for="add-amt">金額 (¥)</label>
                <input type="number" id="add-amt" min="1" max="999999" step="1" inputmode="numeric" pattern="[0-9]*">
            </div>
            <button type="submit" class="btn-save">儲存</button>
            <button type="button" class="btn-del" onclick="deleteItem()">刪除紀錄</button>
        </form>
    </div>
</div>

<!-- 預覽提示 Toast -->
<div id="preview-toast" class="preview-toast"></div>

<script>
const RATE = 0.22; // 匯率設定

// 加入星期字樣 ㈡～㈥
const DAYS = [
    { num: 1, label: '01/06', week: '㈡' },
    { num: 2, label: '01/07', week: '㈢' },
    { num: 3, label: '01/08', week: '㈣' },
    { num: 4, label: '01/09', week: '㈤' },
    { num: 5, label: '01/10', week: '㈥' },
];

const PLAN = [
    [
        { time: '09:00', cat: 'sight', title: '萬座毛', loc: '沖繩景點', id: 1 },
        { time: '12:30', cat: 'food', title: '海人食堂', loc: '午餐', id: 2 },
        { time: '14:00', cat: 'shop', title: '國際通購物', loc: '血拼', id: 3 }
    ],
    [
        { time: '10:00', cat: 'sight', title: '美ら海水族館', loc: '', id: 4 },
        { time: '13:00', cat: 'trans', title: '單軌列車體驗', loc: '', id: 5 },
        { time: '17:00', cat: 'food', title: '咖啡廳', loc: '悠閒下午茶', id: 6 }
    ],
    [], [], []
];

// 初始化範例花費，幣值改為日幣
const EXPENSE = [
    [
        { cat: 'food', title: '午餐', amt: 2500, date: '01/06', note: '', id: 'e1' },
        { cat: 'shop', title: '紀念品', amt: 5000, date: '01/06', note: '買給朋友', id: 'e2' }
    ],
    [
        { cat: 'food', title: '咖啡', amt: 600, date: '01/07', note: '', id: 'e3' },
        { cat: 'trans', title: '單軌車票', amt: 800, date: '01/07', note: '一日券', id: 'e4' }
    ],
    [], [], []
];

const CATEGORIES = [
    { key: 'sight', label: '景點', color: 'bg-sight' },
    { key: 'food', label: '美食', color: 'bg-food' },
    { key: 'shop', label: '購物', color: 'bg-shop' },
    { key: 'trans', label: '交通', color: 'bg-trans' },
    { key: 'other', label: '其他', color: 'bg-other' }
];

let curTab = 'itinerary';
let curDay = 0;
let editingItem = null;
let editingType = null;

// 拖曳相關變數
let longPressTimer = null;
let isDraggingPlan = false;
let dragItemEl = null;
let dragPlaceholder = null;
let dragStartY = 0;
let dragOffsetY = 0;
let dragFromIndex = null;
let previewToastTimer = null;

function switchTab(tabBtn, name) {
    document.querySelectorAll('.tab').forEach($=>$.classList.remove('active'));
    tabBtn.classList.add('active');
    document.getElementById('view-itinerary').style.display = (name==='itinerary')?'block':'none';
    document.getElementById('view-expense').style.display = (name==='expense')?'block':'none';
    curTab = name;
    
    // 切換時重整資料確保最新
    if(name === 'itinerary') {
        renderPlan();
        // 行程頁顯示 FAB
        const fab = document.getElementById('btn-add');
        if (fab) fab.style.display = 'flex';
    } else {
        renderExpense();
        // 記帳頁隱藏 FAB（右下角＋號）
        const fab = document.getElementById('btn-add');
        if (fab) fab.style.display = 'none';
    }
}

function renderDaysBase() {
    const dayList = document.getElementById('day-list');
    dayList.innerHTML = '';
    DAYS.forEach((day, idx) => {
        const div = document.createElement('div');
        div.className = 'day-card' + (curDay===idx?' active':'');
        div.onclick = ()=>{ 
            curDay = idx; 
            renderDays();
            renderPlan(); 
            renderExpense(); 
        };
        const dotHTML = (curDay === idx) ? '<span class="day-dot"></span>' : '';
        div.innerHTML = `
            <div class="day-top">
                <span>Day ${day.num}</span>
                ${dotHTML}
            </div>
            <div class="day-num">${day.label}<span>${day.week}</span></div>
        `;
        dayList.appendChild(div);
    });
}

// 更新「行程頁」底部目前花費，與記帳頁統一
function updateItineraryDayCost() {
    let daySum = 0;
    if (EXPENSE[curDay]) {
        daySum = EXPENSE[curDay].reduce((a,b)=>a+b.amt, 0);
    }
    const el = document.getElementById('itinerary-day-cost');
    if (el) el.textContent = daySum.toLocaleString();
}

function renderPlan() {
    const list = document.getElementById('plan-list');
    list.innerHTML = '';
    
    // 同步更新行程頁的目前花費（使用 EXPENSE[curDay]）
    updateItineraryDayCost();

    const plans = PLAN[curDay] || [];
    if (plans.length === 0) {
        list.innerHTML = `<div style="color:#bbb;text-align:center;margin:2rem 0;">目前沒有行程</div>`;
        return;
    }

    plans.forEach((item, idx) => {
        const cat = CATEGORIES.find(c => c.key === item.cat) || {};
        const div = document.createElement('div');
        div.className = 'item';
        div.setAttribute('data-index', idx);

        div.innerHTML = `
            <div class="time">${item.time}</div>
            <div class="info">
                <span class="tag ${cat.color}">${cat.label || '-'}</span>
                <div class="title">${item.title}</div>
                <div class="loc">
                    <svg class="icon" viewBox="0 0 24 24" width="16" height="16">
                        <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" fill="none"></circle>
                        <path d="M12 2C7 2 4 7.2 4 10.5c0 4.7 6.1 10.8 7.4 12.1.3.3.8.3 1.1 0C13.9 21.3 20 15.2 20 10.5 20 7.2 17 2 12 2z" stroke="currentColor" stroke-width="2" fill="none"></path>
                    </svg>
                    ${item.loc || ''}
                </div>
            </div>
        `;

        // 觸控長按邏輯
        const pressStart = (e) => {
            if (isDraggingPlan) return;
            const startY = (e.touches ? e.touches[0].clientY : e.clientY);
            let moved = false;

            longPressTimer = setTimeout(() => {
                if (navigator.vibrate) navigator.vibrate(20); 
                showPlanPreviewToast(item);
                startPlanDrag(e, div, idx);
            }, 500); 

            const moveHandler = (ev) => {
                const curY = (ev.touches ? ev.touches[0].clientY : ev.clientY);
                if (Math.abs(curY - startY) > 10 && !isDraggingPlan) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                    moved = true;
                }
                if (isDraggingPlan) {
                    ev.preventDefault();
                    onPlanDragMove(ev);
                }
            };

            const endHandler = (ev) => {
                clearTimeout(longPressTimer);
                longPressTimer = null;
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', endHandler);
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', endHandler);

                if (isDraggingPlan) {
                    endPlanDrag(ev);
                } else if (!moved) {
                    openModal('plan', item, idx);
                }
            };

            document.addEventListener('touchmove', moveHandler, { passive: false });
            document.addEventListener('touchend', endHandler);
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', endHandler);
        };

        div.addEventListener('touchstart', pressStart, { passive: false });
        div.addEventListener('mousedown', pressStart);

        list.appendChild(div);
    });
}

/* --- 拖曳相關函式 --- */
function showPlanPreviewToast(item) {
    const toast = document.getElementById('preview-toast');
    toast.textContent = `排序中: ${item.time} ${item.title}`;
    toast.classList.add('show');
    clearTimeout(previewToastTimer);
    previewToastTimer = setTimeout(() => {
        toast.classList.remove('show');
    }, 2000);
}

function startPlanDrag(e, el, index) {
    isDraggingPlan = true;
    dragItemEl = el;
    dragFromIndex = index;
    const rect = el.getBoundingClientRect();
    dragStartY = rect.top;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    dragOffsetY = clientY - rect.top;
    dragPlaceholder = document.createElement('div');
    dragPlaceholder.className = 'drag-placeholder';
    dragPlaceholder.style.height = rect.height + 'px';
    el.parentNode.insertBefore(dragPlaceholder, el.nextSibling);
    el.classList.add('dragging');
    el.style.position = 'fixed';
    el.style.left = rect.left + 'px';
    el.style.top = rect.top + 'px';
    el.style.width = rect.width + 'px';
    el.style.zIndex = '500';
}

function onPlanDragMove(e) {
    if (!isDraggingPlan || !dragItemEl) return;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const newTop = clientY - dragOffsetY;
    dragItemEl.style.top = newTop + 'px';
    const list = document.getElementById('plan-list');
    const siblings = Array.from(list.querySelectorAll('.item')).filter(el => el !== dragItemEl);
    let newIndex = dragFromIndex;
    const centerY = newTop + dragItemEl.offsetHeight / 2;
    siblings.forEach((sib) => {
        const rect = sib.getBoundingClientRect();
        const sibIndex = parseInt(sib.getAttribute('data-index'), 10);
        if (centerY > rect.top + rect.height / 2) {
            if(sibIndex >= newIndex) newIndex = sibIndex + 1;
        } 
    });
    const children = Array.from(list.children);
    let insertBeforeEl = null;
    for(let child of children) {
        if(child === dragItemEl || child === dragPlaceholder) continue;
        const r = child.getBoundingClientRect();
        if(centerY < r.top + r.height / 2) {
            insertBeforeEl = child;
            break;
        }
    }
    if (insertBeforeEl) {
        list.insertBefore(dragPlaceholder, insertBeforeEl);
    } else {
        list.appendChild(dragPlaceholder);
    }
}

function endPlanDrag() {
    if (!isDraggingPlan) { resetPlanDragState(); return; }
    const list = document.getElementById('plan-list');
    const children = Array.from(list.children).filter(c => c !== dragItemEl); 
    const newIndex = children.indexOf(dragPlaceholder);
    if (newIndex >= 0 && dragFromIndex !== null && newIndex !== dragFromIndex) {
        const item = PLAN[curDay].splice(dragFromIndex, 1)[0];
        PLAN[curDay].splice(newIndex, 0, item);
    }
    resetPlanDragState();
    renderPlan();
    document.getElementById('preview-toast').classList.remove('show');
}

function resetPlanDragState() {
    isDraggingPlan = false;
    if (dragItemEl) {
        dragItemEl.classList.remove('dragging');
        dragItemEl.style.position = '';
        dragItemEl.style.left = '';
        dragItemEl.style.top = '';
        dragItemEl.style.width = '';
        dragItemEl.style.zIndex = '';
    }
    if (dragPlaceholder && dragPlaceholder.parentNode) {
        dragPlaceholder.parentNode.removeChild(dragPlaceholder);
    }
    dragItemEl = null;
    dragPlaceholder = null;
    dragFromIndex = null;
}

/* --- 記帳相關函式 --- */
function renderExpense() {
    // 當天花費計算 (以日幣計算)
    let sum = EXPENSE[curDay]?.reduce((a,b)=>a+b.amt,0) || 0;
    
    document.getElementById('total-exp').textContent = sum.toLocaleString();
    
    // 台幣換算
    const twd = Math.round(sum * RATE);
    document.getElementById('total-exp-twd').textContent = twd.toLocaleString();
    
    const grid = document.getElementById('exp-grid');
    grid.innerHTML = '';
    let catMap = {};
    CATEGORIES.forEach(c=>catMap[c.key]=0);
    (EXPENSE[curDay]||[]).forEach(item=>{ catMap[item.cat]=(catMap[item.cat]||0)+item.amt; });
    
    CATEGORIES.forEach(cat=>{
        const val = catMap[cat.key];
        const d = document.createElement('div');
        d.className = 'exp-item';
        // 放大版顯示，未消費的類別顯示 0 或淡色
        d.style.opacity = val > 0 ? 1 : 0.6;
        d.innerHTML = `
            <span class="tag ${cat.color}">${cat.label}</span>
            <div class="val">¥ ${val.toLocaleString()}</div>
        `;
        d.onclick = () => showExpenseDetailByCategory(cat.key);
        grid.appendChild(d);
    });
    
    // 清空明細顯示區，等待點擊
    document.getElementById('exp-detail').innerHTML = '<div style="text-align:center;color:#ccc;font-size:0.8rem;padding:1rem;">點擊上方分類查看詳細</div>';

    // 同步更新行程頁的目前花費
    updateItineraryDayCost();
}

function showExpenseDetailByCategory(catKey) {
    const detail = document.getElementById('exp-detail');
    if (!detail) return;

    const cat = CATEGORIES.find(c => c.key === catKey);
    const label = cat ? cat.label : '';
    const items = (EXPENSE[curDay] || []).filter(it => it.cat === catKey);

    if (!items.length) {
        detail.innerHTML = `<div style="text-align:center;color:#ccc;padding:1rem;">${label}類別尚無消費</div>`;
        return;
    }

    let html = `<div style="margin-bottom:0.5rem; font-weight:bold; color:#666; font-size:0.9rem;">${label} 明細</div>`;
    items.forEach(it => {
        const date = it.date || DAYS[curDay].label;
        const place = it.title || '—';
        html += `
            <div onclick="confirmDeleteExpense('${it.id}', '${place}')" style="background:white;border-radius:0.8rem;padding:0.8rem 1rem;margin-bottom:0.6rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 3px rgba(0,0,0,0.05); cursor:pointer;">
                <div style="font-size:0.9rem;">
                    <div style="font-weight:700;">${place}</div>
                    <div style="color:#999;font-size:0.75rem;">${date} ${it.note ? '· '+it.note : ''}</div>
                </div>
                <div style="font-weight:800;font-size:1.1rem;">¥ ${it.amt.toLocaleString()}</div>
            </div>
        `;
    });
    html += `<div style="text-align:center;font-size:0.7rem;color:#ccc;margin-top:0.5rem;">點擊項目可刪除</div>`;
    detail.innerHTML = html;
    detail.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function confirmDeleteExpense(id, title) {
    if(confirm(`確定要刪除「${title}」這筆紀錄嗎？`)) {
        const idx = EXPENSE[curDay].findIndex(e => e.id === id);
        if(idx > -1) {
            EXPENSE[curDay].splice(idx, 1);
            renderExpense();
        }
    }
}

function openModal(type='plan', item=null, idx=-1){
    document.getElementById('modal-overlay').classList.add('open');
    document.getElementById('add-form').reset();
    document.getElementById('expense-fields').style.display = (curTab==='expense'||type==='expense') ? 'block':'none';
    const cats = document.getElementById('cat-list');
    cats.innerHTML = '';
    CATEGORIES.forEach(c=>{
        let btn = document.createElement('div');
        btn.className = 'cat-chip'+(item&&item.cat===c.key?' active':'');
        btn.textContent = c.label;
        btn.onclick = ()=>{document.querySelectorAll('#cat-list .cat-chip').forEach(x=>x.classList.remove('active'));btn.classList.add('active');};
        btn.setAttribute('data-key', c.key);
        cats.appendChild(btn);
    });
    if(!item && cats.firstChild) cats.firstChild.classList.add('active');

    if(item){
        document.getElementById('add-time').value = item.time||'';
        document.getElementById('add-title').value = item.title;
        document.getElementById('add-loc').value = item.loc||'';
        document.getElementById('modal-title').textContent = type==='plan'?'編輯行程':'編輯記帳';
        if(item.amt) document.getElementById('add-amt').value = item.amt;
        editingItem = idx; editingType = type;
        document.querySelector('.btn-del').style.display = 'block';
    } else {
        document.getElementById('modal-title').textContent = (curTab==='expense'||type==='expense')?'新增記帳':'新增行程';
        editingItem=null; editingType=curTab==='expense'?'expense':'plan';
        document.querySelector('.btn-del').style.display = 'none';
    }
}

function closeModal(){
    document.getElementById('modal-overlay').classList.remove('open');
}

document.getElementById('modal-overlay').addEventListener('click', e=>{
    if(e.target.id==='modal-overlay') closeModal();
});

document.getElementById('add-form').addEventListener('submit', function(e){
    e.preventDefault();
    let time = document.getElementById('add-time').value;
    let title = document.getElementById('add-title').value.trim();
    let loc = document.getElementById('add-loc').value.trim();
    let cat = document.querySelector('#cat-list .cat-chip.active')?.getAttribute('data-key')||CATEGORIES[0].key;
    
    if((curTab==='expense'||editingType==='expense') && document.getElementById('expense-fields').style.display==='block'){
        let amt = parseInt(document.getElementById('add-amt').value)||0;
        if(!amt || amt<1){alert('請填寫金額'); return;}
        const dateStr = DAYS[curDay].label;
        
        if(editingItem!==null){
            EXPENSE[curDay][editingItem] = {cat, title, amt, date: dateStr, note: loc, id: EXPENSE[curDay][editingItem].id};
        } else {
            if(!EXPENSE[curDay]) EXPENSE[curDay]=[];
            EXPENSE[curDay].push({cat, title, amt, date: dateStr, note: loc, id:'e'+Date.now()});
        }
        renderExpense(); closeModal();
        return;
    }
    if(editingItem!==null){
        PLAN[curDay][editingItem] = {time, cat, title, loc, id: PLAN[curDay][editingItem].id};
    } else {
        if(!PLAN[curDay]) PLAN[curDay]=[];
        PLAN[curDay].push({time, cat, title, loc, id: Date.now()});
    }
    renderPlan(); closeModal();
});

function deleteItem(){
    if(editingItem===null) return;
    if(editingType==='expense') {
        EXPENSE[curDay].splice(editingItem,1);
        renderExpense(); closeModal();
    } else {
        PLAN[curDay].splice(editingItem,1);
        renderPlan(); closeModal();
    }
}

function init() {
    renderDays();
    renderPlan();
    renderExpense();
    
    document.addEventListener('gesturestart', function(e) {
        e.preventDefault();
    });

    // 初始化 Modal 分類
    document.getElementById('cat-list').innerHTML = CATEGORIES.map(
        c=>`<div class="cat-chip" data-key="${c.key}">${c.label}</div>`
    ).join('');

    // 初始化快速記帳分類
    const quickCats = document.getElementById('quick-cat-list');
    if(quickCats) {
        quickCats.innerHTML = '';
        CATEGORIES.forEach(c => {
            const btn = document.createElement('div');
            btn.className = 'cat-chip';
            btn.textContent = c.label;
            btn.setAttribute('data-key', c.key);
            btn.onclick = () => {
                quickCats.querySelectorAll('.cat-chip').forEach(x => x.classList.remove('active'));
                btn.classList.add('active');
            };
            quickCats.appendChild(btn);
        });
        if(quickCats.firstChild) quickCats.firstChild.classList.add('active');
    }
    
    // 設定快速記帳選單預設值為當前選擇的天數
    const dateSelect = document.getElementById('quick-date');
    if(dateSelect) {
        dateSelect.value = DAYS[curDay].label;
    }

    // 一開始在行程頁，顯示 FAB
    const fab = document.getElementById('btn-add');
    if (fab) fab.style.display = 'flex';
    
    // 快速記帳表單監聽
    document.getElementById('quick-exp-form').addEventListener('submit', function(e){
        e.preventDefault();
        const dateSelect = document.getElementById('quick-date');
        const date = dateSelect.value; 
        const place = document.getElementById('quick-place').value.trim() || '未命名地點';
        const note = document.getElementById('quick-note').value.trim();
        const amt = parseInt(document.getElementById('quick-amt').value, 10) || 0;
        const catBtn = document.querySelector('#quick-cat-list .cat-chip.active');
        const cat = catBtn ? catBtn.getAttribute('data-key') : CATEGORIES[0].key;

        if (!amt || amt < 1) { alert('請輸入有效花費金額'); return; }

        // 找出選擇的日期對應的 index
        const targetDayIdx = DAYS.findIndex(d => d.label === date);
        if(targetDayIdx === -1) { alert('日期錯誤'); return; }

        if (!EXPENSE[targetDayIdx]) EXPENSE[targetDayIdx] = [];
        EXPENSE[targetDayIdx].push({
            cat,
            title: place,
            amt,
            date,
            note,
            id: 'e' + Date.now()
        });

        // 重置欄位
        document.getElementById('quick-amt').value = '';
        document.getElementById('quick-place').value = '';
        document.getElementById('quick-note').value = '';
        
        // 如果新增的是當天的帳，刷新畫面；如果不是，提示成功
        if(targetDayIdx === curDay) {
            renderExpense();
        } else {
            alert(`已新增至 ${date} 的記帳`);
        }
    });
}

// 監聽日期卡片切換，順便更新快速記帳的預設日期
const originalRenderDays = renderDaysBase;
function renderDays() {
    originalRenderDays();
    const dateSelect = document.getElementById('quick-date');
    if(dateSelect) {
        dateSelect.value = DAYS[curDay].label;
    }
}

window.onload = init;
</script>
</body>
</html>
